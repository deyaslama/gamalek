<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة المنتجات – لوحة التحكم</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Cairo',sans-serif;background:#f4f7fb;color:#333;}

.sidebar{
  width:230px;background:#006b6a;height:100vh;position:fixed;
  right:0;top:0;padding:20px;color:#fff;
}
.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.nav-links{display:flex;flex-direction:column;gap:15px;}
.nav-links a{color:#fff;padding:10px;border-radius:6px;font-size:16px;text-decoration: none;}
.nav-links a:hover,.nav-links a.active{background:#009b9b;}

.main{margin-right:25px;padding:25px;}
.header{
  background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);
  margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;
}

.card{
  background:#fff;padding:20px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:25px;
}

.btn{background:#006b6a;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;}
.btn-red{background:#d62828;color:#fff;}
.btn-light{background:#e4e4e4;color:#333;}

.search-input{
  width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;margin-bottom:10px;
}

.flex-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}

select.filter{
  padding:6px 10px;border-radius:8px;border:1px solid #ccc;font-size:13px;
}

/* جدول */
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:8px;text-align:center;border-bottom:1px solid #eee;font-size:13px;}
th{background:#f1f1f1;font-weight:600;}

.product-img{width:46px;height:46px;object-fit:contain;border:1px solid #ccc;padding:3px;border-radius:6px;}

.star{font-size:20px;color:#ccc;cursor:pointer;}
.star.on{color:#ffbf00;}

.pagination{text-align:center;margin-top:15px;}
.page-btn{padding:6px 10px;margin:0 3px;border:none;border-radius:6px;background:#e4e4e4;cursor:pointer;font-size:13px;}
.page-btn.active{background:#006b6a;color:#fff;}

.counter{font-size:13px;color:#666;}

.modal-overlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:999;
}
.modal-box{
  background:#fff;padding:20px;border-radius:10px;
  box-shadow:0 2px 12px rgba(0,0,0,0.2);width:420px;
}
.modal-box h3{text-align:center;color:#006b6a;margin-bottom:10px;font-size:18px;}
.modal-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;margin-bottom:8px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px;}
</style>
</head>

<body>

<!-- ================= الشريط الجانبي ================ -->

</div>

<!-- ================= المحتوى ================= -->
<div class="main">

  <div class="header">
    <span style="font-size:20px;font-weight:600;">إدارة المنتجات</span>
    <div>
      <button class="btn" onclick="showAddModal()">➕ إضافة منتج</button>
      <button class="btn" onclick="exportExcel()">⬇️ تصدير Excel</button>
      <button class="btn" onclick="showExcelModal()">⬆️ رفع Excel</button>
    </div>
  </div>

  <div class="card">

    <input id="searchInput" class="search-input" placeholder="بحث بالاسم، أسكون، الدولي..." oninput="applyFilters()">

    <div class="flex-row">

      <!-- فلتر الماركات -->
      <select id="brandFilter" class="filter" onchange="applyFilters()">
        <option value="">كل الماركات</option>
      </select>

      <!-- فلتر الأقسام -->
      <select id="categoryFilter" class="filter" onchange="applyFilters()">
        <option value="">كل الأقسام</option>
      </select>

      <select id="sortSelect" class="filter" onchange="changeSort()">
        <option value="">ترتيب افتراضي</option>
        <option value="name_asc">الاسم (أ→ي)</option>
        <option value="name_desc">الاسم (ي→أ)</option>
        <option value="price_asc">السعر من الأقل</option>
        <option value="price_desc">السعر من الأعلى</option>
        <option value="date_desc">الأحدث أولاً</option>
        <option value="date_asc">الأقدم أولاً</option>
        <option value="discount_desc">أعلى خصم</option>
      </select>

      <label style="font-size:13px;">
        <input type="checkbox" id="featuredOnly" onchange="applyFilters()">
        ⭐ المميزة فقط
      </label>

      <span id="counter" class="counter"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>⭐</th>
          <th>الصورة</th>
          <th>الاسم</th>
          <th>الماركة</th>
          <th>السعر بعد الضريبة</th>
          <th>السعر بعد الخصم والضريبة</th>
          <th>القسم</th>
          <th>أسكون</th>
          <th>الدولي</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="productsTable"></tbody>
    </table>

    <div id="pagination" class="pagination"></div>

  </div>

</div>
<!-- ================= نافذة إضافة ================= -->
<div id="addModal" class="modal-overlay">
  <div class="modal-box">
    <h3>إضافة منتج</h3>

    <input id="name" class="modal-input" placeholder="اسم المنتج">
    <input id="base_price" class="modal-input" placeholder="السعر بدون الضريبة">
    <input id="askon_code" class="modal-input" placeholder="كود أسكون">
    <input id="intl_code" class="modal-input" placeholder="الكود الدولي">
    <input id="image_url" class="modal-input" placeholder="رابط الصورة">

    <select id="brand_id" class="modal-input"></select>

    <input id="category" class="modal-input" placeholder="القسم">

    <input id="description" class="modal-input" placeholder="وصف المنتج (اختياري)">

    <input id="discount_value" class="modal-input" placeholder="قيمة الخصم">
    <select id="discount_type" class="modal-input">
      <option value="none">بدون خصم</option>
      <option value="percent">نسبة %</option>
      <option value="fixed">ثابت</option>
    </select>

    <select id="featured" class="modal-input">
      <option value="0">غير مميز</option>
      <option value="1">⭐ مميز</option>
    </select>

    <div class="modal-actions">
      <button class="btn" onclick="addProduct()">حفظ</button>
      <button class="btn-red" onclick="hideAddModal()">إغلاق</button>
    </div>
  </div>
</div>

<!-- ================= نافذة تعديل ================= -->
<div id="editModal" class="modal-overlay">
  <div class="modal-box">
    <h3>تعديل المنتج</h3>

    <input type="hidden" id="edit_id">

    <input id="edit_name" class="modal-input">
    <input id="edit_base_price" class="modal-input">
    <input id="edit_askon_code" class="modal-input">
    <input id="edit_intl_code" class="modal-input">
    <input id="edit_image_url" class="modal-input">

    <select id="edit_brand_id" class="modal-input"></select>

    <input id="edit_category" class="modal-input">

    <input id="edit_description" class="modal-input" placeholder="الوصف">

    <input id="edit_discount_value" class="modal-input">
    <select id="edit_discount_type" class="modal-input">
      <option value="none">بدون خصم</option>
      <option value="percent">نسبة %</option>
      <option value="fixed">ثابت</option>
    </select>

    <select id="edit_featured" class="modal-input">
      <option value="0">غير مميز</option>
      <option value="1">⭐ مميز</option>
    </select>

    <div class="modal-actions">
      <button class="btn" onclick="updateProduct()">حفظ</button>
      <button class="btn-red" onclick="hideEditModal()">إغلاق</button>
    </div>
  </div>
</div>

<!-- ================= نافذة Excel ================= -->
<div id="excelModal" class="modal-overlay">
  <div class="modal-box">
    <h3>رفع ملف Excel</h3>

    <input type="file" id="excelFile" class="modal-input">

    <div class="modal-actions">
      <button class="btn" onclick="uploadExcel()">رفع</button>
      <button class="btn-red" onclick="hideExcelModal()">إغلاق</button>
    </div>
  </div>
</div>
<script>




const API = "http://localhost:3000";

let products = [];
let brands = [];
let filtered = [];
let currentPage = 1;
const perPage = 20;
let currentSort = "";

/* ================= روابط الصور ================= */
function safeImageURL(url) {
  if (!url) return "";
  url = url.trim();

  // روابط Google Drive
  if (url.includes("drive.google.com") || url.includes("lh3.googleusercontent.com")) {
    const match = url.match(/[-\w]{25,}/);
    if (match) {
      return `https://lh3.googleusercontent.com/d/${match[0]}`;
    }
    return url;
  }

  // روابط مباشرة (zid, nahdi, amazon ... إلخ)
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }

  return url;
}

/* ================= مودالات ================= */
function showAddModal(){ document.getElementById("addModal").style.display="flex"; }
function hideAddModal(){ document.getElementById("addModal").style.display="none"; }

function showEditModal(){ document.getElementById("editModal").style.display="flex"; }
function hideEditModal(){ document.getElementById("editModal").style.display="none"; }

function showExcelModal(){ document.getElementById("excelModal").style.display="flex"; }
function hideExcelModal(){ document.getElementById("excelModal").style.display="none"; }

/* ================= تحميل الماركات ================= */
async function loadBrands(){
  const res = await fetch(API + "/api/admin/brands");
  brands = await res.json();

  const addSel = document.getElementById("brand_id");
  const editSel = document.getElementById("edit_brand_id");
  const filterSel = document.getElementById("brandFilter");

  addSel.innerHTML = `<option value="">بدون ماركة</option>`;
  editSel.innerHTML = `<option value="">بدون ماركة</option>`;
  filterSel.innerHTML = `<option value="">كل الماركات</option>`;

  brands.forEach(b=>{
    addSel.innerHTML += `<option value="${b.id}">${b.name}</option>`;
    editSel.innerHTML += `<option value="${b.id}">${b.name}</option>`;
    filterSel.innerHTML += `<option value="${b.id}">${b.name}</option>`;
  });
}

/* ================= تحميل المنتجات ================= */
async function loadProducts(){
  const res = await fetch(API + "/api/admin/products");
  products = await res.json();

  buildCategoryFilter();
  applyFilters();
}

/* ================= بناء الأقسام ================= */
function buildCategoryFilter(){
  const sel = document.getElementById("categoryFilter");
  const cats = [...new Set(products.map(p=>p.category).filter(Boolean))];
  sel.innerHTML = `<option value="">كل الأقسام</option>`;
  cats.forEach(c=> sel.innerHTML += `<option value="${c}">${c}</option>`);
}

/* ================= فلترة ================= */
function applyFilters(){
  const q = document.getElementById("searchInput").value.trim();
  const cat = document.getElementById("categoryFilter").value;
  const brand = document.getElementById("brandFilter").value;
  const featuredOnly = document.getElementById("featuredOnly").checked;

  filtered = products.filter(p=>{
    const s = !q || (p.name||"").includes(q) || (p.askon_code||"").includes(q) || (p.intl_code||"").includes(q);
    const c = !cat || p.category === cat;
    const b = !brand || p.brand_id == brand;
    const f = !featuredOnly || p.featured == 1;
    return s && c && b && f;
  });

  sortProducts();
  currentPage = 1;
  renderTable();
}

/* ================= ترتيب ================= */
function changeSort(){
  currentSort = document.getElementById("sortSelect").value;
  sortProducts();
  currentPage = 1;
  renderTable();
}

function sortProducts(){
  if(!currentSort) return;

  const [field,dir] = currentSort.split("_");

  filtered.sort((a,b)=>{
    let va, vb;

    if(field==="name"){ va = (a.name||"").toLowerCase(); vb = (b.name||"").toLowerCase(); }
    else if(field==="price"){ va = parseFloat(a.base_price)||0; vb = parseFloat(b.base_price)||0; }
    else if(field==="date"){ va = new Date(a.created_at).getTime(); vb = new Date(b.created_at).getTime(); }
    else if(field==="discount"){ va = parseFloat(a.discount_value)||0; vb = parseFloat(b.discount_value)||0; }

    if(va < vb) return dir==="asc"?-1:1;
    if(va > vb) return dir==="asc"?1:-1;
    return 0;
  });
}
function calculateFinalPrice(product) {
    let base = parseFloat(product.base_price) || 0;
    let discountValue = parseFloat(product.discount_value) || 0;
    let type = product.discount_type;

    let priceAfterDiscount = base;

    if (type === "percent") {
        priceAfterDiscount = base - (base * (discountValue / 100));
    } else if (type === "fixed") {
        priceAfterDiscount = base - discountValue;
    }

    if (priceAfterDiscount < 0) priceAfterDiscount = 0;

    let finalPrice = priceAfterDiscount * 1.15;
    let beforePrice = base * 1.15;

    return {
        before: beforePrice.toFixed(2), // 224.25
        final: finalPrice.toFixed(2)    // 100.91
    };
}

/* ================= جدول ================= */
function renderTable(){
  const tbody = document.getElementById("productsTable");
  tbody.innerHTML = "";

  const start = (currentPage-1)*perPage;
  const end = start+perPage;
  const list = filtered.slice(start,end);

  list.forEach(p=>{

    const imgURL = safeImageURL(p.image_url);
    const prices = calculateFinalPrice(p);

    tbody.innerHTML += `
<tr>
  <!-- ⭐ -->
  <td>
    <span class="star ${p.featured?'on':''}" onclick="toggleFeatured(${p.id},${p.featured})">
      ${p.featured?'★':'☆'}
    </span>
  </td>

  <!-- الصورة -->
  <td>
    <img class="product-img"
         src="${imgURL}"
         referrerpolicy="no-referrer"
         onerror="this.src='https://via.placeholder.com/80?text=No+Image'">
  </td>

  <!-- الاسم -->
  <td>${p.name}</td>

  <!-- الماركة -->
  <td>${p.brand_name || "-"}</td>

  <!-- السعر بعد الخصم + الضريبة (نهائي) -->
  <td style="font-weight:bold; color:${p.discount_type !== 'none' ? 'red' : '#006b6a'};">
    ${prices.final} ر.س
</td>


  <!-- السعر قبل الخصم (الأساسي + الضريبة) -->
  <td style="text-decoration:line-through;color:#999;">${prices.before} ر.س</td>

  <!-- القسم -->
  <td>${p.category || "-"}</td>

  <!-- أسكون -->
  <td>${p.askon_code || "-"}</td>

  <!-- الدولي -->
  <td>${p.intl_code || "-"}</td>

  <!-- إجراءات -->
  <td>
    <button class="btn-light" onclick="openEditModal(${p.id})">تعديل</button>
    <button class="btn-red" onclick="deleteProduct(${p.id})">حذف</button>
  </td>
</tr>

    `;
  });

  renderPagination();
}

/* ================= تصدير اكسل ================= */

function exportExcel(){
    const url = API + "/api/admin/products/export";
    const link = document.createElement("a");
    link.href = url;
    link.download = "products.xlsx";
    document.body.appendChild(link);
    link.click();
    link.remove();
}


/* ================= صفحات ================= */
function renderPagination(){
  const total = Math.ceil(filtered.length/perPage);
  let html="";
  for(let i=1;i<=total;i++){
    html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
  }
  document.getElementById("pagination").innerHTML = html;
}

function goPage(n){
  currentPage = n;
  renderTable();
}

/* ================= إضافة ================= */
async function addProduct(){
  const body = {
    name: document.getElementById("name").value,
    base_price: document.getElementById("base_price").value,
    askon_code: document.getElementById("askon_code").value,
    intl_code: document.getElementById("intl_code").value,
    image_url: document.getElementById("image_url").value,
    brand_id: document.getElementById("brand_id").value,
    category: document.getElementById("category").value,
    description: document.getElementById("description").value,
    discount_value: document.getElementById("discount_value").value,
    discount_type: document.getElementById("discount_type").value,
    featured: document.getElementById("featured").value
  };

  await fetch(API + "/api/admin/products", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });

  hideAddModal();
  loadProducts();
}

/* ================= تعديل ================= */
function openEditModal(id){
  const p = products.find(x=>x.id===id);

  document.getElementById("edit_id").value = p.id;
  document.getElementById("edit_name").value = p.name;
  document.getElementById("edit_base_price").value = p.base_price;
  document.getElementById("edit_askon_code").value = p.askon_code;
  document.getElementById("edit_intl_code").value = p.intl_code;
  document.getElementById("edit_image_url").value = p.image_url;
  document.getElementById("edit_brand_id").value = p.brand_id || "";
  document.getElementById("edit_category").value = p.category;
  document.getElementById("edit_description").value = p.description || "";
  document.getElementById("edit_discount_value").value = p.discount_value;
  document.getElementById("edit_discount_type").value = p.discount_type;
  document.getElementById("edit_featured").value = p.featured;

  showEditModal();
}

async function updateProduct(){
  const id = document.getElementById("edit_id").value;

  const body = {
    name: document.getElementById("edit_name").value,
    base_price: document.getElementById("edit_base_price").value,
    askon_code: document.getElementById("edit_askon_code").value,
    intl_code: document.getElementById("edit_intl_code").value,
    image_url: document.getElementById("edit_image_url").value,
    brand_id: document.getElementById("edit_brand_id").value,
    category: document.getElementById("edit_category").value,
    description: document.getElementById("edit_description").value,
    discount_value: document.getElementById("edit_discount_value").value,
    discount_type: document.getElementById("edit_discount_type").value,
    featured: document.getElementById("edit_featured").value
  };

  await fetch(API + "/api/admin/products/" + id, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });

  hideEditModal();
  loadProducts();
}

/* ================= حذف ================= */
async function deleteProduct(id){
  if(!confirm("هل تريد حذف المنتج؟")) return;
  await fetch(API + "/api/admin/products/" + id, { method:"DELETE" });
  loadProducts();
}

/* ================= نجمة ================= */
async function toggleFeatured(id,current){
  await fetch(API + "/api/admin/products/feature", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ id, featured: current?0:1 })
  });
  loadProducts();
}

/* ================= رفع Excel ================= */
async function uploadExcel(){
  const file = document.getElementById("excelFile").files[0];
  if(!file){ alert("اختر ملف"); return; }

  const form = new FormData();
  form.append("file", file);

  await fetch(API + "/api/admin/products/upload-excel", {
    method:"POST",
    body: form
  });

  hideExcelModal();
  loadProducts();
}

/* ================= تشغيل ================= */
(async ()=>{
  await loadBrands();
  await loadProducts();
})();
</script>


</body>