<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>متجر جمالك</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

<!-- CSS Files -->
<link rel="stylesheet" href="frontend/css/base.css">
<link rel="stylesheet" href="frontend/css/animations.css">
<link rel="stylesheet" href="frontend/css/header.css">
<link rel="stylesheet" href="frontend/css/footer.css">
<link rel="stylesheet" href="frontend/css/products.css">
<link rel="stylesheet" href="frontend/css/pages.css">
<link rel="stylesheet" href="frontend/css/modals.css">
<link rel="stylesheet" href="frontend/css/forms.css">
<link rel="stylesheet" href="frontend/css/utilities.css">
<link rel="stylesheet" href="frontend/css/ratings.css">
<link rel="stylesheet" href="frontend/css/loader.css">
<link rel="stylesheet" href="frontend/css/print.css">

</head>

<body>

<!-- ========================= صفحة Loading ========================= -->
<div id="pageLoader" class="page-loader">
  <div class="loader-container">
    <div class="loader-logo">
      <div class="loader-logo-circle">ج</div>
      <div class="loader-logo-text">جمالك</div>
    </div>
    <div class="loader-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <div class="loader-text">جاري التحميل...</div>
  </div>
</div>

<!-- =========================  الهيدر (سيتم دمجه لاحقًا كما هو) ========================= -->

<!-- شريط الكوبون -->
<div id="couponBanner" style="display:none;background:linear-gradient(135deg, #1a0a0a 0%, #2d1b1b 50%, #1a0a0a 100%);color:#ffdada;padding:6px 0;text-align:center;font-size:13px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:999;">
  <div class="container" style="display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;">
    <span>🎟️</span>
    <span id="couponBannerText"></span>
    <span style="background:rgba(233, 30, 99, 0.3);padding:3px 10px;border-radius:4px;font-weight:700;letter-spacing:1px;font-size:12px;" id="couponBannerCode"></span>
  </div>
</div>

<!-- Modal المفضلة - تسجيل الدخول مطلوب -->
<div id="wishlistLoginModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;justify-content:center;align-items:center;backdrop-filter:blur(4px);">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:450px;width:90%;box-shadow:0 12px 48px rgba(0,0,0,0.3);text-align:center;animation:modalSlideIn 0.3s ease-out;">
    <div style="font-size:64px;margin-bottom:20px;">❤️</div>
    <h3 style="font-size:24px;font-weight:700;color:#333;margin-bottom:12px;">تسجيل الدخول مطلوب</h3>
    <p style="font-size:16px;color:#666;margin-bottom:30px;line-height:1.6;">يجب تسجيل الدخول لإضافة المنتجات للمفضلة</p>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <button onclick="goToLoginFromWishlistModal()" style="width:100%;padding:16px;background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(233, 30, 99, 0.4);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(233, 30, 99, 0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(233, 30, 99, 0.4)'">
        تسجيل الدخول
      </button>
      <button onclick="closeWishlistLoginModal()" style="width:100%;padding:14px;background:#f5f5f5;color:#666;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f5f5f5'">
        إلغاء
      </button>
    </div>
  </div>
</div>

<!-- نظام الإشعارات -->
<div id="notificationContainer" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:100000;pointer-events:none;max-width:500px;width:90%;"></div>

<header id="mainHeader">
  <div class="container">
    <div class="nav">

      <!-- الشعار -->
      <div class="logo" onclick="go('home')">
        <div class="logo-circle">ج</div>
        <div style="font-size:22px;font-weight:800;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.2);">جمالك</div>
        <span class="logo-home-text" style="font-size:16px;font-weight:600;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.2);">الرئيسية</span>
        <span class="logo-back-arrow" onclick="event.stopPropagation(); closeMobileSearch();" style="display:none;font-size:12px;color:#fff;cursor:pointer;margin-right:4px;">←</span>
      </div>

      <!-- البحث -->
      <div class="header-search-wrapper" style="flex:1;display:flex;justify-content:center;">
        <!-- زر البحث للجوال فقط -->
        <button class="mobile-search-icon-btn" onclick="toggleMobileSearch()" id="mobileSearchBtn">🔍</button>
        
        <!-- حاوية البحث للجوال -->
        <div class="mobile-search-container" id="mobileSearchContainer" style="position:relative;width:100%;max-width:400px;">
          <!-- Hidden inputs لإرباك المتصفح ومنع اعتبار البحث حقل كلمة مرور -->
          <input type="text" style="display:none;position:absolute;left:-9999px;" tabindex="-1" autocomplete="off" aria-hidden="true">
          <input type="password" style="display:none;position:absolute;left:-9999px;" tabindex="-1" autocomplete="off" aria-hidden="true">
          <form autocomplete="off" onsubmit="return false;" style="display:contents;">
            <input 
              id="headerSearchMobile"
              oninput="headerLiveSearch()"
              onkeydown="if(event.key === 'Enter') { event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); const input = document.getElementById('headerSearchMobile'); if(input) { input.setAttribute('readonly', 'readonly'); input.setAttribute('type', 'text'); input.setAttribute('name', 'search-query-' + Date.now()); input.blur(); } closeHeaderSearchResults(); closeMobileSearch(); setTimeout(() => { goToSearchPage(); }, 100); return false; }"
              onkeypress="if(event.key === 'Enter') { event.preventDefault(); event.stopPropagation(); return false; }"
              onsubmit="return false;"
              placeholder="ابحث عن منتج…" 
              class="header-search-input"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              type="text"
              inputmode="search"
              name="search-query"
              role="searchbox"
              aria-label="بحث عن منتج"
              data-lpignore="true"
              data-form-type="other"
              data-1p-ignore="true"
              data-bwignore="true"
              data-savepassword="false"
              readonly
              onfocus="this.removeAttribute('readonly');"
              tabindex="0"
            />
          </form>
          <span class="header-search-icon">🔍</span>
          <button type="button" class="mobile-search-close" onclick="closeMobileSearch()">✕</button>
          <div id="headerSearchResultsMobile" class="header-search-results"></div>
        </div>
        
        <!-- حقل البحث للكمبيوتر -->
        <div class="desktop-search-container" style="position:relative;width:100%;max-width:400px;">
          <form autocomplete="off" onsubmit="return false;" style="display:contents;">
            <input 
              id="headerSearch"
              oninput="headerLiveSearch()"
              onkeypress="if(event.key === 'Enter') { event.preventDefault(); closeHeaderSearchResults(); goToSearchPage(); }"
              placeholder="ابحث عن منتج…" 
              class="header-search-input"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              type="search"
              name="search-query"
              role="searchbox"
              aria-label="بحث عن منتج"
              data-lpignore="true"
              data-form-type="other"
            />
          </form>
          <span class="header-search-icon">🔍</span>
          <div id="headerSearchResults" class="header-search-results"></div>
        </div>
      </div>

      <!-- روابط (للكمبيوتر) -->
      <div class="nav-links">
        <a href="#" data-page="home" onclick="go('home'); return false;">الرئيسية</a>
        <a href="#" data-page="products" onclick="go('products'); return false;">المنتجات</a>
        <a href="#" data-page="brands" onclick="go('brands'); return false;">الماركات</a>
        <a href="#" data-page="profile" id="profileLink" onclick="go('profile'); return false;" class="profile-link-header">
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">حسابي</span>
        </a>
        <a href="#" data-page="offers" onclick="go('offers'); return false;">العروض</a>
        <a href="#" data-page="categories" onclick="go('categories'); return false;">التصنيفات</a>
        <a href="#" data-page="wishlist" onclick="go('wishlist'); return false;" class="wishlist-link">
          <span id="wishlistIcon" style="display:inline-flex;align-items:center;justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter:drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
          </span>
          <span id="wishlistCount" class="wishlist-count">0</span>
        </a>
      </div>

      <!-- أيقونة السلة -->
      <div onclick="openCart()" class="cart-icon-wrapper">
        <span class="cart-icon" style="display:inline-flex;align-items:center;justify-content:center;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
            <path d="M2.23737 2.28845C1.84442 2.15746 1.41968 2.36983 1.28869 2.76279C1.15771 3.15575 1.37008 3.58049 1.76303 3.71147L2.02794 3.79978C2.70435 4.02524 3.15155 4.17551 3.481 4.32877C3.79296 4.47389 3.92784 4.59069 4.01426 4.71059C4.10068 4.83049 4.16883 4.99538 4.20785 5.33722C4.24907 5.69823 4.2502 6.17 4.2502 6.883L4.2502 9.55484C4.25018 10.9224 4.25017 12.0247 4.36673 12.8917C4.48774 13.7918 4.74664 14.5497 5.34855 15.1516C5.95047 15.7535 6.70834 16.0124 7.60845 16.1334C8.47542 16.25 9.57773 16.25 10.9453 16.25H18.0002C18.4144 16.25 18.7502 15.9142 18.7502 15.5C18.7502 15.0857 18.4144 14.75 18.0002 14.75H11.0002C9.56479 14.75 8.56367 14.7484 7.80832 14.6468C7.07455 14.5482 6.68598 14.3677 6.40921 14.091C6.17403 13.8558 6.00839 13.5398 5.9034 13H16.0222C16.9817 13 17.4614 13 17.8371 12.7522C18.2128 12.5045 18.4017 12.0636 18.7797 11.1817L19.2082 10.1817C20.0177 8.2929 20.4225 7.34849 19.9779 6.67422C19.5333 5.99996 18.5058 5.99996 16.4508 5.99996H5.74526C5.73936 5.69227 5.72644 5.41467 5.69817 5.16708C5.64282 4.68226 5.52222 4.2374 5.23112 3.83352C4.94002 3.42965 4.55613 3.17456 4.1137 2.96873C3.69746 2.7751 3.16814 2.59868 2.54176 2.38991L2.23737 2.28845Z" fill="#ffffff"></path>
            <path d="M7.5 18C8.32843 18 9 18.6716 9 19.5C9 20.3284 8.32843 21 7.5 21C6.67157 21 6 20.3284 6 19.5C6 18.6716 6.67157 18 7.5 18Z" fill="#ffffff"></path>
            <path d="M16.5 18.0001C17.3284 18.0001 18 18.6716 18 19.5001C18 20.3285 17.3284 21.0001 16.5 21.0001C15.6716 21.0001 15 20.3285 15 19.5001C15 18.6716 15.6716 18.0001 16.5 18.0001Z" fill="#ffffff"></path>
          </svg>
        </span>
        <span id="cartCount" class="cart-count"></span>
      </div>

      <!-- زر القائمة للجوال -->
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>

    </div>

    <!-- القائمة المنسدلة للجوال -->
    <div id="mobileMenu" class="mobile-menu">
      <a href="#" data-page="home" onclick="go('home'); toggleMobileMenu(); return false;">🏠 الرئيسية</a>
      <a href="#" data-page="products" onclick="go('products'); toggleMobileMenu(); return false;">🛍️ المنتجات</a>
      <a href="#" data-page="brands" onclick="go('brands'); toggleMobileMenu(); return false;">🏷️ الماركات</a>
      <a href="#" data-page="profile" id="mobileProfileLink" onclick="go('profile'); toggleMobileMenu(); return false;" class="mobile-profile-link-header">
        <span class="mobile-profile-icon">👤</span>
        <span class="mobile-profile-name">حسابي</span>
      </a>
      <a href="#" data-page="offers" onclick="go('offers'); toggleMobileMenu(); return false;">🎁 العروض</a>
      <a href="#" data-page="categories" onclick="go('categories'); toggleMobileMenu(); return false;">📂 التصنيفات</a>
      <a href="#" data-page="wishlist" onclick="go('wishlist'); toggleMobileMenu(); return false;" class="wishlist-link">
        <span id="wishlistIconMobile" style="display:inline-flex;align-items:center;justify-content:center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter:drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </span>
        <span id="wishlistCountMobile" class="wishlist-count">0</span>
      </a>
    </div>

  </div>
  <!-- شريط التقدم -->
  <div id="pageProgressBar" class="page-progress-bar"></div>
</header>

<!-- ========================= قسم التصنيفات ========================= -->
<div class="categories-bar">
  <div class="container">
    <div class="categories">
      <div class="cat" onclick="go('products')">عناية بالبشرة</div>
      <div class="cat" onclick="go('products')">مكياج الوجه</div>
      <div class="cat" onclick="go('products')">مكياج العيون</div>
      <div class="cat" onclick="go('products')">الشفاه</div>
      <div class="cat" onclick="go('products')">العطور</div>
      <div class="cat" onclick="go('products')">العناية الشخصية</div>
      <div class="cat" onclick="go('products')">العروض</div>
    </div>
  </div>
</div>

<!-- ========================= السلة الجانبية (ثابتة) ========================= -->
<!-- خلفية سوداء -->
<div id="cartOverlay" onclick="closeCart()" style="display:none;"></div>
<!-- لوحة السلة -->
<div id="cartPanel">
  <h2 style="color:#8a004a;margin-bottom:10px;">🛒 سلة المشتريات</h2>
  <!-- العناصر -->
  <div id="cartItems" style="flex:1;overflow-y:auto;margin-bottom:10px;"></div>
  <!-- الإجمالي -->
  <div style="font-size:20px;font-weight:800;margin:20px 0;padding:15px;background:linear-gradient(135deg, #fce4ef 0%, #ffeef5 100%);border-radius:12px;color:#8a004a;text-align:center;border:2px solid #f2bfd7;">
    الإجمالي: <span id="cartTotal" style="color:#E91E63;">0</span> ر.س
  </div>
  <!-- أزرار السلة -->
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
    <button onclick="goToCheckout()" style="background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:700;box-shadow:0 4px 12px rgba(233, 30, 99, 0.3);transition:all 0.3s ease;cursor:pointer;">
      إتمام الطلب
    </button>
    <button onclick="closeCart()" style="background:#f5f5f5;color:#666;width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;transition:all 0.3s ease;cursor:pointer;">
      متابعة التسوق
    </button>
  </div>
</div>

<!-- ========================= نظام الصفحات SPA ========================= -->

<div id="app">
<!-- الصفحة الرئيسية -->
<section id="homePage" class="page">
  <!-- سلايدر البانر الثابت (خارج الـ container ليكون fullscreen) -->
  <div id="mainSlider" class="main-slider-fullscreen"></div>
  
  <div class="container">
    <!-- بانرات فوق الماركات -->
    <div id="bannersAboveBrands" class="banner-section" style="margin-bottom:30px;"></div>
    <!-- الماركات -->
    <h2 class="section-title-centered">أشهر الماركات ⭐</h2>
    <div class="brands-wrapper">
      <button class="brand-arrow left" onclick="scrollBrands(-300)">‹</button>
      <div id="brandsSlider" class="brands-slider"></div>
      <button class="brand-arrow right" onclick="scrollBrands(300)">›</button>
    </div>
    <!-- بانرات فوق المنتجات المميزة -->
    <div id="bannersAboveFeatured" class="banner-section" style="margin-bottom:30px;"></div>
    <!-- منتجات مميزة -->
    <h2 class="section-title-with-line">منتجات مختارة ✨</h2>
    <div id="featuredGrid" class="products-grid"></div>
    <!-- بانرات فوق العروض -->
    <div id="bannersAboveOffers" class="banner-section" style="margin-bottom:30px;"></div>
    <!-- عروض -->
    <h2 class="section-title-with-line">عروض خاصة 💗</h2>
    <div id="discountGrid" class="products-grid"></div>
  </div>
</section>

<!-- صفحة البحث -->
<section id="page-search" class="page">
  <div class="container">
    <div class="search-page-header">
      <h2 class="search-page-title">🔍 نتائج البحث</h2>
      <div class="search-page-input-wrapper">
        <input 
          type="text" 
          id="searchPageInput" 
          class="search-page-input" 
          placeholder="ابحث عن منتج..."
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
          onkeypress="if(event.key === 'Enter') { event.preventDefault(); performSearch(); }"
        />
        <button type="button" onclick="performSearch()" class="search-page-btn">بحث</button>
      </div>
      <div id="searchResultsCount" class="search-results-count"></div>
    </div>
    <div id="searchResultsGrid" class="products-grid"></div>
    <div id="searchResultsPagination" class="pagination-container"></div>
    <div id="searchNoResults" class="search-no-results" style="display:none;">
      <div class="no-results-icon">🔍</div>
      <h3>لم يتم العثور على نتائج</h3>
      <p>جرب البحث بكلمات مختلفة أو تحقق من الإملاء</p>
    </div>
  </div>
</section>

<!-- صفحة المفضّلات -->
<section id="page-wishlist" class="page">
  <div class="container">
    <h2 class="section-title">المفضّلات ❤️</h2>
    <div id="wishlistContainer">
      <div id="wishlistGrid" class="products-grid"></div>
    </div>
    <div id="wishlistPagination" class="pagination-container"></div>
  </div>
</section>

<!-- صفحة المحتوى القانوني -->
<section id="page-page" class="page">
  <div class="container" style="max-width:900px;margin:0 auto;padding:40px 20px;">
    <div id="pageContentContainer" style="background:#fff;padding:40px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);line-height:1.8;">
      <h1 id="pageContentTitle" style="color:#8a004a;margin-bottom:30px;font-size:32px;font-weight:700;"></h1>
      <div id="pageContentBody" style="color:#555;font-size:16px;"></div>
    </div>
  </div>
</section>

  <!-- كل المنتجات -->
<section id="page-products" class="page">

  <div class="container">

    <h2 class="section-title">كل المنتجات</h2>

    <!-- مربع البحث -->
    <input id="productsSearch"
           placeholder="ابحث عن منتج…"
           style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:15px;"
           oninput="filterProducts()"
           autocomplete="off"
           autocorrect="off"
           autocapitalize="off"
           spellcheck="false"
           type="search"
           name="product-search"
           data-lpignore="true">

    <!-- شريط التصفية -->
    <div id="productsPageContainer">
      <div id="productsPageGrid" class="products-grid"></div>
    </div>

    <!-- Pagination Bar -->
    <div id="productsPagination" class="pagination-container"></div>

  </div>

</section>


  <!-- تفاصيل المنتج -->
<section id="page-product" class="page">

  <div class="container" id="productDetailsBox" style="min-height:400px;padding:20px;">

    <!-- سيضاف ديناميكياً -->

  </div>

</section>


  <!-- الماركات -->
  <section id="page-brands" class="page">
  <div class="container">

    <h2 class="section-title">الماركات</h2>

    <div id="brandsGrid" 
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;">
    </div>

  </div>
</section>


  <!-- منتجات الماركة -->
<section id="page-brand" class="page">
  <div class="container">
    <h2 class="section-title" id="brandTitle">منتجات الماركة</h2>
    <div id="brandProductsContainer">
      <div id="brandProductsGrid" class="products-grid"></div>
    </div>
    <div id="brandProductsPagination" class="pagination-container"></div>
  </div>
</section>


  <!-- السلة / الدفع -->
<section id="page-checkout" class="page">
  <div class="checkout-container">
    <div class="checkout-card">
      <div class="checkout-header">
        <div class="checkout-icon">🛒</div>
        <h2 class="checkout-title">إتمام الطلب</h2>
        <p class="checkout-subtitle">تأكد من صحة بياناتك قبل إتمام الطلب</p>
      </div>

    <!-- بيانات العميل -->
      <div class="checkout-section">
        <h3 class="section-title-small">بيانات العميل</h3>

        <div class="input-group">
          <label class="input-label">اسم العميل</label>
          <input id="co_name" class="modern-input checkout-readonly" readonly placeholder="سيتم ملؤه تلقائياً عند تسجيل الدخول">
        </div>

        <div class="input-group">
          <label class="input-label">رقم الهاتف</label>
          <input id="co_phone" class="modern-input checkout-readonly" readonly placeholder="سيتم ملؤه تلقائياً عند تسجيل الدخول">
        </div>

        <div class="input-group">
          <label class="input-label">رقم آخر للتواصل (اختياري)</label>
          <input id="co_phone2" class="modern-input" type="tel" placeholder="أدخل رقم هاتف آخر">
        </div>

        <div class="input-group">
          <label class="input-label">العنوان</label>
          <input id="co_address" class="modern-input" placeholder="أدخل عنوان التوصيل">
        </div>

        <div class="input-group">
          <label class="input-label">تحديد الموقع الجغرافي</label>
          <button onclick="pickLocation()" class="modern-btn-location">
            <span class="btn-icon">📍</span>
            <span>تحديد الموقع</span>
      </button>
          <input id="co_location" class="modern-input" readonly placeholder="لم يتم اختيار موقع بعد">
          <small class="location-hint">اضغط على الزر أعلاه لتحديد موقعك الجغرافي</small>
        </div>

        <div class="input-group">
          <label class="input-label">ملاحظات إضافية (اختياري)</label>
          <textarea id="co_notes" class="modern-input" style="height:100px;resize:vertical;" placeholder="أضف أي ملاحظات أو تعليمات خاصة للتوصيل"></textarea>
        </div>
    </div>

    <!-- كوبون الخصم -->
      <div class="checkout-section">
        <h3 class="section-title-small">🎟️ كوبون الخصم</h3>
        <div class="input-group" style="display:flex;gap:10px;align-items:flex-end;">
          <div style="flex:1;">
            <input id="couponCodeInput" class="modern-input" placeholder="أدخل كود الخصم" style="text-transform:uppercase;">
            <div style="margin-top:8px;padding:12px;background:#fff3cd;border:1px solid #ffc107;border-radius:8px;font-size:13px;color:#856404;line-height:1.6;">
              <strong>📌 ملاحظة:</strong> يمكن استخدام كوبون الخصم <strong>مرة واحدة فقط</strong> لكل عميل. إذا كنت قد استخدمت كوبون خصم مسبقاً، لن تتمكن من استخدام كوبون آخر.
            </div>
            <div id="couponMessage" style="margin-top:8px;font-size:14px;"></div>
          </div>
          <button onclick="applyCoupon()" class="modern-btn-primary" style="padding:12px 24px;white-space:nowrap;">
            تطبيق
          </button>
        </div>
    </div>

    <!-- المنتجات + الفاتورة داخل نفس الكرت -->
      <div class="checkout-section" id="checkoutItems"></div>

    <!-- الأزرار -->
      <div class="checkout-actions">
        <button onclick="sendWhatsAppOrder()" class="modern-btn-primary">
          <span>إتمام الطلب عبر واتساب</span>
          <span class="btn-arrow">←</span>
    </button>

        <button onclick="payOnline()" class="modern-btn-secondary checkout-btn-blue">
      الدفع الإلكتروني
    </button>

        <button onclick="go('home')" class="modern-btn-back">
      ◀ متابعة التسوق
    </button>
      </div>
    </div>
  </div>
</section>


<section id="page-track" class="page">

  <div class="track-container">

    <div class="track-title">تتبع الطلب</div>

    <div class="track-info" id="trackInfo">تحميل البيانات...</div>

    <div class="timeline" id="timeline"></div>

    <div class="items-title">الأصناف</div>
    <div id="trackItems"></div>

  </div>

</section>


<!-- صفحة الدفع -->
<section id="page-payment" class="page">
  <div class="payment-container">
    <!-- المحتوى الرئيسي -->
    <div class="payment-main-content">
      <div class="payment-left-panel">
        <!-- معلومات الدفع -->
        <div class="payment-info-card">
          <div class="payment-info-box">
            <span class="payment-info-icon">ℹ️</span>
            <span>سيتم شحن المبلغ إلى محفظتك عبر دافع</span>
          </div>
          
          <div class="payment-total-box">
            <div class="payment-total-label">
              <span class="payment-wallet-icon">💳</span>
              <span>المبلغ الإجمالي</span>
            </div>
            <div class="payment-total-amount" id="paymentTotalAmount">0 ر.س</div>
          </div>

          <div class="payment-methods-label">طرق الدفع المقبولة</div>
          <div class="payment-methods-logos">
            <div class="payment-logo-card">Mastercard</div>
            <div class="payment-logo-visa">VISA</div>
          </div>
        </div>
      </div>

      <div class="payment-right-panel">
        <div class="payment-form-card">
          <h1 class="payment-form-title">الدفع</h1>
          <p class="payment-form-subtitle">معالجة دفع آمنة وسريعة</p>

          <form id="paymentForm" class="payment-form">
            <div class="payment-input-group">
              <label class="payment-label">اسم حامل البطاقة</label>
              <input type="text" id="cardholderName" class="payment-input" placeholder="mohamed adel" value="mohamed adel">
            </div>

            <div class="payment-input-group">
              <label class="payment-label">رقم البطاقة</label>
              <input type="text" id="cardNumber" class="payment-input" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
            </div>

            <div class="payment-row">
              <div class="payment-input-group payment-input-half">
                <label class="payment-label">CVV</label>
                <input type="text" id="cardCVV" class="payment-input" placeholder="..." maxlength="4">
              </div>

              <div class="payment-input-group payment-input-half">
                <label class="payment-label">تاريخ انتهاء الصلاحية</label>
                <div class="payment-date-inputs">
                  <input type="text" id="cardMonth" class="payment-input payment-input-small" placeholder="شهر" maxlength="2">
                  <input type="text" id="cardYear" class="payment-input payment-input-small" placeholder="سنة" maxlength="4">
                </div>
              </div>
            </div>

            <button type="submit" class="payment-submit-btn">
              <span>شحن →</span>
            </button>

            <div class="payment-divider">
              <span>أو ادفع بواسطة</span>
            </div>

            <button type="button" class="payment-apple-pay-btn" onclick="handleApplePay()">
              <span class="apple-logo">
                <svg fill="#ffffff" height="24px" width="24px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 22.773 22.773" xml:space="preserve" stroke="#ffffff">
                  <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                  <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                  <g id="SVGRepo_iconCarrier">
                    <g>
                      <g>
                        <path d="M15.769,0c0.053,0,0.106,0,0.162,0c0.13,1.606-0.483,2.806-1.228,3.675c-0.731,0.863-1.732,1.7-3.351,1.573 c-0.108-1.583,0.506-2.694,1.25-3.561C13.292,0.879,14.557,0.16,15.769,0z"></path>
                        <path d="M20.67,16.716c0,0.016,0,0.03,0,0.045c-0.455,1.378-1.104,2.559-1.896,3.655c-0.723,0.995-1.609,2.334-3.191,2.334 c-1.367,0-2.275-0.879-3.676-0.903c-1.482-0.024-2.297,0.735-3.652,0.926c-0.155,0-0.31,0-0.462,0 c-0.995-0.144-1.798-0.932-2.383-1.642c-1.725-2.098-3.058-4.808-3.306-8.276c0-0.34,0-0.679,0-1.019 c0.105-2.482,1.311-4.5,2.914-5.478c0.846-0.52,2.009-0.963,3.304-0.765c0.555,0.086,1.122,0.276,1.619,0.464 c0.471,0.181,1.06,0.502,1.618,0.485c0.378-0.011,0.754-0.208,1.135-0.347c1.116-0.403,2.21-0.865,3.652-0.648 c1.733,0.262,2.963,1.032,3.723,2.22c-1.466,0.933-2.625,2.339-2.427,4.74C17.818,14.688,19.086,15.964,20.67,16.716z"></path>
                      </g>
                    </g>
                  </g>
                </svg>
              </span>
              <span>Pay</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- الفوتر -->
    <footer class="payment-footer">
      <div class="payment-footer-logo">N</div>
      <div class="payment-footer-text">
        <span>تتم معالجة الدفع بواسطة moyaser لصالح دافع - المملكة العربية السعودية</span>
      </div>
    </footer>
  </div>
</section>


  <!-- فاتورة العميل-->
<section id="page-thanks" class="page">
  <div class="container" style="max-width:750px;margin:auto;padding:25px;">

    <h2 style="text-align:center;color:#8a004a;font-weight:900;">فاتورة الطلب</h2>

    <div id="invoiceBox" style="
      background:#fff;
      padding:20px;
      border-radius:15px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      margin-top:20px;
    ">
      <p style="text-align:center;color:#777;">جاري تحميل الفاتورة...</p>
    </div>

    <button onclick="printInvoice()" 
      style="display:block;width:100%;margin-top:25px;background:#8a004a;color:white;padding:12px;border:none;border-radius:10px;font-size:18px;">
      🖨 طباعة الفاتورة
    </button>

    <button onclick="go('home')" 
      style="display:block;width:100%;margin-top:15px;background:#E91E63;color:white;padding:12px;border:none;border-radius:10px;font-size:18px;">
      ◀ العودة للرئيسية
    </button>

  </div>
</section>








  <!-- صفحة تسجيل الدخول -->
  <section id="page-login" class="page">
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-icon">🔐</div>
        <h2 class="login-title">مرحباً بعودتك</h2>
        <p class="login-subtitle">سجل دخولك للوصول إلى حسابك</p>
      </div>

      <div class="login-form">
        <div class="input-group">
          <label class="input-label">📱 رقم الجوال</label>
          <input id="loginPhone" 
                 type="tel"
                 placeholder="5xxxxxxxx"
                 class="modern-input"
                 autocomplete="tel">
        </div>

        <div class="input-group">
          <label class="input-label">🔒 كلمة المرور</label>
          <input id="loginPass" 
                 type="password" 
                 placeholder="أدخل كلمة المرور"
                 class="modern-input"
                 autocomplete="current-password">
        </div>

        <div class="forgot-link">
          <a href="#" onclick="go('forgot'); return false;">نسيت كلمة المرور؟</a>
        </div>

        <button onclick="doLogin()" class="modern-btn-primary">
          <span>دخول</span>
          <span class="btn-arrow">→</span>
        </button>

        <div id="loginMsg" class="error-message"></div>

        <div class="login-divider">
          <span>أو</span>
        </div>

        <button onclick="go('register')" class="modern-btn-secondary">
          إنشاء حساب جديد
        </button>
      </div>
    </div>
  </div>
</section>
<!-- صفحة نسيان كلمة المرور -->
<section id="page-forgot" class="page">
  <div style="max-width:400px;margin:auto;padding:25px;">
    <h2 class="section-title">استعادة كلمة المرور</h2>

    <label>البريد الإلكتروني</label>
    <input id="fpEmail" type="email"
           placeholder="example@gmail.com"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <button onclick="sendResetCode()"
            style="background:#8a004a;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;">
      إرسال كود الاستعادة
    </button>

    <div id="fpMsg" style="margin-top:15px;color:red;text-align:center;"></div>

    <p style="margin-top:15px;text-align:center;">
      <a href="#" onclick="go('login'); return false;" style="color:#E91E63;">العودة لتسجيل الدخول</a>
    </p>
  </div>
</section>
<!-- صفحة إعادة ضبط كلمة المرور -->
<section id="page-reset" class="page">
  <div style="max-width:400px;margin:auto;padding:25px;">

    <h2 class="section-title">إعادة تعيين كلمة المرور</h2>

    <label>البريد الإلكتروني</label>
    <input id="rpEmail" type="email"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <label>كود التحقق</label>
    <input id="rpCode" 
           placeholder="XXXXXX"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <label>كلمة مرور جديدة</label>
    <input id="rpPass" type="password"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <button onclick="resetPassword()"
            style="background:#8a004a;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;">
      حفظ كلمة المرور الجديدة
    </button>

    <div id="rpMsg" style="margin-top:15px;color:red;text-align:center;"></div>

  </div>
</section>
<!-- صفحة تفعيل الحساب -->
<section id="page-verify" class="page">
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <div class="register-icon">🔐</div>
        <h2 class="register-title">تفعيل الحساب</h2>
        <p class="register-subtitle">أدخل كود التفعيل الذي أرسلناه إلى بريدك الإلكتروني</p>
      </div>

      <div class="register-form">
        <div class="input-group">
          <label class="input-label">📱 رقم الجوال</label>
          <div class="phone-input-group">
            <span class="phone-prefix">🇸🇦 +966</span>
    <input id="vPhone"
                   type="tel"
           readonly
                   class="modern-input phone-input"
                   style="background: #f0f0f0; cursor: not-allowed;">
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">🔑 كود التفعيل</label>
          <input id="vCode" 
                 type="text"
                 inputmode="numeric"
                 pattern="[0-9]*"
                 placeholder="أدخل الكود المكون من 6 أرقام"
                 class="modern-input"
                 maxlength="6"
                 style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 700;"
                 onkeypress="return /[0-9]/i.test(event.key)"
                 oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>

        <button onclick="verifyAccount()" class="modern-btn-primary">
          <span>تفعيل الحساب</span>
          <span class="btn-arrow">→</span>
    </button>

        <div id="verifyMsg" class="error-message"></div>

        <div class="register-footer" style="text-align: center; margin-top: 20px;">
          <div style="padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 15px;">
            <span id="resendBox" style="display: inline-block;">
              <a href="#" onclick="resendVerifyCode(); return false;" class="link-primary" style="font-weight: 600;">
                🔄 إعادة إرسال الكود
              </a>
      </span>
            <span id="timerBox" style="display: none; color: #666; font-size: 14px;">
              ⏱️ إعادة الإرسال متاحة خلال <span id="timer" style="font-weight: 700; color: #E91E63;">60</span> ثانية
      </span>
          </div>
          <p style="margin: 0; color: #666; font-size: 14px;">
            لم تستلم الكود؟ تحقق من صندوق الوارد والرسائل غير المرغوب فيها
    </p>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- صفحة إنشاء حساب جديد -->
<!-- صفحة إنشاء حساب جديد -->
<section id="page-register" class="page">
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <div class="register-icon">✨</div>
        <h2 class="register-title">إنشاء حساب جديد</h2>
        <p class="register-subtitle">انضم إلينا وابدأ رحلتك معنا</p>
      </div>

      <div class="register-form">
        <div class="input-group">
          <label class="input-label">👤 الاسم الكامل</label>
          <input id="regName" 
                 type="text"
                 placeholder="أدخل الاسم الكامل"
                 class="modern-input"
                 autocomplete="name">
        </div>

        <div class="input-group">
          <label class="input-label">📱 رقم الجوال</label>
          <div class="phone-input-group">
            <span class="phone-prefix">🇸🇦 +966</span>
            <input id="regPhone" 
                   type="tel"
                   placeholder="05xxxxxxxx أو 5xxxxxxxx"
                   class="modern-input phone-input"
                   autocomplete="tel">
            <span id="regPhoneIcon" class="validation-icon"></span>
          </div>
          <div id="regPhoneMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">📧 البريد الإلكتروني</label>
          <div class="input-with-icon">
          <input id="regEmail" 
                 type="email"
                 placeholder="example@gmail.com"
                 class="modern-input"
                 autocomplete="email">
            <span id="regEmailIcon" class="validation-icon"></span>
          </div>
          <div id="regEmailMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">🔒 كلمة المرور</label>
          <div class="input-with-icon">
          <input id="regPass" 
                 type="password"
                 placeholder="••••••••"
                 class="modern-input"
                 autocomplete="new-password">
            <span id="regPassIcon" class="validation-icon"></span>
          </div>
          <div id="regPassStrength" class="password-strength"></div>
          <div id="regPassMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">🔒 إعادة كلمة المرور</label>
          <input id="regPass2" 
                 type="password"
                 placeholder="أعد إدخال كلمة المرور"
                 class="modern-input"
                 autocomplete="new-password">
        </div>

        <div class="input-group">
          <label class="input-label">📍 العنوان التفصيلي</label>
          <input id="regAddress" 
                 type="text"
                 placeholder="مثال: جدة - حي الحمدانية - شارع سعيد"
                 class="modern-input"
                 autocomplete="street-address">
        </div>

        <button onclick="doRegister()" class="modern-btn-primary">
          <span>إنشاء الحساب</span>
          <span class="btn-arrow">→</span>
        </button>

        <div id="registerMsg" class="error-message"></div>

        <div class="register-footer">
          <p>لديك حساب بالفعل؟ 
            <a href="#" onclick="go('login'); return false;" class="link-primary">تسجيل الدخول</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>





  <!-- صفحة حساب المستخدم -->
  <section id="page-profile" class="page">
  <div class="container" style="max-width:900px;margin:0 auto;padding:30px 20px;">
    
    <!-- بطاقة المستخدم -->
    <div style="background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);padding:40px;border-radius:16px;color:#fff;margin-bottom:30px;box-shadow:0 8px 24px rgba(138,0,74,0.3);">
      <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
        <div style="width:100px;height:100px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;backdrop-filter:blur(10px);">
          👤
        </div>
        <div style="flex:1;">
          <h2 id="pName" style="font-size:28px;margin-bottom:10px;font-weight:700;">—</h2>
          <p id="pPhone" style="font-size:16px;opacity:0.9;margin:5px 0;">—</p>
          <p id="pEmail" style="font-size:16px;opacity:0.9;margin:5px 0;">—</p>
          <p id="pAddress" style="font-size:16px;opacity:0.9;margin:5px 0;">—</p>
        </div>
    </div>
  </div>

    <!-- الأزرار -->
    <div style="display:flex;gap:15px;margin-bottom:30px;flex-wrap:wrap;">
      <button onclick="showChangePasswordModal()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(6,95,106,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(6,95,106,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(6,95,106,0.3)'">
        🔒 تغيير كلمة المرور
      </button>
      <button onclick="openSupportChat()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(138,0,74,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(138,0,74,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(138,0,74,0.3)'">
        💬 الدعم الفني
      </button>
      <button onclick="logoutUser()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #d62828 0%, #b71c1c 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(214,40,40,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(214,40,40,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(214,40,40,0.3)'">
        🚪 تسجيل الخروج
      </button>
    </div>

    <!-- الطلبات -->
    <h2 class="section-title" style="margin-bottom:20px;">📦 طلباتي</h2>
  <div id="profileOrders"></div>

  </div>

  <!-- نافذة تغيير كلمة المرور -->
  <div id="changePasswordModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;justify-content:center;align-items:center;">
    <div style="background:#fff;padding:40px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h3 style="color:#8a004a;margin-bottom:25px;font-size:24px;font-weight:700;text-align:center;">🔒 تغيير كلمة المرور</h3>
      
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">كلمة المرور الحالية:</label>
        <input type="password" id="currentPassword" placeholder="أدخل كلمة المرور الحالية" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
</div>

      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">كلمة المرور الجديدة:</label>
        <input type="password" id="newPassword" placeholder="أدخل كلمة المرور الجديدة" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
      </div>

      <div style="margin-bottom:25px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">تأكيد كلمة المرور الجديدة:</label>
        <input type="password" id="confirmPassword" placeholder="أعد إدخال كلمة المرور الجديدة" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
      </div>

      <div id="changePasswordMsg" style="margin-bottom:20px;color:#e74c3c;font-size:14px;text-align:center;"></div>

      <div style="display:flex;gap:12px;">
        <button onclick="changePassword()" style="flex:1;padding:12px;background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">تغيير</button>
        <button onclick="hideChangePasswordModal()" style="flex:1;padding:12px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- نافذة شات الدعم -->
  <div id="supportChatModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;justify-content:center;align-items:center;">
    <div style="background:#fff;border-radius:16px;max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <div style="background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);color:#fff;padding:20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;font-size:20px;font-weight:700;">💬 الدعم الفني</h3>
        <button onclick="closeSupportChat()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;">×</button>
      </div>
      <div id="supportChatMessages" style="flex:1;padding:20px;overflow-y:auto;min-height:300px;max-height:400px;background:#f8f9fa;">
        <div style="text-align:center;color:#999;padding:20px;">جاري التحميل...</div>
      </div>
      <div id="supportChatInputArea" style="padding:15px;border-top:2px solid #e0e0e0;display:flex;gap:10px;">
        <input type="text" id="supportChatInput" placeholder="اكتب رسالتك هنا..." style="flex:1;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;" onkeypress="if(event.key==='Enter') sendSupportMessage()">
        <button onclick="sendSupportMessage()" style="padding:12px 20px;background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">إرسال</button>
      </div>
    </div>
  </div>
</section>

<!-- Modal تسجيل الدخول -->
<div id="loginRequiredModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;justify-content:center;align-items:center;backdrop-filter:blur(4px);">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:450px;width:90%;box-shadow:0 12px 48px rgba(0,0,0,0.3);text-align:center;animation:modalSlideIn 0.3s ease-out;">
    <div style="font-size:64px;margin-bottom:20px;">🔐</div>
    <h3 style="color:#8a004a;margin-bottom:15px;font-size:24px;font-weight:800;">تسجيل الدخول مطلوب</h3>
    <p style="color:#666;margin-bottom:30px;font-size:16px;line-height:1.6;">
      لابد من تسجيل دخول قبل إتمام الطلب<br>
      <span style="color:#999;font-size:14px;">سجل دخولك الآن للمتابعة</span>
    </p>
    
    <div style="display:flex;gap:12px;flex-direction:column;">
      <button onclick="goToLoginFromModal()" style="width:100%;padding:16px;background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(233, 30, 99, 0.4);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(233, 30, 99, 0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(233, 30, 99, 0.4)'">
        تسجيل الدخول الآن
      </button>
      <button onclick="closeLoginRequiredModal()" style="width:100%;padding:14px;background:#f5f5f5;color:#666;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f5f5f5'">
        إلغاء
      </button>
    </div>
  </div>
</div>

<!-- صفحة العروض -->
<section id="page-offers" class="page">
  <div class="container">
    <h2 class="section-title">💗 عروض خاصة</h2>
    <div id="offersContainer">
      <div id="offersGrid" class="products-grid"></div>
    </div>
    <div id="offersPagination" class="pagination-container"></div>
  </div>
</section>

<!-- صفحة التصنيفات -->
<section id="page-categories" class="page">
  <div class="container">

    <h2 class="section-title">التصنيفات</h2>

    <div id="categoriesList" 
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;">
    </div>

  </div>
</section>
<!-- صفحة منتجات التصنيف -->
<section id="page-category" class="page">
  <div class="container">

    <h2 class="section-title" id="categoryTitle"></h2>
    <div id="categoryContainer">
      <div id="categoryGrid" class="products-grid"></div>
    </div>
    <div id="categoryPagination" class="pagination-container"></div>

  </div>
</section>

</div>


<!-- ========================= الفوتر ========================= -->
<footer class="footer" id="mainFooter">
  <div class="footer-container">

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">روابط سريعة</h3>
      <p><a href="#" onclick="go('home'); return false;">الرئيسية</a></p>
      <p><a href="#" onclick="go('products'); return false;">المنتجات</a></p>
      <p><a href="#" onclick="go('brands'); return false;">الماركات</a></p>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">معلومات قانونية</h3>
      <p><a href="#" onclick="go('page', 'privacy'); return false;">📋 سياسة الاستخدام والخصوصية</a></p>
      <p><a href="#" onclick="go('page', 'return'); return false;">🔄 سياسة الاستبدال والارجاع</a></p>
      <p><a href="#" onclick="go('page', 'terms'); return false;">📜 الشروط والأحكام</a></p>
      <p><a href="#" onclick="go('page', 'faq'); return false;">❓ الأسئلة الشائعة</a></p>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">تواصل معنا</h3>
      <p>📞 055-555-5555</p>
      <p>📧 info@beauty.com</p>
      <div id="footerSocialMedia" style="margin-top:15px;display:flex;gap:12px;flex-wrap:wrap;">
        <!-- سيتم تحميل الأيقونات هنا -->
      </div>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">الدعم السريع</h3>
      <form id="quickSupportForm" onsubmit="submitComplaint(event)" style="display:flex;flex-direction:column;gap:6px;">
        <input type="email" id="complaintEmail" placeholder="📧 البريد الإلكتروني" required style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;font-family:'Cairo',sans-serif;">
        <input type="text" id="complaintSubject" placeholder="📝 عنوان الشكوى" required style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;font-family:'Cairo',sans-serif;">
        <textarea id="complaintMessage" placeholder="💬 محتوى الشكوى" required rows="3" style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;resize:vertical;font-family:'Cairo',sans-serif;"></textarea>
        <button type="submit" style="padding:8px;background:#8a004a;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;font-family:'Cairo',sans-serif;">إرسال</button>
      </form>
    </div>

  </div>

  <div class="footer-bottom">
    جميع الحقوق محفوظة © 2025 متجر جمالك
  </div>
</footer>



<!-- ========================= كود SPA Router ========================= -->

<script>
async function loadProductsCache(forceReload = false) {
  if (!window.productsCache || forceReload || window.productsCache.length === 0) {
    try {
    const res = await fetch(API + "/api/products");
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      const products = await res.json();
      
      if (!products || !Array.isArray(products)) {
        console.error("Invalid products data:", products);
        window.productsCache = [];
        return;
      }
    
      // التأكد من أن جميع المنتجات لديها stock و quantity وتطبيع مسارات الصور
      window.productsCache = products.map(p => {
        // تطبيع مسار الصورة إذا كان نسبياً
        let imageUrl = p.image_url;
        if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('data:')) {
          if (!imageUrl.startsWith('/')) {
            imageUrl = '/' + imageUrl;
          }
          if (imageUrl.startsWith('uploads/')) {
            imageUrl = '/' + imageUrl;
          }
        }
        
        return {
      ...p,
          image_url: imageUrl || p.image_url,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
        };
      });
      
      console.log(`تم تحميل ${window.productsCache.length} منتج`);
    } catch (error) {
      console.error("خطأ في تحميل المنتجات:", error);
      window.productsCache = [];
    }
  }
}

function safeImageURL(url) {
  // Default placeholder URL (using data URI as fallback to avoid network issues)
  const defaultPlaceholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Crect fill='%23ddd' width='300' height='300'/%3E%3Ctext fill='%23999' font-family='Arial' font-size='14' x='50%25' y='50%25' text-anchor='middle' dominant-baseline='middle'%3Eلا توجد صورة%3C/text%3E%3C/svg%3E";
  
  if (!url || typeof url !== 'string' || url.trim() === "" || url.length < 3) {
    return defaultPlaceholder;
  }

  url = url.trim();

  // Google Drive
  if (url.includes("drive.google.com")) {
    const id = url.match(/[-\w]{25,}/);
    if (id) {
      return `https://lh3.googleusercontent.com/d/${id[0]}`;
    }
    return defaultPlaceholder;
  }

  // Googleusercontent direct image
  if (url.includes("googleusercontent.com")) {
    return url;
  }

  // Full HTTP/HTTPS link
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }

  // Data URI
  if (url.startsWith("data:")) {
    return url;
  }

  // Relative path starting with /uploads (serve from backend)
  if (url.includes("uploads") || url.startsWith("/uploads/") || url.startsWith("uploads/")) {
    // Ensure it starts with /uploads/
    if (url.startsWith("/uploads/")) {
      return url;
    } else if (url.startsWith("uploads/")) {
      return "/" + url;
    } else {
      // If uploads is in the middle of the path
      return url.startsWith("/") ? url : "/" + url;
    }
  }

  // If it's not a valid link → return a placeholder
  return defaultPlaceholder;
}

// ===================== خاصية الزوم على صورة المنتج =====================
function openImageZoom(imageUrl) {
  // إنشاء overlay للزوم
  let overlay = document.getElementById("imageZoomOverlay");
  
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.id = "imageZoomOverlay";
    overlay.innerHTML = `<img id="zoomedImage" src="${imageUrl}" alt="صورة المنتج">`;
    document.body.appendChild(overlay);
    
    // إغلاق عند الضغط في أي مكان
    overlay.onclick = function(e) {
      if (e.target === overlay || e.target.id === "zoomedImage") {
        closeImageZoom();
      }
    };
    
    // إغلاق عند الضغط على ESC
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape" && overlay.style.display === "flex") {
        closeImageZoom();
      }
    });
  } else {
    document.getElementById("zoomedImage").src = imageUrl;
  }
  
  overlay.style.display = "flex";
  document.body.style.overflow = "hidden"; // منع التمرير
}

function closeImageZoom() {
  const overlay = document.getElementById("imageZoomOverlay");
  if (overlay) {
    overlay.style.display = "none";
    document.body.style.overflow = ""; // إعادة التمرير
  }
}



async function go(page, data = null, skipHistory = false) {
  // بدء شريط التقدم
  startPageProgress();
  
  // حفظ الصفحة الحالية قبل الانتقال (إلا إذا كان skipHistory = true)
  if(!skipHistory) {
    saveNavigationState(page, data);
    // إضافة حالة جديدة للـ history
    const state = { page, data };
    const url = data ? `#${page}/${data}` : `#${page}`;
    window.history.pushState(state, '', url);
  }
  
  // إخفاء جميع الصفحات
  document.querySelectorAll(".page").forEach(
    p => {
      p.classList.remove("active");
      // إزالة inline style لإفساح المجال للـ CSS
      p.style.removeProperty("display");
    }
  );

  // إظهار الصفحة المطلوبة
  let targetPage = null;
  
  // للصفحة الرئيسية، ابحث عن homePage أولاً
  // أيضاً تعامل مع "homePage" كـ "home" للتوافق
  if (page === "home" || page === "homePage") {
    targetPage = document.getElementById("homePage");
    if (!targetPage) {
      targetPage = document.getElementById("page-home");
    }
  } else {
    targetPage = document.getElementById("page-" + page);
  }
  
  if (targetPage) {
    targetPage.classList.add("active");
    // إزالة inline style إذا كان موجوداً لإفساح المجال للـ CSS
    targetPage.style.removeProperty("display");
    // للتأكد من أن homePage يظهر
    if ((page === "home" || page === "homePage") && targetPage.id === "homePage") {
      console.log("HomePage is now visible", targetPage);
    }
  } else {
    console.warn("Target page not found:", page);
  }

  // تحديث المؤشر النشط في القائمة
  document.querySelectorAll(".nav-links a, .mobile-menu a").forEach(link => {
    link.classList.remove("active");
    if(link.getAttribute("data-page") === page) {
      link.classList.add("active");
    }
  });
  
  // تهيئة التحقق الفوري عند فتح صفحة التسجيل
  if (page === "register") {
    setTimeout(initValidationListeners, 100);
  }

  // تحميل بيانات حسب الصفحة

  if (page === "home" || page === "homePage") {
    // مسح حقول البحث لمنع ملء رقم الهاتف تلقائياً
    const headerSearch = document.getElementById("headerSearch");
    const headerSearchMobile = document.getElementById("headerSearchMobile");
    if(headerSearch) headerSearch.value = "";
    if(headerSearchMobile) headerSearchMobile.value = "";
    
    if(typeof loadHome === 'function') {
      loadHome();
    }
    
    // تحميل شريط الكوبون في الصفحة الرئيسية بعد تأخير بسيط
    setTimeout(() => {
      loadCouponBanner();
    }, 300);
  } else {
    // إخفاء شريط الكوبون في الصفحات الأخرى
    const banner = document.getElementById("couponBanner");
    if (banner) banner.style.display = "none";
  }
  if (page === "products") {
    // التأكد من تحميل المنتجات أولاً
    if (!window.productsCache || window.productsCache.length === 0) {
      await loadProductsCache(true);
    }
    
    if(window.bannerProducts && window.bannerProducts.length > 0){
      // عرض منتجات البانر
      const productIds = window.bannerProducts;
      window.bannerProducts = null; // مسح بعد الاستخدام
      await loadAllProducts(productIds);
    } else {
      await loadAllProducts();
    }
  }
  if (page === "product") loadProductDetails(data);
  if (page === "brands") loadBrandsList();

  if (page === "brand") {
    window.currentBrand = data;
    loadBrandProducts(data);
  }

  if(page === "checkout") {
    renderCheckoutPage();
    autoFillUserInCheckout();   // ⭐ إضافة مهمة هنا
  }

  if(page === "payment") {
    loadPaymentPage();
  }

  if(page === "search") {
    // إخفاء نتائج البحث المنبثقة عند الانتقال لصفحة البحث
    closeHeaderSearchResults();
    
    // إغلاق البحث على الجوال
    if(window.innerWidth <= 768) {
      closeMobileSearch();
    }
    
    // إزالة التركيز من حقول البحث
    const desktopSearch = document.getElementById("headerSearch");
    const mobileSearch = document.getElementById("headerSearchMobile");
    if(desktopSearch) desktopSearch.blur();
    if(mobileSearch) mobileSearch.blur();
    
    // السماح بالتمرير
    document.body.style.overflow = "";
    
    loadSearchPage(data);
    
    // التأكد من إزالة التركيز بعد تحميل الصفحة
    setTimeout(() => {
      if(desktopSearch) desktopSearch.blur();
      if(mobileSearch) mobileSearch.blur();
      window.scrollTo(0, 0);
    }, 100);
  }
  
  // إكمال شريط التقدم بعد تحميل الصفحة
  setTimeout(() => {
    completePageProgress();
  }, 300);

  // ⭐ إصلاح track (مشروط بوجود الصفحة)
  if (page === "track" && document.getElementById("page-track")) {
  loadTrackPage(data);   // ← إرسال رقم الطلب
}


  // ⭐ إصلاح offers (مشروط بوجود الصفحة)
  if (page === "offers" && document.getElementById("page-offers")) {
    loadOffers();
  }

  if (page === "categories") loadCategories();

  if (page === "category") {
    window.currentCategory = data;
    loadCategoryProducts(data);
  }

  if (page === "thanks") {
    loadInvoice(data);   // ← هنا نحمّل الفاتورة
}


  if (page === "wishlist") loadWishlist();

  // ⭐ صفحة حسابي
  if (page === "profile" && typeof loadProfile === "function") {
    loadProfile();
  }

  // ⭐ صفحة المحتوى القانوني
  if (page === "page" && data) {
    loadPageContent(data);
  }

  // تحديث رابط الحساب في الهيدر عند التنقل
  updateHeaderProfile();
  updateWishlistCount();
  
  // تعيين المؤشر النشط للصفحة الحالية
  const activePage = document.querySelector(".page.active");
  if(activePage) {
    const pageId = activePage.id.replace("page-", "");
    document.querySelectorAll(".nav-links a, .mobile-menu a").forEach(link => {
      link.classList.remove("active");
      if(link.getAttribute("data-page") === pageId) {
        link.classList.add("active");
      }
    });
  }
  
  // إعادة التمرير إلى الأعلى عند فتح أي صفحة
  // استخدام setTimeout لضمان أن الصفحة قد تم عرضها أولاً
  setTimeout(() => {
    window.scrollTo(0, 0);
  }, 0);
}





// Load BASE_URL dynamically from server config
let API = "http://localhost:3000"; // fallback
(async function() {
  try {
    const response = await fetch("/api/config");
    const config = await response.json();
    if (config.baseUrl) {
      API = config.baseUrl;
    }
  } catch (error) {
    console.warn("Could not load BASE_URL from config, using fallback:", error);
  }
  window.API = API; // جعل API متاحاً في الوحدات الخارجية
})();
// تحميل المستخدم من التخزين المحلي بعد فتح الصفحة
window.user = JSON.parse(localStorage.getItem("user") || "null");

// ===================== نظام الإشعارات =====================
function showNotification(message, type = 'warning') {
  const container = document.getElementById("notificationContainer");
  if(!container) return;
  
  const notification = document.createElement("div");
  notification.style.cssText = `
    background: ${type === 'warning' ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : type === 'error' ? 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)' : 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)'};
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    margin-bottom: 12px;
    font-size: 15px;
    font-weight: 500;
    text-align: center;
    animation: slideDown 0.3s ease-out;
    pointer-events: auto;
    position: relative;
    backdrop-filter: blur(10px);
  `;
  
  notification.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      <span style="font-size:20px;">${type === 'warning' ? '⚠️' : type === 'error' ? '❌' : '✅'}</span>
      <span>${message}</span>
    </div>
  `;
  
  // إضافة animation
  if(!document.getElementById("notificationStyles")) {
    const style = document.createElement("style");
    style.id = "notificationStyles";
    style.textContent = `
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  container.appendChild(notification);
  
  // إزالة الإشعار بعد 4 ثواني
  setTimeout(() => {
    notification.style.animation = 'slideUp 0.3s ease-out';
    setTimeout(() => {
      if(notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 4000);
}

// ===================== نظام إدارة سجل التنقل =====================
window.navigationStack = [];

// حفظ الصفحة الحالية قبل الانتقال
function saveNavigationState(page, data = null) {
  const currentPage = document.querySelector(".page.active");
  if(currentPage) {
    // معالجة خاصة للصفحة الرئيسية
    let currentPageId = currentPage.id;
    if(currentPageId === "homePage") {
      currentPageId = "home";
    } else {
      currentPageId = currentPageId.replace("page-", "");
    }
    // فقط نضيف للستاك إذا كانت صفحة مختلفة
    if(currentPageId !== page) {
      // حفظ بيانات الصفحة الحالية إذا كانت مهمة (مثل رقم المنتج)
      let currentData = null;
      if(currentPageId === "product" && window.currentProductId) {
        currentData = window.currentProductId;
      } else if(currentPageId === "brand" && window.currentBrand) {
        currentData = window.currentBrand;
      } else if(currentPageId === "category" && window.currentCategory) {
        currentData = window.currentCategory;
      }
      
      window.navigationStack.push({ page: currentPageId, data: currentData });
      // الاحتفاظ بآخر 20 صفحة فقط
      if(window.navigationStack.length > 20) {
        window.navigationStack.shift();
      }
    }
  }
}

// الرجوع للصفحة السابقة
function goBackToPreviousPage() {
  if(window.navigationStack.length > 0) {
    const previous = window.navigationStack.pop();
    if(previous && previous.page) {
      go(previous.page, previous.data, true); // true = بدون حفظ في السجل
      return true;
    }
  }
  return false;
}

// الاستماع لحدث الرجوع في المتصفح
window.addEventListener('popstate', function(event) {
  if(window.navigationStack.length > 0) {
    const previous = window.navigationStack.pop();
    if(previous && previous.page) {
      go(previous.page, previous.data, true);
    } else {
      go('home', null, true);
    }
  } else {
    // إذا لم توجد صفحة سابقة، الرجوع للصفحة الرئيسية
    go('home', null, true);
  }
});


// ======================= دوال Skeleton Loading =======================
// دالة لإنشاء skeleton cards
function createSkeletonCards(count = 8) {
  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-text short"></div>
        <div class="skeleton-text medium"></div>
        <div class="skeleton-price"></div>
        <div class="skeleton-button"></div>
      </div>
    `;
  }
  return html;
}

// دالة لإنشاء skeleton لصفحة المنتج
function createProductDetailsSkeleton() {
  return `
    <div class="skeleton-product-details">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;align-items:start;">
        <div>
          <div class="skeleton-product-image"></div>
        </div>
        <div>
          <div class="skeleton-product-title"></div>
          <div class="skeleton-product-price"></div>
          <div class="skeleton-product-description"></div>
          <div class="skeleton-product-description"></div>
          <div class="skeleton-product-description"></div>
          <div style="margin-top:30px;width:100%;height:50px;background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s ease-in-out infinite;border-radius:14px;"></div>
        </div>
      </div>
    </div>
  `;
}

// ======================= صفحة كل المنتجات =======================
async function loadAllProducts(productIds = null){
  // استخدام productsCache إذا كان موجوداً، وإلا جلب من API
  let normalizedList;
  
  if (window.productsCache && window.productsCache.length > 0) {
    normalizedList = window.productsCache;
  } else {
  // جلب المنتجات
  const res = await fetch(API + "/api/products");
    if (!res.ok) {
      console.error("فشل تحميل المنتجات");
      return;
    }
  const list = await res.json();

    // التأكد من أن جميع المنتجات لديها stock و quantity وتطبيع مسارات الصور
    normalizedList = list.map(p => {
      // تطبيع مسار الصورة إذا كان نسبياً
      let imageUrl = p.image_url;
      if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('data:')) {
        if (!imageUrl.startsWith('/')) {
          imageUrl = '/' + imageUrl;
        }
        if (imageUrl.startsWith('uploads/')) {
          imageUrl = '/' + imageUrl;
        }
      }
      
      return {
    ...p,
        image_url: imageUrl || p.image_url,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
      };
    });

  // حفظها في المتغير العام
  window.allProducts = normalizedList;
  window.productsCache = normalizedList;
  }

  // إنشاء شريط التصفية
  const container = document.getElementById('productsPageContainer');
  if(container) {
    // إزالة الشريط القديم إن وجد
    const oldFilter = document.getElementById('filterBar-productsPageContainer');
    if(oldFilter) oldFilter.remove();
    createFilterBar('productsPageContainer', normalizedList);
  }

  // إذا كانت هناك منتجات محددة من البانر، فلترتها
  let productsToShow = normalizedList;
  if(productIds && Array.isArray(productIds) && productIds.length > 0){
    productsToShow = normalizedList.filter(p => productIds.includes(parseInt(p.id)));
  }

  // عرض المنتجات باستخدام النظام الجديد
  renderProductsWithPagination('productsPageGrid', productsToShow, 'productsPagination', true);

  // تحديث أزرار السلة
  refreshAllAddToCartButtons();
}



function fillBrandSelect(){
  const sel = document.getElementById("brandSelect");
  if(!sel) return;
  sel.innerHTML = '<option value="">كل الماركات</option>';

  // استخراج الماركات بدون تكرار
  let brands = {};
  allProducts.forEach(p => {
    if(p.brand_id && !brands[p.brand_id]){
      brands[p.brand_id] = p.brand_name;
    }
  });

  for(let id in brands){
    sel.innerHTML += `<option value="${id}">${brands[id]}</option>`;
  }
}

// ======================= شريط التصفية =======================
// إنشاء شريط التصفية
function createFilterBar(containerId, productsList = null) {
  const container = document.getElementById(containerId);
  if(!container) return;

  // استخراج الماركات من المنتجات
  const products = productsList || window.allProducts || window.productsCache || [];
  let brands = {};
  products.forEach(p => {
    if(p.brand_id && p.brand_name && !brands[p.brand_id]){
      brands[p.brand_id] = p.brand_name;
    }
  });

  const brandsOptions = Object.keys(brands).map(id => 
    `<option value="${id}">${brands[id]}</option>`
  ).join('');

  const filterBarHTML = `
    <div class="products-filter-bar" id="filterBar-${containerId}">
      <div class="filter-bar-content">
        <div class="filter-group">
          <label>ترتيب حسب السعر</label>
          <select id="priceSort-${containerId}" onchange="applyFilters('${containerId}')">
            <option value="">الافتراضي</option>
            <option value="price-low">من الأقل للأعلى</option>
            <option value="price-high">من الأعلى للأقل</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ترتيب حسب التقييم</label>
          <select id="ratingSort-${containerId}" onchange="applyFilters('${containerId}')">
            <option value="">الافتراضي</option>
            <option value="rating-high">الأعلى تقييماً</option>
            <option value="rating-low">الأقل تقييماً</option>
          </select>
        </div>
        <div class="filter-group">
          <label>فلترة حسب الماركة</label>
          <select id="brandFilter-${containerId}" onchange="applyFilters('${containerId}')">
            <option value="">كل الماركات</option>
            ${brandsOptions}
          </select>
        </div>
        <div class="filter-actions">
          <button class="filter-reset-btn" onclick="resetFilters('${containerId}')">إعادة تعيين</button>
        </div>
      </div>
    </div>
  `;

  // إضافة الشريط قبل شبكة المنتجات
  const grid = container.querySelector('.products-grid') || container.querySelector('[id*="Grid"]');
  if(grid && grid.parentNode) {
    grid.parentNode.insertAdjacentHTML('beforebegin', filterBarHTML);
  } else {
    container.insertAdjacentHTML('afterbegin', filterBarHTML);
  }
}

// تطبيق التصفية والترتيب
async function applyFilters(containerId) {
  const priceSort = document.getElementById(`priceSort-${containerId}`)?.value || '';
  const ratingSort = document.getElementById(`ratingSort-${containerId}`)?.value || '';
  const brandFilter = document.getElementById(`brandFilter-${containerId}`)?.value || '';

  // تحديد الصفحة الحالية
  let products = [];
  let gridElement = null;

  // تحديد المنتجات والشبكة حسب الصفحة
  if(containerId === 'productsPageContainer') {
    // البدء بكل المنتجات أو نتائج البحث
    const searchText = document.getElementById("productsSearch")?.value.toLowerCase() || '';
    let baseProducts = [...(window.allProducts || [])];
    if(searchText) {
      baseProducts = baseProducts.filter(p => p.name.toLowerCase().includes(searchText));
    }
    products = baseProducts;
    gridElement = document.getElementById('productsPageGrid');
  } else if(containerId === 'brandProductsContainer') {
    products = [...(window.productsCache || [])].filter(p => p.brand_id == window.currentBrand);
    gridElement = document.getElementById('brandProductsGrid');
  } else if(containerId === 'categoryContainer') {
    products = [...(window.productsCache || [])].filter(p => p.category === window.currentCategory);
    gridElement = document.getElementById('categoryGrid');
  } else if(containerId === 'offersContainer') {
    products = [...(window.productsCache || [])].filter(p => p.discount_value > 0);
    gridElement = document.getElementById('offersGrid');
  } else if(containerId === 'wishlistContainer') {
    const wishlistArray = wishlist || JSON.parse(localStorage.getItem("wishlist") || "[]");
    products = [...(window.productsCache || [])].filter(p => wishlistArray.includes(p.id));
    gridElement = document.getElementById('wishlistGrid');
  }

  if(!gridElement || products.length === 0) {
    if(gridElement) {
      gridElement.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">لا يوجد منتجات</p>';
      refreshAllAddToCartButtons();
    }
    return;
  }

  // فلترة حسب الماركة
  let filtered = products;
  if(brandFilter) {
    filtered = filtered.filter(p => p.brand_id == brandFilter);
  }

  // جلب التقييمات للمنتجات
  const productsWithRatings = await Promise.all(
    filtered.map(async (p) => {
      const rating = await getProductRating(p.id);
      return { ...p, rating: rating.average };
    })
  );

  // ترتيب حسب التقييم
  if(ratingSort === 'rating-high') {
    productsWithRatings.sort((a, b) => (b.rating || 0) - (a.rating || 0));
  } else if(ratingSort === 'rating-low') {
    productsWithRatings.sort((a, b) => (a.rating || 0) - (b.rating || 0));
  }

  // ترتيب حسب السعر
  if(priceSort === 'price-low') {
    productsWithRatings.sort((a, b) => {
      const priceA = calculateFinalPrice(a).final;
      const priceB = calculateFinalPrice(b).final;
      return parseFloat(priceA) - parseFloat(priceB);
    });
  } else if(priceSort === 'price-high') {
    productsWithRatings.sort((a, b) => {
      const priceA = calculateFinalPrice(a).final;
      const priceB = calculateFinalPrice(b).final;
      return parseFloat(priceB) - parseFloat(priceA);
    });
  }

  // تحديد معرف Pagination حسب الصفحة
  let paginationId = null;
  if(containerId === 'productsPageContainer') {
    paginationId = 'productsPagination';
  } else if(containerId === 'brandProductsContainer') {
    paginationId = 'brandProductsPagination';
  } else if(containerId === 'categoryContainer') {
    paginationId = 'categoryPagination';
  } else if(containerId === 'offersContainer') {
    paginationId = 'offersPagination';
  } else if(containerId === 'wishlistContainer') {
    paginationId = 'wishlistPagination';
  }

  // عرض المنتجات باستخدام النظام الجديد
  if(gridElement && paginationId) {
    renderProductsWithPagination(gridElement.id, productsWithRatings, paginationId, true);
  } else {
    // Fallback للطريقة القديمة
    gridElement.innerHTML = '';
    if(productsWithRatings.length === 0) {
      gridElement.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">لا يوجد منتجات</p>';
      refreshAllAddToCartButtons();
      return;
    }

    productsWithRatings.forEach(p => {
      gridElement.innerHTML += makeProductCard(p);
    });

    refreshAllAddToCartButtons();
    
    setTimeout(() => {
      updateAllProductRatings();
    }, 100);
  }
}

// إعادة تعيين التصفية
function resetFilters(containerId) {
  const priceSort = document.getElementById(`priceSort-${containerId}`);
  const ratingSort = document.getElementById(`ratingSort-${containerId}`);
  const brandFilter = document.getElementById(`brandFilter-${containerId}`);

  if(priceSort) priceSort.value = '';
  if(ratingSort) ratingSort.value = '';
  if(brandFilter) brandFilter.value = '';

  applyFilters(containerId);
}

// متغيرات Pagination - نظام موحد لجميع الصفحات
// كل صفحة = 30 منتج، لكن نعرض 15 أولاً ثم 15 أخرى عند الوصول للمنتج 15
let paginationState = {
  products: {}, // لكل صفحة: { gridId: { currentPage, allProducts, gridElement, paginationElement } }
  productsPerPage: 30, // كل صفحة تحتوي 30 منتج
  initialLoad: 15, // نعرض 15 منتج أولاً
  secondLoad: 15 // ثم 15 أخرى عند الوصول للمنتج 15
};

// دالة لتهيئة حالة Pagination لصفحة معينة
function initPaginationState(gridId, allProducts, paginationContainerId = null) {
  if(!paginationState.products[gridId]) {
    paginationState.products[gridId] = {
      currentPage: 1,
      allProducts: [],
      gridElement: null,
      paginationElement: null,
      isLoadingMore: false,
      observer: null,
      loadedCount: 0,
      loadingIndicator: null
    };
  }
  
  const state = paginationState.products[gridId];
  state.allProducts = [...allProducts];
  state.gridElement = document.getElementById(gridId);
  if(paginationContainerId) {
    state.paginationElement = document.getElementById(paginationContainerId);
  }
  state.currentPage = 1;
  state.loadedCount = 0;
  state.isLoadingMore = false;
  
  // إزالة observer القديم
  if(state.observer) {
    state.observer.disconnect();
    state.observer = null;
  }
  
  return state;
}

// دالة موحدة لعرض المنتجات مع Pagination
function renderProductsWithPagination(gridId, allProducts, paginationContainerId = null, resetPagination = true) {
  const state = initPaginationState(gridId, allProducts, paginationContainerId);
  
  if(!state.gridElement) return;
  
  // إعادة تعيين إذا طُلب
  if(resetPagination) {
    state.currentPage = 1;
    state.loadedCount = 0;
    state.gridElement.innerHTML = '';
    if(state.observer) {
      state.observer.disconnect();
      state.observer = null;
    }
  }
  
  if(state.allProducts.length === 0) {
    state.gridElement.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">لا يوجد منتجات</p>';
    if(state.paginationElement) {
      state.paginationElement.style.display = 'none';
    }
    return;
  }
  
  // عرض أول 15 منتج
  const initialProducts = state.allProducts.slice(0, paginationState.initialLoad);
  initialProducts.forEach(p => {
    state.gridElement.innerHTML += makeProductCard(p);
  });
  
  state.loadedCount = initialProducts.length;
  
  // تحديث شريط Pagination
  updatePaginationBarForGrid(gridId);
  
  refreshAllAddToCartButtons();
  
  setTimeout(() => {
    updateAllProductRatings();
  }, 100);
  
  // إعداد التحميل التدريجي إذا كان هناك المزيد
  if(state.allProducts.length > paginationState.initialLoad) {
    setTimeout(() => {
      setupInfiniteScrollForGrid(gridId);
    }, 100);
  }
}

// إعداد التحميل التدريجي لصفحة معينة
function setupInfiniteScrollForGrid(gridId) {
  const state = paginationState.products[gridId];
  if(!state || !state.gridElement) return;
  
  // إزالة observer القديم
  if(state.observer) {
    state.observer.disconnect();
    state.observer = null;
  }
  
  // التحقق من وجود منتجات للتحميل
  const totalInCurrentPage = state.currentPage * paginationState.productsPerPage;
  if(state.loadedCount >= Math.min(totalInCurrentPage, state.allProducts.length)) {
    return;
  }
  
  // الحصول على المنتج رقم 15 (أو آخر منتج معروض)
  const products = state.gridElement.children;
  if(products.length === 0) return;
  
  // إنشاء عنصر "جاري تحميل المزيد"
  const loadingDiv = document.createElement('div');
  loadingDiv.id = `loading-${gridId}`;
  loadingDiv.className = 'loading-more-indicator';
  loadingDiv.innerHTML = `
    <div style="text-align:center;padding:20px;color:#8a004a;font-weight:600;">
      <div style="display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #8a004a;border-radius:50%;animation:spin 1s linear infinite;margin-left:10px;"></div>
      جاري تحميل المزيد...
    </div>
  `;
  loadingDiv.style.display = 'none';
  state.gridElement.appendChild(loadingDiv);
  state.loadingIndicator = loadingDiv;
  
  // مراقبة المنتج رقم 15 (أو آخر منتج معروض إذا كان أقل من 15)
  const targetProduct = products[Math.min(14, products.length - 1)];
  if(!targetProduct) return;
  
  // إنشاء Intersection Observer
  state.observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if(entry.isIntersecting && !state.isLoadingMore) {
        const totalInCurrentPage = state.currentPage * paginationState.productsPerPage;
        if(state.loadedCount < Math.min(totalInCurrentPage, state.allProducts.length)) {
          loadMoreProductsForGrid(gridId);
        }
      }
    });
  }, {
    rootMargin: '100px'
  });
  
  state.observer.observe(targetProduct);
}

// تحميل المزيد من المنتجات لصفحة معينة
function loadMoreProductsForGrid(gridId) {
  const state = paginationState.products[gridId];
  if(!state || state.isLoadingMore) return;
  
  const totalInCurrentPage = state.currentPage * paginationState.productsPerPage;
  const remainingInPage = totalInCurrentPage - state.loadedCount;
  
  if(remainingInPage <= 0) return;
  
  state.isLoadingMore = true;
  
  // إظهار رسالة "جاري تحميل المزيد"
  if(state.loadingIndicator) {
    state.loadingIndicator.style.display = 'block';
  }
  
  // محاكاة تأخير صغير للتحميل
  setTimeout(() => {
    const productsToLoad = Math.min(remainingInPage, paginationState.secondLoad);
    const startIndex = state.loadedCount;
    const endIndex = startIndex + productsToLoad;
    const newProducts = state.allProducts.slice(startIndex, endIndex);
    
    // إزالة رسالة التحميل
    if(state.loadingIndicator) {
      state.loadingIndicator.remove();
      state.loadingIndicator = null;
    }
    
    // إضافة المنتجات الجديدة
    newProducts.forEach(p => {
      state.gridElement.innerHTML += makeProductCard(p);
    });
    
    state.loadedCount += newProducts.length;
    state.isLoadingMore = false;
    
    refreshAllAddToCartButtons();
    
    setTimeout(() => {
      updateAllProductRatings();
    }, 100);
    
    // إذا لم نكمل الصفحة بعد، أعد إعداد observer
    if(state.loadedCount < totalInCurrentPage && state.loadedCount < state.allProducts.length) {
      setTimeout(() => {
        setupInfiniteScrollForGrid(gridId);
      }, 100);
    } else {
      // إذا أكملنا الصفحة، أزل observer
      if(state.observer) {
        state.observer.disconnect();
        state.observer = null;
      }
    }
    
    // تحديث شريط Pagination
    updatePaginationBarForGrid(gridId);
  }, 500);
}

// تحديث شريط Pagination لصفحة معينة
function updatePaginationBarForGrid(gridId) {
  const state = paginationState.products[gridId];
  if(!state || !state.paginationElement) return;
  
  if(state.allProducts.length === 0) {
    state.paginationElement.style.display = 'none';
    return;
  }
  
  state.paginationElement.style.display = 'block';
  
  const totalPages = Math.ceil(state.allProducts.length / paginationState.productsPerPage);
  const startProduct = Math.max(1, (state.currentPage - 1) * paginationState.productsPerPage + 1);
  const endProduct = Math.min(state.currentPage * paginationState.productsPerPage, state.allProducts.length);
  
  // إنشاء HTML لشريط Pagination
  let paginationHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
      <div style="color:#666;font-size:14px;">
        <span style="font-weight:600;color:#8a004a;">عرض ${startProduct}-${endProduct}</span>
        <span style="color:#999;">من ${state.allProducts.length} منتج</span>
        <span style="color:#999;margin-right:10px;">| الصفحة ${state.currentPage} من ${totalPages}</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
  `;
  
  // زر الصفحة السابقة
  if(state.currentPage > 1) {
    paginationHTML += `
      <button onclick="goToPageForGrid('${gridId}', ${state.currentPage - 1})" 
              style="padding:8px 16px;background:#8a004a;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:'Tajawal',sans-serif;">
        ‹ السابق
      </button>
    `;
  }
  
  // أرقام الصفحات
  const maxPagesToShow = 5;
  let startPage = Math.max(1, state.currentPage - Math.floor(maxPagesToShow / 2));
  let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
  
  if(endPage - startPage < maxPagesToShow - 1) {
    startPage = Math.max(1, endPage - maxPagesToShow + 1);
  }
  
  if(startPage > 1) {
    paginationHTML += `<button onclick="goToPageForGrid('${gridId}', 1)" style="padding:8px 12px;background:#fff;color:#8a004a;border:2px solid #8a004a;border-radius:8px;cursor:pointer;font-weight:600;font-family:'Tajawal',sans-serif;">1</button>`;
    if(startPage > 2) {
      paginationHTML += `<span style="padding:8px;color:#999;">...</span>`;
    }
  }
  
  for(let i = startPage; i <= endPage; i++) {
    if(i === state.currentPage) {
      paginationHTML += `<button style="padding:8px 12px;background:#8a004a;color:white;border:none;border-radius:8px;font-weight:700;cursor:default;font-family:'Tajawal',sans-serif;">${i}</button>`;
    } else {
      paginationHTML += `<button onclick="goToPageForGrid('${gridId}', ${i})" style="padding:8px 12px;background:#fff;color:#8a004a;border:2px solid #ddd;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;font-family:'Tajawal',sans-serif;" onmouseover="this.style.borderColor='#8a004a';this.style.background='#fce4ef';" onmouseout="this.style.borderColor='#ddd';this.style.background='#fff';">${i}</button>`;
    }
  }
  
  if(endPage < totalPages) {
    if(endPage < totalPages - 1) {
      paginationHTML += `<span style="padding:8px;color:#999;">...</span>`;
    }
    paginationHTML += `<button onclick="goToPageForGrid('${gridId}', ${totalPages})" style="padding:8px 12px;background:#fff;color:#8a004a;border:2px solid #8a004a;border-radius:8px;cursor:pointer;font-weight:600;font-family:'Tajawal',sans-serif;">${totalPages}</button>`;
  }
  
  // زر الصفحة التالية
  if(state.currentPage < totalPages) {
    paginationHTML += `
      <button onclick="goToPageForGrid('${gridId}', ${state.currentPage + 1})" 
              style="padding:8px 16px;background:#8a004a;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-family:'Tajawal',sans-serif;">
        التالي ›
      </button>
    `;
  }
  
  paginationHTML += `
      </div>
    </div>
  `;
  
  state.paginationElement.innerHTML = paginationHTML;
}

// الانتقال لصفحة محددة
function goToPageForGrid(gridId, page) {
  const state = paginationState.products[gridId];
  if(!state) return;
  
  const totalPages = Math.ceil(state.allProducts.length / paginationState.productsPerPage);
  if(page < 1 || page > totalPages) return;
  
  state.currentPage = page;
  state.loadedCount = 0;
  
  if(state.gridElement) {
    state.gridElement.innerHTML = '';
  }
  
  // إزالة observer القديم
  if(state.observer) {
    state.observer.disconnect();
    state.observer = null;
  }
  
  // عرض أول 15 منتج من الصفحة الجديدة
  const pageStartIndex = (page - 1) * paginationState.productsPerPage;
  const initialProducts = state.allProducts.slice(pageStartIndex, pageStartIndex + paginationState.initialLoad);
  
  initialProducts.forEach(p => {
    state.gridElement.innerHTML += makeProductCard(p);
  });
  
  state.loadedCount = initialProducts.length;
  
  updatePaginationBarForGrid(gridId);
  refreshAllAddToCartButtons();
  
  setTimeout(() => {
    updateAllProductRatings();
  }, 100);
  
  // إعداد التحميل التدريجي
  if(state.allProducts.length > pageStartIndex + paginationState.initialLoad) {
    setTimeout(() => {
      setupInfiniteScrollForGrid(gridId);
    }, 100);
  }
  
  // التمرير للأعلى
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderProducts(list, resetPagination = true){
  const grid = document.getElementById("productsPageGrid");
  
  // حفظ قائمة المنتجات المفلترة
  allFilteredProducts = list;
  
  // إعادة تعيين الصفحة إذا طُلب ذلك
  if(resetPagination) {
    currentPage = 1;
    grid.innerHTML = "";
    // إيقاف observer القديم
    if(observer) {
      observer.disconnect();
      observer = null;
    }
    isLoadingMore = false;
  }

  if(list.length === 0){
    grid.innerHTML = "<p style='text-align:center;padding:40px;color:#666;'>لا يوجد منتجات</p>";
    document.getElementById("productsPagination").style.display = "none";
    return;
  }

  // حساب عدد المنتجات المعروضة
  const startIndex = 0;
  const endIndex = Math.min(currentPage * productsPerPage, list.length);
  const productsToShow = list.slice(startIndex, endIndex);

  // إضافة المنتجات
  productsToShow.forEach(p => {
    grid.innerHTML += makeProductCard(p);
  });

  // تحديث شريط Pagination
  updatePaginationBar(list.length);

  refreshAllAddToCartButtons();
  
  // تحديث التقييمات بعد عرض المنتجات
  setTimeout(() => {
    updateAllProductRatings();
  }, 100);

  // إعداد infinite scroll إذا لم نصل لنهاية القائمة
  if(endIndex < list.length) {
    setTimeout(() => {
      setupInfiniteScroll();
    }, 100);
    isLoadingMore = false;
  } else {
    if(observer) {
      observer.disconnect();
      observer = null;
    }
    isLoadingMore = true;
  }
}

// دالة للتعامل مع التمرير (Infinite Scroll) - استخدام Intersection Observer
let observer = null;

function setupInfiniteScroll() {
  // إزالة observer القديم إن وجد
  if(observer) {
    observer.disconnect();
    observer = null;
  }
  
  // التحقق من وجود منتجات إضافية للتحميل
  if(currentPage * productsPerPage >= allFilteredProducts.length) {
    return;
  }
  
  const grid = document.getElementById("productsPageGrid");
  if(!grid || grid.children.length === 0) return;
  
  // الحصول على آخر منتج معروض
  const lastProduct = grid.lastElementChild;
  if(!lastProduct) return;
  
  // إنشاء Intersection Observer
  observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      // عندما يظهر آخر منتج في viewport
      if(entry.isIntersecting && !isLoadingMore) {
        if(currentPage * productsPerPage < allFilteredProducts.length) {
          loadMoreProducts();
        }
      }
    });
  }, {
    root: null,
    rootMargin: '50px', // بدء التحميل قبل 50px من الوصول للعنصر
    threshold: 0.01 // يبدأ التحميل بمجرد ظهور جزء صغير من العنصر
  });
  
  // مراقبة آخر منتج
  observer.observe(lastProduct);
}

// دالة لتحميل المزيد من المنتجات
function loadMoreProducts() {
  if(isLoadingMore) return;
  if(currentPage * productsPerPage >= allFilteredProducts.length) return;
  
  isLoadingMore = true;
  currentPage++;
  
  const startIndex = (currentPage - 1) * productsPerPage;
  const endIndex = Math.min(currentPage * productsPerPage, allFilteredProducts.length);
  const productsToAdd = allFilteredProducts.slice(startIndex, endIndex);
  
  const grid = document.getElementById("productsPageGrid");
  productsToAdd.forEach(p => {
    grid.innerHTML += makeProductCard(p);
  });
  
  // تحديث شريط Pagination
  updatePaginationBar(allFilteredProducts.length);
  
  refreshAllAddToCartButtons();
  
  setTimeout(() => {
    updateAllProductRatings();
    isLoadingMore = false;
    
    // إذا وصلنا للنهاية، أزل observer
    if(endIndex >= allFilteredProducts.length) {
      if(observer) {
        observer.disconnect();
        observer = null;
      }
    } else {
      // إعادة إعداد observer للمنتجات الجديدة
      setupInfiniteScroll();
    }
  }, 100);
}

// دالة لتحديث شريط Pagination
function updatePaginationBar(totalProducts) {
  const paginationBar = document.getElementById("productsPagination");
  const paginationInfo = document.getElementById("paginationInfo");
  const paginationControls = document.getElementById("paginationControls");
  
  if(totalProducts === 0) {
    paginationBar.style.display = "none";
    return;
  }
  
  paginationBar.style.display = "block";
  
  const totalPages = Math.ceil(totalProducts / productsPerPage);
  const startProduct = Math.max(1, (currentPage - 1) * productsPerPage + 1);
  const endProduct = Math.min(currentPage * productsPerPage, totalProducts);
  
  // معلومات الصفحة
  paginationInfo.innerHTML = `
    <span style="font-weight:600;color:#8a004a;">عرض ${startProduct}-${endProduct}</span>
    <span style="color:#999;">من ${totalProducts} منتج</span>
    <span style="color:#999;margin-right:10px;">| الصفحة ${currentPage} من ${totalPages}</span>
  `;
  
  // أزرار التنقل
  let controlsHTML = "";
  
  // زر الصفحة السابقة
  if(currentPage > 1) {
    controlsHTML += `
      <button onclick="goToPage(${currentPage - 1})" 
              style="padding:8px 16px;background:#8a004a;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        ‹ السابق
      </button>
    `;
  }
  
  // أرقام الصفحات
  const maxPagesToShow = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
  let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
  
  if(endPage - startPage < maxPagesToShow - 1) {
    startPage = Math.max(1, endPage - maxPagesToShow + 1);
  }
  
  if(startPage > 1) {
    controlsHTML += `<button onclick="goToPage(1)" style="padding:8px 12px;background:#fff;color:#8a004a;border:2px solid #8a004a;border-radius:8px;cursor:pointer;font-weight:600;">1</button>`;
    if(startPage > 2) {
      controlsHTML += `<span style="padding:8px;color:#999;">...</span>`;
    }
  }
  
  for(let i = startPage; i <= endPage; i++) {
    if(i === currentPage) {
      controlsHTML += `<button style="padding:8px 12px;background:#8a004a;color:white;border:none;border-radius:8px;font-weight:700;cursor:default;">${i}</button>`;
    } else {
      controlsHTML += `<button onclick="goToPage(${i})" style="padding:8px 12px;background:#fff;color:#8a004a;border:2px solid #ddd;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;" onmouseover="this.style.borderColor='#8a004a';this.style.background='#fce4ef';" onmouseout="this.style.borderColor='#ddd';this.style.background='#fff';">${i}</button>`;
    }
  }
  
  if(endPage < totalPages) {
    if(endPage < totalPages - 1) {
      controlsHTML += `<span style="padding:8px;color:#999;">...</span>`;
    }
    controlsHTML += `<button onclick="goToPage(${totalPages})" style="padding:8px 12px;background:#fff;color:#8a004a;border:2px solid #8a004a;border-radius:8px;cursor:pointer;font-weight:600;">${totalPages}</button>`;
  }
  
  // زر الصفحة التالية
  if(currentPage < totalPages) {
    controlsHTML += `
      <button onclick="goToPage(${currentPage + 1})" 
              style="padding:8px 16px;background:#8a004a;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        التالي ›
      </button>
    `;
  }
  
  paginationControls.innerHTML = controlsHTML;
}

// دالة للانتقال لصفحة محددة
function goToPage(page) {
  if(page < 1 || page > Math.ceil(allFilteredProducts.length / productsPerPage)) return;
  
  currentPage = page;
  const grid = document.getElementById("productsPageGrid");
  grid.innerHTML = "";
  
  const startIndex = 0;
  const endIndex = Math.min(currentPage * productsPerPage, allFilteredProducts.length);
  const productsToShow = allFilteredProducts.slice(startIndex, endIndex);
  
  productsToShow.forEach(p => {
    grid.innerHTML += makeProductCard(p);
  });
  
  updatePaginationBar(allFilteredProducts.length);
  refreshAllAddToCartButtons();
  
  setTimeout(() => {
    updateAllProductRatings();
  }, 100);
  
  // التمرير للأعلى
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // إعادة إعداد infinite scroll
  if(endIndex < allFilteredProducts.length) {
    setTimeout(() => {
      setupInfiniteScroll();
    }, 100);
    isLoadingMore = false;
  } else {
    if(observer) {
      observer.disconnect();
      observer = null;
    }
    isLoadingMore = true;
  }
}



function filterProducts(){
  const text = document.getElementById("productsSearch")?.value.toLowerCase() || '';
  
  // إذا كان هناك فلاتر نشطة من شريط التصفية، استخدم applyFilters
  const priceSort = document.getElementById("priceSort-productsPageContainer")?.value || '';
  const ratingSort = document.getElementById("ratingSort-productsPageContainer")?.value || '';
  const brandFilter = document.getElementById("brandFilter-productsPageContainer")?.value || '';
  
  if(priceSort || ratingSort || brandFilter) {
    // إذا كان هناك فلاتر نشطة، استخدم applyFilters
    applyFilters('productsPageContainer');
    return;
  }
  
  // إذا لم يكن هناك فلاتر، فقط ابحث واعرض
  let filtered = allProducts;
  if(text) {
    filtered = allProducts.filter(p => p.name.toLowerCase().includes(text));
  }
  
  // استخدام النظام الجديد
  renderProductsWithPagination('productsPageGrid', filtered, 'productsPagination', true);
}
//------------------ صفحة خصم السعر --------------------
function calculateFinalPrice(p){
  const base = parseFloat(p.base_price) || 0;
  const discountValue = parseFloat(p.discount_value) || 0;
  const discountType = p.discount_type || "none";

  let priceAfterDiscount = base;

  // الخصم
  if(discountType === "percent"){
    priceAfterDiscount = base - (base * (discountValue / 100));
  }
  else if(discountType === "fixed"){
    priceAfterDiscount = base - discountValue;
  }

  if(priceAfterDiscount < 0) priceAfterDiscount = 0;

  // الضريبة (استخدام VATCalculator)
  const beforeVat = VATCalculator.addVAT(base);
  const finalWithVat = VATCalculator.addVAT(priceAfterDiscount);

  return {
    before: beforeVat.toFixed(2),     // السعر قبل الخصم + الضريبة
    final: finalWithVat.toFixed(2),   // السعر بعد الخصم + الضريبة
  };
}

// ======================= دوال التقييمات =======================

// جلب متوسط التقييم للمنتج
async function getProductRating(productId) {
  try {
    const res = await fetch(API + `/api/reviews/${productId}/average`);
    const data = await res.json();
    return {
      average: parseFloat(data.average || 0),
      total: parseInt(data.total || 0)
    };
  } catch (error) {
    return { average: 0, total: 0 };
  }
}

// تحديث النجوم في كارت المنتج
async function updateProductCardRating(productId, ratingElement) {
  const rating = await getProductRating(productId);
  const stars = ratingElement.querySelectorAll('.star');
  const valueSpan = ratingElement.querySelector('.rating-value');
  
  if (valueSpan) {
    valueSpan.textContent = rating.average.toFixed(1);
  }
  
  const fullStars = Math.floor(rating.average);
  const hasHalfStar = rating.average % 1 >= 0.5;
  
  stars.forEach((star, index) => {
    if (index < fullStars) {
      star.innerHTML = '<span style="color:#FFD700;">★</span>';
      star.style.opacity = '1';
    } else if (index === fullStars && hasHalfStar) {
      star.innerHTML = '<span style="color:#FFD700;">★</span>';
      star.style.opacity = '0.5';
    } else {
      star.innerHTML = '<span style="color:#ddd;">★</span>';
      star.style.opacity = '1';
    }
  });
}

// تحديث جميع تقييمات المنتجات في الصفحة
async function updateAllProductRatings() {
  const ratingElements = document.querySelectorAll('.product-rating');
  ratingElements.forEach(async (el) => {
    const productId = el.getAttribute('data-product-id');
    if (productId) {
      await updateProductCardRating(productId, el);
    }
  });
}

// تحميل التقييمات في صفحة المنتج
async function loadProductReviews(productId) {
  const reviewsSection = document.getElementById('productReviewsSection');
  if (!reviewsSection) return;
  
  try {
    // جلب التقييمات والمتوسط
    const [reviewsRes, avgRes] = await Promise.all([
      fetch(API + `/api/reviews/${productId}`),
      fetch(API + `/api/reviews/${productId}/average`)
    ]);
    
    const reviews = await reviewsRes.json();
    const avgData = await avgRes.json();
    const average = parseFloat(avgData.average || 0);
    const total = parseInt(avgData.total || 0);
    
    let html = `
      <div class="reviews-header">
        <h3 class="section-label">التقييمات والمراجعات</h3>
        <div class="reviews-summary">
          <div class="reviews-average">
            <span class="average-rating">${average.toFixed(1)}</span>
            <div class="average-stars">
              ${generateStarsHTML(average)}
            </div>
            <span class="total-reviews">(${total} ${total === 1 ? 'تقييم' : 'تقييمات'})</span>
          </div>
        </div>
      </div>
    `;
    
    // نموذج إضافة تقييم (فقط للمستخدمين المسجلين)
    if (window.user) {
      html += `
        <div class="add-review-section">
          <h4>أضف تقييمك</h4>
          <div class="review-form">
              <div class="rating-input">
              <label>التقييم:</label>
              <div class="star-rating-input">
                ${[5, 4, 3, 2, 1].map(r => `
                  <span class="star-input" data-rating="${r}" onclick="selectRating(${r})" style="color:#FFD700;cursor:pointer;">★</span>
                `).join('')}
              </div>
              <span class="selected-rating-text" id="selectedRatingText">اختر التقييم</span>
            </div>
            <textarea id="reviewComment" class="review-comment-input" placeholder="اكتب تعليقك هنا..."></textarea>
            <button onclick="submitReview(${productId})" class="submit-review-btn">إرسال التقييم</button>
            <div id="reviewMessage" class="review-message"></div>
          </div>
        </div>
      `;
    } else {
      html += `
        <div class="review-login-prompt">
          <p>يجب <a href="#" onclick="go('login'); return false;">تسجيل الدخول</a> وشراء المنتج لإضافة تقييم</p>
        </div>
      `;
    }
    
    // عرض التقييمات المعتمدة
    if (reviews.length > 0) {
      html += `<div class="reviews-list">`;
      reviews.forEach(review => {
        html += `
          <div class="review-item">
            <div class="review-header">
              <div class="review-user">
                <span class="user-initial">${review.user_email.charAt(0).toUpperCase()}</span>
                <div class="user-info">
                  <span class="user-email">${review.user_email}</span>
                  <span class="review-date">${formatDate(review.created_at)}</span>
                </div>
              </div>
              <div class="review-rating" style="display:flex;gap:2px;">
                ${generateStarsHTML(review.rating)}
              </div>
            </div>
            ${review.comment ? `<p class="review-comment">${review.comment}</p>` : ''}
          </div>
        `;
      });
      html += `</div>`;
    } else {
      html += `
        <div class="no-reviews">
          <p>لا توجد تقييمات بعد. كن أول من يقيم هذا المنتج!</p>
        </div>
      `;
    }
    
    reviewsSection.innerHTML = html;
    
    // تهيئة اختيار النجوم
    if (window.user) {
      initStarRating();
    }
    
  } catch (error) {
    console.error('Error loading reviews:', error);
    reviewsSection.innerHTML = '<div class="reviews-error">حدث خطأ في تحميل التقييمات</div>';
  }
}

// توليد HTML للنجوم
function generateStarsHTML(rating) {
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5;
  let html = '';
  
  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      html += '<span class="star-filled" style="color:#FFD700;">★</span>';
    } else if (i === fullStars + 1 && hasHalfStar) {
      html += '<span class="star-half" style="color:#FFD700;opacity:0.5;">★</span>';
    } else {
      html += '<span class="star-empty" style="color:#ddd;">★</span>';
    }
  }
  
  return html;
}

// تهيئة اختيار النجوم
function initStarRating() {
  const starInputs = document.querySelectorAll('.star-input');
  let selectedRating = 0;
  
  starInputs.forEach((star, index) => {
    star.addEventListener('mouseenter', () => {
      const rating = parseInt(star.getAttribute('data-rating'));
      highlightStars(rating);
    });
    
    star.addEventListener('click', () => {
      selectedRating = parseInt(star.getAttribute('data-rating'));
      highlightStars(selectedRating);
      const textEl = document.getElementById('selectedRatingText');
      if (textEl) {
        const texts = ['', 'سيء جداً', 'سيء', 'متوسط', 'جيد', 'ممتاز'];
        textEl.textContent = texts[selectedRating] || 'اختر التقييم';
      }
      window.selectedRating = selectedRating;
    });
  });
  
  const container = document.querySelector('.star-rating-input');
  if (container) {
    container.addEventListener('mouseleave', () => {
      highlightStars(selectedRating);
    });
  }
}

function highlightStars(rating) {
  const starInputs = document.querySelectorAll('.star-input');
  starInputs.forEach((star, index) => {
    const starRating = parseInt(star.getAttribute('data-rating'));
    if (starRating <= rating) {
      star.style.opacity = '1';
      star.style.transform = 'scale(1.1)';
    } else {
      star.style.opacity = '0.3';
      star.style.transform = 'scale(1)';
    }
  });
}

function selectRating(rating) {
  window.selectedRating = rating;
  highlightStars(rating);
  const textEl = document.getElementById('selectedRatingText');
  if (textEl) {
    const texts = ['', 'سيء جداً', 'سيء', 'متوسط', 'جيد', 'ممتاز'];
    textEl.textContent = texts[rating] || 'اختر التقييم';
  }
}

// إرسال التقييم
async function submitReview(productId) {
  if (!window.user) {
    showNotification('يجب تسجيل الدخول أولاً', 'error');
    return;
  }
  
  if (!window.selectedRating || window.selectedRating < 1) {
    showNotification('يرجى اختيار التقييم', 'error');
    return;
  }
  
  const comment = document.getElementById('reviewComment')?.value || '';
  
  try {
    const res = await fetch(API + '/api/reviews', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        product_id: productId,
        rating: window.selectedRating,
        comment: comment,
        user_email: window.user.email,
        user_phone: window.user.phone
      })
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('شكراً لك! سيتم مراجعة تقييمك قبل النشر', 'success');
      document.getElementById('reviewComment').value = '';
      window.selectedRating = 0;
      highlightStars(0);
      document.getElementById('selectedRatingText').textContent = 'اختر التقييم';
      // إعادة تحميل التقييمات في صفحة المنتج
      await loadProductReviews(productId);
      // تحديث تقييم المنتج في جميع الكروت الموجودة في الصفحة
      const allRatingElements = document.querySelectorAll(`.product-rating[data-product-id="${productId}"]`);
      allRatingElements.forEach(async (el) => {
        await updateProductCardRating(productId, el);
      });
    } else {
      showNotification(data.message || 'حدث خطأ في إرسال التقييم', 'error');
    }
  } catch (error) {
    console.error('Error submitting review:', error);
    showNotification('حدث خطأ في إرسال التقييم', 'error');
  }
}

// تنسيق التاريخ
function formatDate(dateString) {
  const date = new Date(dateString);
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ar-SA', options);
}

// ======================= صفحة التفاصيل =======================
// ======================= صفحة التفاصيل =======================
async function loadProductDetails(id) {
  // حفظ معرف المنتج للرجوع
  window.currentProductId = id;

  // ⭐ إصلاح قفز الصفحة للأسفل
  window.scrollTo(0, 0);
  
  // إظهار skeleton loading
  document.getElementById("productDetailsBox").innerHTML = createProductDetailsSkeleton();
  
  const res = await fetch(API + "/api/products");
  const productsList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;

  const p = products.find(x => x.id == id);
  if (!p) {
    document.getElementById("productDetailsBox").innerHTML =
      "<p>❌ المنتج غير موجود</p>";
    return;
  }

  const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  const isOutOfStock = stock <= 0;
  const isFav = wishlist.includes(p.id);

  /* ⭐ حساب الأسعار ⭐ */

  const base = parseFloat(p.base_price) || 0;               // السعر الأساسي بدون ضريبة
  const discountValue = parseFloat(p.discount_value) || 0;  // قيمة الخصم
  const discountType = p.discount_type || "none";           // نوع الخصم

  // تطبيق الخصم
  let afterDiscount = base;
  if (discountType === "percent") {
    afterDiscount = base - (base * (discountValue / 100));
  }
  else if (discountType === "fixed") {
    afterDiscount = base - discountValue;
  }

  if (afterDiscount < 0) afterDiscount = 0;

  // إضافة الضريبة (استخدام VATCalculator)
  const beforeVat = VATCalculator.addVAT(base);         // السعر الأساسي + الضريبة
  const afterVat = VATCalculator.addVAT(afterDiscount); // السعر بعد الخصم + الضريبة

  /* ⭐ عرض تفاصيل المنتج ⭐ */
  document.getElementById("productDetailsBox").innerHTML = `
    <div class="product-details-container">
      <div class="product-main-content">
        <!-- صورة المنتج مع خاصية الزوم -->
        <div class="product-image-wrapper ${isOutOfStock ? 'out-of-stock-image' : ''}">
          <div class="skeleton-product-image" id="productImageSkeleton"></div>
          <img id="productMainImage" 
               src="${safeImageURL(p.image_url)}"
               onerror="this.src='https://via.placeholder.com/400?text=No+Image'; const skeleton = document.getElementById('productImageSkeleton'); if(skeleton) skeleton.style.display='none'; this.style.display='block';"
               class="product-main-image ${isOutOfStock ? 'grayscale' : ''}"
               onclick="openImageZoom('${safeImageURL(p.image_url)}')"
               alt="${p.name}"
               onload="const skeleton = document.getElementById('productImageSkeleton'); if(skeleton) skeleton.style.display='none'; this.style.display='block';"
               style="display:none;">
          <div class="zoom-hint">🔍 اضغط للتكبير</div>
          <div id="productWishlistBtn" 
               onclick="event.stopPropagation(); toggleWishlist(${p.id});"
               style="
                 position:absolute;
                 top:12px;
                 left:12px;
                 font-size:22px;
                 cursor:pointer;
                 z-index:20;
                 color:${isFav ? '#E91E63' : '#bbb'};
                 background:rgba(255,255,255,0.9);
                 width:36px;
                 height:36px;
                 border-radius:50%;
                 display:flex;
                 align-items:center;
                 justify-content:center;
                 box-shadow:0 2px 8px rgba(0,0,0,0.1);
                 transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
               "
               onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 4px 12px rgba(233, 30, 99, 0.3)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
               title="${isFav ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}">
            ❤
          </div>
        </div>

        <!-- بيانات المنتج -->
        <div class="product-info-section">
          <div class="product-header">
            <h1 class="product-title">${p.name}</h1>
            ${p.intl_code ? `
              <div class="product-barcode">
                <span class="barcode-label">الباركود الدولي:</span>
                <span class="barcode-value">${p.intl_code}</span>
              </div>
            ` : ""}
          </div>

          <!-- الأسعار -->
          <div class="product-pricing">
            ${(discountType !== "none" && discountValue > 0) ? `
              <div class="price-before-discount">
                <span class="old-price">${beforeVat.toFixed(2)} ر.س</span>
                <span class="discount-badge">خصم ${discountType === "percent" ? discountValue + "%" : discountValue + " ر.س"}</span>
              </div>
            ` : ""}
            <div class="price-final">
              <span class="price-amount">${afterVat.toFixed(2)}</span>
              <span class="price-currency">ر.س</span>
            </div>
          </div>

          ${(() => {
            const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
            const isOutOfStock = stock <= 0;
            const showStockInfo = stock > 0 && stock <= 6;
            
            return `
              ${showStockInfo ? `
                <div class="product-stock-info">
                  <span class="stock-label">الكمية المتبقية:</span>
                  <span class="stock-value">${stock} حبة</span>
                </div>
              ` : ''}
              
              <!-- زر الإضافة للسلة -->
              <button id="productAddBtn"
                data-id="${p.id}"
                onclick="${isOutOfStock ? 'showNotification(\'عذراً، هذا المنتج غير متوفر حالياً\', \'warning\'); return false;' : `addToCart(${p.id})`}"
                class="product-add-btn ${isOutOfStock ? 'out-of-stock-btn' : ''}"
                ${isOutOfStock ? 'disabled' : ''}>
                <span>${isOutOfStock ? '❌' : '🛒'}</span>
                <span>${isOutOfStock ? 'الكمية منتهية' : 'أضف للسلة'}</span>
              </button>
            `;
          })()}

          <!-- الوصف -->
          <div class="product-description">
            <h3 class="section-label">الوصف</h3>
            <p class="description-text">${p.description || "لا يوجد وصف للمنتج"}</p>
          </div>

          <!-- التقييمات -->
          <div class="product-reviews-section" id="productReviewsSection">
            <div class="reviews-loading">جاري تحميل التقييمات...</div>
          </div>
        </div>
      </div>
    </div>
  `;

  updateProductPageButton(id);
  
  // تحميل التقييمات
  await loadProductReviews(id);

  
  /* ============================================================
   ⭐ إضافة المنتجات المشابهة — سلايدر أفقي ⭐
   ============================================================ */
/* ============================================================
     ⭐ منتجات مشابهة — سلايدر كامل ⭐
   ============================================================ */

let similar = (window.productsCache || [])
  .filter(x => x.category === p.category && x.id != p.id)
  .slice(0, 10); // فقط أول 10 منتجات

if (similar.length > 0) {

  let sliderHTML = `
    <div class="similar-products-section">
      <h2 class="similar-products-title">
        <span>✨</span>
        <span>منتجات مشابهة</span>
      </h2>

      <div class="similar-slider-wrapper">
        <!-- زر السابق -->
        <button id="simPrev" class="slider-nav-btn slider-nav-prev" aria-label="السابق">
          ‹
        </button>

        <!-- السلايدر -->
        <div id="simSlider" class="similar-products-slider">
  `;

  similar.forEach(sp => {
    const prices = calculateFinalPrice(sp);

    sliderHTML += `
      <div class="similar-product-card" onclick="go('product', ${sp.id})">
        <div class="similar-product-image-wrapper">
          <img src="${safeImageURL(sp.image_url)}"
               class="similar-product-image"
               alt="${sp.name}">
          ${sp.discount_value > 0 ? `
            <div class="similar-product-discount">
              خصم ${sp.discount_value}${sp.discount_type === 'percent' ? '%' : ''}
            </div>
          ` : ''}
        </div>
  
        <div class="similar-product-info">
          <h3 class="similar-product-name">${sp.name}</h3>
          
          <div class="similar-product-price">
            ${sp.discount_value > 0 ? `
              <span class="similar-price-old">${prices.before} ر.س</span>
            ` : ''}
            <span class="similar-price-new">${prices.final} ر.س</span>
          </div>
        </div>
      </div>
    `;
  });

  sliderHTML += `
        </div>

        <!-- زر التالي -->
        <button id="simNext" class="slider-nav-btn slider-nav-next" aria-label="التالي">
          ›
        </button>
      </div>
    </div>
  `;

  document.getElementById("productDetailsBox").innerHTML += sliderHTML;

  /* ===== سلوك السلايدر المحسّن - تحكم يدوي مع دعم اللمس ===== */
  const slider = document.getElementById("simSlider");
  const prevBtn = document.getElementById("simPrev");
  const nextBtn = document.getElementById("simNext");
  
  if (!slider || !prevBtn || !nextBtn) return;

  let isScrolling = false;
  let startX = 0;
  let scrollLeft = 0;
  let isDragging = false;
  const cardWidth = 240; // عرض كل بطاقة + gap

  // تحديث حالة الأزرار
  function updateSliderButtons() {
    const maxScroll = slider.scrollWidth - slider.clientWidth;
    const isAtStart = slider.scrollLeft <= 5;
    const isAtEnd = slider.scrollLeft >= maxScroll - 5;
    
    prevBtn.style.opacity = isAtStart ? "0.3" : "1";
    prevBtn.style.pointerEvents = isAtStart ? "none" : "auto";
    prevBtn.style.cursor = isAtStart ? "not-allowed" : "pointer";
    
    nextBtn.style.opacity = isAtEnd ? "0.3" : "1";
    nextBtn.style.pointerEvents = isAtEnd ? "none" : "auto";
    nextBtn.style.cursor = isAtEnd ? "not-allowed" : "pointer";
  }

  // التنقل بالأزرار
  prevBtn.onclick = () => {
    if (isScrolling || isDragging) return;
    isScrolling = true;
    slider.scrollBy({ left: -cardWidth, behavior: "smooth" });
    setTimeout(() => { 
      isScrolling = false;
      updateSliderButtons();
    }, 300);
  };

  nextBtn.onclick = () => {
    if (isScrolling || isDragging) return;
    isScrolling = true;
    slider.scrollBy({ left: cardWidth, behavior: "smooth" });
    setTimeout(() => { 
      isScrolling = false;
      updateSliderButtons();
    }, 300);
  };

  // دعم اللمس والسحب (Touch & Drag)
  slider.addEventListener('mousedown', (e) => {
    isDragging = true;
    slider.style.cursor = 'grabbing';
    slider.style.scrollBehavior = 'auto';
    startX = e.pageX - slider.offsetLeft;
    scrollLeft = slider.scrollLeft;
    e.preventDefault();
  });

  slider.addEventListener('mouseleave', () => {
    isDragging = false;
    slider.style.cursor = 'grab';
    slider.style.scrollBehavior = 'smooth';
  });

  slider.addEventListener('mouseup', () => {
    isDragging = false;
    slider.style.cursor = 'grab';
    slider.style.scrollBehavior = 'smooth';
    updateSliderButtons();
  });

  slider.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX - slider.offsetLeft;
    const walk = (x - startX) * 2; // سرعة السحب
    slider.scrollLeft = scrollLeft - walk;
  });

  // دعم اللمس للشاشات اللمسية
  let touchStartX = 0;
  let touchScrollLeft = 0;

  slider.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].pageX - slider.offsetLeft;
    touchScrollLeft = slider.scrollLeft;
    slider.style.scrollBehavior = 'auto';
  }, { passive: true });

  slider.addEventListener('touchmove', (e) => {
    if (!touchStartX) return;
    const x = e.touches[0].pageX - slider.offsetLeft;
    const walk = (x - touchStartX) * 1.5; // سرعة السحب باللمس
    slider.scrollLeft = touchScrollLeft - walk;
  }, { passive: true });

  slider.addEventListener('touchend', () => {
    touchStartX = 0;
    slider.style.scrollBehavior = 'smooth';
    updateSliderButtons();
  });

  // تحديث الأزرار عند التمرير
  slider.addEventListener('scroll', () => {
    updateSliderButtons();
  });

  // التهيئة الأولية
  updateSliderButtons();
}


}



async function loadBrandsList(){
  const res = await fetch(API + "/api/brands");
  const brands = await res.json();

  const grid = document.getElementById("brandsGrid");
  grid.innerHTML = "";

  brands.forEach(b=>{
    grid.innerHTML += `
      <div class="brand-box" onclick="go('brand', ${b.id})">
        <div class="brand-circle">
          <img src="${b.image_url || 'https://via.placeholder.com/100'}">
        </div>
        <div class="brand-name">${b.name}</div>
      </div>
    `;
  });
}

async function loadBrandProducts(brand_id){
  const res = await fetch(API + "/api/products");
  const allList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const all = allList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = all;

  const list = all.filter(p => p.brand_id == brand_id);

  const brand = list.length ? list[0].brand_name : "ماركة";
  document.getElementById("brandTitle").innerText = brand;

  // إنشاء شريط التصفية
  const container = document.getElementById('brandProductsContainer');
  if(container) {
    // إزالة الشريط القديم إن وجد
    const oldFilter = document.getElementById('filterBar-brandProductsContainer');
    if(oldFilter) oldFilter.remove();
    createFilterBar('brandProductsContainer', list);
  }

  // عرض المنتجات باستخدام النظام الجديد
  renderProductsWithPagination('brandProductsGrid', list, 'brandProductsPagination', true);

  // ⭐ الحل هنا
  refreshAllAddToCartButtons();
}

function loadCheckout(){
  const box = document.getElementById("checkoutItems");
  box.innerHTML = "";

  let total = 0;

  cart.forEach(item=>{
    let t = item.qty * item.price;
    total += t;

    box.innerHTML += `
      <div style="padding:10px 0;border-bottom:1px solid #eee;">
        ${item.name}  
        <br>
        الكمية: ${item.qty} × ${item.price} = ${t.toFixed(2)} ر.س
      </div>
    `;
  });

  document.getElementById("checkoutTotal").innerText = total.toFixed(2);
}

// إرسال الطلب للباك اند
async function confirmOrder(){
  const name = checkoutName.value.trim();
  const phone = checkoutPhone.value.trim();

  if(!name || !phone){
    alert("الرجاء إدخال الاسم ورقم الجوال");
    return;
  }

const body = {
    customer_name: window.user.name,
    customer_phone: window.user.phone,   // ⭐ مهم جداً — الرقم يأتي من حساب المستخدم فقط
    customer_phone2: phone,               // الرقم الذي يدخله العميل في الفورم (رقم ثانوي)
    customer_address: document.getElementById("co_address").value.trim(),
    customer_location: document.getElementById("co_location").value.trim(),
    customer_notes: document.getElementById("co_notes").value.trim(),

    items: cart.map(item => ({
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: item.base_price,
        discount_value: window.productsCache.find(p => p.id == item.id)?.discount_value || 0,
        discount_type: window.productsCache.find(p => p.id == item.id)?.discount_type || "none"
    }))
};




  const res = await fetch(API + "/api/orders", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if(data.success){
    // تحديث المخزون في productsCache بعد إتمام الطلب
    if (window.productsCache) {
      cart.forEach(item => {
        const product = window.productsCache.find(p => p.id == item.id);
        if (product) {
          const currentStock = parseInt(product.stock || product.quantity || product.stock_qty || 0);
          const newStock = Math.max(0, currentStock - item.qty);
          product.stock = newStock;
          product.quantity = newStock;
          product.stock_qty = newStock; // للتوافق مع الكود القديم
        }
      });
    }
    
    cart = [];
    saveCart();
    updateCartIcon();
    go("thanks", data.order_id);
  }
}


async function trackOrder(){
  const id = trackInput.value.trim();
  if(!id) return;

  const res = await fetch(API + "/api/orders/" + id);
  const data = await res.json();

  const box = document.getElementById("trackResult");

  if(data.error){
    box.innerHTML = "❌ الطلب غير موجود";
    return;
  }

  box.innerHTML = `
    <p>الاسم: ${data.order.customer_name}</p>
    <p>الهاتف: ${data.order.customer_phone}</p>
    <p>الحالة: <b>${data.order.status}</b></p>
    <p>الإجمالي: ${data.order.total} ر.س</p>
  `;
}
// تم نقل جميع دوال المصادقة إلى frontend/js/auth.js

async function loadProfile() {

  if (!window.user) {
    go("login");
    return;
  }

  // تعبئة بيانات العميل
  document.getElementById("pName").innerText = window.user.name || "—";
  document.getElementById("pPhone").innerText = "📱 " + (window.user.phone || "—");
  document.getElementById("pEmail").innerText = "📧 " + (window.user.email || "—");
  document.getElementById("pAddress").innerText = "📍 " + (window.user.address || "—");

  // جلب الطلبات
  const orders = await fetchUserOrders(window.user.phone);

  let html = "";

  if (orders.length === 0) {
    html = `
      <div style="text-align:center;padding:60px 20px;background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);">
        <div style="font-size:64px;margin-bottom:20px;">📦</div>
        <p style="color:#666;font-size:18px;margin:0;">لا توجد طلبات حتى الآن</p>
      </div>
    `;
  } else {
    html += '<div style="display:grid;gap:20px;">';
    orders.forEach(o => {
      
      let st = "";
      let statusText = "";
      let statusIcon = "";
      if (o.status === "new") {
        st = "st-new";
        statusText = "جديد";
        statusIcon = "🆕";
      } else if (o.status === "preparing") {
        st = "st-preparing";
        statusText = "قيد التحضير";
        statusIcon = "👨‍🍳";
      } else if (o.status === "completed") {
        st = "st-completed";
        statusText = "مكتمل";
        statusIcon = "✅";
      } else if (o.status === "out") {
        st = "st-out";
        statusText = "في الطريق";
        statusIcon = "🚚";
      } else if (o.status === "cancelled") {
        st = "st-cancelled";
        statusText = "ملغي";
        statusIcon = "❌";
      }

      // تحويل التاريخ إلى تنسيق أفضل
      const orderDate = o.created_at ? new Date(o.created_at).toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : (o.date || "—");

      html += `
      <div style="
        background:linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius:20px;
        padding:24px;
        box-shadow:0 8px 24px rgba(0,0,0,0.1);
        border:2px solid #e9ecef;
        transition:all 0.3s ease;
        position:relative;
        overflow:hidden;
      " onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 32px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 8px 24px rgba(0,0,0,0.1)'">
        <!-- شريط علوي ملون -->
        <div style="position:absolute;top:0;right:0;left:0;height:5px;background:linear-gradient(90deg, #8a004a 0%, #E91E63 100%);"></div>
        
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:20px;margin-bottom:20px;">
          <div style="flex:1;min-width:200px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
              <div style="
                width:50px;
                height:50px;
                background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
                border-radius:12px;
                display:flex;
                align-items:center;
                justify-content:center;
                font-size:24px;
                color:#fff;
                font-weight:700;
                box-shadow:0 4px 12px rgba(138,0,74,0.3);
              ">#${o.id}</div>
              <div>
                <div style="font-size:14px;color:#999;margin-bottom:4px;">رقم الطلب</div>
                <div style="font-size:20px;font-weight:700;color:#333;">${o.id}</div>
              </div>
            </div>
            
            <div style="margin-bottom:12px;">
              <div style="font-size:13px;color:#666;margin-bottom:4px;">📅 التاريخ</div>
              <div style="font-size:15px;color:#333;font-weight:600;">${orderDate}</div>
            </div>
            
            <div>
              <div style="font-size:13px;color:#666;margin-bottom:4px;">💰 الإجمالي</div>
              <div style="font-size:24px;font-weight:800;color:#8a004a;">${safeNum(o.total_with_shipping || o.total)} ر.س</div>
            </div>
          </div>
          
          <div style="text-align:left;">
            <div style="
              display:inline-flex;
              align-items:center;
              gap:8px;
              padding:10px 18px;
              background:${st === "st-new" ? "linear-gradient(135deg, #0288d1 0%, #0277bd 100%)" : 
                         st === "st-preparing" ? "linear-gradient(135deg, #ff9800 0%, #f57c00 100%)" :
                         st === "st-completed" ? "linear-gradient(135deg, #4caf50 0%, #388e3c 100%)" :
                         st === "st-out" ? "linear-gradient(135deg, #7a004b 0%, #6a0038 100%)" :
                         "linear-gradient(135deg, #f44336 0%, #d32f2f 100%)"};
              color:#fff;
              border-radius:12px;
              font-size:14px;
              font-weight:700;
              box-shadow:0 4px 12px rgba(0,0,0,0.2);
            ">
              <span>${statusIcon}</span>
              <span>${statusText}</span>
            </div>
          </div>
        </div>
        
        <div style="margin-top:20px;padding-top:20px;border-top:2px solid #e9ecef;">
        <button onclick="go('track', ${o.id})" 
                  style="
                    width:100%;
                    padding:14px;
                    background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
                    color:#fff;
                    border:none;
                    border-radius:12px;
                    font-size:16px;
                    font-weight:700;
                    cursor:pointer;
                    box-shadow:0 4px 16px rgba(138,0,74,0.3);
                    transition:all 0.3s ease;
                  " 
                  onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(138,0,74,0.4)'" 
                  onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(138,0,74,0.3)'">
            📦 تتبع الطلب
        </button>
        </div>
      </div>
      `;
    });
    html += '</div>';
  }

  document.getElementById("profileOrders").innerHTML = html;
}

function safeNum(n){
  return (!n || isNaN(n)) ? "0.00" : Number(n).toFixed(2);
}

// ===================== تغيير كلمة المرور =====================
function showChangePasswordModal(){
  document.getElementById("changePasswordModal").style.display = "flex";
  document.getElementById("currentPassword").value = "";
  document.getElementById("newPassword").value = "";
  document.getElementById("confirmPassword").value = "";
  document.getElementById("changePasswordMsg").innerText = "";
}

function hideChangePasswordModal(){
  document.getElementById("changePasswordModal").style.display = "none";
}

async function changePassword(){
  const currentPassword = document.getElementById("currentPassword").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();
  const confirmPassword = document.getElementById("confirmPassword").value.trim();
  const msgBox = document.getElementById("changePasswordMsg");
  
  if(!currentPassword || !newPassword || !confirmPassword){
    msgBox.innerText = "⚠️ يرجى ملء جميع الحقول";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  if(newPassword !== confirmPassword){
    msgBox.innerText = "⚠️ كلمة المرور الجديدة غير متطابقة";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  if(newPassword.length < 6){
    msgBox.innerText = "⚠️ كلمة المرور يجب أن تكون 6 أحرف على الأقل";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  try {
    const res = await fetch(API + "/api/change-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone: window.user.phone,
        current_password: currentPassword,
        new_password: newPassword
      })
    });
    
    const data = await res.json();
    
    if(data.success){
      msgBox.innerText = "✅ تم تغيير كلمة المرور بنجاح!";
      msgBox.style.color = "#28a745";
      setTimeout(() => {
        hideChangePasswordModal();
        alert("✅ تم تغيير كلمة المرور بنجاح!");
      }, 1500);
    } else {
      msgBox.innerText = "❌ " + (data.message || "حدث خطأ أثناء تغيير كلمة المرور");
      msgBox.style.color = "#e74c3c";
    }
  } catch (error) {
    console.error("خطأ:", error);
    msgBox.innerText = "❌ حدث خطأ في الاتصال بالسيرفر";
    msgBox.style.color = "#e74c3c";
  }
}

// إغلاق النافذة عند الضغط خارجها
document.addEventListener('click', function(event) {
  const modal = document.getElementById("changePasswordModal");
  if (event.target === modal) {
    hideChangePasswordModal();
  }
});



async function loadHome(){
  try {
    // البحث في homePage أولاً، ثم page-home
    const homePage = document.getElementById("homePage");
    const pageHome = document.getElementById("page-home");
    const container = homePage || pageHome;
    
    // لا حاجة لإضافة active هنا - go() سيتولى ذلك
    
    const featuredGrid = document.getElementById("featuredGrid");
    const discountGrid = document.getElementById("discountGrid");
    
    // التحقق من وجود العناصر
    if (!featuredGrid) console.warn("featuredGrid not found!");
    if (!discountGrid) console.warn("discountGrid not found!");

  // تحميل الماركات
  const brandsRes = await fetch(API + "/api/brands");
    if(!brandsRes.ok) throw new Error("Failed to load brands");
  const brands = await brandsRes.json();

  // تحميل المنتجات
  const prodRes = await fetch(API + "/api/products");
    if(!prodRes.ok) throw new Error("Failed to load products");
  const productsList = await prodRes.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity وتطبيع مسارات الصور
  const products = productsList.map(p => {
    // تطبيع مسار الصورة إذا كان نسبياً
    let imageUrl = p.image_url;
    if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('data:')) {
      // إذا كان المسار نسبياً وليس يبدأ بـ /، أضف /
      if (!imageUrl.startsWith('/')) {
        imageUrl = '/' + imageUrl;
      }
      // إذا كان المسار يبدأ بـ uploads بدون /، أضف /
      if (imageUrl.startsWith('uploads/')) {
        imageUrl = '/' + imageUrl;
      }
    }
    
    return {
      ...p,
      image_url: imageUrl || p.image_url,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
    };
  });
  
  // تحديث productsCache
  window.productsCache = products;
    
    // تحميل البانرات
    try {
      await loadBannersNew();
    } catch(e) {
      console.error("Error loading banners:", e);
    }

  // ==================== الماركات المميزة ====================
  const slider = document.getElementById("brandsSlider");
    if(slider) {
  slider.innerHTML = "";

      const featuredBrands = brands.filter(b => b.featured == 1);
      
      if(featuredBrands.length > 0) {
        // إضافة نسخ للماركات للـ infinite loop
        const brandsToShow = [...featuredBrands, ...featuredBrands, ...featuredBrands];
        
        brandsToShow.forEach((b, index) => {
      slider.innerHTML += `
            <div class="brand-box" data-brand-index="${index}" onclick="go('brand', ${b.id})">
          <div class="brand-circle">
            <img src="${b.image_url || 'https://via.placeholder.com/120'}">
          </div>
          <div class="brand-name">${b.name}</div>
        </div>
      `;
    });
        
        // تهيئة السلايدر التلقائي بعد تحميل الماركات
        setTimeout(() => {
          try {
            initBrandsAutoSlider();
            updateBrandsVisibility();
          } catch(e) {
            console.error("Error initializing brands slider:", e);
          }
        }, 500);
      }
    }

  // ==================== المنتجات المميزة ====================
    if(featuredGrid) {
  featuredGrid.innerHTML = "";

      const featuredProducts = products.filter(p => p.featured == 1);
      if(featuredProducts.length > 0) {
        featuredProducts.slice(0, 15).forEach(p => {
          try {
      featuredGrid.innerHTML += makeProductCard(p);
          } catch(e) {
            console.error("Error creating product card:", e);
          }
    });
      } else {
        featuredGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">لا توجد منتجات مميزة حالياً</p>';
      }
    }

  // ==================== العروض (خصومات) ====================
    if(discountGrid) {
  discountGrid.innerHTML = "";

      const discountProducts = products.filter(p => p.discount_value > 0);
      if(discountProducts.length > 0) {
        discountProducts.slice(0, 15).forEach(p => {
          try {
      discountGrid.innerHTML += makeProductCard(p);
          } catch(e) {
            console.error("Error creating product card:", e);
          }
    });
      } else {
        discountGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">لا توجد عروض حالياً</p>';
      }
    }
	
  // تحديث الأزرار بعد إعادة بناء الصفحة
    try {
  refreshAllAddToCartButtons();
      // تحديث التقييمات بعد تحميل المنتجات
      setTimeout(() => {
        updateAllProductRatings();
      }, 200);
    } catch(e) {
      console.error("Error refreshing buttons:", e);
    }
  } catch(error) {
    console.error("Error in loadHome:", error);
    const featuredGrid = document.getElementById("featuredGrid");
    const discountGrid = document.getElementById("discountGrid");
    if(featuredGrid) {
      featuredGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#e74c3c;">حدث خطأ في تحميل المنتجات</p>';
    }
    if(discountGrid) {
      discountGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#e74c3c;">حدث خطأ في تحميل العروض</p>';
    }
  }
}

// دالة إنشاء skeleton cards
function generateSkeletonCards(count) {
  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-title"></div>
        <div class="skeleton-title-small"></div>
        <div class="skeleton-price"></div>
      </div>
    `;
  }
  return html;
}

// تم نقل كود البانرات إلى ملف frontend/js/banners.js
function makeProductCard(p){
  const wishlistArray = wishlist || JSON.parse(localStorage.getItem("wishlist") || "[]");
  const isFav = wishlistArray.includes(p.id);
  const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  const isOutOfStock = stock <= 0;
  const showStockBadge = stock > 0 && stock <= 6;

  return `
    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" style="position:relative;" onclick="go('product', ${p.id})">

      <!-- الصورة + الخصم -->
      <div style="position:relative;margin:-16px -16px 12px -16px;overflow:hidden;border-radius:24px 24px 0 0;">

        <!-- زر القلب في أعلى الكارت -->
        <div onclick="event.stopPropagation(); toggleWishlist(${p.id});"
             style="
               position:absolute;
               top:12px;
               left:12px;
               font-size:22px;
               cursor:pointer;
               z-index:30;
               color:${isFav ? '#E91E63' : '#bbb'};
               background:rgba(255,255,255,0.9);
               width:36px;
               height:36px;
               border-radius:50%;
               display:flex;
               align-items:center;
               justify-content:center;
               box-shadow:0 2px 8px rgba(0,0,0,0.1);
               transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
             "
             onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 4px 12px rgba(233, 30, 99, 0.3)'"
             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
          ❤
        </div>

        <!-- الخصم في أسفل يمين الصورة -->
        ${
          p.discount_value > 0
          ? `<div style="
                position:absolute;
                bottom:8px;
                right:8px;
                background:#00a6ff;
                color:white;
                padding:3px 10px;
                font-size:12px;
                border-radius:20px;
                font-weight:600;
                white-space:nowrap;
                z-index:20;
              ">
              خصم ${p.discount_value}${p.discount_type === 'percent' ? "%" : ""}
             </div>`
          : ``
        }

        <!-- الصورة -->
        <img class="product-img"
             src="${safeImageURL(p.image_url)}"
             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'Arial\' font-size=\'12\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3Eلا توجد صورة%3C/text%3E%3C/svg%3E';"
             loading="lazy"
             style="${isOutOfStock ? 'filter: grayscale(100%); opacity: 0.5; cursor:pointer;' : 'cursor:pointer;'}"/>
      </div>

      <!-- اسم المنتج -->
      <h3 class="product-name"
          style="font-size:12px; line-height:1.35; height:40px; overflow:hidden; margin:6px 0; cursor:pointer;">
        ${p.name}
      </h3>

      <!-- منطقة الأسعار -->
      <div class="price-row"
           style="display:flex;align-items:center;gap:8px;margin-top:6px;flex-direction:row-reverse;">

        <!-- حساب السعر -->
${(() => {
  const prices = calculateFinalPrice(p);

  return `
    <div style="display:flex;align-items:center;gap:8px;flex-direction:row-reverse;">

      <!-- السعر النهائي -->
      <div style="
        font-size:18px;
        font-weight:800;
        color:${p.discount_value > 0 ? '#E91E63' : '#8a004a'};
        white-space:nowrap;
        background:linear-gradient(135deg, ${p.discount_value > 0 ? '#E91E63' : '#8a004a'} 0%, ${p.discount_value > 0 ? '#c2185b' : '#6a0038'} 100%);
        -webkit-background-clip:text;
        -webkit-text-fill-color:transparent;
        background-clip:text;
        text-shadow:0 2px 4px rgba(138, 0, 74, 0.1);
      ">
        ${prices.final} ر.س
      </div>

      <!-- السعر قبل الخصم -->
      ${
        p.discount_value > 0 
        ? `<div style="
              font-size:13px;
              color:#999;
              text-decoration:line-through;
              white-space:nowrap;
              opacity:0.7;
              position:relative;
            ">
              ${prices.before} ر.س
           </div>`
        : ``
      }

    </div>
  `;
})()}

      </div>

      <!-- النجوم -->
      <div class="product-rating" data-product-id="${p.id}" style="display:flex;align-items:center;gap:4px;margin-top:2px;">
        <div class="stars-container" style="display:flex;gap:2px;">
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
        </div>
        <span class="rating-value" style="font-size:12px;color:#666;font-weight:600;">0.0</span>
      </div>

      <!-- زر السلة -->
      <button 
        id="cart-btn-${p.id}"
        onclick="event.stopPropagation(); ${isOutOfStock ? 'return false;' : `addToCart(${p.id})`}"
        class="add-cart"
        ${isOutOfStock ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
        <span>${isOutOfStock ? '❌' : '🛒'}</span>
        <span>${isOutOfStock ? 'الكمية منتهية' : 'أضف للسلة'}</span>
      </button>

    </div>
  `;
}


// ========================== السلة ==========================

let cart = JSON.parse(localStorage.getItem("cart") || "[]");

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
}

function openCart(){
  const overlay = document.getElementById("cartOverlay");
  const panel = document.getElementById("cartPanel");
  
  if (!overlay || !panel) {
    console.error("Cart elements not found!");
    return;
  }
  
  // تحديث محتوى السلة أولاً
  renderCart();
  
  // ثم فتح اللوحة
  overlay.style.display = "block";
  if(window.innerWidth <= 768) {
  panel.style.right = "0px";
    panel.classList.add("open");
  } else {
    panel.style.right = "0px";
    panel.classList.add("open");
  }
}

function closeCart(){
  document.getElementById("cartOverlay").style.display = "none";
  const panel = document.getElementById("cartPanel");
  panel.style.right = window.innerWidth <= 768 ? "-85%" : "-350px";
  panel.classList.remove("open");
}

async function addToCart(id){
  // إظهار دائرة التحميل في جميع الأزرار التي تحتوي على هذا المنتج
  // البحث عن جميع الأزرار باستخدام querySelectorAll
  const allButtons = document.querySelectorAll(`[id="cart-btn-${id}"]`);
  const productBtn = document.getElementById("productAddBtn");
  
  let originalBtnTexts = [];
  let originalProductBtnText = "";
  
  // إضافة loading لجميع الأزرار الموجودة في الصفحة
  allButtons.forEach((btn, index) => {
    if(btn) {
      btn.classList.add("loading");
      originalBtnTexts[index] = btn.innerHTML;
      btn.innerHTML = '<span style="opacity:0;">أضف للسلة</span>';
      btn.disabled = true;
    }
  });
  
  if(productBtn && productBtn.getAttribute("data-id") == id) {
    productBtn.classList.add("loading");
    originalProductBtnText = productBtn.innerHTML;
    productBtn.innerHTML = '<span style="opacity:0;">أضف للسلة</span>';
    productBtn.disabled = true;
  }

  try {
    // تحميل المنتجات من API (إعادة تحميل إذا لم تكن موجودة)
  if(!window.productsCache){
    const res = await fetch(API + "/api/products");
    const productsList = await res.json();
    
    // التأكد من أن جميع المنتجات لديها stock و quantity
    window.productsCache = productsList.map(p => ({
      ...p,
        stock: parseInt(p.stock || p.quantity || 0),
        quantity: parseInt(p.quantity || p.stock || 0),
        stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
    }));
  }
    
    // إعادة تحميل المنتج المحدد من السيرفر للتأكد من أحدث بيانات المخزون
    const productRes = await fetch(API + "/api/products");
    const allProducts = await productRes.json();
    const updatedProduct = allProducts.find(p => p.id == id);
    if(updatedProduct && window.productsCache){
      const productIndex = window.productsCache.findIndex(p => p.id == id);
      if(productIndex !== -1){
        window.productsCache[productIndex] = {
          ...updatedProduct,
          stock: parseInt(updatedProduct.stock || updatedProduct.quantity || 0),
          quantity: parseInt(updatedProduct.quantity || updatedProduct.stock || 0),
          stock_qty: parseInt(updatedProduct.stock || updatedProduct.quantity || 0)
        };
      }
  }

  const p = window.productsCache.find(x => x.id == id);
    if(!p) {
      // إعادة تعيين جميع الأزرار
      allButtons.forEach((btn, index) => {
        if(btn) {
          btn.classList.remove("loading");
          btn.disabled = false;
          btn.innerHTML = originalBtnTexts[index] || "أضف للسلة";
        }
      });
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText; }
      return;
    }

  // التحقق من المخزون
    const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  if(stock <= 0){
      showNotification("عذراً، هذا المنتج غير متوفر حالياً", 'warning');
      // إعادة تعيين جميع الأزرار
      allButtons.forEach((btn) => {
        if(btn) {
          btn.classList.remove("loading");
          btn.disabled = false;
          btn.innerHTML = "الكمية منتهية";
        }
      });
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = '<span>❌</span><span>الكمية منتهية</span>'; }
    return;
  }

  // هل المنتج موجود في السلة
  let item = cart.find(x => x.id == id);
  const currentQty = item ? item.qty : 0;
  const newQty = currentQty + 1;

  // التحقق من أن الكمية المطلوبة لا تتجاوز المخزون
  if(newQty > stock){
      showNotification(`عذراً، الكمية المتاحة في المخزون هي ${stock} حبة فقط`, 'warning');
      // إعادة تعيين جميع الأزرار
      allButtons.forEach((btn, index) => {
        if(btn) {
          btn.classList.remove("loading");
          btn.disabled = false;
          btn.innerHTML = originalBtnTexts[index] || "أضف للسلة";
        }
      });
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText; }
    return;
  }

  if(item){
    item.qty = newQty;
  } else {
    // حسابات الأسعار
let base = parseFloat(p.base_price) || 0;
let discountValue = parseFloat(p.discount_value) || 0;
let discountType = p.discount_type;

let priceAfterDiscount = base;

if (discountValue > 0) {
    if (discountType === "percent") {
        priceAfterDiscount = base - (base * (discountValue / 100));
    } else if (discountType === "fixed") {
        priceAfterDiscount = base - discountValue;
    }
}

let priceWithVat = VATCalculator.addVAT(priceAfterDiscount);

item = {
    id: p.id,
    name: p.name,
    qty: 1,
    image: p.image_url,

    // مهم جداً — يُرسل إلى الطلب وإلى orders.html
    base_price: base,
    price_after_discount: priceAfterDiscount.toFixed(2),
    price_with_vat: priceWithVat.toFixed(2),
    total: priceWithVat.toFixed(2)   // للقطعة الواحدة
};

    cart.push(item);
  }

  saveCart();
  renderCart();
  updateCartIcon();
  
  // تحديث الأزرار فقط بدون إعادة تحميل الصفحة
  refreshAllAddToCartButtons();
  
  // تحديث صفحة المنتج فقط إذا كنا فيها
  const activePage = document.querySelector(".page.active");
  const active = activePage ? activePage.id : "";
  if(active === "page-product") {
    const productId = window.currentProductId;
    if(productId && productId == id) {
      loadProductDetails(productId);
    }
  }

  // فتح لوحة السلة تلقائياً عند إضافة منتج
  openCart();

  // تحديث جميع أزرار الكرت للمنتج
  allButtons.forEach((btn) => {
    if(btn){
      btn.classList.remove("loading");
      btn.disabled = false;
      btn.innerHTML = `مضاف للسلة +${item.qty}`;
      btn.style.background = "#8a004a";
      btn.style.color = "#fff";
      btn.classList.add("added");
    }
  });

  // تحديث زر صفحة المنتج
    if(productBtn && productBtn.getAttribute("data-id") == id) {
      productBtn.classList.remove("loading");
      productBtn.disabled = false;
      productBtn.innerHTML = `<span>🛒</span><span>مضاف للسلة +${item.qty}</span>`;
      productBtn.classList.add("added");
    } else {
  updateProductPageButton(id);
    }
  } catch(error) {
    console.error("Error adding to cart:", error);
    // إعادة تعيين جميع الأزرار في حالة الخطأ
    allButtons.forEach((btn, index) => {
      if(btn) {
        btn.classList.remove("loading");
        btn.disabled = false;
        btn.innerHTML = originalBtnTexts[index] || "أضف للسلة";
      }
    });
    if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText || '<span>🛒</span><span>أضف للسلة</span>'; }
    alert("⚠️ حدث خطأ أثناء إضافة المنتج للسلة");
  }
}



function removeItem(id){
  cart = cart.filter(x => x.id != id);

  saveCart();
  renderCart();          // تحديث السلة الجانبية
  renderCheckoutPage();  // تحديث صفحة إتمام الطلب
  updateCartIcon();
  refreshAllAddToCartButtons();
  updateProductPageButton(id);
}





function changeQty(id, q){
  const item = cart.find(x => x.id == id);
  if(!item) return;

  // منع تقليل الكمية عن 1 - فقط زر الحذف يحذف المنتج
  if(q < 0 && item.qty <= 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من أن الكمية الجديدة لن تقل عن 1
  if(q < 0 && (item.qty + q) < 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من المخزون
  if(!window.productsCache){
    // إذا لم يتم تحميل المنتجات، استمر بدون تحقق
    item.qty += q;
  } else {
    const p = window.productsCache.find(x => x.id == id);
    if(p){
      const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
      const newQty = item.qty + q;
      
      if(newQty > stock){
        showNotification(`عذراً، الكمية المتاحة في المخزون هي ${stock} حبة فقط`, 'warning');
        return;
      }
    }
    
    item.qty += q;
  }

  // التأكد من أن الكمية لا تقل عن 1
  if(item.qty < 1){
    item.qty = 1;
  }

  saveCart();
  renderCart();
  renderCheckoutPage();  // ← تحديث صفحة إتمام الطلب

  updateCartIcon();
  refreshAllAddToCartButtons();
  updateProductPageButton(id);
}



function renderCart() {
  const box = document.getElementById("cartItems");
  const totalBox = document.getElementById("cartTotal");

  if (!box || !totalBox) {
    console.error("Cart elements not found!");
    return;
  }

  box.innerHTML = "";
  let total = 0;

  // إذا كانت السلة فارغة
  if (cart.length === 0) {
    box.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#999;">
        <div style="font-size:48px;margin-bottom:10px;">🛒</div>
        <div style="font-size:16px;">السلة فارغة</div>
        <div style="font-size:14px;margin-top:5px;">أضف منتجات للبدء</div>
      </div>
    `;
    totalBox.innerText = "0.00";
    return;
  }

  cart.forEach(item => {

// جلب بيانات المنتج الأصلية
let p = window.productsCache?.find(x => x.id == item.id);

// إذا لم يتم العثور على المنتج، استخدم البيانات المحفوظة في السلة
if (!p) {
  // استخدام البيانات المحفوظة في السلة
  box.innerHTML += `
    <div style="display:flex; align-items:flex-start; gap:10px; margin-bottom:15px;">
      <img src="${safeImageURL(item.image)}"
           onerror="this.src='https://via.placeholder.com/80?text=No+Img'"
           style="width:60px; height:60px; object-fit:cover; border-radius:10px;">
      <div style="flex:1;">
        <div style="font-weight:600; color:#333; margin-bottom:4px; font-size:13px; line-height:1.4; max-height:2.8em; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
          ${item.name}
        </div>
        <div style="font-size:17px; font-weight:bold; color:#8a004a;">
          ${item.price_with_vat || item.total} ر.س × ${item.qty}
        </div>
        <button onclick="removeItem(${item.id})" style="background:#ffd6e3;color:#E91E63;border:none;padding:5px 10px;border-radius:6px;font-size:13px;margin-top:5px;">حذف</button>
      </div>
    </div>
  `;
  total += parseFloat(item.price_with_vat || item.total || 0) * item.qty;
  return; // تخطي باقي الكود لهذا العنصر
}

let base = parseFloat(p.base_price) || 0;
let discountValue = parseFloat(p.discount_value) || 0;
let discountType = p.discount_type || "none";

// السعر الأساسي مع الضريبة (استخدام VATCalculator)
let beforePrice = VATCalculator.addVAT(base);

// السعر بعد الخصم
let priceAfterDiscount = base;

if (discountValue > 0) {
  if (discountType === "percent") {
    priceAfterDiscount = base - (base * (discountValue / 100));
  } else if (discountType === "fixed") {
    priceAfterDiscount = base - discountValue;
  }
}

// السعر بعد الخصم + الضريبة (استخدام VATCalculator)
let finalPrice = VATCalculator.addVAT(priceAfterDiscount);

// مجموع هذا المنتج
let lineTotal = finalPrice * item.qty;
total += lineTotal;


    box.innerHTML += `
      <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:18px; padding:12px; background:#f9f9f9; border-radius:12px; border:1px solid #f0f0f0; transition:all 0.3s ease;">

        <img src="${safeImageURL(item.image)}"
             onerror="this.src='https://via.placeholder.com/80?text=No+Img'"
             style="width:70px; height:70px; object-fit:cover; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); flex-shrink:0;">

        <div style="flex:1; display:flex; flex-direction:column; min-width:0;">

          <div style="font-weight:600; color:#333; margin-bottom:4px; line-height:1.4; font-size:12px; max-height:2.8em; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
            ${item.name}
          </div>

          <div style="margin-bottom:5px;">

            ${
  discountValue > 0
  ? `
      <!-- السعر قبل الخصم -->
      <div style="
        font-size:12px;
        color:#999;
        text-decoration:line-through;
        white-space:nowrap;
      ">
        ${beforePrice.toFixed(2)} ر.س
      </div>

      <!-- السعر النهائي -->
      <div style="
        font-size:17px;
        font-weight:bold;
        color:red;
        white-space:nowrap;
      ">
        ${finalPrice.toFixed(2)} ر.س
      </div>
    `
  : `
      <!-- السعر النهائي لمنتج بدون خصم -->
      <div style="
        font-size:17px;
        font-weight:bold;
        color:#006b6a;
        white-space:nowrap;
      ">
        ${beforePrice.toFixed(2)} ر.س
      </div>
    `
}


          </div>

          <div style="display:flex; align-items:center; gap:6px;">

            ${item.qty <= 1 
              ? `<button disabled onclick="return false;" style="background:#e0e0e0; border:1px solid #ccc; border-radius:8px; padding:6px 10px; font-size:14px; cursor:not-allowed; opacity:0.7; color:#999; pointer-events:none; user-select:none; font-weight:bold;" title="الكمية لا يمكن أن تقل عن 1 - استخدم زر الحذف لحذف المنتج">-</button>`
              : `<button onclick="changeQty(${item.id}, -1)" style="background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:6px 10px; font-size:14px; cursor:pointer; font-weight:bold; color:#666; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);" title="تقليل الكمية">-</button>`
            }

            <span style="font-size:15px; font-weight:bold; min-width:24px; text-align:center; color:#333;">
              ${item.qty}
            </span>

            <button onclick="changeQty(${item.id}, +1)"
              style="background:#fff; border:1px solid #e0e0e0; border-radius:8px;
                     padding:6px 10px; font-size:14px; cursor:pointer; font-weight:bold; color:#666; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">+</button>

            <button onclick="removeItem(${item.id})"
              style="background:linear-gradient(135deg, #ffe6f0 0%, #ffd6e3 100%); border:none; border-radius:8px;
                     padding:6px 12px; font-size:12px; color:#E91E63; cursor:pointer; font-weight:600; margin-right:auto; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(233, 30, 99, 0.2);">🗑️ حذف</button>

          </div>

        </div>
      </div>
    `;
  });

  totalBox.innerText = total.toFixed(2);
}

// ========== تحديث أزرار السلة لكل المنتجات ==========
function refreshAllAddToCartButtons() {
  // تحديث الأزرار فقط بدون إعادة بناء DOM
  // هذا يمنع فقدان حالة Pagination
  document.querySelectorAll("[id^='cart-btn-']").forEach(btn => {
    // التحقق من أن الزر موجود في DOM
    if(!btn || !btn.parentElement) return;
    
    const id = Number(btn.id.replace("cart-btn-", ""));
    const item = cart.find(x => x.id === id);

    if (item) {
      // إذا المنتج موجود في السلة
      btn.innerText = `مضاف للسلة +${item.qty}`;
      btn.style.background = "#8a004a";
      btn.style.color = "#fff";
      btn.classList.add("added");
    } else {
      // إذا المنتج غير موجود → أرجع الشكل الطبيعي
      btn.innerText = "أضف للسلة";
      btn.style.background = "";
      btn.style.color = "";
      btn.classList.remove("added");
    }
  });

  // نفس الشيء لزر صفحة المنتج
  const productBtn = document.getElementById("productAddBtn");
  if (productBtn) {
    const productId = Number(productBtn.getAttribute("data-id"));
    const item = cart.find(x => x.id === productId);

    if (item) {
      productBtn.innerText = `مضاف للسلة +${item.qty}`;
      productBtn.style.background = "#8a004a";
      productBtn.style.color = "#fff";
      productBtn.classList.add("added");
    } else {
      productBtn.innerText = "أضف للسلة";
      productBtn.style.background = "";
      productBtn.style.color = "";
      productBtn.classList.remove("added");
    }
  }
}



// ========== تحديث زر السلة داخل صفحة المنتج ==========
function updateProductPageButton(id){
  const btn = document.getElementById("productAddBtn");
  if(!btn) return;

  // التحقق من الكمية أولاً
  const p = window.productsCache?.find(x => x.id == id);
  if(p) {
    const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
    const isOutOfStock = stock <= 0;
    
    // إذا كانت الكمية منتهية، لا نغير الزر
    if(isOutOfStock) {
      btn.classList.add("out-of-stock-btn");
      btn.disabled = true;
      btn.innerHTML = '<span>❌</span><span>الكمية منتهية</span>';
      return;
    }
  }

  const item = cart.find(x => x.id == id);

  if(item){
    btn.innerHTML = `<span>🛒</span><span>مضاف للسلة +${item.qty}</span>`;
    btn.classList.add("added");
    btn.classList.remove("out-of-stock-btn");
    btn.disabled = false;
  }
  else {
    btn.innerHTML = '<span>🛒</span><span>أضف للسلة</span>';
    btn.classList.remove("added");
    btn.classList.remove("out-of-stock-btn");
    btn.disabled = false;
  }
}







// ========== تحديث عداد السلة في الهيدر ==========
function updateCartIcon(){
  const count = cart.reduce((sum, item) => sum + item.qty, 0);
  const badge = document.getElementById("cartCount");

  if(!badge) return;

  if(count > 0){
    badge.style.display = "inline-block";
    badge.innerText = count;
  } else {
    badge.style.display = "none";
  }
}

function goToCheckout() {

  if (cart.length === 0) {
    alert("⚠️ لا يمكنك إتمام الطلب — السلة فارغة");
    return;
  }

  // التحقق من تسجيل الدخول
  if (!window.user || !window.user.phone) {
    showLoginRequiredModal();
    return;
  }

  closeCart();
  go("checkout");
}

function showLoginRequiredModal() {
  const modal = document.getElementById("loginRequiredModal");
  if (modal) {
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
}

function closeLoginRequiredModal() {
  const modal = document.getElementById("loginRequiredModal");
  if (modal) {
    modal.style.display = "none";
    document.body.style.overflow = "";
  }
}

function goToLoginFromModal() {
  closeLoginRequiredModal();
  closeCart();
  go("login");
}

// إغلاق الـ modal عند الضغط على الخلفية
document.addEventListener("click", function(event) {
  const modal = document.getElementById("loginRequiredModal");
  if (modal && event.target === modal) {
    closeLoginRequiredModal();
  }
});

// إغلاق الـ modal عند الضغط على ESC
document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    const modal = document.getElementById("loginRequiredModal");
    if (modal && modal.style.display === "flex") {
      closeLoginRequiredModal();
    }
    const wishlistModal = document.getElementById("wishlistLoginModal");
    if (wishlistModal && wishlistModal.style.display === "flex") {
      closeWishlistLoginModal();
    }
  }
});

// ===================== Modal المفضلة =====================
function showWishlistLoginModal() {
  const modal = document.getElementById("wishlistLoginModal");
  if (modal) {
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
}

function closeWishlistLoginModal() {
  const modal = document.getElementById("wishlistLoginModal");
  if (modal) {
    modal.style.display = "none";
    document.body.style.overflow = "";
  }
}

function goToLoginFromWishlistModal() {
  closeWishlistLoginModal();
  if (typeof go === 'function') {
    go("login");
  } else if (typeof window.go === 'function') {
    window.go("login");
  } else {
    window.location.hash = "#login";
  }
}

// إغلاق الـ modal عند الضغط على الخلفية
document.addEventListener("click", function(event) {
  const modal = document.getElementById("wishlistLoginModal");
  if (modal && event.target === modal) {
    closeWishlistLoginModal();
  }
});

// ===================== نظام السلايدر التلقائي للماركات =====================
let brandsAutoSlideInterval = null;
let brandsSliderPaused = false;

// التمرير اليدوي بالسهام
function scrollBrands(px){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  pauseBrandsAutoSlide();
  
  slider.scrollBy({
    left: px,
    behavior: "smooth"
  });
  
  setTimeout(() => {
    updateBrandsVisibility();
    resumeBrandsAutoSlide();
  }, 600);
}

// تحديث حالة الماركات الجانبية (شفافة/blur)
function updateBrandsVisibility(){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  const brands = slider.querySelectorAll('.brand-box');
  if(brands.length === 0) return;
  
  const sliderRect = slider.getBoundingClientRect();
  const sliderCenter = sliderRect.left + sliderRect.width / 2;
  
  brands.forEach((brand) => {
    const brandRect = brand.getBoundingClientRect();
    const brandCenter = brandRect.left + brandRect.width / 2;
    const distance = Math.abs(brandCenter - sliderCenter);
    const threshold = sliderRect.width / 2.5;
    
    if(distance > threshold) {
      brand.classList.add('side');
    } else {
      brand.classList.remove('side');
    }
  });
}

// إيقاف السلايدر التلقائي
function pauseBrandsAutoSlide(){
  brandsSliderPaused = true;
}

// استئناف السلايدر التلقائي
function resumeBrandsAutoSlide(){
  brandsSliderPaused = false;
}

// تهيئة السلايدر التلقائي - تصميم جديد محسّن
function initBrandsAutoSlider(){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  // إيقاف السلايدر السابق
  if(brandsAutoSlideInterval) {
    clearInterval(brandsAutoSlideInterval);
    brandsAutoSlideInterval = null;
  }
  
  const featuredBrands = slider.querySelectorAll('.brand-box');
  if(featuredBrands.length === 0) return;
  
  // حساب عدد الماركات الأصلي (3 نسخ)
  const originalCount = Math.floor(featuredBrands.length / 3);
  if(originalCount === 0) return;
  
  // انتظار لضمان تحميل العناصر
  setTimeout(() => {
    const isMobile = window.innerWidth <= 768;
    const firstBrand = featuredBrands[0];
    if(!firstBrand) return;
    
    // حساب الأبعاد بدقة
    const cardWidth = firstBrand.offsetWidth || (isMobile ? (slider.clientWidth - 100) / 3 : 120);
    const gap = isMobile ? 18 : 15;
    const scrollAmount = cardWidth + gap;
    
    // بدء من أول ماركة (البداية) - تأكد من البداية
    slider.scrollLeft = 0;
    updateBrandsVisibility();
    
    // تفعيل السلايدر
    brandsSliderPaused = false;
    
    // دالة التمرير التلقائي - من اليسار لليمين (المنتجات تتحرك ناحية اليمين)
    function autoSlide() {
      if(brandsSliderPaused) return;
      
      const currentScroll = slider.scrollLeft;
      const maxScroll = slider.scrollWidth - slider.clientWidth;
      const nextScroll = currentScroll + scrollAmount;
      
      // إذا وصلنا للنهاية - العودة للبداية تلقائياً بدون توقف
      if(nextScroll >= maxScroll - scrollAmount/2) {
        // العودة للبداية بدون animation
        slider.scrollLeft = 0;
        updateBrandsVisibility();
        
        // نكمل التمرير مباشرة بعد العودة (من أول ماركة)
        requestAnimationFrame(() => {
          setTimeout(() => {
            slider.scrollTo({
              left: scrollAmount,
              behavior: 'smooth'
            });
            setTimeout(() => updateBrandsVisibility(), 300);
          }, 50);
        });
      } else {
        // التمرير العادي - من اليسار لليمين (المنتجات تتحرك ناحية اليمين)
        slider.scrollTo({
          left: nextScroll,
          behavior: 'smooth'
        });
        setTimeout(() => updateBrandsVisibility(), 300);
      }
    }
    
    // بدء السلايدر التلقائي - 0.7 ثانية
    brandsAutoSlideInterval = setInterval(autoSlide, 700);
    
    // بدء التمرير الأول بعد 0.5 ثانية
    setTimeout(() => {
      if(!brandsSliderPaused) {
        autoSlide();
      }
    }, 500);
    
    // إدارة التمرير اليدوي
    let isUserScrolling = false;
    let scrollTimeout;
    let lastScrollTime = 0;
    let manualScrollResumeTimeout = null;
    
    const handleScroll = () => {
      const now = Date.now();
      updateBrandsVisibility();
      
      // إذا كان التمرير سريع جداً، فهو يدوي
      if(now - lastScrollTime < 100) {
        isUserScrolling = true;
        // إيقاف السلايدر التلقائي فوراً
        pauseBrandsAutoSlide();
        
        // إلغاء أي timeout سابق
        if(manualScrollResumeTimeout) {
          clearTimeout(manualScrollResumeTimeout);
          manualScrollResumeTimeout = null;
        }
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          isUserScrolling = false;
          // إيقاف السلايدر لمدة 8 ثوانٍ بعد التمرير اليدوي
          manualScrollResumeTimeout = setTimeout(() => {
            resumeBrandsAutoSlide();
            manualScrollResumeTimeout = null;
          }, 8000); // 8 ثوانٍ
        }, 500);
      }
      
      lastScrollTime = now;
    };
    
    slider.addEventListener('scroll', handleScroll, { passive: true });
    
    // إيقاف عند hover
    slider.addEventListener('mouseenter', () => {
      pauseBrandsAutoSlide();
    });
    
    slider.addEventListener('mouseleave', () => {
      resumeBrandsAutoSlide();
    });
    
    // إيقاف عند touch - تحسين للجوال
    let touchStartX = 0;
    let touchStartY = 0;
    let isTouching = false;
    let touchResumeTimeout = null;
    
    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isTouching = true;
      pauseBrandsAutoSlide();
      // إلغاء أي timeout سابق
      if(touchResumeTimeout) {
        clearTimeout(touchResumeTimeout);
        touchResumeTimeout = null;
      }
    }, { passive: true });
    
    slider.addEventListener('touchmove', (e) => {
      if(!isTouching) return;
      // إيقاف السلايدر أثناء الحركة
      pauseBrandsAutoSlide();
      // إلغاء أي timeout سابق
      if(touchResumeTimeout) {
        clearTimeout(touchResumeTimeout);
        touchResumeTimeout = null;
      }
    }, { passive: true });
    
    slider.addEventListener('touchend', () => {
      isTouching = false;
      // إيقاف السلايدر لمدة 8 ثوانٍ بعد اللمس للسماح للمستخدم بالتفاعل
      if(touchResumeTimeout) {
        clearTimeout(touchResumeTimeout);
      }
      touchResumeTimeout = setTimeout(() => {
        resumeBrandsAutoSlide();
        touchResumeTimeout = null;
      }, 8000); // 8 ثوانٍ بدلاً من 3
    }, { passive: true });
    
    // إيقاف السلايدر عند النقر على أي ماركة
    const brandBoxes = slider.querySelectorAll('.brand-box');
    brandBoxes.forEach(box => {
      box.addEventListener('click', () => {
        pauseBrandsAutoSlide();
        // إلغاء أي timeout سابق
        if(touchResumeTimeout) {
          clearTimeout(touchResumeTimeout);
          touchResumeTimeout = null;
        }
        if(manualScrollResumeTimeout) {
          clearTimeout(manualScrollResumeTimeout);
          manualScrollResumeTimeout = null;
        }
        // إيقاف السلايدر لمدة 10 ثوانٍ بعد النقر
        touchResumeTimeout = setTimeout(() => {
          resumeBrandsAutoSlide();
          touchResumeTimeout = null;
        }, 10000);
      });
    });
  }, 600);
}
async function loadOffers(){
  const res = await fetch(API + "/api/products");
  const productsList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;

  const offers = products.filter(p => p.discount_value > 0);

  // إنشاء شريط التصفية
  const container = document.getElementById('offersContainer');
  if(container) {
    // إزالة الشريط القديم إن وجد
    const oldFilter = document.getElementById('filterBar-offersContainer');
    if(oldFilter) oldFilter.remove();
    createFilterBar('offersContainer', offers);
  }

  // عرض المنتجات باستخدام النظام الجديد
  renderProductsWithPagination('offersGrid', offers, 'offersPagination', true);

  // ⭐ الحل هنا
  refreshAllAddToCartButtons();
}

async function loadCategories(){
  const res = await fetch(API + "/api/products");
  const products = await res.json();

  // استخراج التصنيفات بدون تكرار
  let cats = {};

  products.forEach(p=>{
    if(p.category){
      cats[p.category] = true;
    }
  });

  const list = Object.keys(cats);

  const box = document.getElementById("categoriesList");
  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = "<p>لا يوجد تصنيفات</p>";
    return;
  }

  list.forEach(cat=>{
    box.innerHTML += `
      <div onclick="go('category', '${cat}')" 
           style="background:#f9d9e6;padding:20px;border-radius:14px;text-align:center;font-size:16px;color:#8a004a;font-weight:600;cursor:pointer;">
        ${cat}
      </div>
    `;
  });

}
async function loadCategoryProducts(catName){
  const res = await fetch(API + "/api/products");
  const productsList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;

  const filtered = products.filter(p => p.category === catName);

  document.getElementById("categoryTitle").innerText = "تصنيف: " + catName;

  // إنشاء شريط التصفية
  const container = document.getElementById('categoryContainer');
  if(container) {
    // إزالة الشريط القديم إن وجد
    const oldFilter = document.getElementById('filterBar-categoryContainer');
    if(oldFilter) oldFilter.remove();
    createFilterBar('categoryContainer', filtered);
  }

  // عرض المنتجات باستخدام النظام الجديد
  renderProductsWithPagination('categoryGrid', filtered, 'categoryPagination', true);

  // ⭐ الحل هنا
  refreshAllAddToCartButtons();
}



let headerProductsCache = [];

// ===================== وظائف البحث للجوال =====================
function toggleMobileSearch() {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  const searchInput = document.getElementById("headerSearchMobile");
  const logo = document.querySelector(".logo");
  
  if (searchContainer && searchWrapper) {
    // إخفاء الأيقونات أولاً
    searchWrapper.classList.add("search-active");
    
    // منع التمرير الأفقي عند فتح البحث
    document.body.classList.add("search-open");
    document.body.style.overflowX = "hidden";
    
    // إظهار container البحث مباشرة بدون animation
    searchContainer.style.display = "block";
    searchContainer.style.position = "absolute";
    searchContainer.style.top = "0";
    searchContainer.style.left = "0";
    searchContainer.style.right = "0";
    searchContainer.style.width = "100%";
    searchContainer.style.transform = "none";
    
    // إضافة class active بعد تأخير بسيط
    setTimeout(() => {
      searchContainer.classList.add("active");
    }, 10);
    
    // إظهار علامة الرجوع
    const backArrow = document.querySelector(".logo-back-arrow");
    if (backArrow) {
      backArrow.style.display = "inline";
    }
    
    // التركيز على حقل البحث بعد قليل
    setTimeout(() => {
      if (searchInput) {
        searchInput.focus();
      }
    }, 50);
  }
}

function closeMobileSearch() {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  const searchInput = document.getElementById("headerSearchMobile");
  const searchResults = document.getElementById("headerSearchResultsMobile");
  const backArrow = document.querySelector(".logo-back-arrow");
  
  if (searchContainer && searchWrapper) {
    searchContainer.classList.remove("active");
    searchWrapper.classList.remove("search-active");
    
    // إعادة التمرير الأفقي عند إغلاق البحث
    document.body.classList.remove("search-open");
    document.body.style.overflowX = "";
    document.body.style.position = "";
    document.body.style.width = "";
    document.body.style.overflow = ""; // السماح بالتمرير العمودي
    
    // إخفاء علامة الرجوع
    if (backArrow) {
      backArrow.style.display = "none";
    }
    
    if (searchInput) {
      // لا نمسح القيمة هنا لأنها قد تكون مطلوبة لصفحة البحث
      searchInput.blur(); // إزالة التركيز لمنع المتصفح من عرض حفظ كلمة المرور
      // إضافة readonly مؤقت لمنع المتصفح من عرض حفظ كلمة المرور
      searchInput.setAttribute('readonly', 'readonly');
      setTimeout(() => {
        if(searchInput) searchInput.removeAttribute('readonly');
      }, 150);
    }
    
    if (searchResults) {
      searchResults.style.display = "none";
      searchResults.style.visibility = "hidden";
      searchResults.innerHTML = "";
    }
  }
}

// إغلاق البحث عند الضغط خارجه
document.addEventListener("click", function(e) {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchBtn = document.getElementById("mobileSearchBtn");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  
  if (searchContainer && searchContainer.classList.contains("active")) {
    // إذا لم يكن النقر داخل حاوية البحث أو على زر البحث
    if (!searchContainer.contains(e.target) && !searchBtn.contains(e.target)) {
      closeMobileSearch();
    }
  }
});

// إغلاق البحث عند الضغط على ESC
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    const searchContainer = document.getElementById("mobileSearchContainer");
    if (searchContainer && searchContainer.classList.contains("active")) {
      closeMobileSearch();
    }
  }
});

async function headerLiveSearch(){
  // تحديد إذا كنا في الجوال أم لا أولاً
  const isMobile = window.innerWidth <= 768;
  
  // تحديد أي حقل بحث تم استخدامه بناءً على نوع الجهاز
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  
  // في الجوال، استخدم mobileSearch فقط
  // في الكمبيوتر، استخدم desktopSearch فقط
  let activeSearch;
  if(isMobile) {
    activeSearch = mobileSearch;
  } else {
    activeSearch = desktopSearch;
  }
  
  // تحديد أي صندوق نتائج يجب استخدامه
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  
  // للجوال، استخدم mobileBox فقط
  // للكمبيوتر، استخدم desktopBox فقط
  let box;
  if(isMobile) {
    box = mobileBox;
  } else {
    box = desktopBox;
  }
  
  // التأكد من أن box موجود
  if(!box) {
    console.error("Search results box not found. isMobile:", isMobile, "mobileBox:", mobileBox, "desktopBox:", desktopBox);
    return;
  }
  
  const text = activeSearch ? activeSearch.value.toLowerCase() : "";
  
  console.log("Search box selected:", {isMobile, boxId: box.id, searchInput: activeSearch?.id, hasValue: text.trim() !== "", textLength: text.length});

  if(text.trim() === ""){
    box.style.display = "none";
    box.style.visibility = "hidden";
    box.innerHTML = "";
    return;
  }

  // تحميل المنتجات مرة واحدة فقط
  if(headerProductsCache.length === 0){
    const res = await fetch(API + "/api/products");
    const productsList = await res.json();
    
    // التأكد من أن جميع المنتجات لديها stock و quantity
    headerProductsCache = productsList.map(p => ({
      ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
    }));
  }

  // البحث في الاسم والوصف والماركة
  const results = headerProductsCache.filter(p => {
    const searchText = text.toLowerCase();
    const name = (p.name || '').toLowerCase();
    const description = (p.description || '').toLowerCase();
    const brand = (p.brand || '').toLowerCase();
    
    return name.includes(searchText) || 
           description.includes(searchText) || 
           brand.includes(searchText);
  });
  
  // ترتيب النتائج: المطابقة في الاسم أولاً
  results.sort((a, b) => {
    const aName = (a.name || '').toLowerCase();
    const bName = (b.name || '').toLowerCase();
    const aStartsWith = aName.startsWith(text);
    const bStartsWith = bName.startsWith(text);
    
    if(aStartsWith && !bStartsWith) return -1;
    if(!aStartsWith && bStartsWith) return 1;
    return 0;
  });

  if(results.length === 0){
    // إعداد box قبل إظهار "لا توجد نتائج"
    box.innerHTML = `
      <div style="padding:40px 20px;text-align:center;">
        <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">🔍</div>
        <div style="color:#666;font-size:15px;font-weight:500;margin-bottom:4px;">لا توجد نتائج</div>
        <div style="color:#999;font-size:13px;">جرب البحث بكلمات مختلفة</div>
      </div>
    `;
    box.style.display = "block";
    box.style.visibility = "visible";
    box.style.opacity = "1";
    
    // للجوال
    if(isMobile && box.id === "headerSearchResultsMobile") {
      box.style.position = "absolute";
      box.style.top = "100%";
      box.style.left = "10px";
      box.style.right = "10px";
      box.style.width = "calc(100% - 20px)";
      box.style.maxWidth = "calc(100% - 20px)";
      box.style.transform = "none";
      box.style.zIndex = "1001";
      box.style.maxHeight = "70vh";
      box.style.overflowY = "auto";
    }
    return;
  }

  // عرض النتائج
  box.innerHTML = "";
  box.style.display = "block";
  box.style.visibility = "visible";
  box.style.opacity = "1";
  
  // التأكد من أن النتائج مرئية في الجوال
  if(isMobile && box.id === "headerSearchResultsMobile") {
    box.style.position = "absolute";
    box.style.top = "100%";
    box.style.left = "10px";
    box.style.right = "10px";
    box.style.width = "calc(100% - 20px)";
    box.style.maxWidth = "calc(100% - 20px)";
    box.style.transform = "none";
    box.style.zIndex = "1001";
    box.style.maxHeight = "70vh";
    box.style.overflowY = "auto";
    box.style.visibility = "visible";
    box.style.opacity = "1";
    
    // التأكد من أن container موجود ونشط
    const searchContainer = box.closest('.mobile-search-container');
    if(searchContainer && !searchContainer.classList.contains('active')) {
      console.warn("Mobile search container is not active - results may not be visible!");
    }
  }

  results.slice(0, 8).forEach(p=>{
    const imageUrl = safeImageURL(p.image_url);
    const prices = calculateFinalPrice(p);
    const hasDiscount = p.discount_value > 0;
    
    box.innerHTML += `
      <div onclick="go('product', ${p.id}); clearHeaderSearch();"
           class="header-search-result-item"
           style="padding:14px 16px;display:flex;align-items:center;gap:16px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:all 0.2s ease;"
           onmouseover="this.style.background='#f8f9fa';this.style.transform='translateX(-2px)'"
           onmouseout="this.style.background='#fff';this.style.transform='translateX(0)'">
        <div style="position:relative;flex-shrink:0;">
          <img src="${imageUrl}" 
               onerror="this.src='https://via.placeholder.com/80?text=No+Image'"
               style="width:70px;height:70px;border-radius:12px;object-fit:cover;border:1px solid #e8e8e8;background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.05);"
               class="header-search-result-img">
        </div>
        <div style="flex:1;min-width:0;" class="header-search-result-content">
          <div style="font-size:16px;color:#1a1a1a;font-weight:600;margin-bottom:5px;line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;" class="header-search-result-name">
          ${p.name}
        </div>
          ${p.category ? `
            <div style="font-size:13px;color:#666;margin-bottom:6px;font-weight:400;" class="header-search-result-category">
              📂 ${p.category}
            </div>
          ` : ''}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;" class="header-search-result-price">
            <span style="color:#E91E63;font-weight:700;font-size:17px;" class="header-search-price-main">${prices.final} ر.س</span>
            ${hasDiscount ? `
              <span style="color:#999;font-size:13px;text-decoration:line-through;" class="header-search-price-old">${prices.before} ر.س</span>
              <span style="background:linear-gradient(135deg, #ff4757 0%, #ee5a6f 100%);color:#fff;font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600;box-shadow:0 2px 4px rgba(255, 71, 87, 0.3);" class="header-search-discount">
                خصم ${p.discount_value}${p.discount_type === 'percent' ? '%' : ' ر.س'}
              </span>
            ` : ''}
          </div>
        </div>
        <div style="flex-shrink:0;color:#ccc;font-size:22px;transition:all 0.2s ease;" class="header-search-result-arrow">→</div>
      </div>
    `;
  });
}

function clearHeaderSearch(){
  // استخدام نفس دالة closeHeaderSearchResults
  closeHeaderSearchResults();
  
  // مسح قيمة البحث
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  if(desktopSearch) desktopSearch.value = "";
  if(mobileSearch) mobileSearch.value = "";
}

document.addEventListener("click", function(e){
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  const desktopContainer = document.querySelector(".desktop-search-container");
  const mobileContainer = document.querySelector(".mobile-search-container");

  // للكمبيوتر
  if(desktopBox && desktopContainer){
    if(!desktopContainer.contains(e.target)){
      desktopBox.style.display = "none";
    }
  }
  
  // للجوال
  if(mobileBox && mobileContainer){
    if(!mobileContainer.contains(e.target)){
      mobileBox.style.display = "none";
    }
  }
});
// ======================== المفضّلات ========================
// تم نقل كود المفضلة إلى ملف frontend/js/wishlist.js


function refreshCurrentPage(){
  // هذه الدالة لا تعيد تحميل الصفحة بالكامل لتجنب فقدان حالة Pagination
  // يتم تحديث الأزرار فقط عبر refreshAllAddToCartButtons()
  const activePage = document.querySelector(".page.active");
  const active = activePage ? activePage.id : "";

  // تحديث صفحة المنتج فقط إذا كنا فيها (لأنها صفحة واحدة)
  if(active === "page-product") {
    const productId = window.currentProductId;
    if(productId) {
      loadProductDetails(productId);
    }
  }
  
  // تحديث الصفحة الرئيسية فقط (لأنها لا تحتوي على Pagination)
  if(active === "page-home" || active === "homePage") {
    loadHome();
  }
  
  // باقي الصفحات لا تحتاج إعادة تحميل - فقط تحديث الأزرار
  // refreshAllAddToCartButtons() يتم استدعاؤها من addToCart مباشرة
}
function getSARIcon(){
  return `
    <svg width="18" height="18" viewBox="0 0 1228 1228" style="vertical-align:middle;">
    <path d="M699.62 1113.02c-20.06 44.48-33.32 92.75-38.4 143.37l424.51-90.24c20.06-44.47 33.31-92.75 38.4-143.37zM1085.73 895.8c20.06-44.47 33.32-92.75 38.4-143.37l-330.68 70.33v-135.2l292.27-62.11c20.06-44.47 33.32-92.75 38.4-143.37l-330.68 70.27V66.13c-50.67 28.45-95.67 66.32-132.25 110.99v403.35l-132.25 28.11V0c-50.67 28.44-95.67 66.32-132.25 110.99v525.69l-295.91 62.88c-20.06 44.47-33.33 92.75-38.42 143.37l334.33-71.05v170.26l-358.3 76.14c-20.06 44.47-33.32 92.75-38.4 143.37l375.04-79.7c30.53-6.35 56.77-24.4 73.83-49.24l68.78-101.97v-.02c7.14-10.55 11.3-23.27 11.3-36.97V743.77l132.25-28.11v270.4l424.53-90.28Z" fill="#8a004a"></path>
    </svg>
  `;
}

function renderCheckoutPage() {
  const box = document.getElementById("checkoutItems");
  box.innerHTML = "";

  let subtotal = 0;
  let totalQty = 0;

  cart.forEach(item => {

    // السعر الأساسي الحقيقي
    let p = window.productsCache?.find(x => x.id == item.id);

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p?.discount_value || 0;
    let discountType = p?.discount_type || "none";

    // السعر بعد الخصم
    let priceAfterDiscount = base;

    if (discountValue > 0) {
      if (discountType === "percent") priceAfterDiscount = base - (base * discountValue / 100);
      else if (discountType === "fixed") priceAfterDiscount = base - discountValue;
    }

    // السعر النهائي مع الضريبة (استخدام VATCalculator)
    let finalPrice = VATCalculator.addVAT(priceAfterDiscount);

    let lineTotal = finalPrice * item.qty;
    subtotal += lineTotal;
    totalQty += item.qty;

    box.innerHTML += `
      <div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px;">

        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          
          <div style="flex:1;text-align:right;">
            <div style="font-weight:700;margin-bottom:5px;">${item.name}</div>

            <div style="margin-bottom:5px;font-weight:700;">
              ${
                discountValue > 0
                ? `
                    <span style="text-decoration:line-through;color:#999;font-size:14px;margin-left:8px;">
                      ${VATCalculator.addVAT(base).toFixed(2)} ر.س
                    </span>

                    <span style="color:#8a004a;font-weight:700;">
                      ${finalPrice.toFixed(2)} ر.س
                    </span>
                  `
                : `
                  <span style="color:#8a004a;font-weight:700;">
                    ${VATCalculator.addVAT(base).toFixed(2)} ر.س
                  </span>
                `
              }
            </div>

            <div style="display:flex;align-items:center;gap:10px;justify-content:flex-end;">
              ${item.qty <= 1 
                ? `<button disabled onclick="return false;" class="qty-btn" style="opacity:0.6; cursor:not-allowed; background:#e0e0e0; border:1px solid #ccc; color:#999; pointer-events:none; user-select:none;" title="الكمية لا يمكن أن تقل عن 1 - استخدم زر الحذف لحذف المنتج">-</button>`
                : `<button onclick="changeQtyCheckout(${item.id}, -1)" class="qty-btn" title="تقليل الكمية">-</button>`
              }
              <span style="font-size:16px;font-weight:bold;">${item.qty}</span>
              <button onclick="changeQtyCheckout(${item.id}, +1)" class="qty-btn">+</button>
            </div>
          </div>

          <img src="${safeImageURL(item.image)}"
               style="width:70px;height:70px;border-radius:10px;object-fit:cover;margin-left:10px;">
        </div>

        <button onclick="removeItemCheckout(${item.id})"
          style="background:#ffd6e3;color:#E91E63;border:none;padding:5px 15px;border-radius:6px;font-size:14px;margin-top:10px;">
          حذف
        </button>

      </div>
    `;
  });

  // إجماليات
// ===== تفصيل الفاتورة بطريقة النهدي =====
// ===== حساب قيم الفاتورة =====
let base_before_vat_total = 0;
let discount_amount_total = 0;
let subtotal_before_vat = 0;
let subtotal_with_vat = 0;
let vat_total = 0;

cart.forEach(item => {
    let p = window.productsCache.find(x => x.id == item.id);

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p.discount_value || 0;
    let discountAmount = 0;

    // الخصم قبل الضريبة
    if (p.discount_type === "percent") {
        discountAmount = base * (discountValue / 100);
    } 
    else if (p.discount_type === "fixed") {
        discountAmount = discountValue;
    }

    let price_after_discount = base - discountAmount;
    // استخدام VATCalculator لحساب السعر مع الضريبة
    let final_price = VATCalculator.addVAT(price_after_discount);

    base_before_vat_total += base * item.qty;
    discount_amount_total += discountAmount * item.qty;
    subtotal_before_vat += price_after_discount * item.qty;
    subtotal_with_vat += final_price * item.qty;
});

// الضريبة الإجمالية
vat_total = subtotal_with_vat - subtotal_before_vat;

// كود الخصم - حساب من الكوبون المطبق
let coupon_discount = 0;
if (window.appliedCoupon && window.appliedCoupon.active === 1) {
  // الخصم يطبق على subtotal_before_vat (بعد خصومات المنتجات وقبل الضريبة)
  coupon_discount = subtotal_before_vat * (window.appliedCoupon.discount_percent / 100);
  window.appliedCouponDiscount = coupon_discount;
} else {
  window.appliedCouponDiscount = 0;
}

// الإجمالي النهائي بعد الكوبون (مع الضريبة - مثل Backend)
const coupon_discount_with_vat = VATCalculator.addVAT(coupon_discount);
let total_final = subtotal_with_vat - coupon_discount_with_vat;

// --- إضافة الشحن --- (استخدام ShippingAPI)
const shippingData = ShippingAPI.getSimpleShipping();
let shipping = shippingData.shipping;
let shippingVat = shippingData.shipping_vat;
// الإجمالي النهائي بعد الكوبون + الشحن
let finalTotalWithShipping = total_final + shipping + shippingVat;

// ===== عرض الفاتورة =====
box.innerHTML += `

  <div style="padding:12px;margin-top:15px;line-height:1.9;font-size:15px;">

    <div style="display:flex;justify-content:space-between;">
      <span>المجموع الأساسي (بدون ضريبة)</span>
      <b>${base_before_vat_total.toFixed(2)} ر.س</b>
    </div>

    <div style="display:flex;justify-content:space-between; color:green;">
      <span>المبلغ المخصوم</span>
      <b>- ${discount_amount_total.toFixed(2)} ر.س</b>
    </div>

    <hr style="margin:12px 0;">

    <div style="display:flex;justify-content:space-between;">
      <span>المجموع (بدون ضريبة القيمة المضافة)</span>
      <b>${subtotal_before_vat.toFixed(2)} ر.س</b>
    </div>

    <div style="display:flex;justify-content:space-between;">
      <span>قيمة ضريبة القيمة المضافة</span>
      <b>${vat_total.toFixed(2)} ر.س</b>
    </div>

    <hr style="margin:12px 0;">

    <div style="display:flex;justify-content:space-between;">
      <span>المجموع (شامل ضريبة القيمة المضافة)</span>
      <b>${subtotal_with_vat.toFixed(2)} ر.س</b>
    </div>

    ${coupon_discount > 0 ? `
    <div style="display:flex;justify-content:space-between;color:#4caf50;">
      <span>الخصم (كود الخصم: ${window.appliedCoupon ? window.appliedCoupon.code : ''})</span>
      <b>- ${VATCalculator.addVAT(coupon_discount).toFixed(2)} ر.س</b>
    </div>
    ` : ''}

    <div style="margin-top:15px;font-size:22px;font-weight:800;color:#E91E63;text-align:center;">
      السعر الإجمالي النهائي: ${total_final.toFixed(2)} ر.س
    </div>

  </div>
  <div style="display:flex;justify-content:space-between;">
  <span>الشحن:</span>
  <b>${shipping.toFixed(2)} ر.س</b>
</div>

<div style="display:flex;justify-content:space-between;">
  <span>ضريبة الشحن (15%):</span>
  <b>${shippingVat.toFixed(2)} ر.س</b>
</div>

<hr style="margin:12px 0;">

<div style="display:flex;justify-content:space-between;font-size:20px;color:#8a004a;font-weight:900;">
  <span>الإجمالي النهائي + الشحن:</span>
  <b>${finalTotalWithShipping.toFixed(2)} ر.س</b>
</div>

`;
}

// متغيرات الكوبون
if (!window.appliedCoupon) window.appliedCoupon = null;
if (!window.appliedCouponDiscount) window.appliedCouponDiscount = 0;

// تحميل شريط الكوبون
async function loadCouponBanner() {
  const banner = document.getElementById("couponBanner");
  if (!banner) return;
  
  // التحقق من أننا في الصفحة الرئيسية
  const currentPage = document.querySelector(".page.active");
  const isHomePage = currentPage && (currentPage.id === "homePage" || currentPage.id === "page-home");
  
  if (!isHomePage) {
    banner.style.display = "none";
    return;
  }
  
  try {
    // التحقق من حالة المستخدم وعدد طلباته
    let shouldShow = false;
    
    if (!window.user || !window.user.phone) {
      // المستخدم غير مسجل دخول → يظهر دائماً
      shouldShow = true;
    } else {
      // المستخدم مسجل دخول → التحقق من عدد الطلبات
      try {
        const ordersRes = await fetch(API + `/api/user-orders-count?phone=${encodeURIComponent(window.user.phone)}`);
        if (ordersRes.ok) {
          const ordersData = await ordersRes.json();
          // إذا كان عدد الطلبات = 0 → يظهر (عميل جديد)
          // إذا كان عدد الطلبات > 0 → يختفي
          shouldShow = ordersData.count === 0;
        }
      } catch (error) {
        console.error("خطأ في التحقق من عدد الطلبات:", error);
        shouldShow = false;
      }
    }
    
    if (!shouldShow) {
      banner.style.display = "none";
      return;
    }
    
    // جلب الكوبون النشط
    const res = await fetch(API + "/api/coupon/active");
    if (!res.ok) {
      banner.style.display = "none";
      return;
    }
    const coupon = await res.json();
    
    const bannerText = document.getElementById("couponBannerText");
    const bannerCode = document.getElementById("couponBannerCode");
    
    // التحقق مرة أخرى من الصفحة بعد جلب البيانات
    const currentPageCheck = document.querySelector(".page.active");
    const isHomePageCheck = currentPageCheck && (currentPageCheck.id === "homePage" || currentPageCheck.id === "page-home");
    
    if (coupon && coupon.active === 1 && coupon.show_in_banner === 1 && isHomePageCheck) {
      banner.style.display = "block";
      if (bannerText) bannerText.textContent = coupon.name;
      if (bannerCode) bannerCode.textContent = coupon.code;
      console.log("✅ تم عرض شريط الكوبون:", coupon.name, coupon.code);
    } else {
      banner.style.display = "none";
      if (!coupon) {
        console.log("⚠️ لا يوجد كوبون نشط");
      } else if (coupon.show_in_banner !== 1) {
        console.log("⚠️ الكوبون موجود لكن لا يظهر في البانر");
      }
    }
  } catch (error) {
    console.error("خطأ في تحميل الكوبون:", error);
    banner.style.display = "none";
  }
}

// تطبيق الكوبون
async function applyCoupon() {
  const codeInput = document.getElementById("couponCodeInput");
  const messageDiv = document.getElementById("couponMessage");
  if (!codeInput || !messageDiv) return;
  
  const code = codeInput.value.trim().toUpperCase();
  
  if (!code) {
    messageDiv.innerHTML = '<span style="color:#d62828;">❌ يرجى إدخال كود الخصم</span>';
    return;
  }
  
  // الحصول على رقم الهاتف للتحقق من استخدام الكوبون
  const userPhone = window.user ? window.user.phone : (document.getElementById("co_phone") ? document.getElementById("co_phone").value.trim() : "");
  
  try {
    const res = await fetch(API + "/api/coupon/validate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, user_phone: userPhone })
    });
    
    const data = await res.json();
    
    if (data.success) {
      window.appliedCoupon = data.coupon;
      messageDiv.innerHTML = `
        <div style="padding:12px;background:#d4edda;border:1px solid #28a745;border-radius:8px;color:#155724;">
          <strong>✅ تم تطبيق الكوبون بنجاح!</strong><br>
          <span style="font-size:13px;">خصم ${data.coupon.discount_percent}% على إجمالي المنتجات</span><br>
          <span style="font-size:12px;color:#6c757d;margin-top:4px;display:block;">⚠️ تذكر: يمكن استخدام كوبون الخصم مرة واحدة فقط لكل عميل</span>
        </div>
      `;
      codeInput.style.borderColor = "#28a745";
      codeInput.style.borderWidth = "2px";
      
      // إعادة حساب الإجمالي
      renderCheckoutPage();
    } else {
      window.appliedCoupon = null;
      window.appliedCouponDiscount = 0;
      messageDiv.innerHTML = `
        <div style="padding:12px;background:#f8d7da;border:1px solid #dc3545;border-radius:8px;color:#721c24;">
          <strong>❌ ${data.message}</strong><br>
          ${data.message.includes("كوبون واحد فقط") ? '<span style="font-size:12px;display:block;margin-top:6px;">يمكن استخدام كوبون الخصم مرة واحدة فقط لكل عميل</span>' : ''}
        </div>
      `;
      codeInput.style.borderColor = "#dc3545";
      codeInput.style.borderWidth = "2px";
      renderCheckoutPage();
    }
  } catch (error) {
    console.error("خطأ في التحقق من الكوبون:", error);
    messageDiv.innerHTML = '<span style="color:#d62828;">❌ حدث خطأ في الاتصال بالسيرفر</span>';
  }
}

async function payOnline() {
  // 🔐 منع الدفع بدون تسجيل دخول
  if (!window.user) {
    alert("⚠️ يجب تسجيل الدخول قبل الدفع الإلكتروني");
    go("login");
    return;
  }

  if (cart.length === 0) {
    alert("⚠️ السلة فارغة!");
    return;
  }

  // 1) جمع بيانات العميل
  const name = document.getElementById("co_name").value.trim();
  const phone = document.getElementById("co_phone").value.trim();
  const phone2 = document.getElementById("co_phone2").value.trim();
  const notes = document.getElementById("co_notes").value.trim();
  const address = document.getElementById("co_address").value.trim();
  const location = document.getElementById("co_location").value.trim();

  if (!name || !phone) {
    alert("⚠️ الرجاء إدخال الاسم ورقم الجوال قبل الدفع الإلكتروني");
    return;
  }

  // حفظ بيانات الطلب مؤقتاً للاستخدام في صفحة الدفع
  window.pendingOrder = {
    customer_name: name,
    customer_phone: phone,
    customer_phone2: phone2,
    customer_notes: notes,
    customer_address: address,
    customer_location: location,
    coupon_code: window.appliedCoupon ? window.appliedCoupon.code : ""
  };

  // توجيه المستخدم لصفحة الدفع
  go("payment");
}

// إرسال الطلب عبر واتساب
async function sendWhatsAppOrder() {
  if (cart.length === 0) {
    alert("⚠️ السلة فارغة!");
    return;
  }

  // جمع بيانات العميل
  const name = document.getElementById("co_name").value.trim();
  const phone = document.getElementById("co_phone").value.trim();
  const phone2 = document.getElementById("co_phone2").value.trim();
  const notes = document.getElementById("co_notes").value.trim();
  const address = document.getElementById("co_address").value.trim();
  const location = document.getElementById("co_location").value.trim();

  if (!name || !phone) {
    alert("⚠️ الرجاء إدخال الاسم ورقم الجوال");
    return;
  }

  // حساب الإجماليات
  let base_before_vat_total = 0;
  let discount_amount_total = 0;
  let subtotal_before_vat = 0;
  let subtotal_with_vat = 0;

  cart.forEach(item => {
    let p = window.productsCache.find(x => x.id == item.id);
    if (!p) return;

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p.discount_value || 0;
    let discountType = p.discount_type || "none";
    let discountAmount = 0;

    if (discountType === "percent") {
      discountAmount = base * (discountValue / 100);
    } else if (discountType === "fixed") {
      discountAmount = discountValue;
    }

    let price_after_discount = base - discountAmount;
    // استخدام VATCalculator لحساب السعر مع الضريبة
    let final_price = VATCalculator.addVAT(price_after_discount);

    base_before_vat_total += base * item.qty;
    discount_amount_total += discountAmount * item.qty;
    subtotal_before_vat += price_after_discount * item.qty;
    subtotal_with_vat += final_price * item.qty;
  });

  // تطبيق الكوبون
  let coupon_discount = 0;
  let coupon_code = "";
  if (window.appliedCoupon && window.appliedCoupon.active === 1) {
    coupon_discount = subtotal_before_vat * (window.appliedCoupon.discount_percent / 100);
    coupon_code = window.appliedCoupon.code;
  }

  // خصم الكوبون مع الضريبة (مثل Backend)
  const coupon_discount_with_vat = VATCalculator.addVAT(coupon_discount);
  let total_after_coupon = subtotal_with_vat - coupon_discount_with_vat;
  // استخدام ShippingAPI لحساب الشحن
  const shippingData = ShippingAPI.getSimpleShipping();
  let shipping = shippingData.shipping;
  let shippingVat = shippingData.shipping_vat;
  let finalTotal = total_after_coupon + shipping + shippingVat;

  // إرسال الطلب للباك اند
  const body = {
    customer_name: name,
    customer_phone: phone,
    customer_phone2: phone2,
    customer_address: address,
    customer_location: location,
    customer_notes: notes,
    coupon_code: coupon_code,
    items: cart.map(item => {
      let p = window.productsCache.find(x => x.id == item.id);
      return {
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: p ? parseFloat(p.base_price) : 0,
        discount_value: p?.discount_value || 0,
        discount_type: p?.discount_type || "none"
      };
    })
  };

  try {
    const res = await fetch(API + "/api/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (data.success) {
      // تحديث المخزون
      if (window.productsCache) {
        cart.forEach(item => {
          const product = window.productsCache.find(p => p.id == item.id);
          if (product) {
            const currentStock = parseInt(product.stock || product.quantity || 0);
            const newStock = Math.max(0, currentStock - item.qty);
            product.stock = newStock;
            product.quantity = newStock;
          }
        });
      }

      // مسح الكوبون المطبق
      window.appliedCoupon = null;
      window.appliedCouponDiscount = 0;
      const couponCodeInput = document.getElementById("couponCodeInput");
      const couponMessage = document.getElementById("couponMessage");
      if (couponCodeInput) couponCodeInput.value = "";
      if (couponMessage) couponMessage.innerHTML = "";

      cart = [];
      saveCart();
      updateCartIcon();

      // إعداد رسالة واتساب
      let whatsappMessage = `مرحباً، أريد إتمام الطلب التالي:\n\n`;
      whatsappMessage += `👤 الاسم: ${name}\n`;
      whatsappMessage += `📞 الجوال: ${phone}\n`;
      if (phone2) whatsappMessage += `📞 جوال إضافي: ${phone2}\n`;
      if (address) whatsappMessage += `📍 العنوان: ${address}\n`;
      if (location) whatsappMessage += `🗺️ الموقع: ${location}\n`;
      if (notes) whatsappMessage += `📝 ملاحظات: ${notes}\n`;
      if (coupon_code) whatsappMessage += `🎟️ كود الخصم: ${coupon_code}\n`;
      whatsappMessage += `\n📦 المنتجات:\n`;
      
      // استخدام cart من window.cart
      const currentCart = window.cart || cart;
      currentCart.forEach(item => {
        let p = window.productsCache.find(x => x.id == item.id);
        let base = parseFloat(p?.base_price) || 0;
    let discountValue = p?.discount_value || 0;
    let discountType = p?.discount_type || "none";
    let priceAfterDiscount = base;

    if (discountValue > 0) {
      if (discountType === "percent") priceAfterDiscount = base - (base * discountValue / 100);
      else if (discountType === "fixed") priceAfterDiscount = base - discountValue;
    }

    // استخدام VATCalculator لحساب السعر مع الضريبة
    let finalPrice = VATCalculator.addVAT(priceAfterDiscount);
        whatsappMessage += `- ${item.name} × ${item.qty} = ${(finalPrice * item.qty).toFixed(2)} ر.س\n`;
      });

      whatsappMessage += `\n💰 الإجمالي: ${finalTotal.toFixed(2)} ر.س\n`;
      whatsappMessage += `📋 رقم الطلب: ${data.order_id}`;

      // فتح واتساب
      const whatsappUrl = `https://wa.me/966500000000?text=${encodeURIComponent(whatsappMessage)}`;
      window.open(whatsappUrl, '_blank');

      // الانتقال لصفحة الشكر
      go("thanks", data.order_id);
    } else {
      alert("❌ " + (data.message || "حدث خطأ أثناء إرسال الطلب"));
    }
  } catch (error) {
    console.error("خطأ في إرسال الطلب:", error);
    alert("❌ حدث خطأ في الاتصال بالسيرفر");
  }
}

// حساب الإجمالي النهائي (شامل التوصيل)
function calculateFinalTotal() {
  // حساب subtotal_before_vat
  let base_before_vat_total = 0;
  let discount_amount_total = 0;
  let subtotal_before_vat = 0;
  let subtotal_with_vat = 0;

  cart.forEach(item => {
    let p = window.productsCache?.find(x => x.id == item.id);
    if (!p) return;

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p?.discount_value || 0;
    let discountType = p?.discount_type || "none";
    let discountAmount = 0;

    if (discountType === "percent") {
      discountAmount = base * (discountValue / 100);
    } else if (discountType === "fixed") {
      discountAmount = discountValue;
    }

    let price_after_discount = base - discountAmount;
    // استخدام VATCalculator لحساب السعر مع الضريبة
    let final_price = VATCalculator.addVAT(price_after_discount);

    base_before_vat_total += base * item.qty;
    discount_amount_total += discountAmount * item.qty;
    subtotal_before_vat += price_after_discount * item.qty;
    subtotal_with_vat += final_price * item.qty;
  });

  // تطبيق الكوبون على subtotal_before_vat (بعد خصومات المنتجات وقبل الضريبة)
  let coupon_discount = 0;
  if (window.appliedCoupon && window.appliedCoupon.active === 1) {
    coupon_discount = subtotal_before_vat * (window.appliedCoupon.discount_percent / 100);
  }

  // الإجمالي بعد الكوبون
  let total_after_coupon = subtotal_with_vat - coupon_discount;

  // استخدام ShippingAPI لحساب الشحن
  const shippingData = ShippingAPI.getSimpleShipping();
  let shipping = shippingData.shipping;
  let shippingVat = shippingData.shipping_vat;
  let finalTotalWithShipping = total_after_coupon + shipping + shippingVat;

  return finalTotalWithShipping;
}

// تحميل صفحة الدفع
function loadPaymentPage() {
  // حساب الإجمالي النهائي
  const total = calculateFinalTotal();
  
  // عرض الإجمالي
  const totalElement = document.getElementById("paymentTotalAmount");
  if (totalElement) {
    totalElement.textContent = total.toFixed(2) + " ر.س";
  }

  // ملء اسم حامل البطاقة تلقائياً
  const cardholderName = document.getElementById("cardholderName");
  if (cardholderName && window.user && window.user.name) {
    cardholderName.value = window.user.name;
  }

  // إعداد معالج النموذج
  const paymentForm = document.getElementById("paymentForm");
  if (paymentForm) {
    paymentForm.onsubmit = handlePaymentSubmit;
  }

  // تنسيق رقم البطاقة
  const cardNumberInput = document.getElementById("cardNumber");
  if (cardNumberInput) {
    cardNumberInput.addEventListener('input', formatCardNumber);
  }

  // تنسيق CVV
  const cvvInput = document.getElementById("cardCVV");
  if (cvvInput) {
    cvvInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });
  }

  // تنسيق الشهر والسنة
  const monthInput = document.getElementById("cardMonth");
  const yearInput = document.getElementById("cardYear");
  
  if (monthInput) {
    monthInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 2);
    });
  }
  
  if (yearInput) {
    yearInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
    });
  }
}

// تنسيق رقم البطاقة
function formatCardNumber(e) {
  let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
  let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
  e.target.value = formattedValue;
}

// معالجة إرسال النموذج
async function handlePaymentSubmit(e) {
  e.preventDefault();

  const cardNumber = document.getElementById("cardNumber").value.replace(/\s/g, '');
  const cardCVV = document.getElementById("cardCVV").value;
  const cardMonth = document.getElementById("cardMonth").value;
  const cardYear = document.getElementById("cardYear").value;

  // التحقق من البيانات (وهمي - يقبل أي رقم)
  if (!cardNumber || cardNumber.length < 13) {
    alert("⚠️ يرجى إدخال رقم البطاقة");
    return;
  }

  if (!cardCVV || cardCVV.length < 3) {
    alert("⚠️ يرجى إدخال CVV");
    return;
  }

  if (!cardMonth || !cardYear) {
    alert("⚠️ يرجى إدخال تاريخ انتهاء الصلاحية");
    return;
  }

  // معالجة الدفع الوهمي
  await processPayment();
}

// معالجة الدفع الوهمي
async function processPayment() {
  if (!window.pendingOrder) {
    alert("⚠️ لم يتم العثور على بيانات الطلب");
    go("checkout");
    return;
  }

  // عرض رسالة تحميل
  const submitBtn = document.querySelector('.payment-submit-btn');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>جاري المعالجة...</span>';
  }

  // محاكاة تأخير المعالجة
  await new Promise(resolve => setTimeout(resolve, 1500));

  // تجهيز الطلب للباك اند
  const orderData = window.pendingOrder;
  
  // حساب الإجماليات
  let subtotal_with_vat = 0;
  cart.forEach(item => {
    let p = window.productsCache?.find(x => x.id == item.id);
    if (!p) return;

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p?.discount_value || 0;
    let discountType = p?.discount_type || "none";
    let priceAfterDiscount = base;

    if (discountValue > 0) {
      if (discountType === "percent") priceAfterDiscount = base - (base * discountValue / 100);
      else if (discountType === "fixed") priceAfterDiscount = base - discountValue;
    }

    // استخدام VATCalculator لحساب السعر مع الضريبة
    let finalPrice = VATCalculator.addVAT(priceAfterDiscount);
    subtotal_with_vat += finalPrice * item.qty;
  });

  // استخدام ShippingAPI لحساب الشحن
  const shippingData = ShippingAPI.getSimpleShipping();
  const shipping = shippingData.shipping;
  const shippingVat = shippingData.shipping_vat;
  const finalTotal = subtotal_with_vat + shipping + shippingVat;

  // الحصول على كود الكوبون المطبق - التحقق من window.appliedCoupon أولاً، ثم orderData
  let coupon_code = "";
  if (window.appliedCoupon && window.appliedCoupon.active === 1) {
    coupon_code = window.appliedCoupon.code;
  } else if (orderData && orderData.coupon_code) {
    coupon_code = orderData.coupon_code;
  }
  console.log("Coupon code being sent:", coupon_code, "Applied coupon:", window.appliedCoupon);

  const body = {
    customer_name: orderData.customer_name,
    customer_phone: orderData.customer_phone,
    shipping: shipping,
    shipping_vat: shippingVat,
    customer_phone2: orderData.customer_phone2,
    customer_notes: orderData.customer_notes,
    customer_address: orderData.customer_address,
    customer_location: orderData.customer_location,
    notes: orderData.customer_notes,
    coupon_code: coupon_code,  // إضافة كود الكوبون
    items: cart.map(item => ({
      id: item.id,
      name: item.name,
      qty: item.qty,
      base_price: item.base_price,
      discount_value: window.productsCache.find(p => p.id == item.id)?.discount_value || 0,
      discount_type: window.productsCache.find(p => p.id == item.id)?.discount_type || "none"
    }))
  };

  // إرسال الطلب إلى السيرفر
  try {
    const res = await fetch(API + "/api/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!data.success) {
      alert("⚠️ لم يتم تسجيل الطلب! حاول مرة أخرى");
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>شحن →</span>';
      }
      return;
    }

    const orderId = data.order_id;

    // تحديث المخزون
    if (window.productsCache) {
      cart.forEach(item => {
        const product = window.productsCache.find(p => p.id == item.id);
        if (product) {
          const currentStock = parseInt(product.stock || product.quantity || product.stock_qty || 0);
          const newStock = Math.max(0, currentStock - item.qty);
          product.stock = newStock;
          product.quantity = newStock;
          product.stock_qty = newStock;
        }
      });
    }

    // حفظ الطلب في localStorage
    let dashboardOrders = JSON.parse(localStorage.getItem("orders") || "[]");
    dashboardOrders.push({
      id: orderId,
      date: new Date().toLocaleString("ar-EG"),
      customer_name: orderData.customer_name,
      customer_phone: orderData.customer_phone,
      items: cart.map(item => ({
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: item.base_price,
        price_after_discount: item.price_after_discount,
        price_with_vat: item.price_with_vat,
        total: (item.price_with_vat * item.qty).toFixed(2)
      })),
      total: finalTotal.toFixed(2),
      status: "new"
    });
    localStorage.setItem("orders", JSON.stringify(dashboardOrders));

    // مسح الكوبون المطبق
    window.appliedCoupon = null;
    window.appliedCouponDiscount = 0;
    const couponCodeInput = document.getElementById("couponCodeInput");
    const couponMessage = document.getElementById("couponMessage");
    if (couponCodeInput) couponCodeInput.value = "";
    if (couponMessage) couponMessage.innerHTML = "";

    // تفريغ السلة
    cart = [];
    saveCart();
    updateCartIcon();

    // حذف بيانات الطلب المؤقتة
    delete window.pendingOrder;

    // توجيه المستخدم للفاتورة
    go("thanks", orderId);

  } catch (error) {
    console.error("Payment error:", error);
    alert("⚠️ حدث خطأ أثناء معالجة الدفع. يرجى المحاولة مرة أخرى");
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>شحن →</span>';
    }
  }
}

// معالجة Apple Pay
async function handleApplePay() {
  // نفس معالجة الدفع العادي
  await processPayment();
}

// ===================== شريط التقدم =====================
function startPageProgress(){
  const progressBar = document.getElementById("pageProgressBar");
  if(progressBar){
    progressBar.classList.remove("completing");
    progressBar.classList.add("loading");
    progressBar.style.width = "0%";
    // بدء التحميل
    setTimeout(() => {
      progressBar.style.width = "30%";
    }, 10);
  }
}

function completePageProgress(){
  const progressBar = document.getElementById("pageProgressBar");
  if(progressBar){
    progressBar.classList.remove("loading");
    progressBar.classList.add("completing");
    progressBar.style.width = "100%";
    // إخفاء الشريط بعد الإكمال
    setTimeout(() => {
      progressBar.classList.remove("completing");
      progressBar.style.width = "0%";
    }, 400);
  }
}

// ===================== صفحة البحث =====================
// إخفاء نتائج البحث المنبثقة
function closeHeaderSearchResults(){
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  
  if(desktopBox){
    desktopBox.style.display = "none";
    desktopBox.style.visibility = "hidden";
    desktopBox.innerHTML = "";
  }
  
  if(mobileBox){
    mobileBox.style.display = "none";
    mobileBox.style.visibility = "hidden";
    mobileBox.innerHTML = "";
  }
  
  // إزالة التركيز من حقل البحث لمنع المتصفح من عرض حفظ كلمة المرور
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  if(desktopSearch) {
    desktopSearch.blur();
  }
  if(mobileSearch) {
    mobileSearch.blur();
  }
}

function goToSearchPage(){
  // إخفاء نتائج البحث المنبثقة أولاً
  closeHeaderSearchResults();
  
  const isMobile = window.innerWidth <= 768;
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  const searchInput = isMobile ? mobileSearch : desktopSearch;
  const searchTerm = searchInput ? searchInput.value.trim() : "";
  
  // إزالة التركيز من حقل البحث فوراً لمنع المتصفح من عرض حفظ كلمة المرور
  if(desktopSearch) {
    desktopSearch.blur();
    desktopSearch.setAttribute('readonly', 'readonly');
    setTimeout(() => desktopSearch.removeAttribute('readonly'), 100);
  }
  if(mobileSearch) {
    // إضافة readonly فوراً قبل blur لمنع المتصفح من عرض حفظ كلمة المرور
    mobileSearch.setAttribute('readonly', 'readonly');
    mobileSearch.setAttribute('autocomplete', 'off');
    mobileSearch.setAttribute('type', 'text'); // التأكد من أن النوع text
    mobileSearch.setAttribute('name', 'search-query-' + Date.now()); // تغيير name ديناميكياً لإرباك المتصفح
    mobileSearch.blur();
    // إضافة تأخير أطول لإزالة readonly
    setTimeout(() => {
      if(mobileSearch) {
        mobileSearch.removeAttribute('readonly');
        mobileSearch.setAttribute('name', 'search-query');
      }
    }, 500);
  }
  
  // إغلاق البحث على الجوال
  if(isMobile) {
    closeMobileSearch();
  }
  
  // الانتقال لصفحة البحث بعد تأخير بسيط
  setTimeout(() => {
    if(searchTerm){
      go("search", searchTerm);
    } else {
      go("search");
    }
    
    // إزالة التركيز مرة أخرى بعد الانتقال
    setTimeout(() => {
      if(desktopSearch) {
        desktopSearch.blur();
        desktopSearch.setAttribute('readonly', 'readonly');
        setTimeout(() => desktopSearch.removeAttribute('readonly'), 200);
      }
      if(mobileSearch) {
        mobileSearch.blur();
        mobileSearch.setAttribute('readonly', 'readonly');
        setTimeout(() => mobileSearch.removeAttribute('readonly'), 200);
      }
      // السماح بالتمرير
      document.body.style.overflow = "";
      window.scrollTo(0, 0);
    }, 200);
  }, 50);
}

function loadSearchPage(searchTerm = null){
  const searchInput = document.getElementById("searchPageInput");
  if(searchInput && searchTerm){
    searchInput.value = searchTerm;
    performSearch();
  } else if(searchInput){
    searchInput.value = "";
    searchInput.focus();
  }
}

// Fuzzy Search Algorithm (مثل جوجل)
function fuzzyMatch(text, pattern){
  text = text.toLowerCase();
  pattern = pattern.toLowerCase();
  
  // إذا كان النص يحتوي على النمط مباشرة
  if(text.includes(pattern)){
    return { match: true, score: 100 };
  }
  
  // حساب المسافة بين الأحرف
  let textIndex = 0;
  let patternIndex = 0;
  let matches = 0;
  let totalChars = pattern.length;
  
  while(textIndex < text.length && patternIndex < pattern.length){
    if(text[textIndex] === pattern[patternIndex]){
      matches++;
      patternIndex++;
    }
    textIndex++;
  }
  
  // حساب النسبة المئوية للمطابقة
  const matchRatio = (matches / totalChars) * 100;
  
  // إذا كانت النسبة أعلى من 60%، نعتبرها مطابقة
  if(matchRatio >= 60){
    return { match: true, score: matchRatio };
  }
  
  // البحث عن كلمات مشابهة
  const textWords = text.split(/\s+/);
  const patternWords = pattern.split(/\s+/);
  
  let wordMatches = 0;
  patternWords.forEach(patternWord => {
    textWords.forEach(textWord => {
      if(textWord.includes(patternWord) || patternWord.includes(textWord)){
        wordMatches++;
      } else {
        // حساب المسافة بين الكلمات
        const similarity = calculateSimilarity(textWord, patternWord);
        if(similarity > 0.7){
          wordMatches += similarity;
        }
      }
    });
  });
  
  if(wordMatches > 0){
    const wordScore = (wordMatches / patternWords.length) * 100;
    return { match: true, score: wordScore };
  }
  
  return { match: false, score: 0 };
}

// حساب التشابه بين كلمتين
function calculateSimilarity(str1, str2){
  const longer = str1.length > str2.length ? str1 : str2;
  const shorter = str1.length > str2.length ? str2 : str1;
  
  if(longer.length === 0) return 1.0;
  
  const distance = levenshteinDistance(longer, shorter);
  return (longer.length - distance) / longer.length;
}

// حساب مسافة Levenshtein
function levenshteinDistance(str1, str2){
  const matrix = [];
  
  for(let i = 0; i <= str2.length; i++){
    matrix[i] = [i];
  }
  
  for(let j = 0; j <= str1.length; j++){
    matrix[0][j] = j;
  }
  
  for(let i = 1; i <= str2.length; i++){
    for(let j = 1; j <= str1.length; j++){
      if(str2.charAt(i - 1) === str1.charAt(j - 1)){
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  
  return matrix[str2.length][str1.length];
}

async function performSearch(){
  const searchInput = document.getElementById("searchPageInput");
  const searchTerm = searchInput ? searchInput.value.trim() : "";
  const resultsGrid = document.getElementById("searchResultsGrid");
  const noResults = document.getElementById("searchNoResults");
  const resultsCount = document.getElementById("searchResultsCount");
  
  // إخفاء رسالة "لا توجد نتائج" فوراً عند بدء البحث
  if(noResults){
    noResults.style.display = "none";
  }
  
  if(!searchTerm){
    if(resultsGrid) resultsGrid.innerHTML = "";
    if(noResults) noResults.style.display = "none";
    if(resultsCount) resultsCount.textContent = "";
    return;
  }
  
  // عرض loading
  if(resultsGrid) resultsGrid.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">جاري البحث...</div>';
  if(noResults) noResults.style.display = "none";
  if(resultsCount) resultsCount.textContent = "";
  
  // تحميل المنتجات
  if(!window.productsCache || window.productsCache.length === 0){
    await loadProductsCache();
  }
  
  // البحث باستخدام Fuzzy Search
  const searchResults = window.productsCache.map(product => {
    const nameMatch = fuzzyMatch(product.name, searchTerm);
    const categoryMatch = fuzzyMatch(product.category || "", searchTerm);
    const descriptionMatch = fuzzyMatch(product.description || "", searchTerm);
    
    // حساب أعلى درجة مطابقة
    const maxScore = Math.max(
      nameMatch.score,
      categoryMatch.score * 0.7,
      descriptionMatch.score * 0.5
    );
    
    return {
      product,
      score: maxScore,
      match: nameMatch.match || categoryMatch.match || descriptionMatch.match
    };
  })
  .filter(result => result.match)
  .sort((a, b) => b.score - a.score); // ترتيب حسب الدرجة
  
  // عرض النتائج
  if(searchResults.length === 0){
    if(resultsGrid) resultsGrid.innerHTML = "";
    if(noResults) noResults.style.display = "block";
    if(resultsCount) resultsCount.textContent = "";
    const pagination = document.getElementById("searchResultsPagination");
    if(pagination) pagination.style.display = 'none';
  } else {
    if(noResults) noResults.style.display = "none";
    if(resultsCount) resultsCount.textContent = `تم العثور على ${searchResults.length} منتج`;
    
    // استخراج المنتجات فقط
    const products = searchResults.map(({ product }) => product);
    
    // عرض المنتجات باستخدام النظام الجديد
    if(resultsGrid) {
      renderProductsWithPagination('searchResultsGrid', products, 'searchResultsPagination', true);
    }
  }
}

function changeQtyCheckout(id, amount){
  let item = cart.find(p => p.id == id);
  if(!item) return;

  // منع تقليل الكمية عن 1 - فقط زر الحذف يحذف المنتج
  if(amount < 0 && item.qty <= 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من أن الكمية الجديدة لن تقل عن 1
  if(amount < 0 && (item.qty + amount) < 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من المخزون
  if(window.productsCache){
    const p = window.productsCache.find(x => x.id == id);
    if(p){
      const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
      const newQty = item.qty + amount;
      
      if(newQty > stock){
        showNotification(`عذراً، الكمية المتاحة في المخزون هي ${stock} حبة فقط`, 'warning');
        return;
      }
    }
  }

  item.qty += amount;

  // التأكد من أن الكمية لا تقل عن 1
  if(item.qty < 1){
    item.qty = 1;
  }

  saveCart();
  renderCheckoutPage();
  updateCartIcon();          // ← تحديث عداد السلة
  refreshAllAddToCartButtons(); // ← تحديث أزرار إضافة للسلة
}


function removeItemCheckout(id){
  cart = cart.filter(p => p.id != id);

  saveCart();
  renderCheckoutPage();
  updateCartIcon();             // ← تحديث عداد السلة
  refreshAllAddToCartButtons(); // ← تحديث الأزرار
}


function pickLocation(){
  if (!navigator.geolocation) {
    alert("⚠️ متصفحك لا يدعم تحديد الموقع الجغرافي. يرجى تحديث المتصفح أو استخدام متصفح آخر.");
    return;
  }

  // إظهار رسالة للمستخدم
  const locationInput = document.getElementById("co_location");
  locationInput.value = "جاري تحديد الموقع...";
  locationInput.style.color = "#00AEEF";

  const options = {
    enableHighAccuracy: true,
    timeout: 15000, // 15 ثانية
    maximumAge: 0
  };

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      let link = `https://maps.google.com/?q=${lat},${lng}`;
      locationInput.value = link;
      locationInput.style.color = "#4caf50";
      
      // إظهار رسالة نجاح
      if(typeof showNotification === 'function') {
        showNotification("✓ تم تحديد الموقع بنجاح", 'success');
      } else {
        alert("✓ تم تحديد الموقع بنجاح");
      }
    },
    (error) => {
      let errorMsg = "حدث خطأ في تحديد الموقع: ";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg = "⚠️ تم رفض الوصول للموقع الجغرافي. يرجى السماح بالوصول للموقع في إعدادات المتصفح.";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg = "⚠️ معلومات الموقع غير متاحة.";
          break;
        case error.TIMEOUT:
          errorMsg = "⚠️ انتهت مهلة تحديد الموقع. يرجى المحاولة مرة أخرى.";
          break;
        default:
          errorMsg = "⚠️ حدث خطأ غير معروف في تحديد الموقع.";
          break;
      }
      locationInput.value = "";
      locationInput.placeholder = errorMsg;
      locationInput.style.color = "#e74c3c";
      if(typeof showNotification === 'function') {
        showNotification(errorMsg, 'error');
      } else {
        alert(errorMsg);
      }
    },
    options
  );
}


// تم نقل دالة loadWishlist إلى ملف frontend/js/wishlist.js
async function loadTrackPage(orderId) {

  const infoBox = document.getElementById("trackInfo");
  const timelineBox = document.getElementById("timeline");
  const itemsBox = document.getElementById("trackItems");

  infoBox.innerHTML = "جاري التحميل...";
  timelineBox.innerHTML = "";
  itemsBox.innerHTML = "";

  const res = await fetch(`${API}/api/orders/${orderId}`);
  const data = await res.json();

  if (data.error) {
    infoBox.innerHTML = `<p style="color:red;">الطلب غير موجود</p>`;
    return;
  }

  const o = data.order;

  /* ================================
     🛠 إصلاح القيم قبل استخدامها
     ================================ */
  o.total = Number(o.total) || 0;
  o.shipping = Number(o.shipping) || 0;
  o.shipping_vat = Number(o.shipping_vat) || 0;
  o.total_with_shipping = Number(o.total_with_shipping) || (o.total + o.shipping + o.shipping_vat);

  if (o.status === "delivery") o.status = "delivery";

  const items = data.items || [];

  // ---- معلومات الطلب ----
  infoBox.innerHTML = `
    <p><b>رقم الطلب:</b> ${o.id}</p>
    <p><b>التاريخ:</b> ${o.date}</p>
    <p><b>الإجمالي:</b> ${o.total_with_shipping.toFixed(2)} ر.س</p>
  `;

  // ---- الحالات ----
  const steps = [
    { key:"new", text:"تم استلام الطلب" },
    { key:"processing", text:"جاري التجهيز" }, 
    { key:"completed", text:"جاهز" },
    { key:"out", text:"خرج للتوصيل" },
    { key:"delivery", text:"قيد التوصيل" },
    { key:"done", text:"تم التسليم" }, 
    { key:"cancelled", text:"تم الإلغاء" }
  ];

  let activeFound = true;

  steps.forEach(s => {
    let active = "";
    if (activeFound) active = "step-active";
    if (o.status === s.key) activeFound = false;

    timelineBox.innerHTML += `
      <div class="step-item ${active}">
        <div class="step-circle"></div>
        <div class="step-text">${s.text}</div>
      </div>
    `;
  });

  // ---- الأصناف ----
  items.forEach(i => {

    const lineTotal = Number(i.total) || 0;

    itemsBox.innerHTML += `
      <div class="item-card">
        <b>${i.name}</b> × ${i.qty}<br>
        السعر: ${lineTotal.toFixed(2)} ر.س
      </div>
    `;
  });
}




async function viewOrder(id){
  const res = await fetch(API + "/api/orders/" + id);
  const data = await res.json();

  if(data.error){
    alert("الطلب غير موجود");
    return;
  }

  let text = `
    رقم الطلب: ${data.order.id}\n
    التاريخ: ${data.order.date}\n
    الحالة: ${data.order.status}\n
    الإجمالي: ${data.order.total} ر.س\n\n
    --- المنتجات ---\n
  `;

  data.items.forEach(i=>{
    text += `${i.name} × ${i.qty}\n`;
  });

  alert(text);
}


async function fetchUserOrders(phone){
  const res = await fetch(API + "/api/orders?phone=" + phone);
  return await res.json();
}

function autoFillUserInCheckout() {
    if (window.user) {
        const nameInput = document.getElementById("co_name");
        const phoneInput = document.getElementById("co_phone");
        
        if(nameInput && phoneInput) {
            nameInput.value = window.user.name;
            phoneInput.value = window.user.phone;

            nameInput.setAttribute("readonly", true);
            phoneInput.setAttribute("readonly", true);
            
            // إضافة الكلاس الخاص للمربعات readonly
            nameInput.classList.add("checkout-readonly");
            phoneInput.classList.add("checkout-readonly");
        }
    } else {
        // إذا لم يكن مسجل دخول، إزالة readonly والكلاسات
        const nameInput = document.getElementById("co_name");
        const phoneInput = document.getElementById("co_phone");
        
        if(nameInput && phoneInput) {
            nameInput.removeAttribute("readonly");
            phoneInput.removeAttribute("readonly");
            
            nameInput.classList.remove("checkout-readonly");
            phoneInput.classList.remove("checkout-readonly");
            
            nameInput.value = "";
            phoneInput.value = "";
        }
    }
}



// زر الطباعة


async function loadInvoice(orderId){

  const invoiceBox = document.getElementById("invoiceBox");
  invoiceBox.innerHTML = "<p style='text-align:center;padding:40px;color:#8a004a;'>جاري تحميل البيانات...</p>";

  // جلب بيانات الطلب
  const orderRes = await fetch(`${API}/api/orders/${orderId}`);
  const orderData = await orderRes.json();

  if(orderData.error){
    invoiceBox.innerHTML = "<p style='color:red;text-align:center;padding:40px;font-size:18px;'>❌ الطلب غير موجود</p>";
    return;
  }

  const o = orderData.order;

  // جلب الأصناف كاملة (مع الأسعار + الصور + الأكواد)
  const itemsRes = await fetch(`${API}/api/order_items_full/${orderId}`);
  const items = await itemsRes.json();

  let itemsHTML = "";
  let subtotal = 0;

  items.forEach((i, index) => {
    subtotal += i.total;

    const isEven = index % 2 === 0;
    itemsHTML += `
      <tr style="background:${isEven ? '#fafafa' : '#ffffff'};transition:background 0.2s;">
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;font-weight:500;color:#333;">${escapeHtml(i.name)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">
          <span style="background:#f0f0f0;padding:4px 12px;border-radius:20px;font-weight:600;">${i.qty}</span>
        </td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.base_price.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.price_after_discount.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.price_with_vat.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;font-weight:700;color:#8a004a;">${i.total.toFixed(2)} ر.س</td>
      </tr>
    `;
  });

  // حساب الإجماليات
  const shipping = parseFloat(o.shipping) || 0;
  const shippingVat = parseFloat(o.shipping_vat) || 0;
  const couponDiscount = parseFloat(o.coupon_discount || 0) || 0;
  
  // للتحقق من البيانات (يمكن حذفها لاحقاً)
  console.log("Order data:", {
    id: o.id,
    coupon_code: o.coupon_code,
    coupon_discount: o.coupon_discount,
    couponDiscount_parsed: couponDiscount,
    total_with_shipping: o.total_with_shipping
  });
  
  const subtotalAfterCoupon = subtotal - VATCalculator.addVAT(couponDiscount);
  const finalTotal = parseFloat(o.total_with_shipping) || (subtotalAfterCoupon + shipping + shippingVat);

  const html = `
    <div style="
      background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
      padding:30px;
      border-radius:15px 15px 0 0;
      margin:-20px -20px 30px -20px;
      color:#fff;
      text-align:center;
    ">
      <div style="font-size:48px;margin-bottom:10px;">🧾</div>
      <h2 style="margin:0;font-size:28px;font-weight:800;color:#fff;">فاتورة الطلب</h2>
      <p style="margin:10px 0 0 0;opacity:0.9;font-size:16px;">Invoice #${o.id}</p>
    </div>

    <div style="
      background:#f8f9fa;
      padding:25px;
      border-radius:12px;
      margin-bottom:25px;
      border-right:4px solid #8a004a;
    ">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;">
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">📋 رقم الطلب</div>
          <div style="font-size:18px;font-weight:700;color:#8a004a;">#${o.id}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">📅 التاريخ</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${o.date}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">👤 اسم العميل</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${escapeHtml(o.customer_name)}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">📞 رقم الجوال</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${escapeHtml(o.customer_phone)}</div>
        </div>
      </div>
      <div style="background:#fff;padding:15px;border-radius:10px;margin-top:15px;">
        <div style="font-size:14px;color:#999;margin-bottom:8px;">📍 العنوان</div>
        <div style="font-size:16px;font-weight:600;color:#333;line-height:1.6;">${escapeHtml(o.customer_address)}</div>
      </div>
    </div>

    <div style="margin-bottom:25px;">
      <h3 style="
        color:#8a004a;
        font-size:22px;
        font-weight:800;
        margin:0 0 20px 0;
        padding-bottom:15px;
        border-bottom:3px solid #8a004a;
        display:inline-block;
      ">🛍️ تفاصيل المنتجات</h3>
      
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
      <thead>
            <tr style="background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);color:#fff;">
              <th style="padding:18px;text-align:right;font-weight:700;font-size:15px;">الصنف</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">الكمية</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">السعر الأساسي</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">بعد الخصم</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">بعد الضريبة</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">الإجمالي</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>
      </div>
    </div>

    <div style="
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding:25px;
      border-radius:12px;
      margin-top:30px;
    ">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #ddd;">
        <span style="font-size:16px;color:#666;font-weight:600;">💰 إجمالي المنتجات:</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${subtotal.toFixed(2)} ر.س</span>
      </div>
      
      ${o.coupon_code ? (() => {
        const rawDiscount = o.coupon_discount;
        const discountValue = parseFloat(rawDiscount) || 0;
        console.log('Coupon display check:', { coupon_code: o.coupon_code, rawDiscount, discountValue });
        if (discountValue > 0) {
          const discountWithVat = VATCalculator.addVAT(discountValue);
          return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid #ddd;background:#d4edda;border-radius:8px;margin:8px 0;">
            <span style="font-size:16px;color:#155724;font-weight:600;">🎟️ خصم الكوبون (${o.coupon_code}):</span>
            <span style="font-size:16px;font-weight:700;color:#155724;">- ${discountWithVat.toFixed(2)} ر.س</span>
          </div>
          `;
        }
        return '';
      })() : ''}
      
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #ddd;">
        <span style="font-size:16px;color:#666;font-weight:600;">🚚 تكلفة الشحن:</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${shipping.toFixed(2)} ر.س</span>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:2px solid #8a004a;">
        <span style="font-size:16px;color:#666;font-weight:600;">📊 ضريبة الشحن (15%):</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${shippingVat.toFixed(2)} ر.س</span>
      </div>
      
      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:20px 0 0 0;
        margin-top:15px;
      ">
        <span style="font-size:24px;font-weight:800;color:#8a004a;">✨ الإجمالي النهائي:</span>
        <span style="
          font-size:32px;
          font-weight:900;
          color:#8a004a;
          background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
          -webkit-background-clip:text;
          -webkit-text-fill-color:transparent;
          background-clip:text;
        ">${finalTotal.toFixed(2)} ر.س</span>
      </div>
    </div>

    <div style="
      text-align:center;
      margin-top:30px;
      padding:20px;
      background:#f0f4ff;
      border-radius:12px;
      border:2px dashed #8a004a;
    ">
      <div style="font-size:16px;color:#8a004a;font-weight:600;">
        ✅ شكراً لك على ثقتك بنا
      </div>
      <div style="font-size:14px;color:#666;margin-top:8px;">
        سيتم التواصل معك قريباً لتأكيد الطلب
      </div>
    </div>
  `;

  invoiceBox.innerHTML = html;
}


function logoutUser() {
  // حذف بيانات المستخدم من التخزين
  localStorage.removeItem("user");
  window.user = null;

  alert("✔ تم تسجيل الخروج بنجاح");

  // تحديث رابط الحساب في الهيدر
  updateHeaderProfile();

  // تحديث شريط الكوبون (سيظهر الآن لأن المستخدم غير مسجل دخول)
  if (typeof loadCouponBanner === 'function') {
    setTimeout(() => {
      loadCouponBanner();
    }, 300);
  }

  // الانتقال لصفحة تسجيل الدخول
  go("login");
}

// تم نقل جميع دوال المصادقة إلى frontend/js/auth.js


//=================== تايمر رسالة التفعيل ======================
// تم نقل جميع دوال المصادقة إلى frontend/js/auth.js



// ===================== تحديث رابط الحساب في الهيدر =====================
function updateHeaderProfile() {
  const profileLink = document.getElementById("profileLink");
  const mobileProfileLink = document.getElementById("mobileProfileLink");
  
  // استخراج الاسم الأول من الاسم الكامل
  function getFirstName(fullName) {
    if (!fullName) return "";
    // تقسيم الاسم والحصول على أول كلمة
    const parts = fullName.trim().split(/\s+/);
    return parts[0] || fullName;
  }
  
  // تحديث شريط الكوبون بعد تحديث حالة المستخدم
  if (typeof loadCouponBanner === 'function') {
    setTimeout(() => {
      loadCouponBanner();
    }, 200);
  }
  
  if (profileLink) {
    const nameText = profileLink.querySelector(".profile-name-text");
    if (window.user && window.user.name) {
      const firstName = getFirstName(window.user.name);
      if (nameText) {
        nameText.textContent = firstName;
    } else {
        profileLink.innerHTML = `
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">${firstName}</span>
        `;
      }
      profileLink.classList.add("logged-in");
    } else {
      if (nameText) {
        nameText.textContent = "حسابي";
      } else {
        profileLink.innerHTML = `
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">حسابي</span>
        `;
      }
      profileLink.classList.remove("logged-in");
    }
  }
  
  if (mobileProfileLink) {
    const nameText = mobileProfileLink.querySelector(".mobile-profile-name");
    if (window.user && window.user.name) {
      const firstName = getFirstName(window.user.name);
      if (nameText) {
        nameText.textContent = firstName;
    } else {
        mobileProfileLink.innerHTML = `
          <span class="mobile-profile-icon">👤</span>
          <span class="mobile-profile-name">${firstName}</span>
        `;
      }
      mobileProfileLink.classList.add("logged-in");
    } else {
      if (nameText) {
        nameText.textContent = "حسابي";
      } else {
        mobileProfileLink.innerHTML = `
          <span class="mobile-profile-icon">👤</span>
          <span class="mobile-profile-name">حسابي</span>
        `;
      }
      mobileProfileLink.classList.remove("logged-in");
    }
  }
}

// ===================== القائمة المنسدلة للجوال =====================
function toggleMobileMenu() {
  const menu = document.getElementById("mobileMenu");
  if (menu) {
    menu.classList.toggle("active");
  }
}

// إغلاق القائمة عند الضغط خارجها
document.addEventListener("click", function(e) {
  const menu = document.getElementById("mobileMenu");
  const menuBtn = document.querySelector(".mobile-menu-btn");
  
  if (menu && menuBtn && !menu.contains(e.target) && !menuBtn.contains(e.target)) {
    menu.classList.remove("active");
  }
});

// تم نقل دالة updateWishlistCount إلى ملف frontend/js/wishlist.js

// ===================== تحميل محتوى الصفحات القانونية =====================
async function loadPageContent(pageType) {
  try {
    const res = await fetch(API + "/api/pages/" + pageType);
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("pageContentTitle").innerText = "خطأ";
      document.getElementById("pageContentBody").innerHTML = "<p>حدث خطأ في تحميل المحتوى</p>";
      return;
    }

    document.getElementById("pageContentTitle").innerText = data.title || "الصفحة";
    
    // إذا كانت صفحة FAQ، عرض الأسئلة بشكل منظم
    if (pageType === "faq") {
      try {
        const parsed = JSON.parse(data.content);
        if (parsed.questions && Array.isArray(parsed.questions)) {
          let html = '<div style="margin-top:30px;">';
          parsed.questions.forEach((item, index) => {
            html += `
              <div style="margin-bottom:25px;padding:25px;background:#f8f9fa;border-radius:12px;border-right:4px solid #8a004a;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="color:#8a004a;margin-bottom:15px;font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px;">
                  <span style="background:#8a004a;color:#fff;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;">${index + 1}</span>
                  ${escapeHtml(item.question)}
                </h3>
                <p style="color:#555;line-height:1.9;font-size:16px;margin:0;padding-right:45px;">${escapeHtml(item.answer)}</p>
              </div>
            `;
          });
          html += '</div>';
          document.getElementById("pageContentBody").innerHTML = html;
        } else {
          document.getElementById("pageContentBody").innerHTML = data.content || "<p>لا يوجد محتوى</p>";
        }
      } catch (e) {
        // إذا لم يكن JSON، عرض المحتوى كما هو
        document.getElementById("pageContentBody").innerHTML = data.content || "<p>لا يوجد محتوى</p>";
      }
    } else {
      // للصفحات الأخرى، عرض المحتوى HTML مباشرة
      document.getElementById("pageContentBody").innerHTML = data.content || "<p>لا يوجد محتوى</p>";
    }
    
    // التمرير للأعلى
    window.scrollTo(0, 0);
  } catch (error) {
    console.error("خطأ في تحميل المحتوى:", error);
    document.getElementById("pageContentTitle").innerText = "خطأ";
    document.getElementById("pageContentBody").innerHTML = "<p>حدث خطأ في تحميل المحتوى</p>";
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===================== إرسال الشكوى =====================
async function submitComplaint(event) {
  event.preventDefault();
  
  const email = document.getElementById("complaintEmail").value.trim();
  const subject = document.getElementById("complaintSubject").value.trim();
  const message = document.getElementById("complaintMessage").value.trim();
  
  if (!email || !subject || !message) {
    alert("⚠️ يرجى ملء جميع الحقول");
    return;
  }
  
  // تعطيل الزر أثناء الإرسال
  const submitBtn = event.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerText;
  submitBtn.disabled = true;
  submitBtn.innerText = "جاري الإرسال...";
  
  try {
    const res = await fetch(API + "/api/complaints", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ email, subject, message })
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.success) {
      alert("✅ تم إرسال شكواك بنجاح! سنتواصل معك قريباً.");
      document.getElementById("quickSupportForm").reset();
    } else {
      alert("❌ حدث خطأ أثناء الإرسال: " + (data.error || "خطأ غير معروف"));
    }
  } catch (error) {
    console.error("خطأ:", error);
    alert("❌ حدث خطأ في الاتصال بالسيرفر. يرجى المحاولة مرة أخرى.");
  } finally {
    // إعادة تفعيل الزر
    submitBtn.disabled = false;
    submitBtn.innerText = originalText;
  }
}

// تحميل السوشيال ميديا في الفوتر
async function loadFooterSocialMedia() {
  try {
    const res = await fetch(API + "/api/social-media");
    const socialMedia = await res.json();
    
    const container = document.getElementById("footerSocialMedia");
    if (!container) return;
    
    if (socialMedia.length === 0) {
      container.innerHTML = "";
      return;
    }
    
    container.innerHTML = socialMedia.map(sm => `
      <a href="${sm.url}" 
         target="_blank" 
         rel="noopener noreferrer"
         class="social-media-icon"
         title="${sm.platform}"
         style="
           display:flex;
           align-items:center;
           justify-content:center;
           width:40px;
           height:40px;
           border-radius:50%;
           background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           text-decoration:none;
           transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
           box-shadow:0 2px 8px rgba(0,0,0,0.1);
           overflow:hidden;
         "
         onmouseover="this.style.transform='scale(1.15) translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(138, 0, 74, 0.3)'"
         onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
        ${sm.icon_url ? `
          <img src="${sm.icon_url}" 
               alt="${sm.platform}" 
               style="width:24px;height:24px;object-fit:contain;"
               onerror="this.style.display='none'; this.parentElement.innerHTML='🔗';">
        ` : '🔗'}
      </a>
    `).join('');
  } catch (error) {
    console.error("Error loading social media:", error);
  }
}

window.onload = async () => {
  // إخفاء صفحة Loading بعد تحميل كل شيء
  const loader = document.getElementById("pageLoader");
  
  // مسح حقول البحث لمنع ملء رقم الهاتف تلقائياً
  const headerSearch = document.getElementById("headerSearch");
  const headerSearchMobile = document.getElementById("headerSearchMobile");
  if(headerSearch) headerSearch.value = "";
  if(headerSearchMobile) headerSearchMobile.value = "";
  
  try {
    await loadProductsCache(true);   // ← إعادة تحميل قسري للتأكد من أحدث بيانات المخزون
  renderCart();
  updateCartIcon();
  refreshAllAddToCartButtons();
  updateHeaderProfile(); // تحديث رابط الحساب
  updateWishlistCount(); // تحديث عداد المفضلة
    loadFooterSocialMedia(); // تحميل السوشيال ميديا
    loadCouponBanner(); // تحميل شريط الكوبون
  
  // قراءة الـ hash من URL لاستعادة الصفحة الحالية بعد reload
  const hash = window.location.hash;
  let targetPage = "home";
  let targetData = null;
  
  if(hash && hash.length > 1) {
    // إزالة # من البداية
    const hashPath = hash.substring(1);
    const parts = hashPath.split('/');
    targetPage = parts[0];
    if(parts.length > 1) {
      const dataValue = parts[1];
      // تحويل إلى رقم إذا كانت الصفحة تتطلب رقم (مثل product, brand, category)
      if(targetPage === "product" || targetPage === "brand" || targetPage === "category" || targetPage === "track") {
        targetData = parseInt(dataValue);
        if(isNaN(targetData)) {
          targetData = dataValue; // إذا فشل التحويل، استخدم القيمة الأصلية
        }
      } else {
        targetData = dataValue;
      }
    }
  }
  
  // إظهار الصفحة المناسبة
  setTimeout(() => {
    // إخفاء جميع الصفحات أولاً - الاعتماد على CSS فقط
    document.querySelectorAll(".page").forEach(p => {
      p.classList.remove("active");
      p.style.removeProperty("display"); // إزالة أي inline styles
    });
    
    // استدعاء go() لإظهار الصفحة المناسبة (من الـ hash أو الرئيسية)
    go(targetPage, targetData, true); // true = بدون حفظ في السجل لأننا نستعيد الصفحة
  }, 100);
    
    // إخفاء الـ loader بعد تأخير قصير لضمان تحميل كل شيء
    setTimeout(() => {
      if(loader) {
        loader.classList.add("hidden");
        // إزالة العنصر من DOM بعد انتهاء الانتقال
        setTimeout(() => {
          if(loader && loader.parentNode) {
            loader.parentNode.removeChild(loader);
          }
        }, 500);
      }
    }, 800);
  } catch(error) {
    console.error("Error loading page:", error);
    // إخفاء الـ loader حتى في حالة الخطأ
    if(loader) {
      setTimeout(() => {
        loader.classList.add("hidden");
        setTimeout(() => {
          if(loader && loader.parentNode) {
            loader.parentNode.removeChild(loader);
          }
        }, 500);
      }, 1000);
    }
  }
};

function printInvoice() {
    const invoiceHTML = document.getElementById("invoiceBox").innerHTML;

    const printWin = window.open("", "_blank", "width=900,height=1200");

    printWin.document.open();
    printWin.document.write(`
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>فاتورة الطلب</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

      <style>
        @page {
          size: A4;
          margin: 15mm;
        }

        body {
          font-family: 'Cairo', 'Tajawal', sans-serif;
          background: #fff;
          direction: rtl;
          text-align: right;
          padding: 20px;
          color: #333;
          line-height: 1.6;
        }

        .invoice-wrapper {
          width: 100%;
        }

        .header {
          text-align: center;
          margin-bottom: 20px;
        }

        .header h1 {
          color: #8a004a;
          margin-bottom: 5px;
          font-size: 26px;
          font-weight: 900;
        }

        .header .sub {
          font-size: 14px;
          color: #777;
        }

        .section-title {
          font-size: 20px;
          margin: 18px 0 8px;
          color: #8a004a;
          font-weight: 800;
          border-right: 5px solid #8a004a;
          padding-right: 8px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }

        th {
          background: #8a004a !important;
          color: #fff !important;
          padding: 10px 8px;
          border: 1px solid #8a004a;
          font-size: 12px;
          font-weight: 700;
        }

        td {
          padding: 10px 8px;
          border: 1px solid #ddd;
          font-size: 12px;
        }

        tr:nth-child(even) {
          background: #fafafa;
        }

        .totals {
          margin-top: 25px;
          font-size: 16px;
          line-height: 1.8;
        }

        .totals div {
          display: flex;
          justify-content: space-between;
          margin: 4px 0;
        }

        .grand-total {
          text-align: center;
          margin-top: 15px;
          font-size: 24px;
          color: #8a004a;
          font-weight: 900;
        }

        .footer {
          text-align: center;
          margin-top: 30px;
          font-size: 14px;
          color: #888;
        }

      </style>
    </head>

    <body>

      <div class="invoice-wrapper">

        ${invoiceHTML}

        <div class="footer" style="text-align:center;margin-top:40px;padding-top:20px;border-top:2px dashed #8a004a;font-size:13px;color:#666;">
          <div style="margin-bottom:10px;font-weight:700;color:#8a004a;">شكراً لتسوقكم معنا ❤️</div>
          <div style="color:#999;font-size:12px;">للاستفسار والتواصل: يمكنكم التواصل معنا عبر وسائل التواصل المتاحة</div>
        </div>

      </div>

    </body>
    </html>
    `);

    printWin.document.close();

    printWin.onload = () => {
        printWin.focus();
        printWin.print();
    };
}


</script>

<!-- ========================= ملف المصادقة والتسجيل ========================= -->
<script src="frontend/js/auth.js"></script>

<!-- ========================= ملف المفضلة ========================= -->
<script src="frontend/js/wishlist.js"></script>

<!-- ========================= ملف البانرات ========================= -->
<script src="frontend/js/banners.js"></script>

<!-- ========================= ملف حساب التوصيل ========================= -->
<script src="frontend/js/shipping.js"></script>

<!-- ========================= ملف حساب الضريبة (Zatka) ========================= -->
<script src="frontend/js/vat.js"></script>

<!-- ========================= ملف شات الدعم ========================= -->
<script src="frontend/js/support-chat.js"></script>

<!-- ========================= سيضاف هنا: كود API + كود السلة + كود الصفحات ========================= -->


</body>
</html>

