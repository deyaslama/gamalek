<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ูุชุฌุฑ ุฌูุงูู</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

<!-- CSS Files -->
<link rel="stylesheet" href="frontend/css/base.css">
<link rel="stylesheet" href="frontend/css/animations.css">
<link rel="stylesheet" href="frontend/css/header.css">
<link rel="stylesheet" href="frontend/css/footer.css">
<link rel="stylesheet" href="frontend/css/products.css">
<link rel="stylesheet" href="frontend/css/pages.css">
<link rel="stylesheet" href="frontend/css/modals.css">
<link rel="stylesheet" href="frontend/css/forms.css">
<link rel="stylesheet" href="frontend/css/utilities.css">
<link rel="stylesheet" href="frontend/css/ratings.css">
<link rel="stylesheet" href="frontend/css/loader.css">
<link rel="stylesheet" href="frontend/css/print.css">

</head>

<body>

<!-- ========================= ุตูุญุฉ Loading ========================= -->
<div id="pageLoader" class="page-loader">
  <div class="loader-container">
    <div class="loader-logo">
      <div class="loader-logo-circle">ุฌ</div>
      <div class="loader-logo-text">ุฌูุงูู</div>
    </div>
    <div class="loader-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <div class="loader-text">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>
</div>

<!-- =========================  ุงูููุฏุฑ (ุณูุชู ุฏูุฌู ูุงุญููุง ููุง ูู) ========================= -->

<!-- ูุธุงู ุงูุฅุดุนุงุฑุงุช -->
<div id="notificationContainer" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:100000;pointer-events:none;max-width:500px;width:90%;"></div>

<header id="mainHeader">
  <div class="container">
    <div class="nav">

      <!-- ุงูุดุนุงุฑ -->
      <div class="logo" onclick="go('home')">
        <div class="logo-circle">ุฌ</div>
        <div style="font-size:22px;font-weight:800;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.2);">ุฌูุงูู</div>
      </div>

      <!-- ุงูุจุญุซ -->
      <div class="header-search-wrapper" style="flex:1;display:flex;justify-content:center;">
        <!-- ุฒุฑ ุงูุจุญุซ ููุฌูุงู ููุท -->
        <button class="mobile-search-icon-btn" onclick="toggleMobileSearch()" id="mobileSearchBtn">๐</button>
        
        <!-- ุญุงููุฉ ุงูุจุญุซ ููุฌูุงู -->
        <div class="mobile-search-container" id="mobileSearchContainer" style="position:relative;width:100%;max-width:400px;">
          <input 
            id="headerSearchMobile"
            oninput="headerLiveSearch()"
            placeholder="ุงุจุญุซ ุนู ููุชุฌโฆ" 
            class="header-search-input"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            type="search"
            name="product-search"
            data-lpignore="true"
          />
          <span class="header-search-icon">๐</span>
          <button class="mobile-search-close" onclick="closeMobileSearch()">โ</button>
          <div id="headerSearchResultsMobile" class="header-search-results"></div>
        </div>
        
        <!-- ุญูู ุงูุจุญุซ ููููุจููุชุฑ -->
        <div class="desktop-search-container" style="position:relative;width:100%;max-width:400px;">
          <input 
            id="headerSearch"
            oninput="headerLiveSearch()"
            placeholder="ุงุจุญุซ ุนู ููุชุฌโฆ" 
            class="header-search-input"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            type="search"
            name="product-search"
            data-lpignore="true"
          />
          <span class="header-search-icon">๐</span>
          <div id="headerSearchResults" class="header-search-results"></div>
        </div>
      </div>

      <!-- ุฑูุงุจุท (ููููุจููุชุฑ) -->
      <div class="nav-links">
        <a href="#" data-page="home" onclick="go('home'); return false;">ุงูุฑุฆูุณูุฉ</a>
        <a href="#" data-page="products" onclick="go('products'); return false;">ุงูููุชุฌุงุช</a>
        <a href="#" data-page="brands" onclick="go('brands'); return false;">ุงููุงุฑูุงุช</a>
        <a href="#" data-page="profile" id="profileLink" onclick="go('profile'); return false;" class="profile-link-header">
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">ุญุณุงุจู</span>
        </a>
        <a href="#" data-page="offers" onclick="go('offers'); return false;">ุงูุนุฑูุถ</a>
        <a href="#" data-page="categories" onclick="go('categories'); return false;">ุงูุชุตูููุงุช</a>
        <a href="#" data-page="wishlist" onclick="go('wishlist'); return false;" class="wishlist-link">
          <span id="wishlistIcon" style="display:inline-flex;align-items:center;justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter:drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
          </span>
          <span id="wishlistCount" class="wishlist-count">0</span>
        </a>
      </div>

      <!-- ุฃููููุฉ ุงูุณูุฉ -->
      <div onclick="openCart()" class="cart-icon-wrapper">
        <span class="cart-icon" style="display:inline-flex;align-items:center;justify-content:center;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 4C7 2.89543 7.89543 2 9 2H15C16.1046 2 17 2.89543 17 4V6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H19L18 20C18 21.1046 17.1046 22 16 22H8C6.89543 22 6 21.1046 6 20L5 8H4C3.44772 8 3 7.55228 3 7C3 6.44772 3.44772 6 4 6H7V4Z"/>
            <path d="M9 2C8.44772 2 8 2.44772 8 3V4H7V3C7 2.44772 7.44772 2 8 2H9Z"/>
            <path d="M15 2C15.5523 2 16 2.44772 16 3V4H17V3C17 2.44772 16.5523 2 16 2H15Z"/>
            <circle cx="9" cy="20" r="1.5"/>
            <circle cx="15" cy="20" r="1.5"/>
          </svg>
        </span>
        <span id="cartCount" class="cart-count"></span>
      </div>

      <!-- ุฒุฑ ุงููุงุฆูุฉ ููุฌูุงู -->
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">โฐ</button>

    </div>

    <!-- ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ููุฌูุงู -->
    <div id="mobileMenu" class="mobile-menu">
      <a href="#" data-page="home" onclick="go('home'); toggleMobileMenu(); return false;">๐ ุงูุฑุฆูุณูุฉ</a>
      <a href="#" data-page="products" onclick="go('products'); toggleMobileMenu(); return false;">๐๏ธ ุงูููุชุฌุงุช</a>
      <a href="#" data-page="brands" onclick="go('brands'); toggleMobileMenu(); return false;">๐ท๏ธ ุงููุงุฑูุงุช</a>
      <a href="#" data-page="profile" id="mobileProfileLink" onclick="go('profile'); toggleMobileMenu(); return false;" class="mobile-profile-link-header">
        <span class="mobile-profile-icon">๐ค</span>
        <span class="mobile-profile-name">ุญุณุงุจู</span>
      </a>
      <a href="#" data-page="offers" onclick="go('offers'); toggleMobileMenu(); return false;">๐ ุงูุนุฑูุถ</a>
      <a href="#" data-page="categories" onclick="go('categories'); toggleMobileMenu(); return false;">๐ ุงูุชุตูููุงุช</a>
      <a href="#" data-page="wishlist" onclick="go('wishlist'); toggleMobileMenu(); return false;" class="wishlist-link">
        <span id="wishlistIconMobile" style="display:inline-flex;align-items:center;justify-content:center;">โค๏ธ</span>
        <span id="wishlistCountMobile" class="wishlist-count-mobile">0</span>
      </a>
    </div>

  </div>
</header>

<!-- ========================= ูุณู ุงูุชุตูููุงุช ========================= -->
<div class="categories-bar">
  <div class="container">
    <div class="categories">
      <div class="cat" onclick="go('products')">ุนูุงูุฉ ุจุงูุจุดุฑุฉ</div>
      <div class="cat" onclick="go('products')">ูููุงุฌ ุงููุฌู</div>
      <div class="cat" onclick="go('products')">ูููุงุฌ ุงูุนููู</div>
      <div class="cat" onclick="go('products')">ุงูุดูุงู</div>
      <div class="cat" onclick="go('products')">ุงูุนุทูุฑ</div>
      <div class="cat" onclick="go('products')">ุงูุนูุงูุฉ ุงูุดุฎุตูุฉ</div>
      <div class="cat" onclick="go('products')">ุงูุนุฑูุถ</div>
    </div>
  </div>
</div>

<!-- ========================= ุงูุณูุฉ ุงูุฌุงูุจูุฉ (ุซุงุจุชุฉ) ========================= -->
<!-- ุฎูููุฉ ุณูุฏุงุก -->
<div id="cartOverlay" onclick="closeCart()" style="display:none;"></div>
<!-- ููุญุฉ ุงูุณูุฉ -->
<div id="cartPanel">
  <h2 style="color:#8a004a;margin-bottom:10px;">๐ ุณูุฉ ุงููุดุชุฑูุงุช</h2>
  <!-- ุงูุนูุงุตุฑ -->
  <div id="cartItems" style="flex:1;overflow-y:auto;margin-bottom:10px;"></div>
  <!-- ุงูุฅุฌูุงูู -->
  <div style="font-size:20px;font-weight:800;margin:20px 0;padding:15px;background:linear-gradient(135deg, #fce4ef 0%, #ffeef5 100%);border-radius:12px;color:#8a004a;text-align:center;border:2px solid #f2bfd7;">
    ุงูุฅุฌูุงูู: <span id="cartTotal" style="color:#E91E63;">0</span> ุฑ.ุณ
  </div>
  <!-- ุฃุฒุฑุงุฑ ุงูุณูุฉ -->
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
    <button onclick="goToCheckout()" style="background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:700;box-shadow:0 4px 12px rgba(233, 30, 99, 0.3);transition:all 0.3s ease;cursor:pointer;">
      ุฅุชูุงู ุงูุทูุจ
    </button>
    <button onclick="closeCart()" style="background:#f5f5f5;color:#666;width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;transition:all 0.3s ease;cursor:pointer;">
      ูุชุงุจุนุฉ ุงูุชุณูู
    </button>
  </div>
</div>

<!-- ========================= ูุธุงู ุงูุตูุญุงุช SPA ========================= -->

<div id="app">
<!-- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
<section id="homePage" class="page">
  <div class="container">
    <!-- ุณูุงูุฏุฑ -->
    <div class="slider">
      <img src="https://i.imgur.com/UAp8b9b.jpeg" style="width:100%;height:100%;object-fit:cover;">
    </div>
    <!-- ุจุงูุฑุงุช ููู ุงููุงุฑูุงุช -->
    <div id="bannersAboveBrands" class="banners-slider-container" style="margin-bottom:30px;"></div>
    <!-- ุงููุงุฑูุงุช -->
    <h2 class="section-title-centered">ุฃุดูุฑ ุงููุงุฑูุงุช โญ</h2>
    <div class="brands-wrapper">
      <button class="brand-arrow left" onclick="scrollBrands(-300)">โน</button>
      <div id="brandsSlider" class="brands-slider"></div>
      <button class="brand-arrow right" onclick="scrollBrands(300)">โบ</button>
    </div>
    <!-- ุจุงูุฑุงุช ููู ุงูููุชุฌุงุช ุงููููุฒุฉ -->
    <div id="bannersAboveFeatured" class="banners-slider-container" style="margin-bottom:30px;"></div>
    <!-- ููุชุฌุงุช ูููุฒุฉ -->
    <h2 class="section-title-with-line">ููุชุฌุงุช ูุฎุชุงุฑุฉ โจ</h2>
    <div id="featuredGrid" class="products-grid"></div>
    <!-- ุจุงูุฑุงุช ููู ุงูุนุฑูุถ -->
    <div id="bannersAboveOffers" class="banners-slider-container" style="margin-bottom:30px;"></div>
    <!-- ุนุฑูุถ -->
    <h2 class="section-title-with-line">ุนุฑูุถ ุฎุงุตุฉ ๐</h2>
    <div id="discountGrid" class="products-grid"></div>
    <button class="more-btn" onclick="go('products')">ุนุฑุถ ุงููุฒูุฏ</button>
  </div>
</section>

<!-- ุตูุญุฉ ุงูููุถููุงุช -->
<section id="page-wishlist" class="page">
  <div class="container">
    <h2 class="section-title">ุงูููุถููุงุช โค๏ธ</h2>
    <div id="wishlistGrid" class="products-grid"></div>
  </div>
</section>

<!-- ุตูุญุฉ ุงููุญุชูู ุงููุงูููู -->
<section id="page-page" class="page">
  <div class="container" style="max-width:900px;margin:0 auto;padding:40px 20px;">
    <div id="pageContentContainer" style="background:#fff;padding:40px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);line-height:1.8;">
      <h1 id="pageContentTitle" style="color:#8a004a;margin-bottom:30px;font-size:32px;font-weight:700;"></h1>
      <div id="pageContentBody" style="color:#555;font-size:16px;"></div>
    </div>
  </div>
</section>

  <!-- ูู ุงูููุชุฌุงุช -->
<section id="page-products" class="page">

  <div class="container">

    <h2 class="section-title">ูู ุงูููุชุฌุงุช</h2>

    <!-- ูุฑุจุน ุงูุจุญุซ -->
    <input id="productsSearch"
           placeholder="ุงุจุญุซ ุนู ููุชุฌโฆ"
           style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:15px;"
           oninput="filterProducts()">

    <!-- ููุชุฑุฉ ุญุณุจ ุงููุงุฑูุฉ -->
    <select id="brandSelect"
            onchange="filterProducts()"
            style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:20px;">
      <option value="">ูู ุงููุงุฑูุงุช</option>
    </select>

    <!-- ุดุจูุฉ ุงูููุชุฌุงุช -->
    <div id="productsPageGrid" class="products-grid"></div>

  </div>

</section>


  <!-- ุชูุงุตูู ุงูููุชุฌ -->
<section id="page-product" class="page">

  <div class="container" id="productDetailsBox" style="min-height:400px;padding:20px;">

    <!-- ุณูุถุงู ุฏููุงููููุงู -->

  </div>

</section>


  <!-- ุงููุงุฑูุงุช -->
  <section id="page-brands" class="page">
  <div class="container">

    <h2 class="section-title">ุงููุงุฑูุงุช</h2>

    <div id="brandsGrid" 
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;">
    </div>

  </div>
</section>


  <!-- ููุชุฌุงุช ุงููุงุฑูุฉ -->
<section id="page-brand" class="page">
  <div class="container">
    <h2 class="section-title" id="brandTitle">ููุชุฌุงุช ุงููุงุฑูุฉ</h2>
    <div id="brandProductsGrid" class="products-grid"></div>
  </div>
</section>


  <!-- ุงูุณูุฉ / ุงูุฏูุน -->
<section id="page-checkout" class="page">
  <div class="checkout-container">
    <div class="checkout-card">
      <div class="checkout-header">
        <div class="checkout-icon">๐</div>
        <h2 class="checkout-title">ุฅุชูุงู ุงูุทูุจ</h2>
        <p class="checkout-subtitle">ุชุฃูุฏ ูู ุตุญุฉ ุจูุงูุงุชู ูุจู ุฅุชูุงู ุงูุทูุจ</p>
      </div>

    <!-- ุจูุงูุงุช ุงูุนููู -->
      <div class="checkout-section">
        <h3 class="section-title-small">ุจูุงูุงุช ุงูุนููู</h3>

        <div class="input-group">
          <label class="input-label">ุงุณู ุงูุนููู</label>
          <input id="co_name" class="modern-input checkout-readonly" readonly placeholder="ุณูุชู ููุคู ุชููุงุฆูุงู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู">
        </div>

        <div class="input-group">
          <label class="input-label">ุฑูู ุงููุงุชู</label>
          <input id="co_phone" class="modern-input checkout-readonly" readonly placeholder="ุณูุชู ููุคู ุชููุงุฆูุงู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู">
        </div>

        <div class="input-group">
          <label class="input-label">ุฑูู ุขุฎุฑ ููุชูุงุตู (ุงุฎุชูุงุฑู)</label>
          <input id="co_phone2" class="modern-input" type="tel" placeholder="ุฃุฏุฎู ุฑูู ูุงุชู ุขุฎุฑ">
        </div>

        <div class="input-group">
          <label class="input-label">ุงูุนููุงู</label>
          <input id="co_address" class="modern-input" placeholder="ุฃุฏุฎู ุนููุงู ุงูุชูุตูู">
        </div>

        <div class="input-group">
          <label class="input-label">ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู</label>
          <button onclick="pickLocation()" class="modern-btn-location">
            <span class="btn-icon">๐</span>
            <span>ุชุญุฏูุฏ ุงููููุน</span>
      </button>
          <input id="co_location" class="modern-input" readonly placeholder="ูู ูุชู ุงุฎุชูุงุฑ ูููุน ุจุนุฏ">
          <small class="location-hint">ุงุถุบุท ุนูู ุงูุฒุฑ ุฃุนูุงู ูุชุญุฏูุฏ ูููุนู ุงูุฌุบุฑุงูู</small>
        </div>

        <div class="input-group">
          <label class="input-label">ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
          <textarea id="co_notes" class="modern-input" style="height:100px;resize:vertical;" placeholder="ุฃุถู ุฃู ููุงุญุธุงุช ุฃู ุชุนูููุงุช ุฎุงุตุฉ ููุชูุตูู"></textarea>
        </div>
    </div>

    <!-- ุงูููุชุฌุงุช + ุงููุงุชูุฑุฉ ุฏุงุฎู ููุณ ุงููุฑุช -->
      <div class="checkout-section" id="checkoutItems"></div>

    <!-- ุงูุฃุฒุฑุงุฑ -->
      <div class="checkout-actions">
        <button onclick="sendWhatsAppOrder()" class="modern-btn-primary">
          <span>ุฅุชูุงู ุงูุทูุจ ุนุจุฑ ูุงุชุณุงุจ</span>
          <span class="btn-arrow">โ</span>
    </button>

        <button onclick="payOnline()" class="modern-btn-secondary checkout-btn-blue">
      ุงูุฏูุน ุงูุฅููุชุฑููู
    </button>

        <button onclick="go('home')" class="modern-btn-back">
      โ ูุชุงุจุนุฉ ุงูุชุณูู
    </button>
      </div>
    </div>
  </div>
</section>


<section id="page-track" class="page">

  <div class="track-container">

    <div class="track-title">ุชุชุจุน ุงูุทูุจ</div>

    <div class="track-info" id="trackInfo">ุชุญููู ุงูุจูุงูุงุช...</div>

    <div class="timeline" id="timeline"></div>

    <div class="items-title">ุงูุฃุตูุงู</div>
    <div id="trackItems"></div>

  </div>

</section>




  <!-- ูุงุชูุฑุฉ ุงูุนููู-->
<section id="page-thanks" class="page">
  <div class="container" style="max-width:750px;margin:auto;padding:25px;">

    <h2 style="text-align:center;color:#8a004a;font-weight:900;">ูุงุชูุฑุฉ ุงูุทูุจ</h2>

    <div id="invoiceBox" style="
      background:#fff;
      padding:20px;
      border-radius:15px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      margin-top:20px;
    ">
      <p style="text-align:center;color:#777;">ุฌุงุฑู ุชุญููู ุงููุงุชูุฑุฉ...</p>
    </div>

    <button onclick="printInvoice()" 
      style="display:block;width:100%;margin-top:25px;background:#8a004a;color:white;padding:12px;border:none;border-radius:10px;font-size:18px;">
      ๐จ ุทุจุงุนุฉ ุงููุงุชูุฑุฉ
    </button>

    <button onclick="go('home')" 
      style="display:block;width:100%;margin-top:15px;background:#E91E63;color:white;padding:12px;border:none;border-radius:10px;font-size:18px;">
      โ ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
    </button>

  </div>
</section>








  <!-- ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู -->
  <section id="page-login" class="page">
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-icon">๐</div>
        <h2 class="login-title">ูุฑุญุจุงู ุจุนูุฏุชู</h2>
        <p class="login-subtitle">ุณุฌู ุฏุฎููู ูููุตูู ุฅูู ุญุณุงุจู</p>
      </div>

      <div class="login-form">
        <div class="input-group">
          <label class="input-label">๐ฑ ุฑูู ุงูุฌูุงู</label>
          <input id="loginPhone" 
                 type="tel"
                 placeholder="5xxxxxxxx"
                 class="modern-input"
                 autocomplete="tel">
        </div>

        <div class="input-group">
          <label class="input-label">๐ ูููุฉ ุงููุฑูุฑ</label>
          <input id="loginPass" 
                 type="password" 
                 placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ"
                 class="modern-input"
                 autocomplete="current-password">
        </div>

        <div class="forgot-link">
          <a href="#" onclick="go('forgot')">ูุณูุช ูููุฉ ุงููุฑูุฑุ</a>
        </div>

        <button onclick="doLogin()" class="modern-btn-primary">
          <span>ุฏุฎูู</span>
          <span class="btn-arrow">โ</span>
        </button>

        <div id="loginMsg" class="error-message"></div>

        <div class="login-divider">
          <span>ุฃู</span>
        </div>

        <button onclick="go('register')" class="modern-btn-secondary">
          ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
        </button>
      </div>
    </div>
  </div>
</section>
<!-- ุตูุญุฉ ูุณูุงู ูููุฉ ุงููุฑูุฑ -->
<section id="page-forgot" class="page">
  <div style="max-width:400px;margin:auto;padding:25px;">
    <h2 class="section-title">ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ</h2>

    <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
    <input id="fpEmail" type="email"
           placeholder="example@gmail.com"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <button onclick="sendResetCode()"
            style="background:#8a004a;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;">
      ุฅุฑุณุงู ููุฏ ุงูุงุณุชุนุงุฏุฉ
    </button>

    <div id="fpMsg" style="margin-top:15px;color:red;text-align:center;"></div>

    <p style="margin-top:15px;text-align:center;">
      <a href="#" onclick="go('login')" style="color:#E91E63;">ุงูุนูุฏุฉ ูุชุณุฌูู ุงูุฏุฎูู</a>
    </p>
  </div>
</section>
<!-- ุตูุญุฉ ุฅุนุงุฏุฉ ุถุจุท ูููุฉ ุงููุฑูุฑ -->
<section id="page-reset" class="page">
  <div style="max-width:400px;margin:auto;padding:25px;">

    <h2 class="section-title">ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ</h2>

    <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
    <input id="rpEmail" type="email"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <label>ููุฏ ุงูุชุญูู</label>
    <input id="rpCode" 
           placeholder="XXXXXX"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <label>ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ</label>
    <input id="rpPass" type="password"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <button onclick="resetPassword()"
            style="background:#8a004a;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;">
      ุญูุธ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ
    </button>

    <div id="rpMsg" style="margin-top:15px;color:red;text-align:center;"></div>

  </div>
</section>
<!-- ุตูุญุฉ ุชูุนูู ุงูุญุณุงุจ -->
<section id="page-verify" class="page">
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <div class="register-icon">๐</div>
        <h2 class="register-title">ุชูุนูู ุงูุญุณุงุจ</h2>
        <p class="register-subtitle">ุฃุฏุฎู ููุฏ ุงูุชูุนูู ุงูุฐู ุฃุฑุณููุงู ุฅูู ุจุฑูุฏู ุงูุฅููุชุฑููู</p>
      </div>

      <div class="register-form">
        <div class="input-group">
          <label class="input-label">๐ฑ ุฑูู ุงูุฌูุงู</label>
          <div class="phone-input-group">
            <span class="phone-prefix">๐ธ๐ฆ +966</span>
    <input id="vPhone"
                   type="tel"
           readonly
                   class="modern-input phone-input"
                   style="background: #f0f0f0; cursor: not-allowed;">
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">๐ ููุฏ ุงูุชูุนูู</label>
          <input id="vCode" 
                 type="text"
                 inputmode="numeric"
                 pattern="[0-9]*"
                 placeholder="ุฃุฏุฎู ุงูููุฏ ุงููููู ูู 6 ุฃุฑูุงู"
                 class="modern-input"
                 maxlength="6"
                 style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 700;"
                 onkeypress="return /[0-9]/i.test(event.key)"
                 oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>

        <button onclick="verifyAccount()" class="modern-btn-primary">
          <span>ุชูุนูู ุงูุญุณุงุจ</span>
          <span class="btn-arrow">โ</span>
    </button>

        <div id="verifyMsg" class="error-message"></div>

        <div class="register-footer" style="text-align: center; margin-top: 20px;">
          <div style="padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 15px;">
            <span id="resendBox" style="display: inline-block;">
              <a href="#" onclick="resendVerifyCode(); return false;" class="link-primary" style="font-weight: 600;">
                ๐ ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูููุฏ
              </a>
      </span>
            <span id="timerBox" style="display: none; color: #666; font-size: 14px;">
              โฑ๏ธ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู ูุชุงุญุฉ ุฎูุงู <span id="timer" style="font-weight: 700; color: #E91E63;">60</span> ุซุงููุฉ
      </span>
          </div>
          <p style="margin: 0; color: #666; font-size: 14px;">
            ูู ุชุณุชูู ุงูููุฏุ ุชุญูู ูู ุตูุฏูู ุงููุงุฑุฏ ูุงูุฑุณุงุฆู ุบูุฑ ุงููุฑุบูุจ ูููุง
    </p>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- ุตูุญุฉ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ -->
<!-- ุตูุญุฉ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ -->
<section id="page-register" class="page">
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <div class="register-icon">โจ</div>
        <h2 class="register-title">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</h2>
        <p class="register-subtitle">ุงูุถู ุฅูููุง ูุงุจุฏุฃ ุฑุญูุชู ูุนูุง</p>
      </div>

      <div class="register-form">
        <div class="input-group">
          <label class="input-label">๐ค ุงูุงุณู ุงููุงูู</label>
          <input id="regName" 
                 type="text"
                 placeholder="ุฃุฏุฎู ุงูุงุณู ุงููุงูู"
                 class="modern-input"
                 autocomplete="name">
        </div>

        <div class="input-group">
          <label class="input-label">๐ฑ ุฑูู ุงูุฌูุงู</label>
          <div class="phone-input-group">
            <span class="phone-prefix">๐ธ๐ฆ +966</span>
            <input id="regPhone" 
                   type="tel"
                   placeholder="05xxxxxxxx ุฃู 5xxxxxxxx"
                   class="modern-input phone-input"
                   autocomplete="tel">
            <span id="regPhoneIcon" class="validation-icon"></span>
          </div>
          <div id="regPhoneMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <div class="input-with-icon">
          <input id="regEmail" 
                 type="email"
                 placeholder="example@gmail.com"
                 class="modern-input"
                 autocomplete="email">
            <span id="regEmailIcon" class="validation-icon"></span>
          </div>
          <div id="regEmailMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">๐ ูููุฉ ุงููุฑูุฑ</label>
          <div class="input-with-icon">
          <input id="regPass" 
                 type="password"
                 placeholder="โขโขโขโขโขโขโขโข"
                 class="modern-input"
                 autocomplete="new-password">
            <span id="regPassIcon" class="validation-icon"></span>
          </div>
          <div id="regPassStrength" class="password-strength"></div>
          <div id="regPassMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">๐ ุฅุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ</label>
          <input id="regPass2" 
                 type="password"
                 placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ"
                 class="modern-input"
                 autocomplete="new-password">
        </div>

        <div class="input-group">
          <label class="input-label">๐ ุงูุนููุงู ุงูุชูุตููู</label>
          <input id="regAddress" 
                 type="text"
                 placeholder="ูุซุงู: ุฌุฏุฉ - ุญู ุงูุญูุฏุงููุฉ - ุดุงุฑุน ุณุนูุฏ"
                 class="modern-input"
                 autocomplete="street-address">
        </div>

        <button onclick="doRegister()" class="modern-btn-primary">
          <span>ุฅูุดุงุก ุงูุญุณุงุจ</span>
          <span class="btn-arrow">โ</span>
        </button>

        <div id="registerMsg" class="error-message"></div>

        <div class="register-footer">
          <p>ูุฏูู ุญุณุงุจ ุจุงููุนูุ 
            <a href="#" onclick="go('login')" class="link-primary">ุชุณุฌูู ุงูุฏุฎูู</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>





  <!-- ุตูุญุฉ ุญุณุงุจ ุงููุณุชุฎุฏู -->
  <section id="page-profile" class="page">
  <div class="container" style="max-width:900px;margin:0 auto;padding:30px 20px;">
    
    <!-- ุจุทุงูุฉ ุงููุณุชุฎุฏู -->
    <div style="background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);padding:40px;border-radius:16px;color:#fff;margin-bottom:30px;box-shadow:0 8px 24px rgba(138,0,74,0.3);">
      <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
        <div style="width:100px;height:100px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;backdrop-filter:blur(10px);">
          ๐ค
        </div>
        <div style="flex:1;">
          <h2 id="pName" style="font-size:28px;margin-bottom:10px;font-weight:700;">โ</h2>
          <p id="pPhone" style="font-size:16px;opacity:0.9;margin:5px 0;">โ</p>
          <p id="pEmail" style="font-size:16px;opacity:0.9;margin:5px 0;">โ</p>
          <p id="pAddress" style="font-size:16px;opacity:0.9;margin:5px 0;">โ</p>
        </div>
    </div>
  </div>

    <!-- ุงูุฃุฒุฑุงุฑ -->
    <div style="display:flex;gap:15px;margin-bottom:30px;flex-wrap:wrap;">
      <button onclick="showChangePasswordModal()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(6,95,106,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(6,95,106,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(6,95,106,0.3)'">
        ๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ
      </button>
      <button onclick="logoutUser()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #d62828 0%, #b71c1c 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(214,40,40,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(214,40,40,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(214,40,40,0.3)'">
        ๐ช ุชุณุฌูู ุงูุฎุฑูุฌ
      </button>
    </div>

    <!-- ุงูุทูุจุงุช -->
    <h2 class="section-title" style="margin-bottom:20px;">๐ฆ ุทูุจุงุชู</h2>
  <div id="profileOrders"></div>

  </div>

  <!-- ูุงูุฐุฉ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ -->
  <div id="changePasswordModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;justify-content:center;align-items:center;">
    <div style="background:#fff;padding:40px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h3 style="color:#8a004a;margin-bottom:25px;font-size:24px;font-weight:700;text-align:center;">๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h3>
      
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ:</label>
        <input type="password" id="currentPassword" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
</div>

      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ:</label>
        <input type="password" id="newPassword" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
      </div>

      <div style="margin-bottom:25px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ:</label>
        <input type="password" id="confirmPassword" placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
      </div>

      <div id="changePasswordMsg" style="margin-bottom:20px;color:#e74c3c;font-size:14px;text-align:center;"></div>

      <div style="display:flex;gap:12px;">
        <button onclick="changePassword()" style="flex:1;padding:12px;background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">ุชุบููุฑ</button>
        <button onclick="hideChangePasswordModal()" style="flex:1;padding:12px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>
</section>

<!-- Modal ุชุณุฌูู ุงูุฏุฎูู -->
<div id="loginRequiredModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;justify-content:center;align-items:center;backdrop-filter:blur(4px);">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:450px;width:90%;box-shadow:0 12px 48px rgba(0,0,0,0.3);text-align:center;animation:modalSlideIn 0.3s ease-out;">
    <div style="font-size:64px;margin-bottom:20px;">๐</div>
    <h3 style="color:#8a004a;margin-bottom:15px;font-size:24px;font-weight:800;">ุชุณุฌูู ุงูุฏุฎูู ูุทููุจ</h3>
    <p style="color:#666;margin-bottom:30px;font-size:16px;line-height:1.6;">
      ูุงุจุฏ ูู ุชุณุฌูู ุฏุฎูู ูุจู ุฅุชูุงู ุงูุทูุจ<br>
      <span style="color:#999;font-size:14px;">ุณุฌู ุฏุฎููู ุงูุขู ูููุชุงุจุนุฉ</span>
    </p>
    
    <div style="display:flex;gap:12px;flex-direction:column;">
      <button onclick="goToLoginFromModal()" style="width:100%;padding:16px;background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(233, 30, 99, 0.4);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(233, 30, 99, 0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(233, 30, 99, 0.4)'">
        ุชุณุฌูู ุงูุฏุฎูู ุงูุขู
      </button>
      <button onclick="closeLoginRequiredModal()" style="width:100%;padding:14px;background:#f5f5f5;color:#666;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f5f5f5'">
        ุฅูุบุงุก
      </button>
    </div>
  </div>
</div>

<!-- ุตูุญุฉ ุงูุนุฑูุถ -->
<section id="page-offers" class="page">
  <div class="container">
    <h2 class="section-title">๐ ุนุฑูุถ ุฎุงุตุฉ</h2>

    <div id="offersGrid" class="products-grid"></div>

  </div>
</section>

<!-- ุตูุญุฉ ุงูุชุตูููุงุช -->
<section id="page-categories" class="page">
  <div class="container">

    <h2 class="section-title">ุงูุชุตูููุงุช</h2>

    <div id="categoriesList" 
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;">
    </div>

  </div>
</section>
<!-- ุตูุญุฉ ููุชุฌุงุช ุงูุชุตููู -->
<section id="page-category" class="page">
  <div class="container">

    <h2 class="section-title" id="categoryTitle"></h2>

    <div id="categoryGrid" class="products-grid"></div>

  </div>
</section>

</div>


<!-- ========================= ุงูููุชุฑ ========================= -->
<footer class="footer" id="mainFooter">
  <div class="footer-container">

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">ุฑูุงุจุท ุณุฑูุนุฉ</h3>
      <p><a href="#" onclick="go('home'); return false;">ุงูุฑุฆูุณูุฉ</a></p>
      <p><a href="#" onclick="go('products'); return false;">ุงูููุชุฌุงุช</a></p>
      <p><a href="#" onclick="go('brands'); return false;">ุงููุงุฑูุงุช</a></p>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">ูุนูููุงุช ูุงููููุฉ</h3>
      <p><a href="#" onclick="go('page', 'privacy'); return false;">๐ ุณูุงุณุฉ ุงูุงุณุชุฎุฏุงู ูุงูุฎุตูุตูุฉ</a></p>
      <p><a href="#" onclick="go('page', 'return'); return false;">๐ ุณูุงุณุฉ ุงูุงุณุชุจุฏุงู ูุงูุงุฑุฌุงุน</a></p>
      <p><a href="#" onclick="go('page', 'terms'); return false;">๐ ุงูุดุฑูุท ูุงูุฃุญูุงู</a></p>
      <p><a href="#" onclick="go('page', 'faq'); return false;">โ ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a></p>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">ุชูุงุตู ูุนูุง</h3>
      <p>๐ 055-555-5555</p>
      <p>๐ง info@beauty.com</p>
      <div id="footerSocialMedia" style="margin-top:15px;display:flex;gap:12px;flex-wrap:wrap;">
        <!-- ุณูุชู ุชุญููู ุงูุฃููููุงุช ููุง -->
      </div>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">ุงูุฏุนู ุงูุณุฑูุน</h3>
      <form id="quickSupportForm" onsubmit="submitComplaint(event)" style="display:flex;flex-direction:column;gap:6px;">
        <input type="email" id="complaintEmail" placeholder="๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" required style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;font-family:'Cairo',sans-serif;">
        <input type="text" id="complaintSubject" placeholder="๐ ุนููุงู ุงูุดููู" required style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;font-family:'Cairo',sans-serif;">
        <textarea id="complaintMessage" placeholder="๐ฌ ูุญุชูู ุงูุดููู" required rows="3" style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;resize:vertical;font-family:'Cairo',sans-serif;"></textarea>
        <button type="submit" style="padding:8px;background:#8a004a;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;font-family:'Cairo',sans-serif;">ุฅุฑุณุงู</button>
      </form>
    </div>

  </div>

  <div class="footer-bottom">
    ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2025 ูุชุฌุฑ ุฌูุงูู
  </div>
</footer>



<!-- ========================= ููุฏ SPA Router ========================= -->

<script>
async function loadProductsCache(forceReload = false) {
  if (!window.productsCache || forceReload) {
    const res = await fetch(API + "/api/admin/products");
    window.productsCache = await res.json();
    
    // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
    window.productsCache = window.productsCache.map(p => ({
      ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
    }));
  }
}

function safeImageURL(url) {
  if (!url || url.trim() === "" || url.length < 10) {
    return "https://via.placeholder.com/300x300?text=No+Image";
  }

  url = url.trim();

  // Google Drive
  if (url.includes("drive.google.com")) {
    const id = url.match(/[-\w]{25,}/);
    return id ? `https://lh3.googleusercontent.com/d/${id[0]}` : "https://via.placeholder.com/300x300?text=No+Image";
  }

  // Googleusercontent direct image
  if (url.includes("googleusercontent.com")) {
    return url;
  }

  // Full HTTP/HTTPS link
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }

  // If it's not a link โ return a placeholder
  return "https://via.placeholder.com/300x300?text=No+Image";
}

// ===================== ุฎุงุตูุฉ ุงูุฒูู ุนูู ุตูุฑุฉ ุงูููุชุฌ =====================
function openImageZoom(imageUrl) {
  // ุฅูุดุงุก overlay ููุฒูู
  let overlay = document.getElementById("imageZoomOverlay");
  
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.id = "imageZoomOverlay";
    overlay.innerHTML = `<img id="zoomedImage" src="${imageUrl}" alt="ุตูุฑุฉ ุงูููุชุฌ">`;
    document.body.appendChild(overlay);
    
    // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ูู ุฃู ููุงู
    overlay.onclick = function(e) {
      if (e.target === overlay || e.target.id === "zoomedImage") {
        closeImageZoom();
      }
    };
    
    // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุนูู ESC
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape" && overlay.style.display === "flex") {
        closeImageZoom();
      }
    });
  } else {
    document.getElementById("zoomedImage").src = imageUrl;
  }
  
  overlay.style.display = "flex";
  document.body.style.overflow = "hidden"; // ููุน ุงูุชูุฑูุฑ
}

function closeImageZoom() {
  const overlay = document.getElementById("imageZoomOverlay");
  if (overlay) {
    overlay.style.display = "none";
    document.body.style.overflow = ""; // ุฅุนุงุฏุฉ ุงูุชูุฑูุฑ
  }
}



function go(page, data = null, skipHistory = false) {
  // ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ ูุจู ุงูุงูุชูุงู (ุฅูุง ุฅุฐุง ูุงู skipHistory = true)
  if(!skipHistory) {
    saveNavigationState(page, data);
    // ุฅุถุงูุฉ ุญุงูุฉ ุฌุฏูุฏุฉ ููู history
    const state = { page, data };
    const url = data ? `#${page}/${data}` : `#${page}`;
    window.history.pushState(state, '', url);
  }
  
  // ุฅุฎูุงุก ุฌููุน ุงูุตูุญุงุช
  document.querySelectorAll(".page").forEach(
    p => {
      p.classList.remove("active");
      // ุฅุฒุงูุฉ inline style ูุฅูุณุงุญ ุงููุฌุงู ููู CSS
      p.style.removeProperty("display");
    }
  );

  // ุฅุธูุงุฑ ุงูุตูุญุฉ ุงููุทููุจุฉ
  let targetPage = null;
  
  // ููุตูุญุฉ ุงูุฑุฆูุณูุฉุ ุงุจุญุซ ุนู homePage ุฃููุงู
  // ุฃูุถุงู ุชุนุงูู ูุน "homePage" ูู "home" ููุชูุงูู
  if (page === "home" || page === "homePage") {
    targetPage = document.getElementById("homePage");
    if (!targetPage) {
      targetPage = document.getElementById("page-home");
    }
  } else {
    targetPage = document.getElementById("page-" + page);
  }
  
  if (targetPage) {
    targetPage.classList.add("active");
    // ุฅุฒุงูุฉ inline style ุฅุฐุง ูุงู ููุฌูุฏุงู ูุฅูุณุงุญ ุงููุฌุงู ููู CSS
    targetPage.style.removeProperty("display");
    // ููุชุฃูุฏ ูู ุฃู homePage ูุธูุฑ
    if ((page === "home" || page === "homePage") && targetPage.id === "homePage") {
      console.log("HomePage is now visible", targetPage);
    }
  } else {
    console.warn("Target page not found:", page);
  }

  // ุชุญุฏูุซ ุงููุคุดุฑ ุงููุดุท ูู ุงููุงุฆูุฉ
  document.querySelectorAll(".nav-links a, .mobile-menu a").forEach(link => {
    link.classList.remove("active");
    if(link.getAttribute("data-page") === page) {
      link.classList.add("active");
    }
  });
  
  // ุชููุฆุฉ ุงูุชุญูู ุงูููุฑู ุนูุฏ ูุชุญ ุตูุญุฉ ุงูุชุณุฌูู
  if (page === "register") {
    setTimeout(initValidationListeners, 100);
  }

  // ุชุญููู ุจูุงูุงุช ุญุณุจ ุงูุตูุญุฉ

  if (page === "home" || page === "homePage") {
    // ูุณุญ ุญููู ุงูุจุญุซ ูููุน ููุก ุฑูู ุงููุงุชู ุชููุงุฆูุงู
    const headerSearch = document.getElementById("headerSearch");
    const headerSearchMobile = document.getElementById("headerSearchMobile");
    if(headerSearch) headerSearch.value = "";
    if(headerSearchMobile) headerSearchMobile.value = "";
    
    if(typeof loadHome === 'function') {
      loadHome();
    }
  }
  if (page === "products") {
    if(window.bannerProducts && window.bannerProducts.length > 0){
      // ุนุฑุถ ููุชุฌุงุช ุงูุจุงูุฑ
      const productIds = window.bannerProducts;
      window.bannerProducts = null; // ูุณุญ ุจุนุฏ ุงูุงุณุชุฎุฏุงู
      loadAllProducts(productIds);
    } else {
      loadAllProducts();
    }
  }
  if (page === "product") loadProductDetails(data);
  if (page === "brands") loadBrandsList();

  if (page === "brand") {
    window.currentBrand = data;
    loadBrandProducts(data);
  }

  if(page === "checkout") {
    renderCheckoutPage();
    autoFillUserInCheckout();   // โญ ุฅุถุงูุฉ ูููุฉ ููุง
}


  // โญ ุฅุตูุงุญ track (ูุดุฑูุท ุจูุฌูุฏ ุงูุตูุญุฉ)
  if (page === "track" && document.getElementById("page-track")) {
  loadTrackPage(data);   // โ ุฅุฑุณุงู ุฑูู ุงูุทูุจ
}


  // โญ ุฅุตูุงุญ offers (ูุดุฑูุท ุจูุฌูุฏ ุงูุตูุญุฉ)
  if (page === "offers" && document.getElementById("page-offers")) {
    loadOffers();
  }

  if (page === "categories") loadCategories();

  if (page === "category") {
    window.currentCategory = data;
    loadCategoryProducts(data);
  }

  if (page === "thanks") {
    loadInvoice(data);   // โ ููุง ูุญููู ุงููุงุชูุฑุฉ
}


  if (page === "wishlist") loadWishlist();

  // โญ ุตูุญุฉ ุญุณุงุจู
  if (page === "profile" && typeof loadProfile === "function") {
    loadProfile();
  }

  // โญ ุตูุญุฉ ุงููุญุชูู ุงููุงูููู
  if (page === "page" && data) {
    loadPageContent(data);
  }

  // ุชุญุฏูุซ ุฑุงุจุท ุงูุญุณุงุจ ูู ุงูููุฏุฑ ุนูุฏ ุงูุชููู
  updateHeaderProfile();
  updateWishlistCount();
  
  // ุชุนููู ุงููุคุดุฑ ุงููุดุท ููุตูุญุฉ ุงูุญุงููุฉ
  const activePage = document.querySelector(".page.active");
  if(activePage) {
    const pageId = activePage.id.replace("page-", "");
    document.querySelectorAll(".nav-links a, .mobile-menu a").forEach(link => {
      link.classList.remove("active");
      if(link.getAttribute("data-page") === pageId) {
        link.classList.add("active");
      }
    });
  }
}





const API = window.location.origin;
// ุชุญููู ุงููุณุชุฎุฏู ูู ุงูุชุฎุฒูู ุงููุญูู ุจุนุฏ ูุชุญ ุงูุตูุญุฉ
window.user = JSON.parse(localStorage.getItem("user") || "null");

// ===================== ูุธุงู ุงูุฅุดุนุงุฑุงุช =====================
function showNotification(message, type = 'warning') {
  const container = document.getElementById("notificationContainer");
  if(!container) return;
  
  const notification = document.createElement("div");
  notification.style.cssText = `
    background: ${type === 'warning' ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : type === 'error' ? 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)' : 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)'};
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    margin-bottom: 12px;
    font-size: 15px;
    font-weight: 500;
    text-align: center;
    animation: slideDown 0.3s ease-out;
    pointer-events: auto;
    position: relative;
    backdrop-filter: blur(10px);
  `;
  
  notification.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      <span style="font-size:20px;">${type === 'warning' ? 'โ๏ธ' : type === 'error' ? 'โ' : 'โ'}</span>
      <span>${message}</span>
    </div>
  `;
  
  // ุฅุถุงูุฉ animation
  if(!document.getElementById("notificationStyles")) {
    const style = document.createElement("style");
    style.id = "notificationStyles";
    style.textContent = `
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  container.appendChild(notification);
  
  // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุจุนุฏ 4 ุซูุงูู
  setTimeout(() => {
    notification.style.animation = 'slideUp 0.3s ease-out';
    setTimeout(() => {
      if(notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 4000);
}

// ===================== ูุธุงู ุฅุฏุงุฑุฉ ุณุฌู ุงูุชููู =====================
window.navigationStack = [];

// ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ ูุจู ุงูุงูุชูุงู
function saveNavigationState(page, data = null) {
  const currentPage = document.querySelector(".page.active");
  if(currentPage) {
    // ูุนุงูุฌุฉ ุฎุงุตุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
    let currentPageId = currentPage.id;
    if(currentPageId === "homePage") {
      currentPageId = "home";
    } else {
      currentPageId = currentPageId.replace("page-", "");
    }
    // ููุท ูุถูู ููุณุชุงู ุฅุฐุง ูุงูุช ุตูุญุฉ ูุฎุชููุฉ
    if(currentPageId !== page) {
      // ุญูุธ ุจูุงูุงุช ุงูุตูุญุฉ ุงูุญุงููุฉ ุฅุฐุง ูุงูุช ูููุฉ (ูุซู ุฑูู ุงูููุชุฌ)
      let currentData = null;
      if(currentPageId === "product" && window.currentProductId) {
        currentData = window.currentProductId;
      } else if(currentPageId === "brand" && window.currentBrand) {
        currentData = window.currentBrand;
      } else if(currentPageId === "category" && window.currentCategory) {
        currentData = window.currentCategory;
      }
      
      window.navigationStack.push({ page: currentPageId, data: currentData });
      // ุงูุงุญุชูุงุธ ุจุขุฎุฑ 20 ุตูุญุฉ ููุท
      if(window.navigationStack.length > 20) {
        window.navigationStack.shift();
      }
    }
  }
}

// ุงูุฑุฌูุน ููุตูุญุฉ ุงูุณุงุจูุฉ
function goBackToPreviousPage() {
  if(window.navigationStack.length > 0) {
    const previous = window.navigationStack.pop();
    if(previous && previous.page) {
      go(previous.page, previous.data, true); // true = ุจุฏูู ุญูุธ ูู ุงูุณุฌู
      return true;
    }
  }
  return false;
}

// ุงูุงุณุชูุงุน ูุญุฏุซ ุงูุฑุฌูุน ูู ุงููุชุตูุญ
window.addEventListener('popstate', function(event) {
  if(window.navigationStack.length > 0) {
    const previous = window.navigationStack.pop();
    if(previous && previous.page) {
      go(previous.page, previous.data, true);
    } else {
      go('home', null, true);
    }
  } else {
    // ุฅุฐุง ูู ุชูุฌุฏ ุตูุญุฉ ุณุงุจูุฉุ ุงูุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
    go('home', null, true);
  }
});


// ======================= ุฏูุงู Skeleton Loading =======================
// ุฏุงูุฉ ูุฅูุดุงุก skeleton cards
function createSkeletonCards(count = 8) {
  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-text short"></div>
        <div class="skeleton-text medium"></div>
        <div class="skeleton-price"></div>
        <div class="skeleton-button"></div>
      </div>
    `;
  }
  return html;
}

// ุฏุงูุฉ ูุฅูุดุงุก skeleton ูุตูุญุฉ ุงูููุชุฌ
function createProductDetailsSkeleton() {
  return `
    <div class="skeleton-product-details">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;align-items:start;">
        <div>
          <div class="skeleton-product-image"></div>
        </div>
        <div>
          <div class="skeleton-product-title"></div>
          <div class="skeleton-product-price"></div>
          <div class="skeleton-product-description"></div>
          <div class="skeleton-product-description"></div>
          <div class="skeleton-product-description"></div>
          <div style="margin-top:30px;width:100%;height:50px;background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s ease-in-out infinite;border-radius:14px;"></div>
        </div>
      </div>
    </div>
  `;
}

// ======================= ุตูุญุฉ ูู ุงูููุชุฌุงุช =======================
async function loadAllProducts(productIds = null){
  // ุฌูุจ ุงูููุชุฌุงุช
  const res = await fetch(API + "/api/admin/products");
  const list = await res.json();

  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const normalizedList = list.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));

  // ุญูุธูุง ูู ุงููุชุบูุฑ ุงูุนุงู
  window.allProducts = normalizedList;
  window.productsCache = normalizedList;

  // ุชุนุจุฆุฉ ุงูููุชุฑ (ุงููุงุฑูุงุช)
  fillBrandSelect();

  // ุฅุฐุง ูุงูุช ููุงู ููุชุฌุงุช ูุญุฏุฏุฉ ูู ุงูุจุงูุฑุ ููุชุฑุชูุง
  let productsToShow = normalizedList;
  if(productIds && Array.isArray(productIds) && productIds.length > 0){
    productsToShow = normalizedList.filter(p => productIds.includes(parseInt(p.id)));
  }

  // ุนุฑุถ ุงูููุชุฌุงุช
  renderProducts(productsToShow);

  // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูุณูุฉ
  refreshAllAddToCartButtons();
}



function fillBrandSelect(){
  const sel = document.getElementById("brandSelect");
  sel.innerHTML = '<option value="">ูู ุงููุงุฑูุงุช</option>';

  // ุงุณุชุฎุฑุงุฌ ุงููุงุฑูุงุช ุจุฏูู ุชูุฑุงุฑ
  let brands = {};
  allProducts.forEach(p => {
    if(p.brand_id && !brands[p.brand_id]){
      brands[p.brand_id] = p.brand_name;
    }
  });

  for(let id in brands){
    sel.innerHTML += `<option value="${id}">${brands[id]}</option>`;
  }
}

function renderProducts(list){
  const grid = document.getElementById("productsPageGrid");
  grid.innerHTML = "";

  if(list.length === 0){
    grid.innerHTML = "<p>ูุง ููุฌุฏ ููุชุฌุงุช</p>";
    return;
  }

  list.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  refreshAllAddToCartButtons();   // โ ููุง ุงูููุงู ุงูุตุญูุญ
  
  // ุชุญุฏูุซ ุงูุชููููุงุช ุจุนุฏ ุนุฑุถ ุงูููุชุฌุงุช
  setTimeout(() => {
    updateAllProductRatings();
  }, 100);
}



function filterProducts(){
  const text = document.getElementById("productsSearch").value.toLowerCase();
  const brand = document.getElementById("brandSelect").value;

  let filtered = allProducts.filter(p=>
    (!text || p.name.toLowerCase().includes(text)) &&
    (!brand || p.brand_id == brand)
  );

  renderProducts(filtered);
}
//------------------ ุตูุญุฉ ุฎุตู ุงูุณุนุฑ --------------------
function calculateFinalPrice(p){
  const base = parseFloat(p.base_price) || 0;
  const discountValue = parseFloat(p.discount_value) || 0;
  const discountType = p.discount_type || "none";

  let priceAfterDiscount = base;

  // ุงูุฎุตู
  if(discountType === "percent"){
    priceAfterDiscount = base - (base * (discountValue / 100));
  }
  else if(discountType === "fixed"){
    priceAfterDiscount = base - discountValue;
  }

  if(priceAfterDiscount < 0) priceAfterDiscount = 0;

  // ุงูุถุฑูุจุฉ 15%
  const beforeVat = base * 1.15;
  const finalWithVat = priceAfterDiscount * 1.15;

  return {
    before: beforeVat.toFixed(2),     // ุงูุณุนุฑ ูุจู ุงูุฎุตู + ุงูุถุฑูุจุฉ
    final: finalWithVat.toFixed(2),   // ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู + ุงูุถุฑูุจุฉ
  };
}

// ======================= ุฏูุงู ุงูุชููููุงุช =======================

// ุฌูุจ ูุชูุณุท ุงูุชูููู ููููุชุฌ
async function getProductRating(productId) {
  try {
    const res = await fetch(API + `/api/reviews/${productId}/average`);
    const data = await res.json();
    return {
      average: parseFloat(data.average || 0),
      total: parseInt(data.total || 0)
    };
  } catch (error) {
    return { average: 0, total: 0 };
  }
}

// ุชุญุฏูุซ ุงููุฌูู ูู ูุงุฑุช ุงูููุชุฌ
async function updateProductCardRating(productId, ratingElement) {
  const rating = await getProductRating(productId);
  const stars = ratingElement.querySelectorAll('.star');
  const valueSpan = ratingElement.querySelector('.rating-value');
  
  if (valueSpan) {
    valueSpan.textContent = rating.average.toFixed(1);
  }
  
  const fullStars = Math.floor(rating.average);
  const hasHalfStar = rating.average % 1 >= 0.5;
  
  stars.forEach((star, index) => {
    if (index < fullStars) {
      star.innerHTML = '<span style="color:#FFD700;">โ</span>';
      star.style.opacity = '1';
    } else if (index === fullStars && hasHalfStar) {
      star.innerHTML = '<span style="color:#FFD700;">โ</span>';
      star.style.opacity = '0.5';
    } else {
      star.innerHTML = '<span style="color:#ddd;">โ</span>';
      star.style.opacity = '1';
    }
  });
}

// ุชุญุฏูุซ ุฌููุน ุชููููุงุช ุงูููุชุฌุงุช ูู ุงูุตูุญุฉ
async function updateAllProductRatings() {
  const ratingElements = document.querySelectorAll('.product-rating');
  ratingElements.forEach(async (el) => {
    const productId = el.getAttribute('data-product-id');
    if (productId) {
      await updateProductCardRating(productId, el);
    }
  });
}

// ุชุญููู ุงูุชููููุงุช ูู ุตูุญุฉ ุงูููุชุฌ
async function loadProductReviews(productId) {
  const reviewsSection = document.getElementById('productReviewsSection');
  if (!reviewsSection) return;
  
  try {
    // ุฌูุจ ุงูุชููููุงุช ูุงููุชูุณุท
    const [reviewsRes, avgRes] = await Promise.all([
      fetch(API + `/api/reviews/${productId}`),
      fetch(API + `/api/reviews/${productId}/average`)
    ]);
    
    const reviews = await reviewsRes.json();
    const avgData = await avgRes.json();
    const average = parseFloat(avgData.average || 0);
    const total = parseInt(avgData.total || 0);
    
    let html = `
      <div class="reviews-header">
        <h3 class="section-label">ุงูุชููููุงุช ูุงููุฑุงุฌุนุงุช</h3>
        <div class="reviews-summary">
          <div class="reviews-average">
            <span class="average-rating">${average.toFixed(1)}</span>
            <div class="average-stars">
              ${generateStarsHTML(average)}
            </div>
            <span class="total-reviews">(${total} ${total === 1 ? 'ุชูููู' : 'ุชููููุงุช'})</span>
          </div>
        </div>
      </div>
    `;
    
    // ูููุฐุฌ ุฅุถุงูุฉ ุชูููู (ููุท ูููุณุชุฎุฏููู ุงููุณุฌููู)
    if (window.user) {
      html += `
        <div class="add-review-section">
          <h4>ุฃุถู ุชููููู</h4>
          <div class="review-form">
              <div class="rating-input">
              <label>ุงูุชูููู:</label>
              <div class="star-rating-input">
                ${[5, 4, 3, 2, 1].map(r => `
                  <span class="star-input" data-rating="${r}" onclick="selectRating(${r})" style="color:#FFD700;cursor:pointer;">โ</span>
                `).join('')}
              </div>
              <span class="selected-rating-text" id="selectedRatingText">ุงุฎุชุฑ ุงูุชูููู</span>
            </div>
            <textarea id="reviewComment" class="review-comment-input" placeholder="ุงูุชุจ ุชุนูููู ููุง..."></textarea>
            <button onclick="submitReview(${productId})" class="submit-review-btn">ุฅุฑุณุงู ุงูุชูููู</button>
            <div id="reviewMessage" class="review-message"></div>
          </div>
        </div>
      `;
    } else {
      html += `
        <div class="review-login-prompt">
          <p>ูุฌุจ <a href="#" onclick="go('login'); return false;">ุชุณุฌูู ุงูุฏุฎูู</a> ูุดุฑุงุก ุงูููุชุฌ ูุฅุถุงูุฉ ุชูููู</p>
        </div>
      `;
    }
    
    // ุนุฑุถ ุงูุชููููุงุช ุงููุนุชูุฏุฉ
    if (reviews.length > 0) {
      html += `<div class="reviews-list">`;
      reviews.forEach(review => {
        html += `
          <div class="review-item">
            <div class="review-header">
              <div class="review-user">
                <span class="user-initial">${review.user_email.charAt(0).toUpperCase()}</span>
                <div class="user-info">
                  <span class="user-email">${review.user_email}</span>
                  <span class="review-date">${formatDate(review.created_at)}</span>
                </div>
              </div>
              <div class="review-rating" style="display:flex;gap:2px;">
                ${generateStarsHTML(review.rating)}
              </div>
            </div>
            ${review.comment ? `<p class="review-comment">${review.comment}</p>` : ''}
          </div>
        `;
      });
      html += `</div>`;
    } else {
      html += `
        <div class="no-reviews">
          <p>ูุง ุชูุฌุฏ ุชููููุงุช ุจุนุฏ. ูู ุฃูู ูู ูููู ูุฐุง ุงูููุชุฌ!</p>
        </div>
      `;
    }
    
    reviewsSection.innerHTML = html;
    
    // ุชููุฆุฉ ุงุฎุชูุงุฑ ุงููุฌูู
    if (window.user) {
      initStarRating();
    }
    
  } catch (error) {
    console.error('Error loading reviews:', error);
    reviewsSection.innerHTML = '<div class="reviews-error">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุชููููุงุช</div>';
  }
}

// ุชูููุฏ HTML ูููุฌูู
function generateStarsHTML(rating) {
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5;
  let html = '';
  
  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      html += '<span class="star-filled" style="color:#FFD700;">โ</span>';
    } else if (i === fullStars + 1 && hasHalfStar) {
      html += '<span class="star-half" style="color:#FFD700;opacity:0.5;">โ</span>';
    } else {
      html += '<span class="star-empty" style="color:#ddd;">โ</span>';
    }
  }
  
  return html;
}

// ุชููุฆุฉ ุงุฎุชูุงุฑ ุงููุฌูู
function initStarRating() {
  const starInputs = document.querySelectorAll('.star-input');
  let selectedRating = 0;
  
  starInputs.forEach((star, index) => {
    star.addEventListener('mouseenter', () => {
      const rating = parseInt(star.getAttribute('data-rating'));
      highlightStars(rating);
    });
    
    star.addEventListener('click', () => {
      selectedRating = parseInt(star.getAttribute('data-rating'));
      highlightStars(selectedRating);
      const textEl = document.getElementById('selectedRatingText');
      if (textEl) {
        const texts = ['', 'ุณูุก ุฌุฏุงู', 'ุณูุก', 'ูุชูุณุท', 'ุฌูุฏ', 'ููุชุงุฒ'];
        textEl.textContent = texts[selectedRating] || 'ุงุฎุชุฑ ุงูุชูููู';
      }
      window.selectedRating = selectedRating;
    });
  });
  
  const container = document.querySelector('.star-rating-input');
  if (container) {
    container.addEventListener('mouseleave', () => {
      highlightStars(selectedRating);
    });
  }
}

function highlightStars(rating) {
  const starInputs = document.querySelectorAll('.star-input');
  starInputs.forEach((star, index) => {
    const starRating = parseInt(star.getAttribute('data-rating'));
    if (starRating <= rating) {
      star.style.opacity = '1';
      star.style.transform = 'scale(1.1)';
    } else {
      star.style.opacity = '0.3';
      star.style.transform = 'scale(1)';
    }
  });
}

function selectRating(rating) {
  window.selectedRating = rating;
  highlightStars(rating);
  const textEl = document.getElementById('selectedRatingText');
  if (textEl) {
    const texts = ['', 'ุณูุก ุฌุฏุงู', 'ุณูุก', 'ูุชูุณุท', 'ุฌูุฏ', 'ููุชุงุฒ'];
    textEl.textContent = texts[rating] || 'ุงุฎุชุฑ ุงูุชูููู';
  }
}

// ุฅุฑุณุงู ุงูุชูููู
async function submitReview(productId) {
  if (!window.user) {
    showNotification('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู', 'error');
    return;
  }
  
  if (!window.selectedRating || window.selectedRating < 1) {
    showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุชูููู', 'error');
    return;
  }
  
  const comment = document.getElementById('reviewComment')?.value || '';
  
  try {
    const res = await fetch(API + '/api/reviews', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        product_id: productId,
        rating: window.selectedRating,
        comment: comment,
        user_email: window.user.email,
        user_phone: window.user.phone
      })
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('ุดูุฑุงู ูู! ุณูุชู ูุฑุงุฌุนุฉ ุชููููู ูุจู ุงููุดุฑ', 'success');
      document.getElementById('reviewComment').value = '';
      window.selectedRating = 0;
      highlightStars(0);
      document.getElementById('selectedRatingText').textContent = 'ุงุฎุชุฑ ุงูุชูููู';
      // ุฅุนุงุฏุฉ ุชุญููู ุงูุชููููุงุช ูู ุตูุญุฉ ุงูููุชุฌ
      await loadProductReviews(productId);
      // ุชุญุฏูุซ ุชูููู ุงูููุชุฌ ูู ุฌููุน ุงููุฑูุช ุงูููุฌูุฏุฉ ูู ุงูุตูุญุฉ
      const allRatingElements = document.querySelectorAll(`.product-rating[data-product-id="${productId}"]`);
      allRatingElements.forEach(async (el) => {
        await updateProductCardRating(productId, el);
      });
    } else {
      showNotification(data.message || 'ุญุฏุซ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุชูููู', 'error');
    }
  } catch (error) {
    console.error('Error submitting review:', error);
    showNotification('ุญุฏุซ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุชูููู', 'error');
  }
}

// ุชูุณูู ุงูุชุงุฑูุฎ
function formatDate(dateString) {
  const date = new Date(dateString);
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ar-SA', options);
}

// ======================= ุตูุญุฉ ุงูุชูุงุตูู =======================
// ======================= ุตูุญุฉ ุงูุชูุงุตูู =======================
async function loadProductDetails(id) {
  // ุญูุธ ูุนุฑู ุงูููุชุฌ ููุฑุฌูุน
  window.currentProductId = id;

  // โญ ุฅุตูุงุญ ููุฒ ุงูุตูุญุฉ ููุฃุณูู
  window.scrollTo(0, 0);
  
  // ุฅุธูุงุฑ skeleton loading
  document.getElementById("productDetailsBox").innerHTML = createProductDetailsSkeleton();
  
  const res = await fetch(API + "/api/admin/products");
  const productsList = await res.json();
  
  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));
  
  // ุชุญุฏูุซ productsCache
  window.productsCache = products;

  const p = products.find(x => x.id == id);
  if (!p) {
    document.getElementById("productDetailsBox").innerHTML =
      "<p>โ ุงูููุชุฌ ุบูุฑ ููุฌูุฏ</p>";
    return;
  }

  const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  const isOutOfStock = stock <= 0;
  const isFav = wishlist.includes(p.id);

  /* โญ ุญุณุงุจ ุงูุฃุณุนุงุฑ โญ */

  const base = parseFloat(p.base_price) || 0;               // ุงูุณุนุฑ ุงูุฃุณุงุณู ุจุฏูู ุถุฑูุจุฉ
  const discountValue = parseFloat(p.discount_value) || 0;  // ูููุฉ ุงูุฎุตู
  const discountType = p.discount_type || "none";           // ููุน ุงูุฎุตู

  // ุชุทุจูู ุงูุฎุตู
  let afterDiscount = base;
  if (discountType === "percent") {
    afterDiscount = base - (base * (discountValue / 100));
  }
  else if (discountType === "fixed") {
    afterDiscount = base - discountValue;
  }

  if (afterDiscount < 0) afterDiscount = 0;

  // ุฅุถุงูุฉ ุงูุถุฑูุจุฉ 15%
  const beforeVat = base * 1.15;         // ุงูุณุนุฑ ุงูุฃุณุงุณู + ุงูุถุฑูุจุฉ
  const afterVat = afterDiscount * 1.15; // ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู + ุงูุถุฑูุจุฉ

  /* โญ ุนุฑุถ ุชูุงุตูู ุงูููุชุฌ โญ */
  document.getElementById("productDetailsBox").innerHTML = `
    <div class="product-details-container">
      <div class="product-main-content">
        <!-- ุตูุฑุฉ ุงูููุชุฌ ูุน ุฎุงุตูุฉ ุงูุฒูู -->
        <div class="product-image-wrapper ${isOutOfStock ? 'out-of-stock-image' : ''}">
          <div class="skeleton-product-image" id="productImageSkeleton"></div>
          <img id="productMainImage" 
               src="${safeImageURL(p.image_url)}"
               onerror="this.src='https://via.placeholder.com/400?text=No+Image'; const skeleton = document.getElementById('productImageSkeleton'); if(skeleton) skeleton.style.display='none'; this.style.display='block';"
               class="product-main-image ${isOutOfStock ? 'grayscale' : ''}"
               onclick="openImageZoom('${safeImageURL(p.image_url)}')"
               alt="${p.name}"
               onload="const skeleton = document.getElementById('productImageSkeleton'); if(skeleton) skeleton.style.display='none'; this.style.display='block';"
               style="display:none;">
          <div class="zoom-hint">๐ ุงุถุบุท ููุชูุจูุฑ</div>
          <div id="productWishlistBtn" 
               onclick="event.stopPropagation(); toggleWishlist(${p.id});"
               style="
                 position:absolute;
                 top:12px;
                 left:12px;
                 font-size:22px;
                 cursor:pointer;
                 z-index:20;
                 color:${isFav ? '#E91E63' : '#bbb'};
                 background:rgba(255,255,255,0.9);
                 width:36px;
                 height:36px;
                 border-radius:50%;
                 display:flex;
                 align-items:center;
                 justify-content:center;
                 box-shadow:0 2px 8px rgba(0,0,0,0.1);
                 transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
               "
               onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 4px 12px rgba(233, 30, 99, 0.3)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
               title="${isFav ? 'ุฅุฒุงูุฉ ูู ุงูููุถูุฉ' : 'ุฅุถุงูุฉ ููููุถูุฉ'}">
            โค
          </div>
        </div>

        <!-- ุจูุงูุงุช ุงูููุชุฌ -->
        <div class="product-info-section">
          <div class="product-header">
            <h1 class="product-title">${p.name}</h1>
            ${p.intl_code ? `
              <div class="product-barcode">
                <span class="barcode-label">ุงูุจุงุฑููุฏ ุงูุฏููู:</span>
                <span class="barcode-value">${p.intl_code}</span>
              </div>
            ` : ""}
          </div>

          <!-- ุงูุฃุณุนุงุฑ -->
          <div class="product-pricing">
            ${(discountType !== "none" && discountValue > 0) ? `
              <div class="price-before-discount">
                <span class="old-price">${beforeVat.toFixed(2)} ุฑ.ุณ</span>
                <span class="discount-badge">ุฎุตู ${discountType === "percent" ? discountValue + "%" : discountValue + " ุฑ.ุณ"}</span>
              </div>
            ` : ""}
            <div class="price-final">
              <span class="price-amount">${afterVat.toFixed(2)}</span>
              <span class="price-currency">ุฑ.ุณ</span>
            </div>
          </div>

          ${(() => {
            const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
            const isOutOfStock = stock <= 0;
            const showStockInfo = stock > 0 && stock <= 6;
            
            return `
              ${showStockInfo ? `
                <div class="product-stock-info">
                  <span class="stock-label">ุงููููุฉ ุงููุชุจููุฉ:</span>
                  <span class="stock-value">${stock} ุญุจุฉ</span>
                </div>
              ` : ''}
              
              <!-- ุฒุฑ ุงูุฅุถุงูุฉ ููุณูุฉ -->
              <button id="productAddBtn"
                data-id="${p.id}"
                onclick="${isOutOfStock ? 'showNotification(\'ุนุฐุฑุงูุ ูุฐุง ุงูููุชุฌ ุบูุฑ ูุชููุฑ ุญุงููุงู\', \'warning\'); return false;' : `addToCart(${p.id})`}"
                class="product-add-btn ${isOutOfStock ? 'out-of-stock-btn' : ''}"
                ${isOutOfStock ? 'disabled' : ''}>
                <span>${isOutOfStock ? 'โ' : '๐'}</span>
                <span>${isOutOfStock ? 'ุงููููุฉ ููุชููุฉ' : 'ุฃุถู ููุณูุฉ'}</span>
              </button>
            `;
          })()}

          <!-- ุงููุตู -->
          <div class="product-description">
            <h3 class="section-label">ุงููุตู</h3>
            <p class="description-text">${p.description || "ูุง ููุฌุฏ ูุตู ููููุชุฌ"}</p>
          </div>

          <!-- ุงูุชููููุงุช -->
          <div class="product-reviews-section" id="productReviewsSection">
            <div class="reviews-loading">ุฌุงุฑู ุชุญููู ุงูุชููููุงุช...</div>
          </div>
        </div>
      </div>
    </div>
  `;

  updateProductPageButton(id);
  
  // ุชุญููู ุงูุชููููุงุช
  await loadProductReviews(id);

  
  /* ============================================================
   โญ ุฅุถุงูุฉ ุงูููุชุฌุงุช ุงููุดุงุจูุฉ โ ุณูุงูุฏุฑ ุฃููู โญ
   ============================================================ */
/* ============================================================
     โญ ููุชุฌุงุช ูุดุงุจูุฉ โ ุณูุงูุฏุฑ ูุงูู โญ
   ============================================================ */

let similar = (window.productsCache || [])
  .filter(x => x.category === p.category && x.id != p.id)
  .slice(0, 10); // ููุท ุฃูู 10 ููุชุฌุงุช

if (similar.length > 0) {

  let sliderHTML = `
    <div class="similar-products-section">
      <h2 class="similar-products-title">
        <span>โจ</span>
        <span>ููุชุฌุงุช ูุดุงุจูุฉ</span>
      </h2>

      <div class="similar-slider-wrapper">
        <!-- ุฒุฑ ุงูุณุงุจู -->
        <button id="simPrev" class="slider-nav-btn slider-nav-prev" aria-label="ุงูุณุงุจู">
          โน
        </button>

        <!-- ุงูุณูุงูุฏุฑ -->
        <div id="simSlider" class="similar-products-slider">
  `;

  similar.forEach(sp => {
    const prices = calculateFinalPrice(sp);

    sliderHTML += `
      <div class="similar-product-card" onclick="go('product', ${sp.id})">
        <div class="similar-product-image-wrapper">
          <img src="${safeImageURL(sp.image_url)}"
               class="similar-product-image"
               alt="${sp.name}">
          ${sp.discount_value > 0 ? `
            <div class="similar-product-discount">
              ุฎุตู ${sp.discount_value}${sp.discount_type === 'percent' ? '%' : ''}
            </div>
          ` : ''}
        </div>
  
        <div class="similar-product-info">
          <h3 class="similar-product-name">${sp.name}</h3>
          
          <div class="similar-product-price">
            ${sp.discount_value > 0 ? `
              <span class="similar-price-old">${prices.before} ุฑ.ุณ</span>
            ` : ''}
            <span class="similar-price-new">${prices.final} ุฑ.ุณ</span>
          </div>
        </div>
      </div>
    `;
  });

  sliderHTML += `
        </div>

        <!-- ุฒุฑ ุงูุชุงูู -->
        <button id="simNext" class="slider-nav-btn slider-nav-next" aria-label="ุงูุชุงูู">
          โบ
        </button>
      </div>
    </div>
  `;

  document.getElementById("productDetailsBox").innerHTML += sliderHTML;

  /* ===== ุณููู ุงูุณูุงูุฏุฑ ุงููุญุณูู - ูู ุงููุณุงุฑ ูููููู ===== */
  const slider = document.getElementById("simSlider");
  const prevBtn = document.getElementById("simPrev");
  const nextBtn = document.getElementById("simNext");
  
  if (!slider || !prevBtn || !nextBtn) return;

  // ุงูุชุฃูุฏ ูู ุฃู ุงูุณูุงูุฏุฑ ูุจุฏุฃ ูู ุงููุณุงุฑ
  slider.style.direction = 'ltr';
  slider.scrollLeft = 0;

  let isScrolling = false;
  const cardWidth = 240; // ุนุฑุถ ูู ุจุทุงูุฉ + gap (220px + 20px)

  // ุชุญุฏูุซ ุญุงูุฉ ุงูุฃุฒุฑุงุฑ
  function updateButtons() {
    const maxScroll = slider.scrollWidth - slider.clientWidth;
    prevBtn.style.opacity = slider.scrollLeft <= 10 ? "0.5" : "1";
    prevBtn.style.pointerEvents = slider.scrollLeft <= 10 ? "none" : "auto";
    nextBtn.style.opacity = slider.scrollLeft >= maxScroll - 10 ? "0.5" : "1";
    nextBtn.style.pointerEvents = slider.scrollLeft >= maxScroll - 10 ? "none" : "auto";
  }

  // ุฒุฑ ุงูุณุงุจู (ุงูุชุญุฑู ูููุณุงุฑ)
  prevBtn.onclick = () => {
    if (isScrolling) return;
    isScrolling = true;
    slider.scrollBy({ left: -cardWidth, behavior: "smooth" });
    setTimeout(() => { 
      isScrolling = false;
      updateButtons();
    }, 500);
  };

  // ุฒุฑ ุงูุชุงูู (ุงูุชุญุฑู ูููููู)
  nextBtn.onclick = () => {
    if (isScrolling) return;
    isScrolling = true;
    slider.scrollBy({ left: cardWidth, behavior: "smooth" });
    setTimeout(() => { 
      isScrolling = false;
      updateButtons();
    }, 500);
  };

  // ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ ุนูุฏ ุงูุชูุฑูุฑ
  slider.addEventListener('scroll', () => {
    updateButtons();
  });

  // ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ ุนูุฏ ุงูุชุญููู
  updateButtons();
}


}



async function loadBrandsList(){
  const res = await fetch(API + "/api/admin/brands");
  const brands = await res.json();

  const grid = document.getElementById("brandsGrid");
  grid.innerHTML = "";

  brands.forEach(b=>{
    grid.innerHTML += `
      <div class="brand-box" onclick="go('brand', ${b.id})">
        <div class="brand-circle">
          <img src="${b.image_url || 'https://via.placeholder.com/100'}">
        </div>
        <div class="brand-name">${b.name}</div>
      </div>
    `;
  });
}

async function loadBrandProducts(brand_id){
  const res = await fetch(API + "/api/admin/products");
  const allList = await res.json();
  
  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const all = allList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));
  
  // ุชุญุฏูุซ productsCache
  window.productsCache = all;

  const list = all.filter(p => p.brand_id == brand_id);

  const brand = list.length ? list[0].brand_name : "ูุงุฑูุฉ";
  document.getElementById("brandTitle").innerText = brand;

  const grid = document.getElementById("brandProductsGrid");
  grid.innerHTML = "";

  list.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  // โญ ุงูุญู ููุง
  refreshAllAddToCartButtons();
}

function loadCheckout(){
  const box = document.getElementById("checkoutItems");
  box.innerHTML = "";

  let total = 0;

  cart.forEach(item=>{
    let t = item.qty * item.price;
    total += t;

    box.innerHTML += `
      <div style="padding:10px 0;border-bottom:1px solid #eee;">
        ${item.name}  
        <br>
        ุงููููุฉ: ${item.qty} ร ${item.price} = ${t.toFixed(2)} ุฑ.ุณ
      </div>
    `;
  });

  document.getElementById("checkoutTotal").innerText = total.toFixed(2);
}

// ุฅุฑุณุงู ุงูุทูุจ ููุจุงู ุงูุฏ
async function confirmOrder(){
  const name = checkoutName.value.trim();
  const phone = checkoutPhone.value.trim();

  if(!name || !phone){
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุงุณู ูุฑูู ุงูุฌูุงู");
    return;
  }

const body = {
    customer_name: window.user.name,
    customer_phone: window.user.phone,   // โญ ููู ุฌุฏุงู โ ุงูุฑูู ูุฃุชู ูู ุญุณุงุจ ุงููุณุชุฎุฏู ููุท
    customer_phone2: phone,               // ุงูุฑูู ุงูุฐู ูุฏุฎูู ุงูุนููู ูู ุงูููุฑู (ุฑูู ุซุงููู)
    customer_address: document.getElementById("co_address").value.trim(),
    customer_location: document.getElementById("co_location").value.trim(),
    customer_notes: document.getElementById("co_notes").value.trim(),

    items: cart.map(item => ({
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: item.base_price,
        discount_value: window.productsCache.find(p => p.id == item.id)?.discount_value || 0,
        discount_type: window.productsCache.find(p => p.id == item.id)?.discount_type || "none"
    }))
};




  const res = await fetch(API + "/api/orders", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if(data.success){
    // ุชุญุฏูุซ ุงููุฎุฒูู ูู productsCache ุจุนุฏ ุฅุชูุงู ุงูุทูุจ
    if (window.productsCache) {
      cart.forEach(item => {
        const product = window.productsCache.find(p => p.id == item.id);
        if (product) {
          const currentStock = parseInt(product.stock || product.quantity || product.stock_qty || 0);
          const newStock = Math.max(0, currentStock - item.qty);
          product.stock = newStock;
          product.quantity = newStock;
          product.stock_qty = newStock; // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
        }
      });
    }
    
    cart = [];
    saveCart();
    updateCartIcon();
    go("thanks", data.order_id);
  }
}


async function trackOrder(){
  const id = trackInput.value.trim();
  if(!id) return;

  const res = await fetch(API + "/api/orders/" + id);
  const data = await res.json();

  const box = document.getElementById("trackResult");

  if(data.error){
    box.innerHTML = "โ ุงูุทูุจ ุบูุฑ ููุฌูุฏ";
    return;
  }

  box.innerHTML = `
    <p>ุงูุงุณู: ${data.order.customer_name}</p>
    <p>ุงููุงุชู: ${data.order.customer_phone}</p>
    <p>ุงูุญุงูุฉ: <b>${data.order.status}</b></p>
    <p>ุงูุฅุฌูุงูู: ${data.order.total} ุฑ.ุณ</p>
  `;
}
async function doLogin(){
  let phone = loginPhone.value.trim();
  const pass = loginPass.value.trim();

  phone = phone.replace(/\s+/g, "");

  if (phone.startsWith("0")) phone = phone.substring(1);
  if (phone.startsWith("966")) phone = phone.substring(3);
  if (phone.startsWith("00966")) phone = phone.substring(5);

  const res = await fetch(API + "/api/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone, password: pass })
  });

  const data = await res.json();

  if(!data.success){
    loginMsg.innerText = "โ " + data.message;
    loginMsg.style.color = "#e74c3c";
    return;
  }
  
  // ูุณุญ ุฑุณุงูุฉ ุงูุฎุทุฃ ุนูุฏ ุงููุฌุงุญ
  loginMsg.innerText = "";

  window.user = data.user;
  localStorage.setItem("user", JSON.stringify(data.user));
  updateHeaderProfile(); // ุชุญุฏูุซ ุฑุงุจุท ุงูุญุณุงุจ ูู ุงูููุฏุฑ
  go("profile");
}


async function doRegister(){

  const name = regName.value.trim();
  let phone = regPhone.value.trim();
  const email = regEmail.value.trim();
  const pass = regPass.value.trim();
  const pass2 = regPass2.value.trim();
  const address = regAddress.value.trim();

  // ุงูุชุญูู
  if(!name || !phone || !email || !pass || !pass2 || !address){
    registerMsg.innerText = "โ ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช";
    return;
  }

  // ุชูุธูู ุฑูู ุงููุงุชู - ูุจูู 0 ุฃู ุจุฏูู 0
  phone = phone.replace(/\s+/g, "");
if (phone.startsWith("0")) phone = phone.substring(1);
if (phone.startsWith("966")) phone = phone.substring(3);
if (phone.startsWith("00966")) phone = phone.substring(5);

if(!phone.match(/^5\d{8}$/)){
  registerMsg.innerText = "โ ุฑูู ุงูุฌูุงู ูุฌุจ ุฃู ูุจุฏุฃ ุจู 5 ูุทููู 9 ุฃุฑูุงู";
  return;
}

  // ุชุญุณูู ูููุฉ ุงููุฑูุฑ - ุนูู ุงูุฃูู 8 ุฃุญุฑู
  if(pass.length < 8){
    registerMsg.innerText = "โ ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 8 ุฃุญุฑู ุนูู ุงูุฃูู";
    return;
  }

  if(pass !== pass2){
    registerMsg.innerText = "โ ูููุฉ ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุฉ";
    return;
  }

  try {
    const res = await fetch(API + "/api/register", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      name,
      phone,
      email,
      password: pass,
      address
    })
  });

    if (!res.ok) {
      throw new Error("Network error");
    }

  const data = await res.json();

  if(!data.success){
    registerMsg.innerText = "โ " + data.message;
    registerMsg.style.color = "#e74c3c";
    return;
  }

  registerMsg.innerHTML = "โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ โ ุชู ุฅุฑุณุงู ููุฏ ุงูุชูุนูู";
  registerMsg.style.color = "#4caf50";

  // ุญูุธ ุงููุงุชู ูุตูุญุฉ ุงูุชูุนูู
  document.getElementById("vPhone").value = phone;

  // ุชุดุบูู ุงููุคูุช
  startVerifyTimer();

  // ุงูุฐูุงุจ ูุตูุญุฉ ุงูุชูุนูู
  go("verify");
  } catch (error) {
    registerMsg.innerText = "โ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
    registerMsg.style.color = "#e74c3c";
    console.error("Registration error:", error);
  }
}

// ุงูุชุญูู ุงูููุฑู ูู ุงูุฅูููู
let emailCheckTimeout;
async function checkEmail(email) {
  const emailIcon = document.getElementById("regEmailIcon");
  const emailMsg = document.getElementById("regEmailMsg");
  
  if (!email || !email.includes("@") || !email.includes(".")) {
    emailIcon.classList.remove("show", "valid", "invalid");
    emailMsg.textContent = "";
    return;
  }
  
  clearTimeout(emailCheckTimeout);
  emailCheckTimeout = setTimeout(async () => {
    try {
      const res = await fetch(API + "/api/check-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      
      if (!res.ok) {
        throw new Error("Network error");
      }
      
      const data = await res.json();
      
      if (data.exists) {
        emailIcon.classList.add("show", "invalid");
        emailIcon.classList.remove("valid");
        emailMsg.textContent = "โ ูุฐุง ุงูุฅูููู ูุณุฌู ูุณุจูุงู";
        emailMsg.className = "validation-message error";
      } else {
        emailIcon.classList.add("show", "valid");
        emailIcon.classList.remove("invalid");
        emailMsg.textContent = "โ ุงูุฅูููู ูุชุงุญ";
        emailMsg.className = "validation-message success";
      }
    } catch (error) {
      // ูู ุญุงูุฉ ุงูุฎุทุฃุ ูุง ูุนุฑุถ ุฃู ุดูุก
      emailIcon.classList.remove("show", "valid", "invalid");
      emailMsg.textContent = "";
    }
  }, 500);
}

// ุงูุชุญูู ุงูููุฑู ูู ุฑูู ุงูุฌูุงู
let phoneCheckTimeout;
async function checkPhone(phone) {
  const phoneIcon = document.getElementById("regPhoneIcon");
  const phoneMsg = document.getElementById("regPhoneMsg");
  
  let cleanPhone = phone.replace(/\s+/g, "");
  if (cleanPhone.startsWith("0")) cleanPhone = cleanPhone.substring(1);
  if (cleanPhone.startsWith("966")) cleanPhone = cleanPhone.substring(3);
  if (cleanPhone.startsWith("00966")) cleanPhone = cleanPhone.substring(5);
  
  if (!cleanPhone || !cleanPhone.match(/^5\d{8}$/)) {
    phoneIcon.classList.remove("show", "valid", "invalid");
    phoneMsg.textContent = "";
    return;
  }
  
  clearTimeout(phoneCheckTimeout);
  phoneCheckTimeout = setTimeout(async () => {
    try {
      const res = await fetch(API + "/api/check-phone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: cleanPhone })
      });
      
      if (!res.ok) {
        throw new Error("Network error");
      }
      
      const data = await res.json();
      
      if (data.exists) {
        phoneIcon.classList.add("show", "invalid");
        phoneIcon.classList.remove("valid");
        phoneMsg.textContent = "โ ูุฐุง ุงูุฑูู ูุณุฌู ูุณุจูุงู";
        phoneMsg.className = "validation-message error";
      } else {
        phoneIcon.classList.add("show", "valid");
        phoneIcon.classList.remove("invalid");
        phoneMsg.textContent = "โ ุงูุฑูู ูุชุงุญ";
        phoneMsg.className = "validation-message success";
      }
    } catch (error) {
      // ูู ุญุงูุฉ ุงูุฎุทุฃุ ูุง ูุนุฑุถ ุฃู ุดูุก
      phoneIcon.classList.remove("show", "valid", "invalid");
      phoneMsg.textContent = "";
    }
  }, 500);
}

// ุชุญุณูู ูููุฉ ุงููุฑูุฑ
function checkPasswordStrength(password) {
  const strengthBar = document.getElementById("regPassStrength");
  const passMsg = document.getElementById("regPassMsg");
  const passIcon = document.getElementById("regPassIcon");
  
  if (!password) {
    strengthBar.innerHTML = "";
    passMsg.textContent = "";
    passIcon.classList.remove("show", "valid", "invalid");
    return;
  }
  
  let strength = 0;
  let feedback = [];
  
  if (password.length >= 8) strength++;
  else feedback.push("8 ุฃุญุฑู ุนูู ุงูุฃูู");
  
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  
  let strengthClass = "weak";
  let strengthText = "ุถุนููุฉ";
  
  if (strength >= 4) {
    strengthClass = "strong";
    strengthText = "ูููุฉ";
    passIcon.classList.add("show", "valid");
    passIcon.classList.remove("invalid");
    passMsg.textContent = "โ ูููุฉ ูุฑูุฑ ูููุฉ";
    passMsg.className = "validation-message success";
  } else if (strength >= 2) {
    strengthClass = "medium";
    strengthText = "ูุชูุณุทุฉ";
    passIcon.classList.remove("show", "valid", "invalid");
    passMsg.textContent = "ูููุฉ ุงููุฑูุฑ ูุชูุณุทุฉ - ุฃุถู ุฃุฑูุงู ูุฑููุฒ ูุฒูุงุฏุฉ ุงูููุฉ";
    passMsg.className = "validation-message";
  } else {
    passIcon.classList.remove("show", "valid", "invalid");
    passMsg.textContent = feedback.length > 0 ? feedback.join("ุ ") : "ูููุฉ ุงููุฑูุฑ ุถุนููุฉ";
    passMsg.className = "validation-message error";
  }
  
  strengthBar.innerHTML = `<div class="password-strength-bar ${strengthClass}"></div>`;
}

// ุชููุฆุฉ ุงูุชุญูู ุงูููุฑู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
function initValidationListeners() {
  const regEmail = document.getElementById("regEmail");
  const regPhone = document.getElementById("regPhone");
  const regPass = document.getElementById("regPass");
  
  if (regEmail) {
    regEmail.addEventListener("input", (e) => checkEmail(e.target.value));
  }
  
  if (regPhone) {
    regPhone.addEventListener("input", (e) => checkPhone(e.target.value));
  }
  
  if (regPass) {
    regPass.addEventListener("input", (e) => checkPasswordStrength(e.target.value));
  }
}

// ุชููุฆุฉ ุนูุฏ ุชุญููู DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initValidationListeners);
} else {
  initValidationListeners();
}

async function loadProfile() {

  if (!window.user) {
    go("login");
    return;
  }

  // ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุนููู
  document.getElementById("pName").innerText = window.user.name || "โ";
  document.getElementById("pPhone").innerText = "๐ฑ " + (window.user.phone || "โ");
  document.getElementById("pEmail").innerText = "๐ง " + (window.user.email || "โ");
  document.getElementById("pAddress").innerText = "๐ " + (window.user.address || "โ");

  // ุฌูุจ ุงูุทูุจุงุช
  const orders = await fetchUserOrders(window.user.phone);

  let html = "";

  if (orders.length === 0) {
    html = `<p style="text-align:center;color:#777;margin-top:20px;">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุชู ุงูุขู</p>`;
  } else {
    orders.forEach(o => {
      
      let st = "";
      if (o.status === "new") st = "st-new";
      else if (o.status === "preparing") st = "st-preparing";
      else if (o.status === "completed") st = "st-completed";
      else if (o.status === "out") st = "st-out";
      else if (o.status === "cancelled") st = "st-cancelled";

      html += `
      <div class="order-box">
        <p><b>ุฑูู ุงูุทูุจ:</b> ${o.id}</p>
        <p><b>ุงูุชุงุฑูุฎ:</b> ${o.date}</p>
        <p><b>ุงูุฅุฌูุงูู:</b> ${safeNum(o.total_with_shipping || o.total)} ุฑ.ุณ</p>
        <p><span class="status-badge ${st}">${o.status}</span></p>
        <button onclick="go('track', ${o.id})" 
                style="margin-top:10px;background:#7a004b;color:white;border:none;padding:7px 12px;border-radius:6px;cursor:pointer;">
          ุชุชุจุน ุงูุทูุจ
        </button>
      </div>
      `;
    });
  }

  document.getElementById("profileOrders").innerHTML = html;
}

function safeNum(n){
  return (!n || isNaN(n)) ? "0.00" : Number(n).toFixed(2);
}

// ===================== ุชุบููุฑ ูููุฉ ุงููุฑูุฑ =====================
function showChangePasswordModal(){
  document.getElementById("changePasswordModal").style.display = "flex";
  document.getElementById("currentPassword").value = "";
  document.getElementById("newPassword").value = "";
  document.getElementById("confirmPassword").value = "";
  document.getElementById("changePasswordMsg").innerText = "";
}

function hideChangePasswordModal(){
  document.getElementById("changePasswordModal").style.display = "none";
}

async function changePassword(){
  const currentPassword = document.getElementById("currentPassword").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();
  const confirmPassword = document.getElementById("confirmPassword").value.trim();
  const msgBox = document.getElementById("changePasswordMsg");
  
  if(!currentPassword || !newPassword || !confirmPassword){
    msgBox.innerText = "โ๏ธ ูุฑุฌู ููุก ุฌููุน ุงูุญููู";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  if(newPassword !== confirmPassword){
    msgBox.innerText = "โ๏ธ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ุบูุฑ ูุชุทุงุจูุฉ";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  if(newPassword.length < 6){
    msgBox.innerText = "โ๏ธ ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  try {
    const res = await fetch(API + "/api/change-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone: window.user.phone,
        current_password: currentPassword,
        new_password: newPassword
      })
    });
    
    const data = await res.json();
    
    if(data.success){
      msgBox.innerText = "โ ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ!";
      msgBox.style.color = "#28a745";
      setTimeout(() => {
        hideChangePasswordModal();
        alert("โ ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ!");
      }, 1500);
    } else {
      msgBox.innerText = "โ " + (data.message || "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุบููุฑ ูููุฉ ุงููุฑูุฑ");
      msgBox.style.color = "#e74c3c";
    }
  } catch (error) {
    console.error("ุฎุทุฃ:", error);
    msgBox.innerText = "โ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ";
    msgBox.style.color = "#e74c3c";
  }
}

// ุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌูุง
document.addEventListener('click', function(event) {
  const modal = document.getElementById("changePasswordModal");
  if (event.target === modal) {
    hideChangePasswordModal();
  }
});



async function loadHome(){
  try {
    // ุงูุจุญุซ ูู homePage ุฃููุงูุ ุซู page-home
    const homePage = document.getElementById("homePage");
    const pageHome = document.getElementById("page-home");
    const container = homePage || pageHome;
    
    // ูุง ุญุงุฌุฉ ูุฅุถุงูุฉ active ููุง - go() ุณูุชููู ุฐูู
    
    const featuredGrid = document.getElementById("featuredGrid");
    const discountGrid = document.getElementById("discountGrid");
    
    // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงุตุฑ
    if (!featuredGrid) console.warn("featuredGrid not found!");
    if (!discountGrid) console.warn("discountGrid not found!");

  // ุชุญููู ุงููุงุฑูุงุช
  const brandsRes = await fetch(API + "/api/admin/brands");
    if(!brandsRes.ok) throw new Error("Failed to load brands");
  const brands = await brandsRes.json();

  // ุชุญููู ุงูููุชุฌุงุช
  const prodRes = await fetch(API + "/api/admin/products");
    if(!prodRes.ok) throw new Error("Failed to load products");
  const productsList = await prodRes.json();
  
  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const products = productsList.map(p => ({
    ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));
  
  // ุชุญุฏูุซ productsCache
  window.productsCache = products;
    
    // ุชุญููู ุงูุจุงูุฑุงุช
    try {
      await loadBanners();
    } catch(e) {
      console.error("Error loading banners:", e);
    }

  // ==================== ุงููุงุฑูุงุช ุงููููุฒุฉ ====================
  const slider = document.getElementById("brandsSlider");
    if(slider) {
  slider.innerHTML = "";

      const featuredBrands = brands.filter(b => b.featured == 1);
      
      if(featuredBrands.length > 0) {
        // ุฅุถุงูุฉ ูุณุฎ ูููุงุฑูุงุช ููู infinite loop
        const brandsToShow = [...featuredBrands, ...featuredBrands, ...featuredBrands];
        
        brandsToShow.forEach((b, index) => {
      slider.innerHTML += `
            <div class="brand-box" data-brand-index="${index}" onclick="go('brand', ${b.id})">
          <div class="brand-circle">
            <img src="${b.image_url || 'https://via.placeholder.com/120'}">
          </div>
          <div class="brand-name">${b.name}</div>
        </div>
      `;
    });
        
        // ุชููุฆุฉ ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู ุจุนุฏ ุชุญููู ุงููุงุฑูุงุช
        setTimeout(() => {
          try {
            initBrandsAutoSlider();
            updateBrandsVisibility();
          } catch(e) {
            console.error("Error initializing brands slider:", e);
          }
        }, 500);
      }
    }

  // ==================== ุงูููุชุฌุงุช ุงููููุฒุฉ ====================
    if(featuredGrid) {
  featuredGrid.innerHTML = "";

      const featuredProducts = products.filter(p => p.featured == 1);
      if(featuredProducts.length > 0) {
        featuredProducts.slice(0, 12).forEach(p => {
          try {
      featuredGrid.innerHTML += makeProductCard(p);
          } catch(e) {
            console.error("Error creating product card:", e);
          }
    });
      } else {
        featuredGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">ูุง ุชูุฌุฏ ููุชุฌุงุช ูููุฒุฉ ุญุงููุงู</p>';
      }
    }

  // ==================== ุงูุนุฑูุถ (ุฎุตููุงุช) ====================
    if(discountGrid) {
  discountGrid.innerHTML = "";

      const discountProducts = products.filter(p => p.discount_value > 0);
      if(discountProducts.length > 0) {
        discountProducts.slice(0, 12).forEach(p => {
          try {
      discountGrid.innerHTML += makeProductCard(p);
          } catch(e) {
            console.error("Error creating product card:", e);
          }
    });
      } else {
        discountGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">ูุง ุชูุฌุฏ ุนุฑูุถ ุญุงููุงู</p>';
      }
    }
	
  // ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ ุจุนุฏ ุฅุนุงุฏุฉ ุจูุงุก ุงูุตูุญุฉ
    try {
  refreshAllAddToCartButtons();
      // ุชุญุฏูุซ ุงูุชููููุงุช ุจุนุฏ ุชุญููู ุงูููุชุฌุงุช
      setTimeout(() => {
        updateAllProductRatings();
      }, 200);
    } catch(e) {
      console.error("Error refreshing buttons:", e);
    }
  } catch(error) {
    console.error("Error in loadHome:", error);
    const featuredGrid = document.getElementById("featuredGrid");
    const discountGrid = document.getElementById("discountGrid");
    if(featuredGrid) {
      featuredGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#e74c3c;">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูููุชุฌุงุช</p>';
    }
    if(discountGrid) {
      discountGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#e74c3c;">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุนุฑูุถ</p>';
    }
  }
}

// ุฏุงูุฉ ุฅูุดุงุก skeleton cards
function generateSkeletonCards(count) {
  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-title"></div>
        <div class="skeleton-title-small"></div>
        <div class="skeleton-price"></div>
      </div>
    `;
  }
  return html;
}

// ===================== ุชุญููู ูุนุฑุถ ุงูุจุงูุฑุงุช =====================
async function loadBanners(){
  const positions = [
    { key: 'above_brands', id: 'bannersAboveBrands' },
    { key: 'above_featured', id: 'bannersAboveFeatured' },
    { key: 'above_offers', id: 'bannersAboveOffers' }
  ];
  
  for(const pos of positions){
    try {
      const res = await fetch(API + "/api/banners/" + pos.key);
      const banners = await res.json();
      
      if(banners.error || !Array.isArray(banners)){
        continue;
      }
      
      const container = document.getElementById(pos.id);
      if(!container){
        console.warn(`Container ${pos.id} not found`);
        continue;
      }
      
      if(banners.length === 0){
        container.innerHTML = "";
        continue;
      }
      
      renderBannerSlider(pos.id, pos.key, banners);
    } catch (error) {
      console.error(`Error loading banners for ${pos.key}:`, error);
    }
  }
}

function renderBannerSlider(containerId, position, banners){
  const container = document.getElementById(containerId);
  
  if(!container){
    console.warn(`Container ${containerId} not found`);
    return;
  }
  
  if(banners.length === 0){
    container.innerHTML = "";
    return;
  }
  
  // ุงุณุชุฎุฏุงู containerId ููุนุฑู ูุฑูุฏ ุจุฏูุงู ูู position
  const sliderId = containerId.replace('banners', 'slider');
  
  let html = `
    <div class="banners-slider-wrapper" id="bannerSlider_${sliderId}">
      <div class="banners-slider" id="bannerSliderInner_${sliderId}">
  `;
  
  banners.forEach((banner, index) => {
    let productIds = [];
    try {
      productIds = JSON.parse(banner.product_ids || "[]");
    } catch(e) {
      productIds = [];
    }
    
    const productIdsStr = productIds.join(',');
    
    html += `
      <div class="banner-slide" onclick="handleBannerClick('${productIdsStr}')">
        <img src="${banner.desktop_image}" class="banner-slide-desktop" alt="${banner.title}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%221200%22 height=%22400%22%3E%3Crect fill=%22%238a004a%22 width=%221200%22 height=%22400%22/%3E%3Ctext fill=%22%23fff%22 font-family=%22Arial%22 font-size=%2240%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EBanner%3C/text%3E%3C/svg%3E'">
        <img src="${banner.mobile_image}" class="banner-slide-mobile" alt="${banner.title}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%238a004a%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23fff%22 font-family=%22Arial%22 font-size=%2230%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EBanner%3C/text%3E%3C/svg%3E'">
      </div>
    `;
  });
  
  html += `
      </div>
      ${banners.length > 1 ? `
        <div class="banner-slider-dots" id="bannerDots_${sliderId}">
          ${banners.map((_, i) => `<span class="banner-dot ${i === 0 ? 'active' : ''}" onclick="bannerGoTo('${sliderId}', ${i})" onmouseenter="pauseBannerAutoSlide('${sliderId}')" onmouseleave="resumeBannerAutoSlide('${sliderId}')"></span>`).join('')}
        </div>
      ` : ''}
    </div>
  `;
  
  container.innerHTML = html;
  
  // ุฅุถุงูุฉ swipe gestures ููุฌูุงู
  if(banners.length > 1){
    initBannerSwipe(sliderId, banners.length);
    startBannerAutoSlide(sliderId, banners.length);
  }
}

let bannerIntervals = {};
let bannerPaused = {};
let bannerCurrentIndex = {};

function startBannerAutoSlide(sliderId, count){
  if(bannerIntervals[sliderId]){
    clearInterval(bannerIntervals[sliderId]);
  }
  
  if(!bannerCurrentIndex[sliderId]){
    bannerCurrentIndex[sliderId] = 0;
  }
  
  bannerIntervals[sliderId] = setInterval(() => {
    if(bannerPaused[sliderId]) return;
    
    bannerCurrentIndex[sliderId] = (bannerCurrentIndex[sliderId] + 1) % count;
    bannerGoTo(sliderId, bannerCurrentIndex[sliderId], true);
  }, 5000); // ุชุบููุฑ ูู 5 ุซูุงูู
}

function pauseBannerAutoSlide(sliderId){
  bannerPaused[sliderId] = true;
}

function resumeBannerAutoSlide(sliderId){
  bannerPaused[sliderId] = false;
}

function bannerSlide(sliderId, direction){
  const slider = document.getElementById(`bannerSliderInner_${sliderId}`);
  if(!slider) return;
  
  const banners = slider.querySelectorAll('.banner-slide');
  const count = banners.length;
  if(count === 0) return;
  
  if(!bannerCurrentIndex[sliderId]){
    bannerCurrentIndex[sliderId] = 0;
  }
  
  // ุญุณุงุจ ุงูููุฑุณ ุงูุฌุฏูุฏ ูุน ุงูุชุฏููุฑ ุงูุฏุงุฆุฑู
  let newIndex = bannerCurrentIndex[sliderId] + direction;
  if(newIndex < 0) newIndex = count - 1;
  if(newIndex >= count) newIndex = 0;
  
  bannerCurrentIndex[sliderId] = newIndex;
  bannerGoTo(sliderId, newIndex, true);
}

function bannerGoTo(sliderId, index, isAuto = false){
  const slider = document.getElementById(`bannerSliderInner_${sliderId}`);
  if(!slider) return;
  
  const banners = slider.querySelectorAll('.banner-slide');
  const count = banners.length;
  if(count === 0) return;
  
  // ุงูุชุฃูุฏ ูู ุฃู ุงูููุฑุณ ุตุญูุญ
  if(index < 0) index = count - 1;
  if(index >= count) index = 0;
  
  bannerCurrentIndex[sliderId] = index;
  
  const slideWidth = slider.offsetWidth;
  slider.scrollTo({
    left: index * slideWidth,
    behavior: 'smooth'
  });
  
  updateBannerDots(sliderId, index);
  
  // ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู ุฅุฐุง ูู ููู ุชููุงุฆูุงู
  if(!isAuto && count > 1){
    startBannerAutoSlide(sliderId, count);
  }
}

function updateBannerDots(sliderId, activeIndex){
  const dots = document.querySelectorAll(`#bannerDots_${sliderId} .banner-dot`);
  dots.forEach((dot, index) => {
    dot.classList.toggle('active', index === activeIndex);
  });
}

// ุฅุถุงูุฉ swipe gestures ููุฌูุงู
function initBannerSwipe(sliderId, count){
  const slider = document.getElementById(`bannerSliderInner_${sliderId}`);
  if(!slider) return;
  
  let startX = 0;
  let startY = 0;
  let isDown = false;
  
  slider.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isDown = true;
    pauseBannerAutoSlide(sliderId);
  });
  
  slider.addEventListener('touchmove', (e) => {
    if(!isDown) return;
    e.preventDefault();
  });
  
  slider.addEventListener('touchend', (e) => {
    if(!isDown) return;
    isDown = false;
    
    const endX = e.changedTouches[0].clientX;
    const endY = e.changedTouches[0].clientY;
    const diffX = startX - endX;
    const diffY = startY - endY;
    
    // ุงูุชุฃูุฏ ูู ุฃู ุงูุญุฑูุฉ ุฃูููุฉ ุฃูุซุฑ ูู ุนููุฏูุฉ
    if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50){
      if(diffX > 0){
        // swipe left - next
        bannerSlide(sliderId, 1);
      } else {
        // swipe right - prev
        bannerSlide(sliderId, -1);
      }
    }
    
    setTimeout(() => {
      resumeBannerAutoSlide(sliderId);
    }, 2000);
  });
  
  // ุฅุถุงูุฉ ุฏุนู ุงููุงูุณ ููููุจููุชุฑ
  slider.addEventListener('mousedown', (e) => {
    startX = e.clientX;
    startY = e.clientY;
    isDown = true;
    pauseBannerAutoSlide(sliderId);
    e.preventDefault();
  });
  
  slider.addEventListener('mousemove', (e) => {
    if(!isDown) return;
    e.preventDefault();
  });
  
  slider.addEventListener('mouseup', (e) => {
    if(!isDown) return;
    isDown = false;
    
    const endX = e.clientX;
    const endY = e.clientY;
    const diffX = startX - endX;
    const diffY = startY - endY;
    
    if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50){
      if(diffX > 0){
        bannerSlide(sliderId, 1);
      } else {
        bannerSlide(sliderId, -1);
      }
    }
    
    setTimeout(() => {
      resumeBannerAutoSlide(sliderId);
    }, 2000);
  });
  
  slider.addEventListener('mouseleave', () => {
    isDown = false;
    resumeBannerAutoSlide(sliderId);
  });
}

function handleBannerClick(productIdsStr){
  if(!productIdsStr || productIdsStr.trim() === ''){
    go('products');
    return;
  }
  
  const productIds = productIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
  
  if(productIds.length === 0){
    go('products');
    return;
  }
  
  // ุญูุธ ุงูููุชุฌุงุช ุงููุญุฏุฏุฉ ูู ูุชุบูุฑ ุนุงู
  window.bannerProducts = productIds;
  
  // ุนุฑุถ ุงูููุชุฌุงุช ุงููุญุฏุฏุฉ
  go('products');
}
function makeProductCard(p){
  const wishlistArray = wishlist || JSON.parse(localStorage.getItem("wishlist") || "[]");
  const isFav = wishlistArray.includes(p.id);
  const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  const isOutOfStock = stock <= 0;
  const showStockBadge = stock > 0 && stock <= 6;

  return `
    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" style="position:relative;" onclick="go('product', ${p.id})">

      <!-- ุฒุฑ ุงูููุจ ูู ุฃุนูู ุงููุงุฑุช -->
      <div onclick="event.stopPropagation(); toggleWishlist(${p.id});"
           style="
             position:absolute;
             top:12px;
             left:12px;
             font-size:22px;
             cursor:pointer;
             z-index:20;
             color:${isFav ? '#E91E63' : '#bbb'};
             background:rgba(255,255,255,0.9);
             width:36px;
             height:36px;
             border-radius:50%;
             display:flex;
             align-items:center;
             justify-content:center;
             box-shadow:0 2px 8px rgba(0,0,0,0.1);
             transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
           "
           onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 4px 12px rgba(233, 30, 99, 0.3)'"
           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
        โค
      </div>

      <!-- ุงูุตูุฑุฉ + ุงูุฎุตู -->
      <div style="position:relative;">

        <!-- ุงูุฎุตู ูู ุฃุณูู ูููู ุงูุตูุฑุฉ -->
        ${
          p.discount_value > 0
          ? `<div style="
                position:absolute;
                bottom:0px;
                right:2px;
                background:#00a6ff;
                color:white;
                padding:3px 10px;
                font-size:12px;
                border-radius:20px;
                font-weight:600;
                white-space:nowrap;
                z-index:10;
              ">
              ุฎุตู ${p.discount_value}${p.discount_type === 'percent' ? "%" : ""}
             </div>`
          : ``
        }

        <!-- ุงูุตูุฑุฉ -->
        <img class="product-img"
             src="${safeImageURL(p.image_url)}"
             onerror="this.src='https://via.placeholder.com/200?text=No+Image'"
             style="${isOutOfStock ? 'filter: grayscale(100%); opacity: 0.5; cursor:pointer;' : 'cursor:pointer;'}"/>
      </div>

      <!-- ุงุณู ุงูููุชุฌ -->
      <h3 class="product-name"
          style="font-size:12px; line-height:1.35; height:40px; overflow:hidden; margin:6px 0; cursor:pointer;">
        ${p.name}
      </h3>

      <!-- ููุทูุฉ ุงูุฃุณุนุงุฑ -->
      <div class="price-row"
           style="display:flex;align-items:center;gap:8px;margin-top:6px;flex-direction:row-reverse;">

        <!-- ุญุณุงุจ ุงูุณุนุฑ -->
${(() => {
  const prices = calculateFinalPrice(p);

  return `
    <div style="display:flex;align-items:center;gap:8px;flex-direction:row-reverse;">

      <!-- ุงูุณุนุฑ ุงูููุงุฆู -->
      <div style="
        font-size:18px;
        font-weight:800;
        color:${p.discount_value > 0 ? '#E91E63' : '#8a004a'};
        white-space:nowrap;
        background:linear-gradient(135deg, ${p.discount_value > 0 ? '#E91E63' : '#8a004a'} 0%, ${p.discount_value > 0 ? '#c2185b' : '#6a0038'} 100%);
        -webkit-background-clip:text;
        -webkit-text-fill-color:transparent;
        background-clip:text;
        text-shadow:0 2px 4px rgba(138, 0, 74, 0.1);
      ">
        ${prices.final} ุฑ.ุณ
      </div>

      <!-- ุงูุณุนุฑ ูุจู ุงูุฎุตู -->
      ${
        p.discount_value > 0 
        ? `<div style="
              font-size:13px;
              color:#999;
              text-decoration:line-through;
              white-space:nowrap;
              opacity:0.7;
              position:relative;
            ">
              ${prices.before} ุฑ.ุณ
           </div>`
        : ``
      }

    </div>
  `;
})()}

      </div>

      <!-- ุงููุฌูู -->
      <div class="product-rating" data-product-id="${p.id}" style="display:flex;align-items:center;gap:4px;margin-top:4px;">
        <div class="stars-container" style="display:flex;gap:2px;">
          <span class="star"><span style="color:#ddd;">โ</span></span>
          <span class="star"><span style="color:#ddd;">โ</span></span>
          <span class="star"><span style="color:#ddd;">โ</span></span>
          <span class="star"><span style="color:#ddd;">โ</span></span>
          <span class="star"><span style="color:#ddd;">โ</span></span>
        </div>
        <span class="rating-value" style="font-size:12px;color:#666;font-weight:600;">0.0</span>
      </div>

      <!-- ุฒุฑ ุงูุณูุฉ -->
      <button 
        id="cart-btn-${p.id}"
        onclick="event.stopPropagation(); ${isOutOfStock ? 'return false;' : `addToCart(${p.id})`}"
        class="add-cart"
        ${isOutOfStock ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
        ${isOutOfStock ? 'ุงููููุฉ ููุชููุฉ' : 'ุฃุถู ููุณูุฉ'}
      </button>

    </div>
  `;
}


// ========================== ุงูุณูุฉ ==========================

let cart = JSON.parse(localStorage.getItem("cart") || "[]");

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
}

function openCart(){
  const overlay = document.getElementById("cartOverlay");
  const panel = document.getElementById("cartPanel");
  
  if (!overlay || !panel) {
    console.error("Cart elements not found!");
    return;
  }
  
  // ุชุญุฏูุซ ูุญุชูู ุงูุณูุฉ ุฃููุงู
  renderCart();
  
  // ุซู ูุชุญ ุงูููุญุฉ
  overlay.style.display = "block";
  if(window.innerWidth <= 768) {
  panel.style.right = "0px";
    panel.classList.add("open");
  } else {
    panel.style.right = "0px";
    panel.classList.add("open");
  }
}

function closeCart(){
  document.getElementById("cartOverlay").style.display = "none";
  const panel = document.getElementById("cartPanel");
  panel.style.right = window.innerWidth <= 768 ? "-85%" : "-350px";
  panel.classList.remove("open");
}

async function addToCart(id){
  // ุฅุธูุงุฑ ุฏุงุฆุฑุฉ ุงูุชุญููู ูู ุงูุฒุฑ
  const btn = document.getElementById(`cart-btn-${id}`);
  const productBtn = document.getElementById("productAddBtn");
  
  let originalBtnText = "";
  let originalProductBtnText = "";
  
  if(btn) {
    btn.classList.add("loading");
    originalBtnText = btn.innerHTML;
    btn.innerHTML = '<span style="opacity:0;">ุฃุถู ููุณูุฉ</span>';
    btn.disabled = true;
  }
  
  if(productBtn && productBtn.getAttribute("data-id") == id) {
    productBtn.classList.add("loading");
    originalProductBtnText = productBtn.innerHTML;
    productBtn.innerHTML = '<span style="opacity:0;">ุฃุถู ููุณูุฉ</span>';
    productBtn.disabled = true;
  }

  try {
    // ุชุญููู ุงูููุชุฌุงุช ูู API (ุฅุนุงุฏุฉ ุชุญููู ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ)
  if(!window.productsCache){
    const res = await fetch(API + "/api/admin/products");
    const productsList = await res.json();
    
    // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
    window.productsCache = productsList.map(p => ({
      ...p,
        stock: parseInt(p.stock || p.quantity || 0),
        quantity: parseInt(p.quantity || p.stock || 0),
        stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
    }));
  }
    
    // ุฅุนุงุฏุฉ ุชุญููู ุงูููุชุฌ ุงููุญุฏุฏ ูู ุงูุณูุฑูุฑ ููุชุฃูุฏ ูู ุฃุญุฏุซ ุจูุงูุงุช ุงููุฎุฒูู
    const productRes = await fetch(API + "/api/admin/products");
    const allProducts = await productRes.json();
    const updatedProduct = allProducts.find(p => p.id == id);
    if(updatedProduct && window.productsCache){
      const productIndex = window.productsCache.findIndex(p => p.id == id);
      if(productIndex !== -1){
        window.productsCache[productIndex] = {
          ...updatedProduct,
          stock: parseInt(updatedProduct.stock || updatedProduct.quantity || 0),
          quantity: parseInt(updatedProduct.quantity || updatedProduct.stock || 0),
          stock_qty: parseInt(updatedProduct.stock || updatedProduct.quantity || 0)
        };
      }
  }

  const p = window.productsCache.find(x => x.id == id);
    if(!p) {
      if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = originalBtnText; }
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText; }
      return;
    }

  // ุงูุชุญูู ูู ุงููุฎุฒูู
    const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  if(stock <= 0){
      showNotification("ุนุฐุฑุงูุ ูุฐุง ุงูููุชุฌ ุบูุฑ ูุชููุฑ ุญุงููุงู", 'warning');
      if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = "ุงููููุฉ ููุชููุฉ"; }
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = '<span>โ</span><span>ุงููููุฉ ููุชููุฉ</span>'; }
    return;
  }

  // ูู ุงูููุชุฌ ููุฌูุฏ ูู ุงูุณูุฉ
  let item = cart.find(x => x.id == id);
  const currentQty = item ? item.qty : 0;
  const newQty = currentQty + 1;

  // ุงูุชุญูู ูู ุฃู ุงููููุฉ ุงููุทููุจุฉ ูุง ุชุชุฌุงูุฒ ุงููุฎุฒูู
  if(newQty > stock){
      showNotification(`ุนุฐุฑุงูุ ุงููููุฉ ุงููุชุงุญุฉ ูู ุงููุฎุฒูู ูู ${stock} ุญุจุฉ ููุท`, 'warning');
      if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = originalBtnText; }
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText; }
    return;
  }

  if(item){
    item.qty = newQty;
  } else {
    // ุญุณุงุจุงุช ุงูุฃุณุนุงุฑ
let base = parseFloat(p.base_price) || 0;
let discountValue = parseFloat(p.discount_value) || 0;
let discountType = p.discount_type;

let priceAfterDiscount = base;

if (discountValue > 0) {
    if (discountType === "percent") {
        priceAfterDiscount = base - (base * (discountValue / 100));
    } else if (discountType === "fixed") {
        priceAfterDiscount = base - discountValue;
    }
}

let priceWithVat = priceAfterDiscount * 1.15;

item = {
    id: p.id,
    name: p.name,
    qty: 1,
    image: p.image_url,

    // ููู ุฌุฏุงู โ ููุฑุณู ุฅูู ุงูุทูุจ ูุฅูู orders.html
    base_price: base,
    price_after_discount: priceAfterDiscount.toFixed(2),
    price_with_vat: priceWithVat.toFixed(2),
    total: priceWithVat.toFixed(2)   // ูููุทุนุฉ ุงููุงุญุฏุฉ
};

    cart.push(item);
  }

  saveCart();
  renderCart();
  updateCartIcon();
  refreshCurrentPage();

  // ูุชุญ ููุญุฉ ุงูุณูุฉ ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ ููุชุฌ
  openCart();

  // ุชุญุฏูุซ ุฒุฑ ุงููุฑุช ููููุชุฌ
  if(btn){
      btn.classList.remove("loading");
      btn.disabled = false;
      btn.innerHTML = `ูุถุงู ููุณูุฉ +${item.qty}`;
    btn.style.background = "#8a004a";
    btn.style.color = "#fff";
    btn.classList.add("added");
  }

  // ุชุญุฏูุซ ุฒุฑ ุตูุญุฉ ุงูููุชุฌ
    if(productBtn && productBtn.getAttribute("data-id") == id) {
      productBtn.classList.remove("loading");
      productBtn.disabled = false;
      productBtn.innerHTML = `<span>๐</span><span>ูุถุงู ููุณูุฉ +${item.qty}</span>`;
      productBtn.classList.add("added");
    } else {
  updateProductPageButton(id);
    }
  } catch(error) {
    console.error("Error adding to cart:", error);
    // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฒุฑุงุฑ ูู ุญุงูุฉ ุงูุฎุทุฃ
    if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = originalBtnText || "ุฃุถู ููุณูุฉ"; }
    if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText || '<span>๐</span><span>ุฃุถู ููุณูุฉ</span>'; }
    alert("โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูููุชุฌ ููุณูุฉ");
  }
}



function removeItem(id){
  cart = cart.filter(x => x.id != id);

  saveCart();
  renderCart();          // ุชุญุฏูุซ ุงูุณูุฉ ุงูุฌุงูุจูุฉ
  renderCheckoutPage();  // ุชุญุฏูุซ ุตูุญุฉ ุฅุชูุงู ุงูุทูุจ
  updateCartIcon();
  refreshAllAddToCartButtons();
  updateProductPageButton(id);
}





function changeQty(id, q){
  const item = cart.find(x => x.id == id);
  if(!item) return;

  // ููุน ุชูููู ุงููููุฉ ุนู 1 - ููุท ุฒุฑ ุงูุญุฐู ูุญุฐู ุงูููุชุฌ
  if(q < 0 && item.qty <= 1){
    return; // ูุง ุชุณูุญ ุจุชูููู ุงููููุฉ ุนู 1
  }

  // ุงูุชุญูู ูู ุฃู ุงููููุฉ ุงูุฌุฏูุฏุฉ ูู ุชูู ุนู 1
  if(q < 0 && (item.qty + q) < 1){
    return; // ูุง ุชุณูุญ ุจุชูููู ุงููููุฉ ุนู 1
  }

  // ุงูุชุญูู ูู ุงููุฎุฒูู
  if(!window.productsCache){
    // ุฅุฐุง ูู ูุชู ุชุญููู ุงูููุชุฌุงุชุ ุงุณุชูุฑ ุจุฏูู ุชุญูู
    item.qty += q;
  } else {
    const p = window.productsCache.find(x => x.id == id);
    if(p){
      const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
      const newQty = item.qty + q;
      
      if(newQty > stock){
        showNotification(`ุนุฐุฑุงูุ ุงููููุฉ ุงููุชุงุญุฉ ูู ุงููุฎุฒูู ูู ${stock} ุญุจุฉ ููุท`, 'warning');
        return;
      }
    }
    
    item.qty += q;
  }

  // ุงูุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุง ุชูู ุนู 1
  if(item.qty < 1){
    item.qty = 1;
  }

  saveCart();
  renderCart();
  renderCheckoutPage();  // โ ุชุญุฏูุซ ุตูุญุฉ ุฅุชูุงู ุงูุทูุจ

  updateCartIcon();
  refreshAllAddToCartButtons();
  updateProductPageButton(id);
}



function renderCart() {
  const box = document.getElementById("cartItems");
  const totalBox = document.getElementById("cartTotal");

  if (!box || !totalBox) {
    console.error("Cart elements not found!");
    return;
  }

  box.innerHTML = "";
  let total = 0;

  // ุฅุฐุง ูุงูุช ุงูุณูุฉ ูุงุฑุบุฉ
  if (cart.length === 0) {
    box.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#999;">
        <div style="font-size:48px;margin-bottom:10px;">๐</div>
        <div style="font-size:16px;">ุงูุณูุฉ ูุงุฑุบุฉ</div>
        <div style="font-size:14px;margin-top:5px;">ุฃุถู ููุชุฌุงุช ููุจุฏุก</div>
      </div>
    `;
    totalBox.innerText = "0.00";
    return;
  }

  cart.forEach(item => {

// ุฌูุจ ุจูุงูุงุช ุงูููุชุฌ ุงูุฃุตููุฉ
let p = window.productsCache?.find(x => x.id == item.id);

// ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุฌุ ุงุณุชุฎุฏู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงูุณูุฉ
if (!p) {
  // ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงูุณูุฉ
  box.innerHTML += `
    <div style="display:flex; align-items:flex-start; gap:10px; margin-bottom:15px;">
      <img src="${safeImageURL(item.image)}"
           onerror="this.src='https://via.placeholder.com/80?text=No+Img'"
           style="width:60px; height:60px; object-fit:cover; border-radius:10px;">
      <div style="flex:1;">
        <div style="font-weight:600; color:#333; margin-bottom:4px; font-size:13px; line-height:1.4; max-height:2.8em; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
          ${item.name}
        </div>
        <div style="font-size:17px; font-weight:bold; color:#8a004a;">
          ${item.price_with_vat || item.total} ุฑ.ุณ ร ${item.qty}
        </div>
        <button onclick="removeItem(${item.id})" style="background:#ffd6e3;color:#E91E63;border:none;padding:5px 10px;border-radius:6px;font-size:13px;margin-top:5px;">ุญุฐู</button>
      </div>
    </div>
  `;
  total += parseFloat(item.price_with_vat || item.total || 0) * item.qty;
  return; // ุชุฎุทู ุจุงูู ุงูููุฏ ููุฐุง ุงูุนูุตุฑ
}

let base = parseFloat(p.base_price) || 0;
let discountValue = parseFloat(p.discount_value) || 0;
let discountType = p.discount_type || "none";

// ุงูุณุนุฑ ุงูุฃุณุงุณู ูุน ุงูุถุฑูุจุฉ
let beforePrice = base * 1.15;

// ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู
let priceAfterDiscount = base;

if (discountValue > 0) {
  if (discountType === "percent") {
    priceAfterDiscount = base - (base * (discountValue / 100));
  } else if (discountType === "fixed") {
    priceAfterDiscount = base - discountValue;
  }
}

// ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู + ุงูุถุฑูุจุฉ
let finalPrice = priceAfterDiscount * 1.15;

// ูุฌููุน ูุฐุง ุงูููุชุฌ
let lineTotal = finalPrice * item.qty;
total += lineTotal;


    box.innerHTML += `
      <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:18px; padding:12px; background:#f9f9f9; border-radius:12px; border:1px solid #f0f0f0; transition:all 0.3s ease;">

        <img src="${safeImageURL(item.image)}"
             onerror="this.src='https://via.placeholder.com/80?text=No+Img'"
             style="width:70px; height:70px; object-fit:cover; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); flex-shrink:0;">

        <div style="flex:1; display:flex; flex-direction:column; min-width:0;">

          <div style="font-weight:600; color:#333; margin-bottom:4px; line-height:1.4; font-size:12px; max-height:2.8em; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
            ${item.name}
          </div>

          <div style="margin-bottom:5px;">

            ${
  discountValue > 0
  ? `
      <!-- ุงูุณุนุฑ ูุจู ุงูุฎุตู -->
      <div style="
        font-size:12px;
        color:#999;
        text-decoration:line-through;
        white-space:nowrap;
      ">
        ${beforePrice.toFixed(2)} ุฑ.ุณ
      </div>

      <!-- ุงูุณุนุฑ ุงูููุงุฆู -->
      <div style="
        font-size:17px;
        font-weight:bold;
        color:red;
        white-space:nowrap;
      ">
        ${finalPrice.toFixed(2)} ุฑ.ุณ
      </div>
    `
  : `
      <!-- ุงูุณุนุฑ ุงูููุงุฆู ูููุชุฌ ุจุฏูู ุฎุตู -->
      <div style="
        font-size:17px;
        font-weight:bold;
        color:#006b6a;
        white-space:nowrap;
      ">
        ${beforePrice.toFixed(2)} ุฑ.ุณ
      </div>
    `
}


          </div>

          <div style="display:flex; align-items:center; gap:6px;">

            ${item.qty <= 1 
              ? `<button disabled onclick="return false;" style="background:#e0e0e0; border:1px solid #ccc; border-radius:8px; padding:6px 10px; font-size:14px; cursor:not-allowed; opacity:0.7; color:#999; pointer-events:none; user-select:none; font-weight:bold;" title="ุงููููุฉ ูุง ูููู ุฃู ุชูู ุนู 1 - ุงุณุชุฎุฏู ุฒุฑ ุงูุญุฐู ูุญุฐู ุงูููุชุฌ">-</button>`
              : `<button onclick="changeQty(${item.id}, -1)" style="background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:6px 10px; font-size:14px; cursor:pointer; font-weight:bold; color:#666; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);" title="ุชูููู ุงููููุฉ">-</button>`
            }

            <span style="font-size:15px; font-weight:bold; min-width:24px; text-align:center; color:#333;">
              ${item.qty}
            </span>

            <button onclick="changeQty(${item.id}, +1)"
              style="background:#fff; border:1px solid #e0e0e0; border-radius:8px;
                     padding:6px 10px; font-size:14px; cursor:pointer; font-weight:bold; color:#666; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">+</button>

            <button onclick="removeItem(${item.id})"
              style="background:linear-gradient(135deg, #ffe6f0 0%, #ffd6e3 100%); border:none; border-radius:8px;
                     padding:6px 12px; font-size:12px; color:#E91E63; cursor:pointer; font-weight:600; margin-right:auto; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(233, 30, 99, 0.2);">๐๏ธ ุญุฐู</button>

          </div>

        </div>
      </div>
    `;
  });

  totalBox.innerText = total.toFixed(2);
}

// ========== ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูุณูุฉ ููู ุงูููุชุฌุงุช ==========
function refreshAllAddToCartButtons() {
  document.querySelectorAll("[id^='cart-btn-']").forEach(btn => {

    const id = Number(btn.id.replace("cart-btn-", ""));
    const item = cart.find(x => x.id === id);

    if (item) {
      // ุฅุฐุง ุงูููุชุฌ ููุฌูุฏ ูู ุงูุณูุฉ
      btn.innerText = `ูุถุงู ููุณูุฉ +${item.qty}`;
      btn.style.background = "#8a004a";
      btn.style.color = "#fff";
      btn.classList.add("added");
    } else {
      // ุฅุฐุง ุงูููุชุฌ ุบูุฑ ููุฌูุฏ โ ุฃุฑุฌุน ุงูุดูู ุงูุทุจูุนู
      btn.innerText = "ุฃุถู ููุณูุฉ";
      btn.style.background = "";
      btn.style.color = "";
      btn.classList.remove("added");
    }
  });

  // ููุณ ุงูุดูุก ูุฒุฑ ุตูุญุฉ ุงูููุชุฌ
  const productBtn = document.getElementById("productAddBtn");
  if (productBtn) {
    const productId = Number(productBtn.getAttribute("data-id"));
    const item = cart.find(x => x.id === productId);

    if (item) {
      productBtn.innerText = `ูุถุงู ููุณูุฉ +${item.qty}`;
      productBtn.style.background = "#8a004a";
      productBtn.style.color = "#fff";
      productBtn.classList.add("added");
    } else {
      productBtn.innerText = "ุฃุถู ููุณูุฉ";
      productBtn.style.background = "";
      productBtn.style.color = "";
      productBtn.classList.remove("added");
    }
  }
}



// ========== ุชุญุฏูุซ ุฒุฑ ุงูุณูุฉ ุฏุงุฎู ุตูุญุฉ ุงูููุชุฌ ==========
function updateProductPageButton(id){
  const btn = document.getElementById("productAddBtn");
  if(!btn) return;

  const item = cart.find(x => x.id == id);

  if(item){
    btn.innerText = `ูุถุงู ููุณูุฉ +${item.qty}`;
    btn.classList.add("added");
  }
  else {
    btn.innerText = "ุฃุถู ููุณูุฉ";
    btn.classList.remove("added");
  }
}







// ========== ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณูุฉ ูู ุงูููุฏุฑ ==========
function updateCartIcon(){
  const count = cart.reduce((sum, item) => sum + item.qty, 0);
  const badge = document.getElementById("cartCount");

  if(!badge) return;

  if(count > 0){
    badge.style.display = "inline-block";
    badge.innerText = count;
  } else {
    badge.style.display = "none";
  }
}

function goToCheckout() {

  if (cart.length === 0) {
    alert("โ๏ธ ูุง ููููู ุฅุชูุงู ุงูุทูุจ โ ุงูุณูุฉ ูุงุฑุบุฉ");
    return;
  }

  // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
  if (!window.user || !window.user.phone) {
    showLoginRequiredModal();
    return;
  }

  closeCart();
  go("checkout");
}

function showLoginRequiredModal() {
  const modal = document.getElementById("loginRequiredModal");
  if (modal) {
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
}

function closeLoginRequiredModal() {
  const modal = document.getElementById("loginRequiredModal");
  if (modal) {
    modal.style.display = "none";
    document.body.style.overflow = "";
  }
}

function goToLoginFromModal() {
  closeLoginRequiredModal();
  closeCart();
  go("login");
}

// ุฅุบูุงู ุงูู modal ุนูุฏ ุงูุถุบุท ุนูู ุงูุฎูููุฉ
document.addEventListener("click", function(event) {
  const modal = document.getElementById("loginRequiredModal");
  if (modal && event.target === modal) {
    closeLoginRequiredModal();
  }
});

// ุฅุบูุงู ุงูู modal ุนูุฏ ุงูุถุบุท ุนูู ESC
document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    const modal = document.getElementById("loginRequiredModal");
    if (modal && modal.style.display === "flex") {
      closeLoginRequiredModal();
    }
  }
});

// ===================== ูุธุงู ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู ูููุงุฑูุงุช =====================
let brandsAutoSlideInterval = null;
let brandsSliderPaused = false;

// ุงูุชูุฑูุฑ ุงููุฏูู ุจุงูุณูุงู
function scrollBrands(px){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  pauseBrandsAutoSlide();
  
  slider.scrollBy({
    left: px,
    behavior: "smooth"
  });
  
  setTimeout(() => {
    updateBrandsVisibility();
    resumeBrandsAutoSlide();
  }, 600);
}

// ุชุญุฏูุซ ุญุงูุฉ ุงููุงุฑูุงุช ุงูุฌุงูุจูุฉ (ุดูุงูุฉ/blur)
function updateBrandsVisibility(){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  const brands = slider.querySelectorAll('.brand-box');
  if(brands.length === 0) return;
  
  const sliderRect = slider.getBoundingClientRect();
  const sliderCenter = sliderRect.left + sliderRect.width / 2;
  
  brands.forEach((brand) => {
    const brandRect = brand.getBoundingClientRect();
    const brandCenter = brandRect.left + brandRect.width / 2;
    const distance = Math.abs(brandCenter - sliderCenter);
    const threshold = sliderRect.width / 2.5;
    
    if(distance > threshold) {
      brand.classList.add('side');
    } else {
      brand.classList.remove('side');
    }
  });
}

// ุฅููุงู ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู
function pauseBrandsAutoSlide(){
  brandsSliderPaused = true;
}

// ุงุณุชุฆูุงู ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู
function resumeBrandsAutoSlide(){
  brandsSliderPaused = false;
}

// ุชููุฆุฉ ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู - ุชุตููู ุฌุฏูุฏ ูุญุณูู
function initBrandsAutoSlider(){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  // ุฅููุงู ุงูุณูุงูุฏุฑ ุงูุณุงุจู
  if(brandsAutoSlideInterval) {
    clearInterval(brandsAutoSlideInterval);
    brandsAutoSlideInterval = null;
  }
  
  const featuredBrands = slider.querySelectorAll('.brand-box');
  if(featuredBrands.length === 0) return;
  
  // ุญุณุงุจ ุนุฏุฏ ุงููุงุฑูุงุช ุงูุฃุตูู (3 ูุณุฎ)
  const originalCount = Math.floor(featuredBrands.length / 3);
  if(originalCount === 0) return;
  
  // ุงูุชุธุงุฑ ูุถูุงู ุชุญููู ุงูุนูุงุตุฑ
  setTimeout(() => {
    const isMobile = window.innerWidth <= 768;
    const firstBrand = featuredBrands[0];
    if(!firstBrand) return;
    
    // ุญุณุงุจ ุงูุฃุจุนุงุฏ ุจุฏูุฉ
    const cardWidth = firstBrand.offsetWidth || (isMobile ? (slider.clientWidth - 100) / 3 : 120);
    const gap = isMobile ? 18 : 15;
    const scrollAmount = cardWidth + gap;
    
    // ุจุฏุก ูู ุฃูู ูุงุฑูุฉ (ุงูุจุฏุงูุฉ) - ุชุฃูุฏ ูู ุงูุจุฏุงูุฉ
    slider.scrollLeft = 0;
    updateBrandsVisibility();
    
    // ุชูุนูู ุงูุณูุงูุฏุฑ
    brandsSliderPaused = false;
    
    // ุฏุงูุฉ ุงูุชูุฑูุฑ ุงูุชููุงุฆู - ูู ุงููุณุงุฑ ูููููู (ุงูููุชุฌุงุช ุชุชุญุฑู ูุงุญูุฉ ุงููููู)
    function autoSlide() {
      if(brandsSliderPaused) return;
      
      const currentScroll = slider.scrollLeft;
      const maxScroll = slider.scrollWidth - slider.clientWidth;
      const nextScroll = currentScroll + scrollAmount;
      
      // ุฅุฐุง ูุตููุง ููููุงูุฉ - ุงูุนูุฏุฉ ููุจุฏุงูุฉ ุชููุงุฆูุงู ุจุฏูู ุชููู
      if(nextScroll >= maxScroll - scrollAmount/2) {
        // ุงูุนูุฏุฉ ููุจุฏุงูุฉ ุจุฏูู animation
        slider.scrollLeft = 0;
        updateBrandsVisibility();
        
        // ูููู ุงูุชูุฑูุฑ ูุจุงุดุฑุฉ ุจุนุฏ ุงูุนูุฏุฉ (ูู ุฃูู ูุงุฑูุฉ)
        requestAnimationFrame(() => {
          setTimeout(() => {
            slider.scrollTo({
              left: scrollAmount,
              behavior: 'smooth'
            });
            setTimeout(() => updateBrandsVisibility(), 300);
          }, 50);
        });
      } else {
        // ุงูุชูุฑูุฑ ุงูุนุงุฏู - ูู ุงููุณุงุฑ ูููููู (ุงูููุชุฌุงุช ุชุชุญุฑู ูุงุญูุฉ ุงููููู)
        slider.scrollTo({
          left: nextScroll,
          behavior: 'smooth'
        });
        setTimeout(() => updateBrandsVisibility(), 300);
      }
    }
    
    // ุจุฏุก ุงูุณูุงูุฏุฑ ุงูุชููุงุฆู - 0.7 ุซุงููุฉ
    brandsAutoSlideInterval = setInterval(autoSlide, 700);
    
    // ุจุฏุก ุงูุชูุฑูุฑ ุงูุฃูู ุจุนุฏ 0.5 ุซุงููุฉ
    setTimeout(() => {
      if(!brandsSliderPaused) {
        autoSlide();
      }
    }, 500);
    
    // ุฅุฏุงุฑุฉ ุงูุชูุฑูุฑ ุงููุฏูู
    let isUserScrolling = false;
    let scrollTimeout;
    let lastScrollTime = 0;
    
    const handleScroll = () => {
      const now = Date.now();
      updateBrandsVisibility();
      
      // ุฅุฐุง ูุงู ุงูุชูุฑูุฑ ุณุฑูุน ุฌุฏุงูุ ููู ูุฏูู
      if(now - lastScrollTime < 100) {
        isUserScrolling = true;
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          isUserScrolling = false;
          if(!brandsSliderPaused) {
            pauseBrandsAutoSlide();
            setTimeout(() => resumeBrandsAutoSlide(), 5000);
          }
        }, 300);
      }
      
      lastScrollTime = now;
    };
    
    slider.addEventListener('scroll', handleScroll, { passive: true });
    
    // ุฅููุงู ุนูุฏ hover
    slider.addEventListener('mouseenter', () => {
      pauseBrandsAutoSlide();
    });
    
    slider.addEventListener('mouseleave', () => {
      resumeBrandsAutoSlide();
    });
    
    // ุฅููุงู ุนูุฏ touch
    let touchStartX = 0;
    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      pauseBrandsAutoSlide();
    }, { passive: true });
    
    slider.addEventListener('touchend', () => {
      setTimeout(() => {
        resumeBrandsAutoSlide();
      }, 3000);
    }, { passive: true });
  }, 600);
}
async function loadOffers(){
  const res = await fetch(API + "/api/admin/products");
  const productsList = await res.json();
  
  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));
  
  // ุชุญุฏูุซ productsCache
  window.productsCache = products;

  const offers = products.filter(p => p.discount_value > 0);

  const grid = document.getElementById("offersGrid");
  grid.innerHTML = "";

  offers.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  // โญ ุงูุญู ููุง
  refreshAllAddToCartButtons();
}

async function loadCategories(){
  const res = await fetch(API + "/api/admin/products");
  const products = await res.json();

  // ุงุณุชุฎุฑุงุฌ ุงูุชุตูููุงุช ุจุฏูู ุชูุฑุงุฑ
  let cats = {};

  products.forEach(p=>{
    if(p.category){
      cats[p.category] = true;
    }
  });

  const list = Object.keys(cats);

  const box = document.getElementById("categoriesList");
  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = "<p>ูุง ููุฌุฏ ุชุตูููุงุช</p>";
    return;
  }

  list.forEach(cat=>{
    box.innerHTML += `
      <div onclick="go('category', '${cat}')" 
           style="background:#f9d9e6;padding:20px;border-radius:14px;text-align:center;font-size:16px;color:#8a004a;font-weight:600;cursor:pointer;">
        ${cat}
      </div>
    `;
  });

}
async function loadCategoryProducts(catName){
  const res = await fetch(API + "/api/admin/products");
  const productsList = await res.json();
  
  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));
  
  // ุชุญุฏูุซ productsCache
  window.productsCache = products;

  const filtered = products.filter(p => p.category === catName);

  document.getElementById("categoryTitle").innerText = "ุชุตููู: " + catName;

  const grid = document.getElementById("categoryGrid");
  grid.innerHTML = "";

  filtered.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  // โญ ุงูุญู ููุง
  refreshAllAddToCartButtons();
}



let headerProductsCache = [];

// ===================== ูุธุงุฆู ุงูุจุญุซ ููุฌูุงู =====================
function toggleMobileSearch() {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  const searchInput = document.getElementById("headerSearchMobile");
  
  if (searchContainer && searchWrapper) {
    searchContainer.classList.add("active");
    searchWrapper.classList.add("search-active");
    
    // ุงูุชุฑููุฒ ุนูู ุญูู ุงูุจุญุซ ุจุนุฏ ูููู
    setTimeout(() => {
      if (searchInput) {
        searchInput.focus();
      }
    }, 100);
  }
}

function closeMobileSearch() {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  const searchInput = document.getElementById("headerSearchMobile");
  const searchResults = document.getElementById("headerSearchResultsMobile");
  
  if (searchContainer && searchWrapper) {
    searchContainer.classList.remove("active");
    searchWrapper.classList.remove("search-active");
    
    if (searchInput) {
      searchInput.value = "";
      searchInput.blur();
    }
    
    if (searchResults) {
      searchResults.style.display = "none";
    }
  }
}

// ุฅุบูุงู ุงูุจุญุซ ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌู
document.addEventListener("click", function(e) {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchBtn = document.getElementById("mobileSearchBtn");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  
  if (searchContainer && searchContainer.classList.contains("active")) {
    // ุฅุฐุง ูู ููู ุงูููุฑ ุฏุงุฎู ุญุงููุฉ ุงูุจุญุซ ุฃู ุนูู ุฒุฑ ุงูุจุญุซ
    if (!searchContainer.contains(e.target) && !searchBtn.contains(e.target)) {
      closeMobileSearch();
    }
  }
});

// ุฅุบูุงู ุงูุจุญุซ ุนูุฏ ุงูุถุบุท ุนูู ESC
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    const searchContainer = document.getElementById("mobileSearchContainer");
    if (searchContainer && searchContainer.classList.contains("active")) {
      closeMobileSearch();
    }
  }
});

async function headerLiveSearch(){
  // ุชุญุฏูุฏ ุฅุฐุง ููุง ูู ุงูุฌูุงู ุฃู ูุง ุฃููุงู
  const isMobile = window.innerWidth <= 768;
  
  // ุชุญุฏูุฏ ุฃู ุญูู ุจุญุซ ุชู ุงุณุชุฎุฏุงูู ุจูุงุกู ุนูู ููุน ุงูุฌูุงุฒ
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  
  // ูู ุงูุฌูุงูุ ุงุณุชุฎุฏู mobileSearch ููุท
  // ูู ุงูููุจููุชุฑุ ุงุณุชุฎุฏู desktopSearch ููุท
  let activeSearch;
  if(isMobile) {
    activeSearch = mobileSearch;
  } else {
    activeSearch = desktopSearch;
  }
  
  // ุชุญุฏูุฏ ุฃู ุตูุฏูู ูุชุงุฆุฌ ูุฌุจ ุงุณุชุฎุฏุงูู
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  
  // ููุฌูุงูุ ุงุณุชุฎุฏู mobileBox ููุท
  // ููููุจููุชุฑุ ุงุณุชุฎุฏู desktopBox ููุท
  let box;
  if(isMobile) {
    box = mobileBox;
  } else {
    box = desktopBox;
  }
  
  // ุงูุชุฃูุฏ ูู ุฃู box ููุฌูุฏ
  if(!box) {
    console.error("Search results box not found. isMobile:", isMobile, "mobileBox:", mobileBox, "desktopBox:", desktopBox);
    return;
  }
  
  const text = activeSearch ? activeSearch.value.toLowerCase() : "";
  
  console.log("Search box selected:", {isMobile, boxId: box.id, searchInput: activeSearch?.id, hasValue: text.trim() !== "", textLength: text.length});

  if(text.trim() === ""){
    box.style.display = "none";
    box.style.visibility = "hidden";
    box.innerHTML = "";
    return;
  }

  // ุชุญููู ุงูููุชุฌุงุช ูุฑุฉ ูุงุญุฏุฉ ููุท
  if(headerProductsCache.length === 0){
    const res = await fetch(API + "/api/admin/products");
    const productsList = await res.json();
    
    // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
    headerProductsCache = productsList.map(p => ({
      ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
    }));
  }

  // ุงูุจุญุซ ูู ุงูุงุณู ูุงููุตู ูุงููุงุฑูุฉ
  const results = headerProductsCache.filter(p => {
    const searchText = text.toLowerCase();
    const name = (p.name || '').toLowerCase();
    const description = (p.description || '').toLowerCase();
    const brand = (p.brand || '').toLowerCase();
    
    return name.includes(searchText) || 
           description.includes(searchText) || 
           brand.includes(searchText);
  });
  
  // ุชุฑุชูุจ ุงููุชุงุฆุฌ: ุงููุทุงุจูุฉ ูู ุงูุงุณู ุฃููุงู
  results.sort((a, b) => {
    const aName = (a.name || '').toLowerCase();
    const bName = (b.name || '').toLowerCase();
    const aStartsWith = aName.startsWith(text);
    const bStartsWith = bName.startsWith(text);
    
    if(aStartsWith && !bStartsWith) return -1;
    if(!aStartsWith && bStartsWith) return 1;
    return 0;
  });

  if(results.length === 0){
    // ุฅุนุฏุงุฏ box ูุจู ุฅุธูุงุฑ "ูุง ุชูุฌุฏ ูุชุงุฆุฌ"
    box.innerHTML = `
      <div style="padding:40px 20px;text-align:center;">
        <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">๐</div>
        <div style="color:#666;font-size:15px;font-weight:500;margin-bottom:4px;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>
        <div style="color:#999;font-size:13px;">ุฌุฑุจ ุงูุจุญุซ ุจูููุงุช ูุฎุชููุฉ</div>
      </div>
    `;
    box.style.display = "block";
    box.style.visibility = "visible";
    box.style.opacity = "1";
    
    // ููุฌูุงู
    if(isMobile && box.id === "headerSearchResultsMobile") {
      box.style.position = "absolute";
      box.style.top = "100%";
      box.style.left = "50%";
      box.style.transform = "translateX(-50%)";
      box.style.width = "calc(100vw - 40px)";
      box.style.maxWidth = "95vw";
      box.style.zIndex = "1001";
      box.style.maxHeight = "70vh";
      box.style.overflowY = "auto";
    }
    return;
  }

  // ุนุฑุถ ุงููุชุงุฆุฌ
  box.innerHTML = "";
  box.style.display = "block";
  box.style.visibility = "visible";
  box.style.opacity = "1";
  
  // ุงูุชุฃูุฏ ูู ุฃู ุงููุชุงุฆุฌ ูุฑุฆูุฉ ูู ุงูุฌูุงู
  if(isMobile && box.id === "headerSearchResultsMobile") {
    box.style.position = "absolute";
    box.style.top = "100%";
    box.style.left = "50%";
    box.style.transform = "translateX(-50%)";
    box.style.width = "calc(100vw - 40px)";
    box.style.maxWidth = "95vw";
    box.style.zIndex = "1001";
    box.style.maxHeight = "70vh";
    box.style.overflowY = "auto";
    box.style.visibility = "visible";
    box.style.opacity = "1";
    
    // ุงูุชุฃูุฏ ูู ุฃู container ููุฌูุฏ ููุดุท
    const searchContainer = box.closest('.mobile-search-container');
    if(searchContainer && !searchContainer.classList.contains('active')) {
      console.warn("Mobile search container is not active - results may not be visible!");
    }
  }

  results.slice(0, 8).forEach(p=>{
    const imageUrl = safeImageURL(p.image_url);
    const prices = calculateFinalPrice(p);
    const hasDiscount = p.discount_value > 0;
    
    box.innerHTML += `
      <div onclick="go('product', ${p.id}); clearHeaderSearch();"
           class="header-search-result-item"
           style="padding:14px 16px;display:flex;align-items:center;gap:16px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:all 0.2s ease;"
           onmouseover="this.style.background='#f8f9fa';this.style.transform='translateX(-2px)'"
           onmouseout="this.style.background='#fff';this.style.transform='translateX(0)'">
        <div style="position:relative;flex-shrink:0;">
          <img src="${imageUrl}" 
               onerror="this.src='https://via.placeholder.com/80?text=No+Image'"
               style="width:70px;height:70px;border-radius:12px;object-fit:cover;border:1px solid #e8e8e8;background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.05);"
               class="header-search-result-img">
        </div>
        <div style="flex:1;min-width:0;" class="header-search-result-content">
          <div style="font-size:16px;color:#1a1a1a;font-weight:600;margin-bottom:5px;line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;" class="header-search-result-name">
          ${p.name}
        </div>
          ${p.category ? `
            <div style="font-size:13px;color:#666;margin-bottom:6px;font-weight:400;" class="header-search-result-category">
              ๐ ${p.category}
            </div>
          ` : ''}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;" class="header-search-result-price">
            <span style="color:#E91E63;font-weight:700;font-size:17px;" class="header-search-price-main">${prices.final} ุฑ.ุณ</span>
            ${hasDiscount ? `
              <span style="color:#999;font-size:13px;text-decoration:line-through;" class="header-search-price-old">${prices.before} ุฑ.ุณ</span>
              <span style="background:linear-gradient(135deg, #ff4757 0%, #ee5a6f 100%);color:#fff;font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600;box-shadow:0 2px 4px rgba(255, 71, 87, 0.3);" class="header-search-discount">
                ุฎุตู ${p.discount_value}${p.discount_type === 'percent' ? '%' : ' ุฑ.ุณ'}
              </span>
            ` : ''}
          </div>
        </div>
        <div style="flex-shrink:0;color:#ccc;font-size:22px;transition:all 0.2s ease;" class="header-search-result-arrow">โ</div>
      </div>
    `;
  });
}

function clearHeaderSearch(){
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  
  if(desktopSearch) desktopSearch.value = "";
  if(mobileSearch) mobileSearch.value = "";
  if(desktopBox) desktopBox.style.display = "none";
  if(mobileBox) mobileBox.style.display = "none";
}

document.addEventListener("click", function(e){
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  const desktopContainer = document.querySelector(".desktop-search-container");
  const mobileContainer = document.querySelector(".mobile-search-container");

  // ููููุจููุชุฑ
  if(desktopBox && desktopContainer){
    if(!desktopContainer.contains(e.target)){
      desktopBox.style.display = "none";
    }
  }
  
  // ููุฌูุงู
  if(mobileBox && mobileContainer){
    if(!mobileContainer.contains(e.target)){
      mobileBox.style.display = "none";
    }
  }
});
// ======================== ุงูููุถููุงุช ========================
let wishlist = JSON.parse(localStorage.getItem("wishlist") || "[]"); // IDs ููุท


function saveWishlist(){
  localStorage.setItem("wishlist", JSON.stringify(wishlist));
}

async function toggleWishlist(id){
  const isCurrentlyFav = wishlist.includes(id);

  // ูู ุงูููุชุฌ ููุฌูุฏ โ ุงุญุฐูู
  if(isCurrentlyFav){
    wishlist = wishlist.filter(x => x !== id);
  } 
  else {
    wishlist.push(id);
  }

  saveWishlist();
  updateWishlistCount(); // ุชุญุฏูุซ ุนุฏุงุฏ ุงูููุถูุฉ
  
  // ุชุญุฏูุซ ุงูููุจ ูู ุตูุญุฉ ุงูููุชุฌ ูุจุงุดุฑุฉ ุฏูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
  const productWishlistBtn = document.getElementById("productWishlistBtn");
  if(productWishlistBtn && window.currentProductId === id) {
    const isNowFav = !isCurrentlyFav;
    productWishlistBtn.style.color = isNowFav ? '#E91E63' : '#bbb';
    productWishlistBtn.title = isNowFav ? 'ุฅุฒุงูุฉ ูู ุงูููุถูุฉ' : 'ุฅุถุงูุฉ ููููุถูุฉ';
    
    // ุชุฃุซูุฑ ุงูุชุฒุงุฒ ููุตูุฑุฉ ููุท
    const imageWrapper = document.querySelector('.product-image-wrapper');
    if(imageWrapper) {
      imageWrapper.style.animation = 'none';
      setTimeout(() => {
        imageWrapper.style.animation = 'heartShake 0.5s ease';
      }, 10);
    }
  } else {
    // ุชุญุฏูุซ ุงูุตูุญุงุช ุงูุฃุฎุฑู
  refreshCurrentPage();
  }
}


function refreshCurrentPage(){
  const activePage = document.querySelector(".page.active");
  const active = activePage ? activePage.id : "";

  if(active === "page-products") loadAllProducts();
  if(active === "page-home" || active === "homePage") loadHome();
  if(active === "page-wishlist") loadWishlist();
  if(active === "page-brand") loadBrandProducts(window.currentBrand);
  if(active === "page-category") loadCategoryProducts(window.currentCategory);
  if(active === "page-product") {
    // ุชุญุฏูุซ ุตูุญุฉ ุงูููุชุฌ ุงูุญุงููุฉ
    const productId = window.currentProductId;
    if(productId) {
      loadProductDetails(productId);
    }
  }
}
function getSARIcon(){
  return `
    <svg width="18" height="18" viewBox="0 0 1228 1228" style="vertical-align:middle;">
    <path d="M699.62 1113.02c-20.06 44.48-33.32 92.75-38.4 143.37l424.51-90.24c20.06-44.47 33.31-92.75 38.4-143.37zM1085.73 895.8c20.06-44.47 33.32-92.75 38.4-143.37l-330.68 70.33v-135.2l292.27-62.11c20.06-44.47 33.32-92.75 38.4-143.37l-330.68 70.27V66.13c-50.67 28.45-95.67 66.32-132.25 110.99v403.35l-132.25 28.11V0c-50.67 28.44-95.67 66.32-132.25 110.99v525.69l-295.91 62.88c-20.06 44.47-33.33 92.75-38.42 143.37l334.33-71.05v170.26l-358.3 76.14c-20.06 44.47-33.32 92.75-38.4 143.37l375.04-79.7c30.53-6.35 56.77-24.4 73.83-49.24l68.78-101.97v-.02c7.14-10.55 11.3-23.27 11.3-36.97V743.77l132.25-28.11v270.4l424.53-90.28Z" fill="#8a004a"></path>
    </svg>
  `;
}

function renderCheckoutPage() {
  const box = document.getElementById("checkoutItems");
  box.innerHTML = "";

  let subtotal = 0;
  let totalQty = 0;

  cart.forEach(item => {

    // ุงูุณุนุฑ ุงูุฃุณุงุณู ุงูุญูููู
    let p = window.productsCache?.find(x => x.id == item.id);

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p?.discount_value || 0;
    let discountType = p?.discount_type || "none";

    // ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู
    let priceAfterDiscount = base;

    if (discountValue > 0) {
      if (discountType === "percent") priceAfterDiscount = base - (base * discountValue / 100);
      else if (discountType === "fixed") priceAfterDiscount = base - discountValue;
    }

    // ุงูุณุนุฑ ุงูููุงุฆู ูุน ุงูุถุฑูุจุฉ
    let finalPrice = priceAfterDiscount * 1.15;

    let lineTotal = finalPrice * item.qty;
    subtotal += lineTotal;
    totalQty += item.qty;

    box.innerHTML += `
      <div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px;">

        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          
          <div style="flex:1;text-align:right;">
            <div style="font-weight:700;margin-bottom:5px;">${item.name}</div>

            <div style="margin-bottom:5px;font-weight:700;">
              ${
                discountValue > 0
                ? `
                    <span style="text-decoration:line-through;color:#999;font-size:14px;margin-left:8px;">
                      ${(base * 1.15).toFixed(2)} ุฑ.ุณ
                    </span>

                    <span style="color:#8a004a;font-weight:700;">
                      ${finalPrice.toFixed(2)} ุฑ.ุณ
                    </span>
                  `
                : `
                  <span style="color:#8a004a;font-weight:700;">
                    ${(base * 1.15).toFixed(2)} ุฑ.ุณ
                  </span>
                `
              }
            </div>

            <div style="display:flex;align-items:center;gap:10px;justify-content:flex-end;">
              ${item.qty <= 1 
                ? `<button disabled onclick="return false;" class="qty-btn" style="opacity:0.6; cursor:not-allowed; background:#e0e0e0; border:1px solid #ccc; color:#999; pointer-events:none; user-select:none;" title="ุงููููุฉ ูุง ูููู ุฃู ุชูู ุนู 1 - ุงุณุชุฎุฏู ุฒุฑ ุงูุญุฐู ูุญุฐู ุงูููุชุฌ">-</button>`
                : `<button onclick="changeQtyCheckout(${item.id}, -1)" class="qty-btn" title="ุชูููู ุงููููุฉ">-</button>`
              }
              <span style="font-size:16px;font-weight:bold;">${item.qty}</span>
              <button onclick="changeQtyCheckout(${item.id}, +1)" class="qty-btn">+</button>
            </div>
          </div>

          <img src="${safeImageURL(item.image)}"
               style="width:70px;height:70px;border-radius:10px;object-fit:cover;margin-left:10px;">
        </div>

        <button onclick="removeItemCheckout(${item.id})"
          style="background:#ffd6e3;color:#E91E63;border:none;padding:5px 15px;border-radius:6px;font-size:14px;margin-top:10px;">
          ุญุฐู
        </button>

      </div>
    `;
  });

  // ุฅุฌูุงููุงุช
// ===== ุชูุตูู ุงููุงุชูุฑุฉ ุจุทุฑููุฉ ุงูููุฏู =====
// ===== ุญุณุงุจ ููู ุงููุงุชูุฑุฉ =====
let base_before_vat_total = 0;
let discount_amount_total = 0;
let subtotal_before_vat = 0;
let subtotal_with_vat = 0;
let vat_total = 0;

cart.forEach(item => {
    let p = window.productsCache.find(x => x.id == item.id);

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p.discount_value || 0;
    let discountAmount = 0;

    // ุงูุฎุตู ูุจู ุงูุถุฑูุจุฉ
    if (p.discount_type === "percent") {
        discountAmount = base * (discountValue / 100);
    } 
    else if (p.discount_type === "fixed") {
        discountAmount = discountValue;
    }

    let price_after_discount = base - discountAmount;
    let final_price = price_after_discount * 1.15;

    base_before_vat_total += base * item.qty;
    discount_amount_total += discountAmount * item.qty;
    subtotal_before_vat += price_after_discount * item.qty;
    subtotal_with_vat += final_price * item.qty;
});

// ุงูุถุฑูุจุฉ ุงูุฅุฌูุงููุฉ
vat_total = subtotal_with_vat - subtotal_before_vat;

// ููุฏ ุงูุฎุตู
let coupon_discount = 0;

// ุงูุฅุฌูุงูู ุงูููุงุฆู
let total_final = subtotal_with_vat - coupon_discount;

// --- ุฅุถุงูุฉ ุงูุดุญู ---
let shipping = 15;
let shippingVat = shipping * 0.15;
let finalTotalWithShipping = subtotal_with_vat + shipping + shippingVat;

// ===== ุนุฑุถ ุงููุงุชูุฑุฉ =====
box.innerHTML += `

  <div style="padding:12px;margin-top:15px;line-height:1.9;font-size:15px;">

    <div style="display:flex;justify-content:space-between;">
      <span>ุงููุฌููุน ุงูุฃุณุงุณู (ุจุฏูู ุถุฑูุจุฉ)</span>
      <b>${base_before_vat_total.toFixed(2)} ุฑ.ุณ</b>
    </div>

    <div style="display:flex;justify-content:space-between; color:green;">
      <span>ุงููุจูุบ ุงููุฎุตูู</span>
      <b>- ${discount_amount_total.toFixed(2)} ุฑ.ุณ</b>
    </div>

    <hr style="margin:12px 0;">

    <div style="display:flex;justify-content:space-between;">
      <span>ุงููุฌููุน (ุจุฏูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ)</span>
      <b>${subtotal_before_vat.toFixed(2)} ุฑ.ุณ</b>
    </div>

    <div style="display:flex;justify-content:space-between;">
      <span>ูููุฉ ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ</span>
      <b>${vat_total.toFixed(2)} ุฑ.ุณ</b>
    </div>

    <hr style="margin:12px 0;">

    <div style="display:flex;justify-content:space-between;">
      <span>ุงููุฌููุน (ุดุงูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ)</span>
      <b>${subtotal_with_vat.toFixed(2)} ุฑ.ุณ</b>
    </div>

    <div style="display:flex;justify-content:space-between;">
      <span>ุงูุฎุตู (ููุฏ ุงูุฎุตู)</span>
      <b>${coupon_discount.toFixed(2)} ุฑ.ุณ</b>
    </div>

    <div style="margin-top:15px;font-size:22px;font-weight:800;color:#E91E63;text-align:center;">
      ุงูุณุนุฑ ุงูุฅุฌูุงูู ุงูููุงุฆู: ${total_final.toFixed(2)} ุฑ.ุณ
    </div>

  </div>
  <div style="display:flex;justify-content:space-between;">
  <span>ุงูุดุญู:</span>
  <b>${shipping.toFixed(2)} ุฑ.ุณ</b>
</div>

<div style="display:flex;justify-content:space-between;">
  <span>ุถุฑูุจุฉ ุงูุดุญู (15%):</span>
  <b>${shippingVat.toFixed(2)} ุฑ.ุณ</b>
</div>

<hr style="margin:12px 0;">

<div style="display:flex;justify-content:space-between;font-size:20px;color:#8a004a;font-weight:900;">
  <span>ุงูุฅุฌูุงูู ุงูููุงุฆู + ุงูุดุญู:</span>
  <b>${finalTotalWithShipping.toFixed(2)} ุฑ.ุณ</b>
</div>

`;
}




async function payOnline() {
// ๐ ููุน ุงูุฏูุน ุจุฏูู ุชุณุฌูู ุฏุฎูู
if (!window.user) {
  alert("โ๏ธ ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูุจู ุงูุฏูุน ุงูุฅููุชุฑููู");
  go("login");
  return;
}


  if (cart.length === 0) {
    alert("โ๏ธ ุงูุณูุฉ ูุงุฑุบุฉ!");
    return;
  }

  // 1) ุฌูุน ุจูุงูุงุช ุงูุนููู
  const name = document.getElementById("co_name").value.trim();
  const phone = document.getElementById("co_phone").value.trim();
  const phone2 = document.getElementById("co_phone2").value.trim();
  const notes = document.getElementById("co_notes").value.trim();
  const address = document.getElementById("co_address").value.trim();
  const location = document.getElementById("co_location").value.trim();

  if (!name || !phone) {
    alert("โ๏ธ ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุงุณู ูุฑูู ุงูุฌูุงู ูุจู ุงูุฏูุน ุงูุฅููุชุฑููู");
    return;
  }

  // 2) ุชุฌููุฒ ุงูุทูุจ ููุจุงู ุงูุฏ
  const body = {
    customer_name: name,
    customer_phone: phone,
	shipping: 15,
    shipping_vat: 15 * 0.15,
	customer_phone2: phone2,
	customer_notes: notes,
    customer_address: address,
    customer_location: location,
    notes: notes,

    items: cart.map(item => ({
    id: item.id,
    name: item.name,
    qty: item.qty,
    base_price: item.base_price,
    discount_value: window.productsCache.find(p => p.id == item.id)?.discount_value || 0,
    discount_type: window.productsCache.find(p => p.id == item.id)?.discount_type || "none"
}))


  };

  // 3) ุฅุฑุณุงู ุงูุทูุจ ุฅูู ุงูุณูุฑูุฑ
  
  const res = await fetch(API + "/api/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if (!data.success) {
    alert("โ๏ธ ูู ูุชู ุชุณุฌูู ุงูุทูุจ! ุญุงูู ูุฑุฉ ุฃุฎุฑู");
    return;
  }

const orderId = data.order_id;

  // ุชุญุฏูุซ ุงููุฎุฒูู ูู productsCache ุจุนุฏ ุฅุชูุงู ุงูุทูุจ
  if (window.productsCache) {
    cart.forEach(item => {
      const product = window.productsCache.find(p => p.id == item.id);
      if (product) {
        const currentStock = parseInt(product.stock || product.quantity || product.stock_qty || 0);
        const newStock = Math.max(0, currentStock - item.qty);
        product.stock = newStock;
        product.quantity = newStock;
        product.stock_qty = newStock; // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
      }
    });
  }

// ===== ุญูุธ ุงูุทูุจ ูู localStorage ูููุญุฉ ุงูุชุญูู =====
let dashboardOrders = JSON.parse(localStorage.getItem("orders") || "[]");

dashboardOrders.push({
    id: orderId,
    date: new Date().toLocaleString("ar-EG"),
    customer_name: name,
    customer_phone: phone,
    items: cart.map(item => ({
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: item.base_price,
        price_after_discount: item.price_after_discount,
        price_with_vat: item.price_with_vat,
        total: (item.price_with_vat * item.qty).toFixed(2)
    })),
    total: cart.reduce((sum, i) => sum + (i.price_with_vat * i.qty), 0).toFixed(2),
    status: "new"
});


localStorage.setItem("orders", JSON.stringify(dashboardOrders));
// ====================================================


  // 4) ุชูุฑูุบ ุงูุณูุฉ + ุชุญุฏูุซ ุงููุงุฌูุฉ
  cart = [];
  saveCart();
  updateCartIcon();

  // 5) ุนุฑุถ ุฑูู ุงูุทูุจ + ุตูุญุฉ ุงูุดูุฑ
  go("thanks", orderId);
}


function changeQtyCheckout(id, amount){
  let item = cart.find(p => p.id == id);
  if(!item) return;

  // ููุน ุชูููู ุงููููุฉ ุนู 1 - ููุท ุฒุฑ ุงูุญุฐู ูุญุฐู ุงูููุชุฌ
  if(amount < 0 && item.qty <= 1){
    return; // ูุง ุชุณูุญ ุจุชูููู ุงููููุฉ ุนู 1
  }

  // ุงูุชุญูู ูู ุฃู ุงููููุฉ ุงูุฌุฏูุฏุฉ ูู ุชูู ุนู 1
  if(amount < 0 && (item.qty + amount) < 1){
    return; // ูุง ุชุณูุญ ุจุชูููู ุงููููุฉ ุนู 1
  }

  // ุงูุชุญูู ูู ุงููุฎุฒูู
  if(window.productsCache){
    const p = window.productsCache.find(x => x.id == id);
    if(p){
      const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
      const newQty = item.qty + amount;
      
      if(newQty > stock){
        showNotification(`ุนุฐุฑุงูุ ุงููููุฉ ุงููุชุงุญุฉ ูู ุงููุฎุฒูู ูู ${stock} ุญุจุฉ ููุท`, 'warning');
        return;
      }
    }
  }

  item.qty += amount;

  // ุงูุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุง ุชูู ุนู 1
  if(item.qty < 1){
    item.qty = 1;
  }

  saveCart();
  renderCheckoutPage();
  updateCartIcon();          // โ ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณูุฉ
  refreshAllAddToCartButtons(); // โ ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุฅุถุงูุฉ ููุณูุฉ
}


function removeItemCheckout(id){
  cart = cart.filter(p => p.id != id);

  saveCart();
  renderCheckoutPage();
  updateCartIcon();             // โ ุชุญุฏูุซ ุนุฏุงุฏ ุงูุณูุฉ
  refreshAllAddToCartButtons(); // โ ุชุญุฏูุซ ุงูุฃุฒุฑุงุฑ
}


function pickLocation(){
  if (!navigator.geolocation) {
    alert("โ๏ธ ูุชุตูุญู ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู. ูุฑุฌู ุชุญุฏูุซ ุงููุชุตูุญ ุฃู ุงุณุชุฎุฏุงู ูุชุตูุญ ุขุฎุฑ.");
    return;
  }

  // ุฅุธูุงุฑ ุฑุณุงูุฉ ูููุณุชุฎุฏู
  const locationInput = document.getElementById("co_location");
  locationInput.value = "ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...";
  locationInput.style.color = "#00AEEF";

  const options = {
    enableHighAccuracy: true,
    timeout: 15000, // 15 ุซุงููุฉ
    maximumAge: 0
  };

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      let link = `https://maps.google.com/?q=${lat},${lng}`;
      locationInput.value = link;
      locationInput.style.color = "#4caf50";
      
      // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
      if(typeof showNotification === 'function') {
        showNotification("โ ุชู ุชุญุฏูุฏ ุงููููุน ุจูุฌุงุญ", 'success');
      } else {
        alert("โ ุชู ุชุญุฏูุฏ ุงููููุน ุจูุฌุงุญ");
      }
    },
    (error) => {
      let errorMsg = "ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุฏ ุงููููุน: ";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg = "โ๏ธ ุชู ุฑูุถ ุงููุตูู ูููููุน ุงูุฌุบุฑุงูู. ูุฑุฌู ุงูุณูุงุญ ุจุงููุตูู ูููููุน ูู ุฅุนุฏุงุฏุงุช ุงููุชุตูุญ.";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg = "โ๏ธ ูุนูููุงุช ุงููููุน ุบูุฑ ูุชุงุญุฉ.";
          break;
        case error.TIMEOUT:
          errorMsg = "โ๏ธ ุงูุชูุช ูููุฉ ุชุญุฏูุฏ ุงููููุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
          break;
        default:
          errorMsg = "โ๏ธ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู ูู ุชุญุฏูุฏ ุงููููุน.";
          break;
      }
      locationInput.value = "";
      locationInput.placeholder = errorMsg;
      locationInput.style.color = "#e74c3c";
      if(typeof showNotification === 'function') {
        showNotification(errorMsg, 'error');
      } else {
        alert(errorMsg);
      }
    },
    options
  );
}


async function loadWishlist(){
  const res = await fetch(API + "/api/admin/products");
  const allList = await res.json();
  
  // ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูููุชุฌุงุช ูุฏููุง stock ู quantity
  const all = allList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู
  }));
  
  // ุชุญุฏูุซ productsCache
  window.productsCache = all;

  const favList = all.filter(p => wishlist.includes(p.id));

  const grid = document.getElementById("wishlistGrid");
  grid.innerHTML = "";

  if(favList.length === 0){
    grid.innerHTML = "<p>ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ุงูููุถููุฉ.</p>";
    return;
  }

  favList.forEach(p=>{
  grid.innerHTML += makeProductCard(p);
});

refreshAllAddToCartButtons();

}
async function loadTrackPage(orderId) {

  const infoBox = document.getElementById("trackInfo");
  const timelineBox = document.getElementById("timeline");
  const itemsBox = document.getElementById("trackItems");

  infoBox.innerHTML = "ุฌุงุฑู ุงูุชุญููู...";
  timelineBox.innerHTML = "";
  itemsBox.innerHTML = "";

  const res = await fetch(`${API}/api/orders/${orderId}`);
  const data = await res.json();

  if (data.error) {
    infoBox.innerHTML = `<p style="color:red;">ุงูุทูุจ ุบูุฑ ููุฌูุฏ</p>`;
    return;
  }

  const o = data.order;

  /* ================================
     ๐ ุฅุตูุงุญ ุงูููู ูุจู ุงุณุชุฎุฏุงููุง
     ================================ */
  o.total = Number(o.total) || 0;
  o.shipping = Number(o.shipping) || 0;
  o.shipping_vat = Number(o.shipping_vat) || 0;
  o.total_with_shipping = Number(o.total_with_shipping) || (o.total + o.shipping + o.shipping_vat);

  if (o.status === "delivery") o.status = "delivery";

  const items = data.items || [];

  // ---- ูุนูููุงุช ุงูุทูุจ ----
  infoBox.innerHTML = `
    <p><b>ุฑูู ุงูุทูุจ:</b> ${o.id}</p>
    <p><b>ุงูุชุงุฑูุฎ:</b> ${o.date}</p>
    <p><b>ุงูุฅุฌูุงูู:</b> ${o.total_with_shipping.toFixed(2)} ุฑ.ุณ</p>
  `;

  // ---- ุงูุญุงูุงุช ----
  const steps = [
    { key:"new", text:"ุชู ุงุณุชูุงู ุงูุทูุจ" },
    { key:"processing", text:"ุฌุงุฑู ุงูุชุฌููุฒ" }, 
    { key:"completed", text:"ุฌุงูุฒ" },
    { key:"out", text:"ุฎุฑุฌ ููุชูุตูู" },
    { key:"delivery", text:"ููุฏ ุงูุชูุตูู" },
    { key:"done", text:"ุชู ุงูุชุณููู" }, 
    { key:"cancelled", text:"ุชู ุงูุฅูุบุงุก" }
  ];

  let activeFound = true;

  steps.forEach(s => {
    let active = "";
    if (activeFound) active = "step-active";
    if (o.status === s.key) activeFound = false;

    timelineBox.innerHTML += `
      <div class="step-item ${active}">
        <div class="step-circle"></div>
        <div class="step-text">${s.text}</div>
      </div>
    `;
  });

  // ---- ุงูุฃุตูุงู ----
  items.forEach(i => {

    const lineTotal = Number(i.total) || 0;

    itemsBox.innerHTML += `
      <div class="item-card">
        <b>${i.name}</b> ร ${i.qty}<br>
        ุงูุณุนุฑ: ${lineTotal.toFixed(2)} ุฑ.ุณ
      </div>
    `;
  });
}




async function viewOrder(id){
  const res = await fetch(API + "/api/orders/" + id);
  const data = await res.json();

  if(data.error){
    alert("ุงูุทูุจ ุบูุฑ ููุฌูุฏ");
    return;
  }

  let text = `
    ุฑูู ุงูุทูุจ: ${data.order.id}\n
    ุงูุชุงุฑูุฎ: ${data.order.date}\n
    ุงูุญุงูุฉ: ${data.order.status}\n
    ุงูุฅุฌูุงูู: ${data.order.total} ุฑ.ุณ\n\n
    --- ุงูููุชุฌุงุช ---\n
  `;

  data.items.forEach(i=>{
    text += `${i.name} ร ${i.qty}\n`;
  });

  alert(text);
}


async function fetchUserOrders(phone){
  const res = await fetch(API + "/api/orders?phone=" + phone);
  return await res.json();
}

function autoFillUserInCheckout() {
    if (window.user) {
        const nameInput = document.getElementById("co_name");
        const phoneInput = document.getElementById("co_phone");
        
        if(nameInput && phoneInput) {
            nameInput.value = window.user.name;
            phoneInput.value = window.user.phone;

            nameInput.setAttribute("readonly", true);
            phoneInput.setAttribute("readonly", true);
            
            // ุฅุถุงูุฉ ุงูููุงุณ ุงูุฎุงุต ูููุฑุจุนุงุช readonly
            nameInput.classList.add("checkout-readonly");
            phoneInput.classList.add("checkout-readonly");
        }
    } else {
        // ุฅุฐุง ูู ููู ูุณุฌู ุฏุฎููุ ุฅุฒุงูุฉ readonly ูุงูููุงุณุงุช
        const nameInput = document.getElementById("co_name");
        const phoneInput = document.getElementById("co_phone");
        
        if(nameInput && phoneInput) {
            nameInput.removeAttribute("readonly");
            phoneInput.removeAttribute("readonly");
            
            nameInput.classList.remove("checkout-readonly");
            phoneInput.classList.remove("checkout-readonly");
            
            nameInput.value = "";
            phoneInput.value = "";
        }
    }
}



// ุฒุฑ ุงูุทุจุงุนุฉ


async function loadInvoice(orderId){

  const invoiceBox = document.getElementById("invoiceBox");
  invoiceBox.innerHTML = "<p style='text-align:center;padding:40px;color:#8a004a;'>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>";

  // ุฌูุจ ุจูุงูุงุช ุงูุทูุจ
  const orderRes = await fetch(`${API}/api/orders/${orderId}`);
  const orderData = await orderRes.json();

  if(orderData.error){
    invoiceBox.innerHTML = "<p style='color:red;text-align:center;padding:40px;font-size:18px;'>โ ุงูุทูุจ ุบูุฑ ููุฌูุฏ</p>";
    return;
  }

  const o = orderData.order;

  // ุฌูุจ ุงูุฃุตูุงู ูุงููุฉ (ูุน ุงูุฃุณุนุงุฑ + ุงูุตูุฑ + ุงูุฃููุงุฏ)
  const itemsRes = await fetch(`${API}/api/order_items_full/${orderId}`);
  const items = await itemsRes.json();

  let itemsHTML = "";
  let subtotal = 0;

  items.forEach((i, index) => {
    subtotal += i.total;

    const isEven = index % 2 === 0;
    itemsHTML += `
      <tr style="background:${isEven ? '#fafafa' : '#ffffff'};transition:background 0.2s;">
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;font-weight:500;color:#333;">${escapeHtml(i.name)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">
          <span style="background:#f0f0f0;padding:4px 12px;border-radius:20px;font-weight:600;">${i.qty}</span>
        </td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.base_price.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.price_after_discount.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.price_with_vat.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;font-weight:700;color:#8a004a;">${i.total.toFixed(2)} ุฑ.ุณ</td>
      </tr>
    `;
  });

  // ุญุณุงุจ ุงูุฅุฌูุงููุงุช
  const shipping = parseFloat(o.shipping) || 0;
  const shippingVat = parseFloat(o.shipping_vat) || 0;
  const finalTotal = parseFloat(o.total_with_shipping) || 0;

  const html = `
    <div style="
      background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
      padding:30px;
      border-radius:15px 15px 0 0;
      margin:-20px -20px 30px -20px;
      color:#fff;
      text-align:center;
    ">
      <div style="font-size:48px;margin-bottom:10px;">๐งพ</div>
      <h2 style="margin:0;font-size:28px;font-weight:800;color:#fff;">ูุงุชูุฑุฉ ุงูุทูุจ</h2>
      <p style="margin:10px 0 0 0;opacity:0.9;font-size:16px;">Invoice #${o.id}</p>
    </div>

    <div style="
      background:#f8f9fa;
      padding:25px;
      border-radius:12px;
      margin-bottom:25px;
      border-right:4px solid #8a004a;
    ">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;">
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">๐ ุฑูู ุงูุทูุจ</div>
          <div style="font-size:18px;font-weight:700;color:#8a004a;">#${o.id}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">๐ ุงูุชุงุฑูุฎ</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${o.date}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">๐ค ุงุณู ุงูุนููู</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${escapeHtml(o.customer_name)}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">๐ ุฑูู ุงูุฌูุงู</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${escapeHtml(o.customer_phone)}</div>
        </div>
      </div>
      <div style="background:#fff;padding:15px;border-radius:10px;margin-top:15px;">
        <div style="font-size:14px;color:#999;margin-bottom:8px;">๐ ุงูุนููุงู</div>
        <div style="font-size:16px;font-weight:600;color:#333;line-height:1.6;">${escapeHtml(o.customer_address)}</div>
      </div>
    </div>

    <div style="margin-bottom:25px;">
      <h3 style="
        color:#8a004a;
        font-size:22px;
        font-weight:800;
        margin:0 0 20px 0;
        padding-bottom:15px;
        border-bottom:3px solid #8a004a;
        display:inline-block;
      ">๐๏ธ ุชูุงุตูู ุงูููุชุฌุงุช</h3>
      
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
      <thead>
            <tr style="background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);color:#fff;">
              <th style="padding:18px;text-align:right;font-weight:700;font-size:15px;">ุงูุตูู</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">ุงููููุฉ</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">ุงูุณุนุฑ ุงูุฃุณุงุณู</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">ุจุนุฏ ุงูุฎุตู</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">ุจุนุฏ ุงูุถุฑูุจุฉ</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">ุงูุฅุฌูุงูู</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>
      </div>
    </div>

    <div style="
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding:25px;
      border-radius:12px;
      margin-top:30px;
    ">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #ddd;">
        <span style="font-size:16px;color:#666;font-weight:600;">๐ฐ ุฅุฌูุงูู ุงูููุชุฌุงุช:</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${subtotal.toFixed(2)} ุฑ.ุณ</span>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #ddd;">
        <span style="font-size:16px;color:#666;font-weight:600;">๐ ุชูููุฉ ุงูุดุญู:</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${shipping.toFixed(2)} ุฑ.ุณ</span>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:2px solid #8a004a;">
        <span style="font-size:16px;color:#666;font-weight:600;">๐ ุถุฑูุจุฉ ุงูุดุญู (15%):</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${shippingVat.toFixed(2)} ุฑ.ุณ</span>
      </div>
      
      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:20px 0 0 0;
        margin-top:15px;
      ">
        <span style="font-size:24px;font-weight:800;color:#8a004a;">โจ ุงูุฅุฌูุงูู ุงูููุงุฆู:</span>
        <span style="
          font-size:32px;
          font-weight:900;
          color:#8a004a;
          background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
          -webkit-background-clip:text;
          -webkit-text-fill-color:transparent;
          background-clip:text;
        ">${finalTotal.toFixed(2)} ุฑ.ุณ</span>
      </div>
    </div>

    <div style="
      text-align:center;
      margin-top:30px;
      padding:20px;
      background:#f0f4ff;
      border-radius:12px;
      border:2px dashed #8a004a;
    ">
      <div style="font-size:16px;color:#8a004a;font-weight:600;">
        โ ุดูุฑุงู ูู ุนูู ุซูุชู ุจูุง
      </div>
      <div style="font-size:14px;color:#666;margin-top:8px;">
        ุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู ูุชุฃููุฏ ุงูุทูุจ
      </div>
    </div>
  `;

  invoiceBox.innerHTML = html;
}


function logoutUser() {
  // ุญุฐู ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ุงูุชุฎุฒูู
  localStorage.removeItem("user");
  window.user = null;

  alert("โ ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ");

  // ุชุญุฏูุซ ุฑุงุจุท ุงูุญุณุงุจ ูู ุงูููุฏุฑ
  updateHeaderProfile();

  // ุงูุงูุชูุงู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
  go("login");
}

  // ====================== ุฅุฑุณุงู ููุฏ ูุณูุงู ุงูุจุงุณูุฑุฏ ======================
async function sendResetCode() {
  const email = fpEmail.value.trim();

  const res = await fetch(API + "/api/forgot", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  const data = await res.json();

  if (!data.success) {
    fpMsg.innerText = "โ " + data.message;
    return;
  }

  alert("โ ุชู ุฅุฑุณุงู ููุฏ ุงูุงุณุชุนุงุฏุฉ ุฅูู ุจุฑูุฏู ุงูุฅููุชุฑููู");
  rpEmail.value = email;
  go("reset");
}


// ====================== ุฅุนุงุฏุฉ ุถุจุท ูููุฉ ุงููุฑูุฑ ======================
async function resetPassword() {
  const email = rpEmail.value.trim();
  const code = rpCode.value.trim();
  const new_password = rpPass.value.trim();

  const res = await fetch(API + "/api/reset-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, code, new_password })
  });

  const data = await res.json();

  if (!data.success) {
    rpMsg.innerText = "โ " + data.message;
    return;
  }

  alert("โ ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ!");
  go("login");
}


// ====================== ุชูุนูู ุงูุญุณุงุจ ======================
async function verifyAccount(){
  const phone = document.getElementById("vPhone").value.trim();
  const code  = document.getElementById("vCode").value.trim();
  const verifyMsg = document.getElementById("verifyMsg");

  if (!code || code.length !== 6) {
    verifyMsg.innerText = "โ ูุฑุฌู ุฅุฏุฎุงู ููุฏ ุงูุชูุนูู ุงููููู ูู 6 ุฃุฑูุงู";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    return;
  }

  try {
  const res = await fetch(API + "/api/verify", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone, code })
  });

    if (!res.ok) {
      throw new Error("Network error");
    }

  const data = await res.json();

  if(!data.success){
      verifyMsg.innerText = "โ ููุฏ ุงูุชูุนูู ุบูุฑ ุตุญูุญ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู";
      verifyMsg.style.color = "#e74c3c";
      verifyMsg.style.display = "block";
      // ูุณุญ ุงูุญูู ูุฅุนุงุฏุฉ ุงููุญุงููุฉ
      document.getElementById("vCode").value = "";
      document.getElementById("vCode").focus();
    return;
  }

    verifyMsg.innerHTML = "โ ุชู ุชูุนูู ุงูุญุณุงุจ ุจูุฌุงุญ โ ุณูุชู ุชุญูููู ุงูุขู...";
    verifyMsg.style.color = "#4caf50";
    verifyMsg.style.display = "block";

  setTimeout(()=>{
    go("login");
    }, 1500);
  } catch (error) {
    verifyMsg.innerText = "โ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    console.error("Verification error:", error);
  }
}


//=================== ุชุงููุฑ ุฑุณุงูุฉ ุงูุชูุนูู ======================
let verifyTimer = null;
function startVerifyTimer(){
  let sec = 60;
  const resendBox = document.getElementById("resendBox");
  const timerBox = document.getElementById("timerBox");
  const timer = document.getElementById("timer");
  
  if (resendBox) resendBox.style.display = "none";
  if (timerBox) timerBox.style.display = "inline";

  if (timer) timer.innerText = sec;

  if (verifyTimer) {
    clearInterval(verifyTimer);
  }

  verifyTimer = setInterval(()=>{
    sec--;
    if (timer) timer.innerText = sec;

    if(sec <= 0){
      clearInterval(verifyTimer);
      if (timerBox) timerBox.style.display = "none";
      if (resendBox) resendBox.style.display = "inline";
    }
  },1000);
}
// =================== ุงุนุงุฏุฉ ุงุฑุณุงู ุงูููุฏ =========================
async function resendVerifyCode(){
  const phone = document.getElementById("vPhone").value;
  const verifyMsg = document.getElementById("verifyMsg");

  if (!phone) {
    verifyMsg.innerText = "โ ุฑูู ุงูุฌูุงู ุบูุฑ ููุฌูุฏ";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    return false;
  }

  try {
  const res = await fetch(API + "/api/resend-verify", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone })
  });

    if (!res.ok) {
      throw new Error("Network error");
    }

  const data = await res.json();

  if(data.success){
      verifyMsg.innerHTML = "โ ุชู ุฅุฑุณุงู ููุฏ ุฌุฏูุฏ ุฅูู ุจุฑูุฏู ุงูุฅููุชุฑููู";
      verifyMsg.style.color = "#4caf50";
      verifyMsg.style.display = "block";
    startVerifyTimer();
      // ูุณุญ ุงูุญูู ุงููุฏูู
      document.getElementById("vCode").value = "";
      document.getElementById("vCode").focus();
  } else {
      verifyMsg.innerText = "โ " + (data.message || "ุญุฏุซ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูููุฏ");
      verifyMsg.style.color = "#e74c3c";
      verifyMsg.style.display = "block";
    }
  } catch (error) {
    verifyMsg.innerText = "โ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    console.error("Resend code error:", error);
  }
  
  return false;
}



// ===================== ุชุญุฏูุซ ุฑุงุจุท ุงูุญุณุงุจ ูู ุงูููุฏุฑ =====================
function updateHeaderProfile() {
  const profileLink = document.getElementById("profileLink");
  const mobileProfileLink = document.getElementById("mobileProfileLink");
  
  // ุงุณุชุฎุฑุงุฌ ุงูุงุณู ุงูุฃูู ูู ุงูุงุณู ุงููุงูู
  function getFirstName(fullName) {
    if (!fullName) return "";
    // ุชูุณูู ุงูุงุณู ูุงูุญุตูู ุนูู ุฃูู ูููุฉ
    const parts = fullName.trim().split(/\s+/);
    return parts[0] || fullName;
  }
  
  if (profileLink) {
    const nameText = profileLink.querySelector(".profile-name-text");
    if (window.user && window.user.name) {
      const firstName = getFirstName(window.user.name);
      if (nameText) {
        nameText.textContent = firstName;
    } else {
        profileLink.innerHTML = `
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">${firstName}</span>
        `;
      }
      profileLink.classList.add("logged-in");
    } else {
      if (nameText) {
        nameText.textContent = "ุญุณุงุจู";
      } else {
        profileLink.innerHTML = `
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">ุญุณุงุจู</span>
        `;
      }
      profileLink.classList.remove("logged-in");
    }
  }
  
  if (mobileProfileLink) {
    const nameText = mobileProfileLink.querySelector(".mobile-profile-name");
    if (window.user && window.user.name) {
      const firstName = getFirstName(window.user.name);
      if (nameText) {
        nameText.textContent = firstName;
    } else {
        mobileProfileLink.innerHTML = `
          <span class="mobile-profile-icon">๐ค</span>
          <span class="mobile-profile-name">${firstName}</span>
        `;
      }
      mobileProfileLink.classList.add("logged-in");
    } else {
      if (nameText) {
        nameText.textContent = "ุญุณุงุจู";
      } else {
        mobileProfileLink.innerHTML = `
          <span class="mobile-profile-icon">๐ค</span>
          <span class="mobile-profile-name">ุญุณุงุจู</span>
        `;
      }
      mobileProfileLink.classList.remove("logged-in");
    }
  }
}

// ===================== ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ููุฌูุงู =====================
function toggleMobileMenu() {
  const menu = document.getElementById("mobileMenu");
  if (menu) {
    menu.classList.toggle("active");
  }
}

// ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌูุง
document.addEventListener("click", function(e) {
  const menu = document.getElementById("mobileMenu");
  const menuBtn = document.querySelector(".mobile-menu-btn");
  
  if (menu && menuBtn && !menu.contains(e.target) && !menuBtn.contains(e.target)) {
    menu.classList.remove("active");
  }
});

// ===================== ุชุญุฏูุซ ุนุฏุงุฏ ุงูููุถูุฉ =====================
function updateWishlistCount() {
  const countBadge = document.getElementById("wishlistCount");
  const mobileCountBadge = document.getElementById("mobileWishlistCount");
  
  const count = wishlist.length;
  
  if (countBadge) {
    if (count > 0) {
      countBadge.innerText = count;
      countBadge.style.display = "inline-block";
    } else {
      countBadge.style.display = "none";
    }
  }
  
  if (mobileCountBadge) {
    if (count > 0) {
      mobileCountBadge.innerText = count;
      mobileCountBadge.style.display = "inline-block";
    } else {
      mobileCountBadge.style.display = "none";
    }
  }
}

// ===================== ุชุญููู ูุญุชูู ุงูุตูุญุงุช ุงููุงููููุฉ =====================
async function loadPageContent(pageType) {
  try {
    const res = await fetch(API + "/api/pages/" + pageType);
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("pageContentTitle").innerText = "ุฎุทุฃ";
      document.getElementById("pageContentBody").innerHTML = "<p>ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููุญุชูู</p>";
      return;
    }

    document.getElementById("pageContentTitle").innerText = data.title || "ุงูุตูุญุฉ";
    
    // ุฅุฐุง ูุงูุช ุตูุญุฉ FAQุ ุนุฑุถ ุงูุฃุณุฆูุฉ ุจุดูู ููุธู
    if (pageType === "faq") {
      try {
        const parsed = JSON.parse(data.content);
        if (parsed.questions && Array.isArray(parsed.questions)) {
          let html = '<div style="margin-top:30px;">';
          parsed.questions.forEach((item, index) => {
            html += `
              <div style="margin-bottom:25px;padding:25px;background:#f8f9fa;border-radius:12px;border-right:4px solid #8a004a;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="color:#8a004a;margin-bottom:15px;font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px;">
                  <span style="background:#8a004a;color:#fff;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;">${index + 1}</span>
                  ${escapeHtml(item.question)}
                </h3>
                <p style="color:#555;line-height:1.9;font-size:16px;margin:0;padding-right:45px;">${escapeHtml(item.answer)}</p>
              </div>
            `;
          });
          html += '</div>';
          document.getElementById("pageContentBody").innerHTML = html;
        } else {
          document.getElementById("pageContentBody").innerHTML = data.content || "<p>ูุง ููุฌุฏ ูุญุชูู</p>";
        }
      } catch (e) {
        // ุฅุฐุง ูู ููู JSONุ ุนุฑุถ ุงููุญุชูู ููุง ูู
        document.getElementById("pageContentBody").innerHTML = data.content || "<p>ูุง ููุฌุฏ ูุญุชูู</p>";
      }
    } else {
      // ููุตูุญุงุช ุงูุฃุฎุฑูุ ุนุฑุถ ุงููุญุชูู HTML ูุจุงุดุฑุฉ
      document.getElementById("pageContentBody").innerHTML = data.content || "<p>ูุง ููุฌุฏ ูุญุชูู</p>";
    }
    
    // ุงูุชูุฑูุฑ ููุฃุนูู
    window.scrollTo(0, 0);
  } catch (error) {
    console.error("ุฎุทุฃ ูู ุชุญููู ุงููุญุชูู:", error);
    document.getElementById("pageContentTitle").innerText = "ุฎุทุฃ";
    document.getElementById("pageContentBody").innerHTML = "<p>ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููุญุชูู</p>";
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===================== ุฅุฑุณุงู ุงูุดููู =====================
async function submitComplaint(event) {
  event.preventDefault();
  
  const email = document.getElementById("complaintEmail").value.trim();
  const subject = document.getElementById("complaintSubject").value.trim();
  const message = document.getElementById("complaintMessage").value.trim();
  
  if (!email || !subject || !message) {
    alert("โ๏ธ ูุฑุฌู ููุก ุฌููุน ุงูุญููู");
    return;
  }
  
  // ุชุนุทูู ุงูุฒุฑ ุฃุซูุงุก ุงูุฅุฑุณุงู
  const submitBtn = event.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerText;
  submitBtn.disabled = true;
  submitBtn.innerText = "ุฌุงุฑู ุงูุฅุฑุณุงู...";
  
  try {
    const res = await fetch(API + "/api/complaints", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ email, subject, message })
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.success) {
      alert("โ ุชู ุฅุฑุณุงู ุดููุงู ุจูุฌุงุญ! ุณูุชูุงุตู ูุนู ูุฑูุจุงู.");
      document.getElementById("quickSupportForm").reset();
    } else {
      alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู: " + (data.error || "ุฎุทุฃ ุบูุฑ ูุนุฑูู"));
    }
  } catch (error) {
    console.error("ุฎุทุฃ:", error);
    alert("โ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
  } finally {
    // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
    submitBtn.disabled = false;
    submitBtn.innerText = originalText;
  }
}

// ุชุญููู ุงูุณูุดูุงู ููุฏูุง ูู ุงูููุชุฑ
async function loadFooterSocialMedia() {
  try {
    const res = await fetch(API + "/api/social-media");
    const socialMedia = await res.json();
    
    const container = document.getElementById("footerSocialMedia");
    if (!container) return;
    
    if (socialMedia.length === 0) {
      container.innerHTML = "";
      return;
    }
    
    container.innerHTML = socialMedia.map(sm => `
      <a href="${sm.url}" 
         target="_blank" 
         rel="noopener noreferrer"
         class="social-media-icon"
         title="${sm.platform}"
         style="
           display:flex;
           align-items:center;
           justify-content:center;
           width:40px;
           height:40px;
           border-radius:50%;
           background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           text-decoration:none;
           transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
           box-shadow:0 2px 8px rgba(0,0,0,0.1);
           overflow:hidden;
         "
         onmouseover="this.style.transform='scale(1.15) translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(138, 0, 74, 0.3)'"
         onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
        ${sm.icon_url ? `
          <img src="${sm.icon_url}" 
               alt="${sm.platform}" 
               style="width:24px;height:24px;object-fit:contain;"
               onerror="this.style.display='none'; this.parentElement.innerHTML='๐';">
        ` : '๐'}
      </a>
    `).join('');
  } catch (error) {
    console.error("Error loading social media:", error);
  }
}

window.onload = async () => {
  // ุฅุฎูุงุก ุตูุญุฉ Loading ุจุนุฏ ุชุญููู ูู ุดูุก
  const loader = document.getElementById("pageLoader");
  
  // ูุณุญ ุญููู ุงูุจุญุซ ูููุน ููุก ุฑูู ุงููุงุชู ุชููุงุฆูุงู
  const headerSearch = document.getElementById("headerSearch");
  const headerSearchMobile = document.getElementById("headerSearchMobile");
  if(headerSearch) headerSearch.value = "";
  if(headerSearchMobile) headerSearchMobile.value = "";
  
  try {
    await loadProductsCache(true);   // โ ุฅุนุงุฏุฉ ุชุญููู ูุณุฑู ููุชุฃูุฏ ูู ุฃุญุฏุซ ุจูุงูุงุช ุงููุฎุฒูู
  renderCart();
  updateCartIcon();
  refreshAllAddToCartButtons();
  updateHeaderProfile(); // ุชุญุฏูุซ ุฑุงุจุท ุงูุญุณุงุจ
  updateWishlistCount(); // ุชุญุฏูุซ ุนุฏุงุฏ ุงูููุถูุฉ
    loadFooterSocialMedia(); // ุชุญููู ุงูุณูุดูุงู ููุฏูุง
  
  // ูุฑุงุกุฉ ุงูู hash ูู URL ูุงุณุชุนุงุฏุฉ ุงูุตูุญุฉ ุงูุญุงููุฉ ุจุนุฏ reload
  const hash = window.location.hash;
  let targetPage = "home";
  let targetData = null;
  
  if(hash && hash.length > 1) {
    // ุฅุฒุงูุฉ # ูู ุงูุจุฏุงูุฉ
    const hashPath = hash.substring(1);
    const parts = hashPath.split('/');
    targetPage = parts[0];
    if(parts.length > 1) {
      const dataValue = parts[1];
      // ุชุญููู ุฅูู ุฑูู ุฅุฐุง ูุงูุช ุงูุตูุญุฉ ุชุชุทูุจ ุฑูู (ูุซู product, brand, category)
      if(targetPage === "product" || targetPage === "brand" || targetPage === "category" || targetPage === "track") {
        targetData = parseInt(dataValue);
        if(isNaN(targetData)) {
          targetData = dataValue; // ุฅุฐุง ูุดู ุงูุชุญูููุ ุงุณุชุฎุฏู ุงููููุฉ ุงูุฃุตููุฉ
        }
      } else {
        targetData = dataValue;
      }
    }
  }
  
  // ุฅุธูุงุฑ ุงูุตูุญุฉ ุงูููุงุณุจุฉ
  setTimeout(() => {
    // ุฅุฎูุงุก ุฌููุน ุงูุตูุญุงุช ุฃููุงู - ุงูุงุนุชูุงุฏ ุนูู CSS ููุท
    document.querySelectorAll(".page").forEach(p => {
      p.classList.remove("active");
      p.style.removeProperty("display"); // ุฅุฒุงูุฉ ุฃู inline styles
    });
    
    // ุงุณุชุฏุนุงุก go() ูุฅุธูุงุฑ ุงูุตูุญุฉ ุงูููุงุณุจุฉ (ูู ุงูู hash ุฃู ุงูุฑุฆูุณูุฉ)
    go(targetPage, targetData, true); // true = ุจุฏูู ุญูุธ ูู ุงูุณุฌู ูุฃููุง ูุณุชุนูุฏ ุงูุตูุญุฉ
  }, 100);
    
    // ุฅุฎูุงุก ุงูู loader ุจุนุฏ ุชุฃุฎูุฑ ูุตูุฑ ูุถูุงู ุชุญููู ูู ุดูุก
    setTimeout(() => {
      if(loader) {
        loader.classList.add("hidden");
        // ุฅุฒุงูุฉ ุงูุนูุตุฑ ูู DOM ุจุนุฏ ุงูุชูุงุก ุงูุงูุชูุงู
        setTimeout(() => {
          if(loader && loader.parentNode) {
            loader.parentNode.removeChild(loader);
          }
        }, 500);
      }
    }, 800);
  } catch(error) {
    console.error("Error loading page:", error);
    // ุฅุฎูุงุก ุงูู loader ุญุชู ูู ุญุงูุฉ ุงูุฎุทุฃ
    if(loader) {
      setTimeout(() => {
        loader.classList.add("hidden");
        setTimeout(() => {
          if(loader && loader.parentNode) {
            loader.parentNode.removeChild(loader);
          }
        }, 500);
      }, 1000);
    }
  }
};

function printInvoice() {
    const invoiceHTML = document.getElementById("invoiceBox").innerHTML;

    const printWin = window.open("", "_blank", "width=900,height=1200");

    printWin.document.open();
    printWin.document.write(`
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ูุงุชูุฑุฉ ุงูุทูุจ</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

      <style>
        @page {
          size: A4;
          margin: 15mm;
        }

        body {
          font-family: 'Cairo', 'Tajawal', sans-serif;
          background: #fff;
          direction: rtl;
          text-align: right;
          padding: 20px;
          color: #333;
          line-height: 1.6;
        }

        .invoice-wrapper {
          width: 100%;
        }

        .header {
          text-align: center;
          margin-bottom: 20px;
        }

        .header h1 {
          color: #8a004a;
          margin-bottom: 5px;
          font-size: 26px;
          font-weight: 900;
        }

        .header .sub {
          font-size: 14px;
          color: #777;
        }

        .section-title {
          font-size: 20px;
          margin: 18px 0 8px;
          color: #8a004a;
          font-weight: 800;
          border-right: 5px solid #8a004a;
          padding-right: 8px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }

        th {
          background: #8a004a !important;
          color: #fff !important;
          padding: 10px 8px;
          border: 1px solid #8a004a;
          font-size: 12px;
          font-weight: 700;
        }

        td {
          padding: 10px 8px;
          border: 1px solid #ddd;
          font-size: 12px;
        }

        tr:nth-child(even) {
          background: #fafafa;
        }

        .totals {
          margin-top: 25px;
          font-size: 16px;
          line-height: 1.8;
        }

        .totals div {
          display: flex;
          justify-content: space-between;
          margin: 4px 0;
        }

        .grand-total {
          text-align: center;
          margin-top: 15px;
          font-size: 24px;
          color: #8a004a;
          font-weight: 900;
        }

        .footer {
          text-align: center;
          margin-top: 30px;
          font-size: 14px;
          color: #888;
        }

      </style>
    </head>

    <body>

      <div class="invoice-wrapper">

        ${invoiceHTML}

        <div class="footer" style="text-align:center;margin-top:40px;padding-top:20px;border-top:2px dashed #8a004a;font-size:13px;color:#666;">
          <div style="margin-bottom:10px;font-weight:700;color:#8a004a;">ุดูุฑุงู ูุชุณูููู ูุนูุง โค๏ธ</div>
          <div style="color:#999;font-size:12px;">ููุงุณุชูุณุงุฑ ูุงูุชูุงุตู: ูููููู ุงูุชูุงุตู ูุนูุง ุนุจุฑ ูุณุงุฆู ุงูุชูุงุตู ุงููุชุงุญุฉ</div>
        </div>

      </div>

    </body>
    </html>
    `);

    printWin.document.close();

    printWin.onload = () => {
        printWin.focus();
        printWin.print();
    };
}


</script>


<!-- ========================= ุณูุถุงู ููุง: ููุฏ API + ููุฏ ุงูุณูุฉ + ููุฏ ุงูุตูุญุงุช ========================= -->


</body>
</html>

