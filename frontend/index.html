<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>متجر جمالك</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

<!-- CSS Files -->
<link rel="stylesheet" href="frontend/css/base.css">
<link rel="stylesheet" href="frontend/css/animations.css">
<link rel="stylesheet" href="frontend/css/header.css">
<link rel="stylesheet" href="frontend/css/footer.css">
<link rel="stylesheet" href="frontend/css/products.css">
<link rel="stylesheet" href="frontend/css/pages.css">
<link rel="stylesheet" href="frontend/css/modals.css">
<link rel="stylesheet" href="frontend/css/forms.css">
<link rel="stylesheet" href="frontend/css/utilities.css">
<link rel="stylesheet" href="frontend/css/ratings.css">
<link rel="stylesheet" href="frontend/css/loader.css">
<link rel="stylesheet" href="frontend/css/print.css">

</head>

<body>

<!-- ========================= صفحة Loading ========================= -->
<div id="pageLoader" class="page-loader">
  <div class="loader-container">
    <div class="loader-logo">
      <div class="loader-logo-circle">ج</div>
      <div class="loader-logo-text">جمالك</div>
    </div>
    <div class="loader-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <div class="loader-text">جاري التحميل...</div>
  </div>
</div>

<!-- =========================  الهيدر (سيتم دمجه لاحقًا كما هو) ========================= -->

<!-- نظام الإشعارات -->
<div id="notificationContainer" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:100000;pointer-events:none;max-width:500px;width:90%;"></div>

<header id="mainHeader">
  <div class="container">
    <div class="nav">

      <!-- الشعار -->
      <div class="logo" onclick="go('home')">
        <div class="logo-circle">ج</div>
        <div style="font-size:22px;font-weight:800;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.2);">جمالك</div>
      </div>

      <!-- البحث -->
      <div class="header-search-wrapper" style="flex:1;display:flex;justify-content:center;">
        <!-- زر البحث للجوال فقط -->
        <button class="mobile-search-icon-btn" onclick="toggleMobileSearch()" id="mobileSearchBtn">🔍</button>
        
        <!-- حاوية البحث للجوال -->
        <div class="mobile-search-container" id="mobileSearchContainer" style="position:relative;width:100%;max-width:400px;">
          <input 
            id="headerSearchMobile"
            oninput="headerLiveSearch()"
            placeholder="ابحث عن منتج…" 
            class="header-search-input"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            type="search"
            name="product-search"
            data-lpignore="true"
          />
          <span class="header-search-icon">🔍</span>
          <button class="mobile-search-close" onclick="closeMobileSearch()">✕</button>
          <div id="headerSearchResultsMobile" class="header-search-results"></div>
        </div>
        
        <!-- حقل البحث للكمبيوتر -->
        <div class="desktop-search-container" style="position:relative;width:100%;max-width:400px;">
          <input 
            id="headerSearch"
            oninput="headerLiveSearch()"
            placeholder="ابحث عن منتج…" 
            class="header-search-input"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            type="search"
            name="product-search"
            data-lpignore="true"
          />
          <span class="header-search-icon">🔍</span>
          <div id="headerSearchResults" class="header-search-results"></div>
        </div>
      </div>

      <!-- روابط (للكمبيوتر) -->
      <div class="nav-links">
        <a href="#" data-page="home" onclick="go('home'); return false;">الرئيسية</a>
        <a href="#" data-page="products" onclick="go('products'); return false;">المنتجات</a>
        <a href="#" data-page="brands" onclick="go('brands'); return false;">الماركات</a>
        <a href="#" data-page="profile" id="profileLink" onclick="go('profile'); return false;" class="profile-link-header">
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">حسابي</span>
        </a>
        <a href="#" data-page="offers" onclick="go('offers'); return false;">العروض</a>
        <a href="#" data-page="categories" onclick="go('categories'); return false;">التصنيفات</a>
        <a href="#" data-page="wishlist" onclick="go('wishlist'); return false;" class="wishlist-link">
          <span id="wishlistIcon" style="display:inline-flex;align-items:center;justify-content:center;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="filter:drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
          </span>
          <span id="wishlistCount" class="wishlist-count">0</span>
        </a>
      </div>

      <!-- أيقونة السلة -->
      <div onclick="openCart()" class="cart-icon-wrapper">
        <span class="cart-icon" style="display:inline-flex;align-items:center;justify-content:center;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 4C7 2.89543 7.89543 2 9 2H15C16.1046 2 17 2.89543 17 4V6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H19L18 20C18 21.1046 17.1046 22 16 22H8C6.89543 22 6 21.1046 6 20L5 8H4C3.44772 8 3 7.55228 3 7C3 6.44772 3.44772 6 4 6H7V4Z"/>
            <path d="M9 2C8.44772 2 8 2.44772 8 3V4H7V3C7 2.44772 7.44772 2 8 2H9Z"/>
            <path d="M15 2C15.5523 2 16 2.44772 16 3V4H17V3C17 2.44772 16.5523 2 16 2H15Z"/>
            <circle cx="9" cy="20" r="1.5"/>
            <circle cx="15" cy="20" r="1.5"/>
          </svg>
        </span>
        <span id="cartCount" class="cart-count"></span>
      </div>

      <!-- زر القائمة للجوال -->
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">☰</button>

    </div>

    <!-- القائمة المنسدلة للجوال -->
    <div id="mobileMenu" class="mobile-menu">
      <a href="#" data-page="home" onclick="go('home'); toggleMobileMenu(); return false;">🏠 الرئيسية</a>
      <a href="#" data-page="products" onclick="go('products'); toggleMobileMenu(); return false;">🛍️ المنتجات</a>
      <a href="#" data-page="brands" onclick="go('brands'); toggleMobileMenu(); return false;">🏷️ الماركات</a>
      <a href="#" data-page="profile" id="mobileProfileLink" onclick="go('profile'); toggleMobileMenu(); return false;" class="mobile-profile-link-header">
        <span class="mobile-profile-icon">👤</span>
        <span class="mobile-profile-name">حسابي</span>
      </a>
      <a href="#" data-page="offers" onclick="go('offers'); toggleMobileMenu(); return false;">🎁 العروض</a>
      <a href="#" data-page="categories" onclick="go('categories'); toggleMobileMenu(); return false;">📂 التصنيفات</a>
      <a href="#" data-page="wishlist" onclick="go('wishlist'); toggleMobileMenu(); return false;" class="wishlist-link">
        <span id="wishlistIconMobile" style="display:inline-flex;align-items:center;justify-content:center;">❤️</span>
        <span id="wishlistCountMobile" class="wishlist-count-mobile">0</span>
      </a>
    </div>

  </div>
</header>

<!-- ========================= قسم التصنيفات ========================= -->
<div class="categories-bar">
  <div class="container">
    <div class="categories">
      <div class="cat" onclick="go('products')">عناية بالبشرة</div>
      <div class="cat" onclick="go('products')">مكياج الوجه</div>
      <div class="cat" onclick="go('products')">مكياج العيون</div>
      <div class="cat" onclick="go('products')">الشفاه</div>
      <div class="cat" onclick="go('products')">العطور</div>
      <div class="cat" onclick="go('products')">العناية الشخصية</div>
      <div class="cat" onclick="go('products')">العروض</div>
    </div>
  </div>
</div>

<!-- ========================= السلة الجانبية (ثابتة) ========================= -->
<!-- خلفية سوداء -->
<div id="cartOverlay" onclick="closeCart()" style="display:none;"></div>
<!-- لوحة السلة -->
<div id="cartPanel">
  <h2 style="color:#8a004a;margin-bottom:10px;">🛒 سلة المشتريات</h2>
  <!-- العناصر -->
  <div id="cartItems" style="flex:1;overflow-y:auto;margin-bottom:10px;"></div>
  <!-- الإجمالي -->
  <div style="font-size:20px;font-weight:800;margin:20px 0;padding:15px;background:linear-gradient(135deg, #fce4ef 0%, #ffeef5 100%);border-radius:12px;color:#8a004a;text-align:center;border:2px solid #f2bfd7;">
    الإجمالي: <span id="cartTotal" style="color:#E91E63;">0</span> ر.س
  </div>
  <!-- أزرار السلة -->
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
    <button onclick="goToCheckout()" style="background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:700;box-shadow:0 4px 12px rgba(233, 30, 99, 0.3);transition:all 0.3s ease;cursor:pointer;">
      إتمام الطلب
    </button>
    <button onclick="closeCart()" style="background:#f5f5f5;color:#666;width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;transition:all 0.3s ease;cursor:pointer;">
      متابعة التسوق
    </button>
  </div>
</div>

<!-- ========================= نظام الصفحات SPA ========================= -->

<div id="app">
<!-- الصفحة الرئيسية -->
<section id="homePage" class="page">
  <div class="container">
    <!-- سلايدر -->
    <div class="slider">
      <img src="https://i.imgur.com/UAp8b9b.jpeg" style="width:100%;height:100%;object-fit:cover;">
    </div>
    <!-- بانرات فوق الماركات -->
    <div id="bannersAboveBrands" class="banners-slider-container" style="margin-bottom:30px;"></div>
    <!-- الماركات -->
    <h2 class="section-title-centered">أشهر الماركات ⭐</h2>
    <div class="brands-wrapper">
      <button class="brand-arrow left" onclick="scrollBrands(-300)">‹</button>
      <div id="brandsSlider" class="brands-slider"></div>
      <button class="brand-arrow right" onclick="scrollBrands(300)">›</button>
    </div>
    <!-- بانرات فوق المنتجات المميزة -->
    <div id="bannersAboveFeatured" class="banners-slider-container" style="margin-bottom:30px;"></div>
    <!-- منتجات مميزة -->
    <h2 class="section-title-with-line">منتجات مختارة ✨</h2>
    <div id="featuredGrid" class="products-grid"></div>
    <!-- بانرات فوق العروض -->
    <div id="bannersAboveOffers" class="banners-slider-container" style="margin-bottom:30px;"></div>
    <!-- عروض -->
    <h2 class="section-title-with-line">عروض خاصة 💗</h2>
    <div id="discountGrid" class="products-grid"></div>
    <button class="more-btn" onclick="go('products')">عرض المزيد</button>
  </div>
</section>

<!-- صفحة المفضّلات -->
<section id="page-wishlist" class="page">
  <div class="container">
    <h2 class="section-title">المفضّلات ❤️</h2>
    <div id="wishlistGrid" class="products-grid"></div>
  </div>
</section>

<!-- صفحة المحتوى القانوني -->
<section id="page-page" class="page">
  <div class="container" style="max-width:900px;margin:0 auto;padding:40px 20px;">
    <div id="pageContentContainer" style="background:#fff;padding:40px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);line-height:1.8;">
      <h1 id="pageContentTitle" style="color:#8a004a;margin-bottom:30px;font-size:32px;font-weight:700;"></h1>
      <div id="pageContentBody" style="color:#555;font-size:16px;"></div>
    </div>
  </div>
</section>

  <!-- كل المنتجات -->
<section id="page-products" class="page">

  <div class="container">

    <h2 class="section-title">كل المنتجات</h2>

    <!-- مربع البحث -->
    <input id="productsSearch"
           placeholder="ابحث عن منتج…"
           style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:15px;"
           oninput="filterProducts()">

    <!-- فلترة حسب الماركة -->
    <select id="brandSelect"
            onchange="filterProducts()"
            style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:20px;">
      <option value="">كل الماركات</option>
    </select>

    <!-- شبكة المنتجات -->
    <div id="productsPageGrid" class="products-grid"></div>

  </div>

</section>


  <!-- تفاصيل المنتج -->
<section id="page-product" class="page">

  <div class="container" id="productDetailsBox" style="min-height:400px;padding:20px;">

    <!-- سيضاف ديناميكياً -->

  </div>

</section>


  <!-- الماركات -->
  <section id="page-brands" class="page">
  <div class="container">

    <h2 class="section-title">الماركات</h2>

    <div id="brandsGrid" 
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;">
    </div>

  </div>
</section>


  <!-- منتجات الماركة -->
<section id="page-brand" class="page">
  <div class="container">
    <h2 class="section-title" id="brandTitle">منتجات الماركة</h2>
    <div id="brandProductsGrid" class="products-grid"></div>
  </div>
</section>


  <!-- السلة / الدفع -->
<section id="page-checkout" class="page">
  <div class="checkout-container">
    <div class="checkout-card">
      <div class="checkout-header">
        <div class="checkout-icon">🛒</div>
        <h2 class="checkout-title">إتمام الطلب</h2>
        <p class="checkout-subtitle">تأكد من صحة بياناتك قبل إتمام الطلب</p>
      </div>

    <!-- بيانات العميل -->
      <div class="checkout-section">
        <h3 class="section-title-small">بيانات العميل</h3>

        <div class="input-group">
          <label class="input-label">اسم العميل</label>
          <input id="co_name" class="modern-input checkout-readonly" readonly placeholder="سيتم ملؤه تلقائياً عند تسجيل الدخول">
        </div>

        <div class="input-group">
          <label class="input-label">رقم الهاتف</label>
          <input id="co_phone" class="modern-input checkout-readonly" readonly placeholder="سيتم ملؤه تلقائياً عند تسجيل الدخول">
        </div>

        <div class="input-group">
          <label class="input-label">رقم آخر للتواصل (اختياري)</label>
          <input id="co_phone2" class="modern-input" type="tel" placeholder="أدخل رقم هاتف آخر">
        </div>

        <div class="input-group">
          <label class="input-label">العنوان</label>
          <input id="co_address" class="modern-input" placeholder="أدخل عنوان التوصيل">
        </div>

        <div class="input-group">
          <label class="input-label">تحديد الموقع الجغرافي</label>
          <button onclick="pickLocation()" class="modern-btn-location">
            <span class="btn-icon">📍</span>
            <span>تحديد الموقع</span>
      </button>
          <input id="co_location" class="modern-input" readonly placeholder="لم يتم اختيار موقع بعد">
          <small class="location-hint">اضغط على الزر أعلاه لتحديد موقعك الجغرافي</small>
        </div>

        <div class="input-group">
          <label class="input-label">ملاحظات إضافية (اختياري)</label>
          <textarea id="co_notes" class="modern-input" style="height:100px;resize:vertical;" placeholder="أضف أي ملاحظات أو تعليمات خاصة للتوصيل"></textarea>
        </div>
    </div>

    <!-- المنتجات + الفاتورة داخل نفس الكرت -->
      <div class="checkout-section" id="checkoutItems"></div>

    <!-- الأزرار -->
      <div class="checkout-actions">
        <button onclick="sendWhatsAppOrder()" class="modern-btn-primary">
          <span>إتمام الطلب عبر واتساب</span>
          <span class="btn-arrow">←</span>
    </button>

        <button onclick="payOnline()" class="modern-btn-secondary checkout-btn-blue">
      الدفع الإلكتروني
    </button>

        <button onclick="go('home')" class="modern-btn-back">
      ◀ متابعة التسوق
    </button>
      </div>
    </div>
  </div>
</section>


<section id="page-track" class="page">

  <div class="track-container">

    <div class="track-title">تتبع الطلب</div>

    <div class="track-info" id="trackInfo">تحميل البيانات...</div>

    <div class="timeline" id="timeline"></div>

    <div class="items-title">الأصناف</div>
    <div id="trackItems"></div>

  </div>

</section>




  <!-- فاتورة العميل-->
<section id="page-thanks" class="page">
  <div class="container" style="max-width:750px;margin:auto;padding:25px;">

    <h2 style="text-align:center;color:#8a004a;font-weight:900;">فاتورة الطلب</h2>

    <div id="invoiceBox" style="
      background:#fff;
      padding:20px;
      border-radius:15px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      margin-top:20px;
    ">
      <p style="text-align:center;color:#777;">جاري تحميل الفاتورة...</p>
    </div>

    <button onclick="printInvoice()" 
      style="display:block;width:100%;margin-top:25px;background:#8a004a;color:white;padding:12px;border:none;border-radius:10px;font-size:18px;">
      🖨 طباعة الفاتورة
    </button>

    <button onclick="go('home')" 
      style="display:block;width:100%;margin-top:15px;background:#E91E63;color:white;padding:12px;border:none;border-radius:10px;font-size:18px;">
      ◀ العودة للرئيسية
    </button>

  </div>
</section>








  <!-- صفحة تسجيل الدخول -->
  <section id="page-login" class="page">
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-icon">🔐</div>
        <h2 class="login-title">مرحباً بعودتك</h2>
        <p class="login-subtitle">سجل دخولك للوصول إلى حسابك</p>
      </div>

      <div class="login-form">
        <div class="input-group">
          <label class="input-label">📱 رقم الجوال</label>
          <input id="loginPhone" 
                 type="tel"
                 placeholder="5xxxxxxxx"
                 class="modern-input"
                 autocomplete="tel">
        </div>

        <div class="input-group">
          <label class="input-label">🔒 كلمة المرور</label>
          <input id="loginPass" 
                 type="password" 
                 placeholder="أدخل كلمة المرور"
                 class="modern-input"
                 autocomplete="current-password">
        </div>

        <div class="forgot-link">
          <a href="#" onclick="go('forgot')">نسيت كلمة المرور؟</a>
        </div>

        <button onclick="doLogin()" class="modern-btn-primary">
          <span>دخول</span>
          <span class="btn-arrow">→</span>
        </button>

        <div id="loginMsg" class="error-message"></div>

        <div class="login-divider">
          <span>أو</span>
        </div>

        <button onclick="go('register')" class="modern-btn-secondary">
          إنشاء حساب جديد
        </button>
      </div>
    </div>
  </div>
</section>
<!-- صفحة نسيان كلمة المرور -->
<section id="page-forgot" class="page">
  <div style="max-width:400px;margin:auto;padding:25px;">
    <h2 class="section-title">استعادة كلمة المرور</h2>

    <label>البريد الإلكتروني</label>
    <input id="fpEmail" type="email"
           placeholder="example@gmail.com"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <button onclick="sendResetCode()"
            style="background:#8a004a;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;">
      إرسال كود الاستعادة
    </button>

    <div id="fpMsg" style="margin-top:15px;color:red;text-align:center;"></div>

    <p style="margin-top:15px;text-align:center;">
      <a href="#" onclick="go('login')" style="color:#E91E63;">العودة لتسجيل الدخول</a>
    </p>
  </div>
</section>
<!-- صفحة إعادة ضبط كلمة المرور -->
<section id="page-reset" class="page">
  <div style="max-width:400px;margin:auto;padding:25px;">

    <h2 class="section-title">إعادة تعيين كلمة المرور</h2>

    <label>البريد الإلكتروني</label>
    <input id="rpEmail" type="email"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <label>كود التحقق</label>
    <input id="rpCode" 
           placeholder="XXXXXX"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <label>كلمة مرور جديدة</label>
    <input id="rpPass" type="password"
           style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:12px;">

    <button onclick="resetPassword()"
            style="background:#8a004a;color:white;width:100%;padding:14px;border:none;border-radius:12px;font-size:17px;">
      حفظ كلمة المرور الجديدة
    </button>

    <div id="rpMsg" style="margin-top:15px;color:red;text-align:center;"></div>

  </div>
</section>
<!-- صفحة تفعيل الحساب -->
<section id="page-verify" class="page">
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <div class="register-icon">🔐</div>
        <h2 class="register-title">تفعيل الحساب</h2>
        <p class="register-subtitle">أدخل كود التفعيل الذي أرسلناه إلى بريدك الإلكتروني</p>
      </div>

      <div class="register-form">
        <div class="input-group">
          <label class="input-label">📱 رقم الجوال</label>
          <div class="phone-input-group">
            <span class="phone-prefix">🇸🇦 +966</span>
    <input id="vPhone"
                   type="tel"
           readonly
                   class="modern-input phone-input"
                   style="background: #f0f0f0; cursor: not-allowed;">
          </div>
        </div>

        <div class="input-group">
          <label class="input-label">🔑 كود التفعيل</label>
          <input id="vCode" 
                 type="text"
                 inputmode="numeric"
                 pattern="[0-9]*"
                 placeholder="أدخل الكود المكون من 6 أرقام"
                 class="modern-input"
                 maxlength="6"
                 style="text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 700;"
                 onkeypress="return /[0-9]/i.test(event.key)"
                 oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>

        <button onclick="verifyAccount()" class="modern-btn-primary">
          <span>تفعيل الحساب</span>
          <span class="btn-arrow">→</span>
    </button>

        <div id="verifyMsg" class="error-message"></div>

        <div class="register-footer" style="text-align: center; margin-top: 20px;">
          <div style="padding: 15px; background: #f8f9fa; border-radius: 12px; margin-bottom: 15px;">
            <span id="resendBox" style="display: inline-block;">
              <a href="#" onclick="resendVerifyCode(); return false;" class="link-primary" style="font-weight: 600;">
                🔄 إعادة إرسال الكود
              </a>
      </span>
            <span id="timerBox" style="display: none; color: #666; font-size: 14px;">
              ⏱️ إعادة الإرسال متاحة خلال <span id="timer" style="font-weight: 700; color: #E91E63;">60</span> ثانية
      </span>
          </div>
          <p style="margin: 0; color: #666; font-size: 14px;">
            لم تستلم الكود؟ تحقق من صندوق الوارد والرسائل غير المرغوب فيها
    </p>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- صفحة إنشاء حساب جديد -->
<!-- صفحة إنشاء حساب جديد -->
<section id="page-register" class="page">
  <div class="register-container">
    <div class="register-card">
      <div class="register-header">
        <div class="register-icon">✨</div>
        <h2 class="register-title">إنشاء حساب جديد</h2>
        <p class="register-subtitle">انضم إلينا وابدأ رحلتك معنا</p>
      </div>

      <div class="register-form">
        <div class="input-group">
          <label class="input-label">👤 الاسم الكامل</label>
          <input id="regName" 
                 type="text"
                 placeholder="أدخل الاسم الكامل"
                 class="modern-input"
                 autocomplete="name">
        </div>

        <div class="input-group">
          <label class="input-label">📱 رقم الجوال</label>
          <div class="phone-input-group">
            <span class="phone-prefix">🇸🇦 +966</span>
            <input id="regPhone" 
                   type="tel"
                   placeholder="05xxxxxxxx أو 5xxxxxxxx"
                   class="modern-input phone-input"
                   autocomplete="tel">
            <span id="regPhoneIcon" class="validation-icon"></span>
          </div>
          <div id="regPhoneMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">📧 البريد الإلكتروني</label>
          <div class="input-with-icon">
          <input id="regEmail" 
                 type="email"
                 placeholder="example@gmail.com"
                 class="modern-input"
                 autocomplete="email">
            <span id="regEmailIcon" class="validation-icon"></span>
          </div>
          <div id="regEmailMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">🔒 كلمة المرور</label>
          <div class="input-with-icon">
          <input id="regPass" 
                 type="password"
                 placeholder="••••••••"
                 class="modern-input"
                 autocomplete="new-password">
            <span id="regPassIcon" class="validation-icon"></span>
          </div>
          <div id="regPassStrength" class="password-strength"></div>
          <div id="regPassMsg" class="validation-message"></div>
        </div>

        <div class="input-group">
          <label class="input-label">🔒 إعادة كلمة المرور</label>
          <input id="regPass2" 
                 type="password"
                 placeholder="أعد إدخال كلمة المرور"
                 class="modern-input"
                 autocomplete="new-password">
        </div>

        <div class="input-group">
          <label class="input-label">📍 العنوان التفصيلي</label>
          <input id="regAddress" 
                 type="text"
                 placeholder="مثال: جدة - حي الحمدانية - شارع سعيد"
                 class="modern-input"
                 autocomplete="street-address">
        </div>

        <button onclick="doRegister()" class="modern-btn-primary">
          <span>إنشاء الحساب</span>
          <span class="btn-arrow">→</span>
        </button>

        <div id="registerMsg" class="error-message"></div>

        <div class="register-footer">
          <p>لديك حساب بالفعل؟ 
            <a href="#" onclick="go('login')" class="link-primary">تسجيل الدخول</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>





  <!-- صفحة حساب المستخدم -->
  <section id="page-profile" class="page">
  <div class="container" style="max-width:900px;margin:0 auto;padding:30px 20px;">
    
    <!-- بطاقة المستخدم -->
    <div style="background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);padding:40px;border-radius:16px;color:#fff;margin-bottom:30px;box-shadow:0 8px 24px rgba(138,0,74,0.3);">
      <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
        <div style="width:100px;height:100px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:48px;backdrop-filter:blur(10px);">
          👤
        </div>
        <div style="flex:1;">
          <h2 id="pName" style="font-size:28px;margin-bottom:10px;font-weight:700;">—</h2>
          <p id="pPhone" style="font-size:16px;opacity:0.9;margin:5px 0;">—</p>
          <p id="pEmail" style="font-size:16px;opacity:0.9;margin:5px 0;">—</p>
          <p id="pAddress" style="font-size:16px;opacity:0.9;margin:5px 0;">—</p>
        </div>
    </div>
  </div>

    <!-- الأزرار -->
    <div style="display:flex;gap:15px;margin-bottom:30px;flex-wrap:wrap;">
      <button onclick="showChangePasswordModal()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(6,95,106,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(6,95,106,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(6,95,106,0.3)'">
        🔒 تغيير كلمة المرور
      </button>
      <button onclick="logoutUser()" style="flex:1;min-width:200px;padding:15px 25px;background:linear-gradient(135deg, #d62828 0%, #b71c1c 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(214,40,40,0.3);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(214,40,40,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(214,40,40,0.3)'">
        🚪 تسجيل الخروج
      </button>
    </div>

    <!-- الطلبات -->
    <h2 class="section-title" style="margin-bottom:20px;">📦 طلباتي</h2>
  <div id="profileOrders"></div>

  </div>

  <!-- نافذة تغيير كلمة المرور -->
  <div id="changePasswordModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;justify-content:center;align-items:center;">
    <div style="background:#fff;padding:40px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <h3 style="color:#8a004a;margin-bottom:25px;font-size:24px;font-weight:700;text-align:center;">🔒 تغيير كلمة المرور</h3>
      
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">كلمة المرور الحالية:</label>
        <input type="password" id="currentPassword" placeholder="أدخل كلمة المرور الحالية" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
</div>

      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">كلمة المرور الجديدة:</label>
        <input type="password" id="newPassword" placeholder="أدخل كلمة المرور الجديدة" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
      </div>

      <div style="margin-bottom:25px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#333;">تأكيد كلمة المرور الجديدة:</label>
        <input type="password" id="confirmPassword" placeholder="أعد إدخال كلمة المرور الجديدة" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:'Cairo',sans-serif;">
      </div>

      <div id="changePasswordMsg" style="margin-bottom:20px;color:#e74c3c;font-size:14px;text-align:center;"></div>

      <div style="display:flex;gap:12px;">
        <button onclick="changePassword()" style="flex:1;padding:12px;background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">تغيير</button>
        <button onclick="hideChangePasswordModal()" style="flex:1;padding:12px;background:#e0e0e0;color:#333;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">إلغاء</button>
      </div>
    </div>
  </div>
</section>

<!-- Modal تسجيل الدخول -->
<div id="loginRequiredModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10001;justify-content:center;align-items:center;backdrop-filter:blur(4px);">
  <div style="background:#fff;padding:40px;border-radius:20px;max-width:450px;width:90%;box-shadow:0 12px 48px rgba(0,0,0,0.3);text-align:center;animation:modalSlideIn 0.3s ease-out;">
    <div style="font-size:64px;margin-bottom:20px;">🔐</div>
    <h3 style="color:#8a004a;margin-bottom:15px;font-size:24px;font-weight:800;">تسجيل الدخول مطلوب</h3>
    <p style="color:#666;margin-bottom:30px;font-size:16px;line-height:1.6;">
      لابد من تسجيل دخول قبل إتمام الطلب<br>
      <span style="color:#999;font-size:14px;">سجل دخولك الآن للمتابعة</span>
    </p>
    
    <div style="display:flex;gap:12px;flex-direction:column;">
      <button onclick="goToLoginFromModal()" style="width:100%;padding:16px;background:linear-gradient(135deg, #E91E63 0%, #c2185b 100%);color:#fff;border:none;border-radius:12px;font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(233, 30, 99, 0.4);transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(233, 30, 99, 0.5)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(233, 30, 99, 0.4)'">
        تسجيل الدخول الآن
      </button>
      <button onclick="closeLoginRequiredModal()" style="width:100%;padding:14px;background:#f5f5f5;color:#666;border:1px solid #e0e0e0;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f5f5f5'">
        إلغاء
      </button>
    </div>
  </div>
</div>

<!-- صفحة العروض -->
<section id="page-offers" class="page">
  <div class="container">
    <h2 class="section-title">💗 عروض خاصة</h2>

    <div id="offersGrid" class="products-grid"></div>

  </div>
</section>

<!-- صفحة التصنيفات -->
<section id="page-categories" class="page">
  <div class="container">

    <h2 class="section-title">التصنيفات</h2>

    <div id="categoriesList" 
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;">
    </div>

  </div>
</section>
<!-- صفحة منتجات التصنيف -->
<section id="page-category" class="page">
  <div class="container">

    <h2 class="section-title" id="categoryTitle"></h2>

    <div id="categoryGrid" class="products-grid"></div>

  </div>
</section>

</div>


<!-- ========================= الفوتر ========================= -->
<footer class="footer" id="mainFooter">
  <div class="footer-container">

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">روابط سريعة</h3>
      <p><a href="#" onclick="go('home'); return false;">الرئيسية</a></p>
      <p><a href="#" onclick="go('products'); return false;">المنتجات</a></p>
      <p><a href="#" onclick="go('brands'); return false;">الماركات</a></p>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">معلومات قانونية</h3>
      <p><a href="#" onclick="go('page', 'privacy'); return false;">📋 سياسة الاستخدام والخصوصية</a></p>
      <p><a href="#" onclick="go('page', 'return'); return false;">🔄 سياسة الاستبدال والارجاع</a></p>
      <p><a href="#" onclick="go('page', 'terms'); return false;">📜 الشروط والأحكام</a></p>
      <p><a href="#" onclick="go('page', 'faq'); return false;">❓ الأسئلة الشائعة</a></p>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">تواصل معنا</h3>
      <p>📞 055-555-5555</p>
      <p>📧 info@beauty.com</p>
      <div id="footerSocialMedia" style="margin-top:15px;display:flex;gap:12px;flex-wrap:wrap;">
        <!-- سيتم تحميل الأيقونات هنا -->
      </div>
    </div>

    <div>
      <h3 style="color:#8a004a;margin-bottom:10px;">الدعم السريع</h3>
      <form id="quickSupportForm" onsubmit="submitComplaint(event)" style="display:flex;flex-direction:column;gap:6px;">
        <input type="email" id="complaintEmail" placeholder="📧 البريد الإلكتروني" required style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;font-family:'Cairo',sans-serif;">
        <input type="text" id="complaintSubject" placeholder="📝 عنوان الشكوى" required style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;font-family:'Cairo',sans-serif;">
        <textarea id="complaintMessage" placeholder="💬 محتوى الشكوى" required rows="3" style="padding:6px;border-radius:6px;border:1px solid #ddd;font-size:13px;resize:vertical;font-family:'Cairo',sans-serif;"></textarea>
        <button type="submit" style="padding:8px;background:#8a004a;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;font-family:'Cairo',sans-serif;">إرسال</button>
      </form>
    </div>

  </div>

  <div class="footer-bottom">
    جميع الحقوق محفوظة © 2025 متجر جمالك
  </div>
</footer>



<!-- ========================= كود SPA Router ========================= -->

<script>
async function loadProductsCache(forceReload = false) {
  if (!window.productsCache || forceReload) {
    const res = await fetch(API + "/api/admin/products");
    window.productsCache = await res.json();
    
    // التأكد من أن جميع المنتجات لديها stock و quantity
    window.productsCache = window.productsCache.map(p => ({
      ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
    }));
  }
}

function safeImageURL(url) {
  if (!url || url.trim() === "" || url.length < 10) {
    return "https://via.placeholder.com/300x300?text=No+Image";
  }

  url = url.trim();

  // Google Drive
  if (url.includes("drive.google.com")) {
    const id = url.match(/[-\w]{25,}/);
    return id ? `https://lh3.googleusercontent.com/d/${id[0]}` : "https://via.placeholder.com/300x300?text=No+Image";
  }

  // Googleusercontent direct image
  if (url.includes("googleusercontent.com")) {
    return url;
  }

  // Full HTTP/HTTPS link
  if (url.startsWith("http://") || url.startsWith("https://")) {
    return url;
  }

  // If it's not a link → return a placeholder
  return "https://via.placeholder.com/300x300?text=No+Image";
}

// ===================== خاصية الزوم على صورة المنتج =====================
function openImageZoom(imageUrl) {
  // إنشاء overlay للزوم
  let overlay = document.getElementById("imageZoomOverlay");
  
  if (!overlay) {
    overlay = document.createElement("div");
    overlay.id = "imageZoomOverlay";
    overlay.innerHTML = `<img id="zoomedImage" src="${imageUrl}" alt="صورة المنتج">`;
    document.body.appendChild(overlay);
    
    // إغلاق عند الضغط في أي مكان
    overlay.onclick = function(e) {
      if (e.target === overlay || e.target.id === "zoomedImage") {
        closeImageZoom();
      }
    };
    
    // إغلاق عند الضغط على ESC
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape" && overlay.style.display === "flex") {
        closeImageZoom();
      }
    });
  } else {
    document.getElementById("zoomedImage").src = imageUrl;
  }
  
  overlay.style.display = "flex";
  document.body.style.overflow = "hidden"; // منع التمرير
}

function closeImageZoom() {
  const overlay = document.getElementById("imageZoomOverlay");
  if (overlay) {
    overlay.style.display = "none";
    document.body.style.overflow = ""; // إعادة التمرير
  }
}



function go(page, data = null, skipHistory = false) {
  // حفظ الصفحة الحالية قبل الانتقال (إلا إذا كان skipHistory = true)
  if(!skipHistory) {
    saveNavigationState(page, data);
    // إضافة حالة جديدة للـ history
    const state = { page, data };
    const url = data ? `#${page}/${data}` : `#${page}`;
    window.history.pushState(state, '', url);
  }
  
  // إخفاء جميع الصفحات
  document.querySelectorAll(".page").forEach(
    p => {
      p.classList.remove("active");
      // إزالة inline style لإفساح المجال للـ CSS
      p.style.removeProperty("display");
    }
  );

  // إظهار الصفحة المطلوبة
  let targetPage = null;
  
  // للصفحة الرئيسية، ابحث عن homePage أولاً
  // أيضاً تعامل مع "homePage" كـ "home" للتوافق
  if (page === "home" || page === "homePage") {
    targetPage = document.getElementById("homePage");
    if (!targetPage) {
      targetPage = document.getElementById("page-home");
    }
  } else {
    targetPage = document.getElementById("page-" + page);
  }
  
  if (targetPage) {
    targetPage.classList.add("active");
    // إزالة inline style إذا كان موجوداً لإفساح المجال للـ CSS
    targetPage.style.removeProperty("display");
    // للتأكد من أن homePage يظهر
    if ((page === "home" || page === "homePage") && targetPage.id === "homePage") {
      console.log("HomePage is now visible", targetPage);
    }
  } else {
    console.warn("Target page not found:", page);
  }

  // تحديث المؤشر النشط في القائمة
  document.querySelectorAll(".nav-links a, .mobile-menu a").forEach(link => {
    link.classList.remove("active");
    if(link.getAttribute("data-page") === page) {
      link.classList.add("active");
    }
  });
  
  // تهيئة التحقق الفوري عند فتح صفحة التسجيل
  if (page === "register") {
    setTimeout(initValidationListeners, 100);
  }

  // تحميل بيانات حسب الصفحة

  if (page === "home" || page === "homePage") {
    // مسح حقول البحث لمنع ملء رقم الهاتف تلقائياً
    const headerSearch = document.getElementById("headerSearch");
    const headerSearchMobile = document.getElementById("headerSearchMobile");
    if(headerSearch) headerSearch.value = "";
    if(headerSearchMobile) headerSearchMobile.value = "";
    
    if(typeof loadHome === 'function') {
      loadHome();
    }
  }
  if (page === "products") {
    if(window.bannerProducts && window.bannerProducts.length > 0){
      // عرض منتجات البانر
      const productIds = window.bannerProducts;
      window.bannerProducts = null; // مسح بعد الاستخدام
      loadAllProducts(productIds);
    } else {
      loadAllProducts();
    }
  }
  if (page === "product") loadProductDetails(data);
  if (page === "brands") loadBrandsList();

  if (page === "brand") {
    window.currentBrand = data;
    loadBrandProducts(data);
  }

  if(page === "checkout") {
    renderCheckoutPage();
    autoFillUserInCheckout();   // ⭐ إضافة مهمة هنا
}


  // ⭐ إصلاح track (مشروط بوجود الصفحة)
  if (page === "track" && document.getElementById("page-track")) {
  loadTrackPage(data);   // ← إرسال رقم الطلب
}


  // ⭐ إصلاح offers (مشروط بوجود الصفحة)
  if (page === "offers" && document.getElementById("page-offers")) {
    loadOffers();
  }

  if (page === "categories") loadCategories();

  if (page === "category") {
    window.currentCategory = data;
    loadCategoryProducts(data);
  }

  if (page === "thanks") {
    loadInvoice(data);   // ← هنا نحمّل الفاتورة
}


  if (page === "wishlist") loadWishlist();

  // ⭐ صفحة حسابي
  if (page === "profile" && typeof loadProfile === "function") {
    loadProfile();
  }

  // ⭐ صفحة المحتوى القانوني
  if (page === "page" && data) {
    loadPageContent(data);
  }

  // تحديث رابط الحساب في الهيدر عند التنقل
  updateHeaderProfile();
  updateWishlistCount();
  
  // تعيين المؤشر النشط للصفحة الحالية
  const activePage = document.querySelector(".page.active");
  if(activePage) {
    const pageId = activePage.id.replace("page-", "");
    document.querySelectorAll(".nav-links a, .mobile-menu a").forEach(link => {
      link.classList.remove("active");
      if(link.getAttribute("data-page") === pageId) {
        link.classList.add("active");
      }
    });
  }
}





const API = "http://localhost:3000";
// تحميل المستخدم من التخزين المحلي بعد فتح الصفحة
window.user = JSON.parse(localStorage.getItem("user") || "null");

// ===================== نظام الإشعارات =====================
function showNotification(message, type = 'warning') {
  const container = document.getElementById("notificationContainer");
  if(!container) return;
  
  const notification = document.createElement("div");
  notification.style.cssText = `
    background: ${type === 'warning' ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : type === 'error' ? 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)' : 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)'};
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    margin-bottom: 12px;
    font-size: 15px;
    font-weight: 500;
    text-align: center;
    animation: slideDown 0.3s ease-out;
    pointer-events: auto;
    position: relative;
    backdrop-filter: blur(10px);
  `;
  
  notification.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      <span style="font-size:20px;">${type === 'warning' ? '⚠️' : type === 'error' ? '❌' : '✅'}</span>
      <span>${message}</span>
    </div>
  `;
  
  // إضافة animation
  if(!document.getElementById("notificationStyles")) {
    const style = document.createElement("style");
    style.id = "notificationStyles";
    style.textContent = `
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  container.appendChild(notification);
  
  // إزالة الإشعار بعد 4 ثواني
  setTimeout(() => {
    notification.style.animation = 'slideUp 0.3s ease-out';
    setTimeout(() => {
      if(notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 4000);
}

// ===================== نظام إدارة سجل التنقل =====================
window.navigationStack = [];

// حفظ الصفحة الحالية قبل الانتقال
function saveNavigationState(page, data = null) {
  const currentPage = document.querySelector(".page.active");
  if(currentPage) {
    // معالجة خاصة للصفحة الرئيسية
    let currentPageId = currentPage.id;
    if(currentPageId === "homePage") {
      currentPageId = "home";
    } else {
      currentPageId = currentPageId.replace("page-", "");
    }
    // فقط نضيف للستاك إذا كانت صفحة مختلفة
    if(currentPageId !== page) {
      // حفظ بيانات الصفحة الحالية إذا كانت مهمة (مثل رقم المنتج)
      let currentData = null;
      if(currentPageId === "product" && window.currentProductId) {
        currentData = window.currentProductId;
      } else if(currentPageId === "brand" && window.currentBrand) {
        currentData = window.currentBrand;
      } else if(currentPageId === "category" && window.currentCategory) {
        currentData = window.currentCategory;
      }
      
      window.navigationStack.push({ page: currentPageId, data: currentData });
      // الاحتفاظ بآخر 20 صفحة فقط
      if(window.navigationStack.length > 20) {
        window.navigationStack.shift();
      }
    }
  }
}

// الرجوع للصفحة السابقة
function goBackToPreviousPage() {
  if(window.navigationStack.length > 0) {
    const previous = window.navigationStack.pop();
    if(previous && previous.page) {
      go(previous.page, previous.data, true); // true = بدون حفظ في السجل
      return true;
    }
  }
  return false;
}

// الاستماع لحدث الرجوع في المتصفح
window.addEventListener('popstate', function(event) {
  if(window.navigationStack.length > 0) {
    const previous = window.navigationStack.pop();
    if(previous && previous.page) {
      go(previous.page, previous.data, true);
    } else {
      go('home', null, true);
    }
  } else {
    // إذا لم توجد صفحة سابقة، الرجوع للصفحة الرئيسية
    go('home', null, true);
  }
});


// ======================= دوال Skeleton Loading =======================
// دالة لإنشاء skeleton cards
function createSkeletonCards(count = 8) {
  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-text short"></div>
        <div class="skeleton-text medium"></div>
        <div class="skeleton-price"></div>
        <div class="skeleton-button"></div>
      </div>
    `;
  }
  return html;
}

// دالة لإنشاء skeleton لصفحة المنتج
function createProductDetailsSkeleton() {
  return `
    <div class="skeleton-product-details">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;align-items:start;">
        <div>
          <div class="skeleton-product-image"></div>
        </div>
        <div>
          <div class="skeleton-product-title"></div>
          <div class="skeleton-product-price"></div>
          <div class="skeleton-product-description"></div>
          <div class="skeleton-product-description"></div>
          <div class="skeleton-product-description"></div>
          <div style="margin-top:30px;width:100%;height:50px;background:linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s ease-in-out infinite;border-radius:14px;"></div>
        </div>
      </div>
    </div>
  `;
}

// ======================= صفحة كل المنتجات =======================
async function loadAllProducts(productIds = null){
  // جلب المنتجات
  const res = await fetch(API + "/api/admin/products");
  const list = await res.json();

  // التأكد من أن جميع المنتجات لديها stock و quantity
  const normalizedList = list.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));

  // حفظها في المتغير العام
  window.allProducts = normalizedList;
  window.productsCache = normalizedList;

  // تعبئة الفلتر (الماركات)
  fillBrandSelect();

  // إذا كانت هناك منتجات محددة من البانر، فلترتها
  let productsToShow = normalizedList;
  if(productIds && Array.isArray(productIds) && productIds.length > 0){
    productsToShow = normalizedList.filter(p => productIds.includes(parseInt(p.id)));
  }

  // عرض المنتجات
  renderProducts(productsToShow);

  // تحديث أزرار السلة
  refreshAllAddToCartButtons();
}



function fillBrandSelect(){
  const sel = document.getElementById("brandSelect");
  sel.innerHTML = '<option value="">كل الماركات</option>';

  // استخراج الماركات بدون تكرار
  let brands = {};
  allProducts.forEach(p => {
    if(p.brand_id && !brands[p.brand_id]){
      brands[p.brand_id] = p.brand_name;
    }
  });

  for(let id in brands){
    sel.innerHTML += `<option value="${id}">${brands[id]}</option>`;
  }
}

function renderProducts(list){
  const grid = document.getElementById("productsPageGrid");
  grid.innerHTML = "";

  if(list.length === 0){
    grid.innerHTML = "<p>لا يوجد منتجات</p>";
    return;
  }

  list.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  refreshAllAddToCartButtons();   // ✔ هنا المكان الصحيح
  
  // تحديث التقييمات بعد عرض المنتجات
  setTimeout(() => {
    updateAllProductRatings();
  }, 100);
}



function filterProducts(){
  const text = document.getElementById("productsSearch").value.toLowerCase();
  const brand = document.getElementById("brandSelect").value;

  let filtered = allProducts.filter(p=>
    (!text || p.name.toLowerCase().includes(text)) &&
    (!brand || p.brand_id == brand)
  );

  renderProducts(filtered);
}
//------------------ صفحة خصم السعر --------------------
function calculateFinalPrice(p){
  const base = parseFloat(p.base_price) || 0;
  const discountValue = parseFloat(p.discount_value) || 0;
  const discountType = p.discount_type || "none";

  let priceAfterDiscount = base;

  // الخصم
  if(discountType === "percent"){
    priceAfterDiscount = base - (base * (discountValue / 100));
  }
  else if(discountType === "fixed"){
    priceAfterDiscount = base - discountValue;
  }

  if(priceAfterDiscount < 0) priceAfterDiscount = 0;

  // الضريبة 15%
  const beforeVat = base * 1.15;
  const finalWithVat = priceAfterDiscount * 1.15;

  return {
    before: beforeVat.toFixed(2),     // السعر قبل الخصم + الضريبة
    final: finalWithVat.toFixed(2),   // السعر بعد الخصم + الضريبة
  };
}

// ======================= دوال التقييمات =======================

// جلب متوسط التقييم للمنتج
async function getProductRating(productId) {
  try {
    const res = await fetch(API + `/api/reviews/${productId}/average`);
    const data = await res.json();
    return {
      average: parseFloat(data.average || 0),
      total: parseInt(data.total || 0)
    };
  } catch (error) {
    return { average: 0, total: 0 };
  }
}

// تحديث النجوم في كارت المنتج
async function updateProductCardRating(productId, ratingElement) {
  const rating = await getProductRating(productId);
  const stars = ratingElement.querySelectorAll('.star');
  const valueSpan = ratingElement.querySelector('.rating-value');
  
  if (valueSpan) {
    valueSpan.textContent = rating.average.toFixed(1);
  }
  
  const fullStars = Math.floor(rating.average);
  const hasHalfStar = rating.average % 1 >= 0.5;
  
  stars.forEach((star, index) => {
    if (index < fullStars) {
      star.innerHTML = '<span style="color:#FFD700;">★</span>';
      star.style.opacity = '1';
    } else if (index === fullStars && hasHalfStar) {
      star.innerHTML = '<span style="color:#FFD700;">★</span>';
      star.style.opacity = '0.5';
    } else {
      star.innerHTML = '<span style="color:#ddd;">★</span>';
      star.style.opacity = '1';
    }
  });
}

// تحديث جميع تقييمات المنتجات في الصفحة
async function updateAllProductRatings() {
  const ratingElements = document.querySelectorAll('.product-rating');
  ratingElements.forEach(async (el) => {
    const productId = el.getAttribute('data-product-id');
    if (productId) {
      await updateProductCardRating(productId, el);
    }
  });
}

// تحميل التقييمات في صفحة المنتج
async function loadProductReviews(productId) {
  const reviewsSection = document.getElementById('productReviewsSection');
  if (!reviewsSection) return;
  
  try {
    // جلب التقييمات والمتوسط
    const [reviewsRes, avgRes] = await Promise.all([
      fetch(API + `/api/reviews/${productId}`),
      fetch(API + `/api/reviews/${productId}/average`)
    ]);
    
    const reviews = await reviewsRes.json();
    const avgData = await avgRes.json();
    const average = parseFloat(avgData.average || 0);
    const total = parseInt(avgData.total || 0);
    
    let html = `
      <div class="reviews-header">
        <h3 class="section-label">التقييمات والمراجعات</h3>
        <div class="reviews-summary">
          <div class="reviews-average">
            <span class="average-rating">${average.toFixed(1)}</span>
            <div class="average-stars">
              ${generateStarsHTML(average)}
            </div>
            <span class="total-reviews">(${total} ${total === 1 ? 'تقييم' : 'تقييمات'})</span>
          </div>
        </div>
      </div>
    `;
    
    // نموذج إضافة تقييم (فقط للمستخدمين المسجلين)
    if (window.user) {
      html += `
        <div class="add-review-section">
          <h4>أضف تقييمك</h4>
          <div class="review-form">
              <div class="rating-input">
              <label>التقييم:</label>
              <div class="star-rating-input">
                ${[5, 4, 3, 2, 1].map(r => `
                  <span class="star-input" data-rating="${r}" onclick="selectRating(${r})" style="color:#FFD700;cursor:pointer;">★</span>
                `).join('')}
              </div>
              <span class="selected-rating-text" id="selectedRatingText">اختر التقييم</span>
            </div>
            <textarea id="reviewComment" class="review-comment-input" placeholder="اكتب تعليقك هنا..."></textarea>
            <button onclick="submitReview(${productId})" class="submit-review-btn">إرسال التقييم</button>
            <div id="reviewMessage" class="review-message"></div>
          </div>
        </div>
      `;
    } else {
      html += `
        <div class="review-login-prompt">
          <p>يجب <a href="#" onclick="go('login'); return false;">تسجيل الدخول</a> وشراء المنتج لإضافة تقييم</p>
        </div>
      `;
    }
    
    // عرض التقييمات المعتمدة
    if (reviews.length > 0) {
      html += `<div class="reviews-list">`;
      reviews.forEach(review => {
        html += `
          <div class="review-item">
            <div class="review-header">
              <div class="review-user">
                <span class="user-initial">${review.user_email.charAt(0).toUpperCase()}</span>
                <div class="user-info">
                  <span class="user-email">${review.user_email}</span>
                  <span class="review-date">${formatDate(review.created_at)}</span>
                </div>
              </div>
              <div class="review-rating" style="display:flex;gap:2px;">
                ${generateStarsHTML(review.rating)}
              </div>
            </div>
            ${review.comment ? `<p class="review-comment">${review.comment}</p>` : ''}
          </div>
        `;
      });
      html += `</div>`;
    } else {
      html += `
        <div class="no-reviews">
          <p>لا توجد تقييمات بعد. كن أول من يقيم هذا المنتج!</p>
        </div>
      `;
    }
    
    reviewsSection.innerHTML = html;
    
    // تهيئة اختيار النجوم
    if (window.user) {
      initStarRating();
    }
    
  } catch (error) {
    console.error('Error loading reviews:', error);
    reviewsSection.innerHTML = '<div class="reviews-error">حدث خطأ في تحميل التقييمات</div>';
  }
}

// توليد HTML للنجوم
function generateStarsHTML(rating) {
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5;
  let html = '';
  
  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      html += '<span class="star-filled" style="color:#FFD700;">★</span>';
    } else if (i === fullStars + 1 && hasHalfStar) {
      html += '<span class="star-half" style="color:#FFD700;opacity:0.5;">★</span>';
    } else {
      html += '<span class="star-empty" style="color:#ddd;">★</span>';
    }
  }
  
  return html;
}

// تهيئة اختيار النجوم
function initStarRating() {
  const starInputs = document.querySelectorAll('.star-input');
  let selectedRating = 0;
  
  starInputs.forEach((star, index) => {
    star.addEventListener('mouseenter', () => {
      const rating = parseInt(star.getAttribute('data-rating'));
      highlightStars(rating);
    });
    
    star.addEventListener('click', () => {
      selectedRating = parseInt(star.getAttribute('data-rating'));
      highlightStars(selectedRating);
      const textEl = document.getElementById('selectedRatingText');
      if (textEl) {
        const texts = ['', 'سيء جداً', 'سيء', 'متوسط', 'جيد', 'ممتاز'];
        textEl.textContent = texts[selectedRating] || 'اختر التقييم';
      }
      window.selectedRating = selectedRating;
    });
  });
  
  const container = document.querySelector('.star-rating-input');
  if (container) {
    container.addEventListener('mouseleave', () => {
      highlightStars(selectedRating);
    });
  }
}

function highlightStars(rating) {
  const starInputs = document.querySelectorAll('.star-input');
  starInputs.forEach((star, index) => {
    const starRating = parseInt(star.getAttribute('data-rating'));
    if (starRating <= rating) {
      star.style.opacity = '1';
      star.style.transform = 'scale(1.1)';
    } else {
      star.style.opacity = '0.3';
      star.style.transform = 'scale(1)';
    }
  });
}

function selectRating(rating) {
  window.selectedRating = rating;
  highlightStars(rating);
  const textEl = document.getElementById('selectedRatingText');
  if (textEl) {
    const texts = ['', 'سيء جداً', 'سيء', 'متوسط', 'جيد', 'ممتاز'];
    textEl.textContent = texts[rating] || 'اختر التقييم';
  }
}

// إرسال التقييم
async function submitReview(productId) {
  if (!window.user) {
    showNotification('يجب تسجيل الدخول أولاً', 'error');
    return;
  }
  
  if (!window.selectedRating || window.selectedRating < 1) {
    showNotification('يرجى اختيار التقييم', 'error');
    return;
  }
  
  const comment = document.getElementById('reviewComment')?.value || '';
  
  try {
    const res = await fetch(API + '/api/reviews', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        product_id: productId,
        rating: window.selectedRating,
        comment: comment,
        user_email: window.user.email,
        user_phone: window.user.phone
      })
    });
    
    const data = await res.json();
    
    if (data.success) {
      showNotification('شكراً لك! سيتم مراجعة تقييمك قبل النشر', 'success');
      document.getElementById('reviewComment').value = '';
      window.selectedRating = 0;
      highlightStars(0);
      document.getElementById('selectedRatingText').textContent = 'اختر التقييم';
      // إعادة تحميل التقييمات في صفحة المنتج
      await loadProductReviews(productId);
      // تحديث تقييم المنتج في جميع الكروت الموجودة في الصفحة
      const allRatingElements = document.querySelectorAll(`.product-rating[data-product-id="${productId}"]`);
      allRatingElements.forEach(async (el) => {
        await updateProductCardRating(productId, el);
      });
    } else {
      showNotification(data.message || 'حدث خطأ في إرسال التقييم', 'error');
    }
  } catch (error) {
    console.error('Error submitting review:', error);
    showNotification('حدث خطأ في إرسال التقييم', 'error');
  }
}

// تنسيق التاريخ
function formatDate(dateString) {
  const date = new Date(dateString);
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ar-SA', options);
}

// ======================= صفحة التفاصيل =======================
// ======================= صفحة التفاصيل =======================
async function loadProductDetails(id) {
  // حفظ معرف المنتج للرجوع
  window.currentProductId = id;

  // ⭐ إصلاح قفز الصفحة للأسفل
  window.scrollTo(0, 0);
  
  // إظهار skeleton loading
  document.getElementById("productDetailsBox").innerHTML = createProductDetailsSkeleton();
  
  const res = await fetch(API + "/api/admin/products");
  const productsList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;

  const p = products.find(x => x.id == id);
  if (!p) {
    document.getElementById("productDetailsBox").innerHTML =
      "<p>❌ المنتج غير موجود</p>";
    return;
  }

  const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  const isOutOfStock = stock <= 0;
  const isFav = wishlist.includes(p.id);

  /* ⭐ حساب الأسعار ⭐ */

  const base = parseFloat(p.base_price) || 0;               // السعر الأساسي بدون ضريبة
  const discountValue = parseFloat(p.discount_value) || 0;  // قيمة الخصم
  const discountType = p.discount_type || "none";           // نوع الخصم

  // تطبيق الخصم
  let afterDiscount = base;
  if (discountType === "percent") {
    afterDiscount = base - (base * (discountValue / 100));
  }
  else if (discountType === "fixed") {
    afterDiscount = base - discountValue;
  }

  if (afterDiscount < 0) afterDiscount = 0;

  // إضافة الضريبة 15%
  const beforeVat = base * 1.15;         // السعر الأساسي + الضريبة
  const afterVat = afterDiscount * 1.15; // السعر بعد الخصم + الضريبة

  /* ⭐ عرض تفاصيل المنتج ⭐ */
  document.getElementById("productDetailsBox").innerHTML = `
    <div class="product-details-container">
      <div class="product-main-content">
        <!-- صورة المنتج مع خاصية الزوم -->
        <div class="product-image-wrapper ${isOutOfStock ? 'out-of-stock-image' : ''}">
          <div class="skeleton-product-image" id="productImageSkeleton"></div>
          <img id="productMainImage" 
               src="${safeImageURL(p.image_url)}"
               onerror="this.src='https://via.placeholder.com/400?text=No+Image'; const skeleton = document.getElementById('productImageSkeleton'); if(skeleton) skeleton.style.display='none'; this.style.display='block';"
               class="product-main-image ${isOutOfStock ? 'grayscale' : ''}"
               onclick="openImageZoom('${safeImageURL(p.image_url)}')"
               alt="${p.name}"
               onload="const skeleton = document.getElementById('productImageSkeleton'); if(skeleton) skeleton.style.display='none'; this.style.display='block';"
               style="display:none;">
          <div class="zoom-hint">🔍 اضغط للتكبير</div>
          <div id="productWishlistBtn" 
               onclick="event.stopPropagation(); toggleWishlist(${p.id});"
               style="
                 position:absolute;
                 top:12px;
                 left:12px;
                 font-size:22px;
                 cursor:pointer;
                 z-index:20;
                 color:${isFav ? '#E91E63' : '#bbb'};
                 background:rgba(255,255,255,0.9);
                 width:36px;
                 height:36px;
                 border-radius:50%;
                 display:flex;
                 align-items:center;
                 justify-content:center;
                 box-shadow:0 2px 8px rgba(0,0,0,0.1);
                 transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
               "
               onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 4px 12px rgba(233, 30, 99, 0.3)'"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
               title="${isFav ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}">
            ❤
          </div>
        </div>

        <!-- بيانات المنتج -->
        <div class="product-info-section">
          <div class="product-header">
            <h1 class="product-title">${p.name}</h1>
            ${p.intl_code ? `
              <div class="product-barcode">
                <span class="barcode-label">الباركود الدولي:</span>
                <span class="barcode-value">${p.intl_code}</span>
              </div>
            ` : ""}
          </div>

          <!-- الأسعار -->
          <div class="product-pricing">
            ${(discountType !== "none" && discountValue > 0) ? `
              <div class="price-before-discount">
                <span class="old-price">${beforeVat.toFixed(2)} ر.س</span>
                <span class="discount-badge">خصم ${discountType === "percent" ? discountValue + "%" : discountValue + " ر.س"}</span>
              </div>
            ` : ""}
            <div class="price-final">
              <span class="price-amount">${afterVat.toFixed(2)}</span>
              <span class="price-currency">ر.س</span>
            </div>
          </div>

          ${(() => {
            const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
            const isOutOfStock = stock <= 0;
            const showStockInfo = stock > 0 && stock <= 6;
            
            return `
              ${showStockInfo ? `
                <div class="product-stock-info">
                  <span class="stock-label">الكمية المتبقية:</span>
                  <span class="stock-value">${stock} حبة</span>
                </div>
              ` : ''}
              
              <!-- زر الإضافة للسلة -->
              <button id="productAddBtn"
                data-id="${p.id}"
                onclick="${isOutOfStock ? 'showNotification(\'عذراً، هذا المنتج غير متوفر حالياً\', \'warning\'); return false;' : `addToCart(${p.id})`}"
                class="product-add-btn ${isOutOfStock ? 'out-of-stock-btn' : ''}"
                ${isOutOfStock ? 'disabled' : ''}>
                <span>${isOutOfStock ? '❌' : '🛒'}</span>
                <span>${isOutOfStock ? 'الكمية منتهية' : 'أضف للسلة'}</span>
              </button>
            `;
          })()}

          <!-- الوصف -->
          <div class="product-description">
            <h3 class="section-label">الوصف</h3>
            <p class="description-text">${p.description || "لا يوجد وصف للمنتج"}</p>
          </div>

          <!-- التقييمات -->
          <div class="product-reviews-section" id="productReviewsSection">
            <div class="reviews-loading">جاري تحميل التقييمات...</div>
          </div>
        </div>
      </div>
    </div>
  `;

  updateProductPageButton(id);
  
  // تحميل التقييمات
  await loadProductReviews(id);

  
  /* ============================================================
   ⭐ إضافة المنتجات المشابهة — سلايدر أفقي ⭐
   ============================================================ */
/* ============================================================
     ⭐ منتجات مشابهة — سلايدر كامل ⭐
   ============================================================ */

let similar = (window.productsCache || [])
  .filter(x => x.category === p.category && x.id != p.id)
  .slice(0, 10); // فقط أول 10 منتجات

if (similar.length > 0) {

  let sliderHTML = `
    <div class="similar-products-section">
      <h2 class="similar-products-title">
        <span>✨</span>
        <span>منتجات مشابهة</span>
      </h2>

      <div class="similar-slider-wrapper">
        <!-- زر السابق -->
        <button id="simPrev" class="slider-nav-btn slider-nav-prev" aria-label="السابق">
          ‹
        </button>

        <!-- السلايدر -->
        <div id="simSlider" class="similar-products-slider">
  `;

  similar.forEach(sp => {
    const prices = calculateFinalPrice(sp);

    sliderHTML += `
      <div class="similar-product-card" onclick="go('product', ${sp.id})">
        <div class="similar-product-image-wrapper">
          <img src="${safeImageURL(sp.image_url)}"
               class="similar-product-image"
               alt="${sp.name}">
          ${sp.discount_value > 0 ? `
            <div class="similar-product-discount">
              خصم ${sp.discount_value}${sp.discount_type === 'percent' ? '%' : ''}
            </div>
          ` : ''}
        </div>
  
        <div class="similar-product-info">
          <h3 class="similar-product-name">${sp.name}</h3>
          
          <div class="similar-product-price">
            ${sp.discount_value > 0 ? `
              <span class="similar-price-old">${prices.before} ر.س</span>
            ` : ''}
            <span class="similar-price-new">${prices.final} ر.س</span>
          </div>
        </div>
      </div>
    `;
  });

  sliderHTML += `
        </div>

        <!-- زر التالي -->
        <button id="simNext" class="slider-nav-btn slider-nav-next" aria-label="التالي">
          ›
        </button>
      </div>
    </div>
  `;

  document.getElementById("productDetailsBox").innerHTML += sliderHTML;

  /* ===== سلوك السلايدر المحسّن - من اليسار لليمين ===== */
  const slider = document.getElementById("simSlider");
  const prevBtn = document.getElementById("simPrev");
  const nextBtn = document.getElementById("simNext");
  
  if (!slider || !prevBtn || !nextBtn) return;

  // التأكد من أن السلايدر يبدأ من اليسار
  slider.style.direction = 'ltr';
  slider.scrollLeft = 0;

  let isScrolling = false;
  const cardWidth = 240; // عرض كل بطاقة + gap (220px + 20px)

  // تحديث حالة الأزرار
  function updateButtons() {
    const maxScroll = slider.scrollWidth - slider.clientWidth;
    prevBtn.style.opacity = slider.scrollLeft <= 10 ? "0.5" : "1";
    prevBtn.style.pointerEvents = slider.scrollLeft <= 10 ? "none" : "auto";
    nextBtn.style.opacity = slider.scrollLeft >= maxScroll - 10 ? "0.5" : "1";
    nextBtn.style.pointerEvents = slider.scrollLeft >= maxScroll - 10 ? "none" : "auto";
  }

  // زر السابق (التحرك لليسار)
  prevBtn.onclick = () => {
    if (isScrolling) return;
    isScrolling = true;
    slider.scrollBy({ left: -cardWidth, behavior: "smooth" });
    setTimeout(() => { 
      isScrolling = false;
      updateButtons();
    }, 500);
  };

  // زر التالي (التحرك لليمين)
  nextBtn.onclick = () => {
    if (isScrolling) return;
    isScrolling = true;
    slider.scrollBy({ left: cardWidth, behavior: "smooth" });
    setTimeout(() => { 
      isScrolling = false;
      updateButtons();
    }, 500);
  };

  // تحديث الأزرار عند التمرير
  slider.addEventListener('scroll', () => {
    updateButtons();
  });

  // تحديث الأزرار عند التحميل
  updateButtons();
}


}



async function loadBrandsList(){
  const res = await fetch(API + "/api/admin/brands");
  const brands = await res.json();

  const grid = document.getElementById("brandsGrid");
  grid.innerHTML = "";

  brands.forEach(b=>{
    grid.innerHTML += `
      <div class="brand-box" onclick="go('brand', ${b.id})">
        <div class="brand-circle">
          <img src="${b.image_url || 'https://via.placeholder.com/100'}">
        </div>
        <div class="brand-name">${b.name}</div>
      </div>
    `;
  });
}

async function loadBrandProducts(brand_id){
  const res = await fetch(API + "/api/admin/products");
  const allList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const all = allList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = all;

  const list = all.filter(p => p.brand_id == brand_id);

  const brand = list.length ? list[0].brand_name : "ماركة";
  document.getElementById("brandTitle").innerText = brand;

  const grid = document.getElementById("brandProductsGrid");
  grid.innerHTML = "";

  list.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  // ⭐ الحل هنا
  refreshAllAddToCartButtons();
}

function loadCheckout(){
  const box = document.getElementById("checkoutItems");
  box.innerHTML = "";

  let total = 0;

  cart.forEach(item=>{
    let t = item.qty * item.price;
    total += t;

    box.innerHTML += `
      <div style="padding:10px 0;border-bottom:1px solid #eee;">
        ${item.name}  
        <br>
        الكمية: ${item.qty} × ${item.price} = ${t.toFixed(2)} ر.س
      </div>
    `;
  });

  document.getElementById("checkoutTotal").innerText = total.toFixed(2);
}

// إرسال الطلب للباك اند
async function confirmOrder(){
  const name = checkoutName.value.trim();
  const phone = checkoutPhone.value.trim();

  if(!name || !phone){
    alert("الرجاء إدخال الاسم ورقم الجوال");
    return;
  }

const body = {
    customer_name: window.user.name,
    customer_phone: window.user.phone,   // ⭐ مهم جداً — الرقم يأتي من حساب المستخدم فقط
    customer_phone2: phone,               // الرقم الذي يدخله العميل في الفورم (رقم ثانوي)
    customer_address: document.getElementById("co_address").value.trim(),
    customer_location: document.getElementById("co_location").value.trim(),
    customer_notes: document.getElementById("co_notes").value.trim(),

    items: cart.map(item => ({
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: item.base_price,
        discount_value: window.productsCache.find(p => p.id == item.id)?.discount_value || 0,
        discount_type: window.productsCache.find(p => p.id == item.id)?.discount_type || "none"
    }))
};




  const res = await fetch(API + "/api/orders", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if(data.success){
    // تحديث المخزون في productsCache بعد إتمام الطلب
    if (window.productsCache) {
      cart.forEach(item => {
        const product = window.productsCache.find(p => p.id == item.id);
        if (product) {
          const currentStock = parseInt(product.stock || product.quantity || product.stock_qty || 0);
          const newStock = Math.max(0, currentStock - item.qty);
          product.stock = newStock;
          product.quantity = newStock;
          product.stock_qty = newStock; // للتوافق مع الكود القديم
        }
      });
    }
    
    cart = [];
    saveCart();
    updateCartIcon();
    go("thanks", data.order_id);
  }
}


async function trackOrder(){
  const id = trackInput.value.trim();
  if(!id) return;

  const res = await fetch(API + "/api/orders/" + id);
  const data = await res.json();

  const box = document.getElementById("trackResult");

  if(data.error){
    box.innerHTML = "❌ الطلب غير موجود";
    return;
  }

  box.innerHTML = `
    <p>الاسم: ${data.order.customer_name}</p>
    <p>الهاتف: ${data.order.customer_phone}</p>
    <p>الحالة: <b>${data.order.status}</b></p>
    <p>الإجمالي: ${data.order.total} ر.س</p>
  `;
}
async function doLogin(){
  let phone = loginPhone.value.trim();
  const pass = loginPass.value.trim();

  phone = phone.replace(/\s+/g, "");

  if (phone.startsWith("0")) phone = phone.substring(1);
  if (phone.startsWith("966")) phone = phone.substring(3);
  if (phone.startsWith("00966")) phone = phone.substring(5);

  const res = await fetch(API + "/api/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone, password: pass })
  });

  const data = await res.json();

  if(!data.success){
    loginMsg.innerText = "❌ " + data.message;
    loginMsg.style.color = "#e74c3c";
    return;
  }
  
  // مسح رسالة الخطأ عند النجاح
  loginMsg.innerText = "";

  window.user = data.user;
  localStorage.setItem("user", JSON.stringify(data.user));
  updateHeaderProfile(); // تحديث رابط الحساب في الهيدر
  go("profile");
}


async function doRegister(){

  const name = regName.value.trim();
  let phone = regPhone.value.trim();
  const email = regEmail.value.trim();
  const pass = regPass.value.trim();
  const pass2 = regPass2.value.trim();
  const address = regAddress.value.trim();

  // التحقق
  if(!name || !phone || !email || !pass || !pass2 || !address){
    registerMsg.innerText = "❌ الرجاء إدخال جميع البيانات";
    return;
  }

  // تنظيف رقم الهاتف - قبول 0 أو بدون 0
  phone = phone.replace(/\s+/g, "");
if (phone.startsWith("0")) phone = phone.substring(1);
if (phone.startsWith("966")) phone = phone.substring(3);
if (phone.startsWith("00966")) phone = phone.substring(5);

if(!phone.match(/^5\d{8}$/)){
  registerMsg.innerText = "❌ رقم الجوال يجب أن يبدأ بـ 5 وطوله 9 أرقام";
  return;
}

  // تحسين كلمة المرور - على الأقل 8 أحرف
  if(pass.length < 8){
    registerMsg.innerText = "❌ كلمة المرور يجب أن تكون 8 أحرف على الأقل";
    return;
  }

  if(pass !== pass2){
    registerMsg.innerText = "❌ كلمة المرور غير متطابقة";
    return;
  }

  try {
    const res = await fetch(API + "/api/register", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      name,
      phone,
      email,
      password: pass,
      address
    })
  });

    if (!res.ok) {
      throw new Error("Network error");
    }

  const data = await res.json();

  if(!data.success){
    registerMsg.innerText = "❌ " + data.message;
    registerMsg.style.color = "#e74c3c";
    return;
  }

  registerMsg.innerHTML = "✔ تم إنشاء الحساب — تم إرسال كود التفعيل";
  registerMsg.style.color = "#4caf50";

  // حفظ الهاتف لصفحة التفعيل
  document.getElementById("vPhone").value = phone;

  // تشغيل المؤقت
  startVerifyTimer();

  // الذهاب لصفحة التفعيل
  go("verify");
  } catch (error) {
    registerMsg.innerText = "❌ حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.";
    registerMsg.style.color = "#e74c3c";
    console.error("Registration error:", error);
  }
}

// التحقق الفوري من الإيميل
let emailCheckTimeout;
async function checkEmail(email) {
  const emailIcon = document.getElementById("regEmailIcon");
  const emailMsg = document.getElementById("regEmailMsg");
  
  if (!email || !email.includes("@") || !email.includes(".")) {
    emailIcon.classList.remove("show", "valid", "invalid");
    emailMsg.textContent = "";
    return;
  }
  
  clearTimeout(emailCheckTimeout);
  emailCheckTimeout = setTimeout(async () => {
    try {
      const res = await fetch(API + "/api/check-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      
      if (!res.ok) {
        throw new Error("Network error");
      }
      
      const data = await res.json();
      
      if (data.exists) {
        emailIcon.classList.add("show", "invalid");
        emailIcon.classList.remove("valid");
        emailMsg.textContent = "❌ هذا الإيميل مسجل مسبقاً";
        emailMsg.className = "validation-message error";
      } else {
        emailIcon.classList.add("show", "valid");
        emailIcon.classList.remove("invalid");
        emailMsg.textContent = "✓ الإيميل متاح";
        emailMsg.className = "validation-message success";
      }
    } catch (error) {
      // في حالة الخطأ، لا نعرض أي شيء
      emailIcon.classList.remove("show", "valid", "invalid");
      emailMsg.textContent = "";
    }
  }, 500);
}

// التحقق الفوري من رقم الجوال
let phoneCheckTimeout;
async function checkPhone(phone) {
  const phoneIcon = document.getElementById("regPhoneIcon");
  const phoneMsg = document.getElementById("regPhoneMsg");
  
  let cleanPhone = phone.replace(/\s+/g, "");
  if (cleanPhone.startsWith("0")) cleanPhone = cleanPhone.substring(1);
  if (cleanPhone.startsWith("966")) cleanPhone = cleanPhone.substring(3);
  if (cleanPhone.startsWith("00966")) cleanPhone = cleanPhone.substring(5);
  
  if (!cleanPhone || !cleanPhone.match(/^5\d{8}$/)) {
    phoneIcon.classList.remove("show", "valid", "invalid");
    phoneMsg.textContent = "";
    return;
  }
  
  clearTimeout(phoneCheckTimeout);
  phoneCheckTimeout = setTimeout(async () => {
    try {
      const res = await fetch(API + "/api/check-phone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: cleanPhone })
      });
      
      if (!res.ok) {
        throw new Error("Network error");
      }
      
      const data = await res.json();
      
      if (data.exists) {
        phoneIcon.classList.add("show", "invalid");
        phoneIcon.classList.remove("valid");
        phoneMsg.textContent = "❌ هذا الرقم مسجل مسبقاً";
        phoneMsg.className = "validation-message error";
      } else {
        phoneIcon.classList.add("show", "valid");
        phoneIcon.classList.remove("invalid");
        phoneMsg.textContent = "✓ الرقم متاح";
        phoneMsg.className = "validation-message success";
      }
    } catch (error) {
      // في حالة الخطأ، لا نعرض أي شيء
      phoneIcon.classList.remove("show", "valid", "invalid");
      phoneMsg.textContent = "";
    }
  }, 500);
}

// تحسين كلمة المرور
function checkPasswordStrength(password) {
  const strengthBar = document.getElementById("regPassStrength");
  const passMsg = document.getElementById("regPassMsg");
  const passIcon = document.getElementById("regPassIcon");
  
  if (!password) {
    strengthBar.innerHTML = "";
    passMsg.textContent = "";
    passIcon.classList.remove("show", "valid", "invalid");
    return;
  }
  
  let strength = 0;
  let feedback = [];
  
  if (password.length >= 8) strength++;
  else feedback.push("8 أحرف على الأقل");
  
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^a-zA-Z0-9]/.test(password)) strength++;
  
  let strengthClass = "weak";
  let strengthText = "ضعيفة";
  
  if (strength >= 4) {
    strengthClass = "strong";
    strengthText = "قوية";
    passIcon.classList.add("show", "valid");
    passIcon.classList.remove("invalid");
    passMsg.textContent = "✓ كلمة مرور قوية";
    passMsg.className = "validation-message success";
  } else if (strength >= 2) {
    strengthClass = "medium";
    strengthText = "متوسطة";
    passIcon.classList.remove("show", "valid", "invalid");
    passMsg.textContent = "كلمة المرور متوسطة - أضف أرقام ورموز لزيادة القوة";
    passMsg.className = "validation-message";
  } else {
    passIcon.classList.remove("show", "valid", "invalid");
    passMsg.textContent = feedback.length > 0 ? feedback.join("، ") : "كلمة المرور ضعيفة";
    passMsg.className = "validation-message error";
  }
  
  strengthBar.innerHTML = `<div class="password-strength-bar ${strengthClass}"></div>`;
}

// تهيئة التحقق الفوري عند تحميل الصفحة
function initValidationListeners() {
  const regEmail = document.getElementById("regEmail");
  const regPhone = document.getElementById("regPhone");
  const regPass = document.getElementById("regPass");
  
  if (regEmail) {
    regEmail.addEventListener("input", (e) => checkEmail(e.target.value));
  }
  
  if (regPhone) {
    regPhone.addEventListener("input", (e) => checkPhone(e.target.value));
  }
  
  if (regPass) {
    regPass.addEventListener("input", (e) => checkPasswordStrength(e.target.value));
  }
}

// تهيئة عند تحميل DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initValidationListeners);
} else {
  initValidationListeners();
}

async function loadProfile() {

  if (!window.user) {
    go("login");
    return;
  }

  // تعبئة بيانات العميل
  document.getElementById("pName").innerText = window.user.name || "—";
  document.getElementById("pPhone").innerText = "📱 " + (window.user.phone || "—");
  document.getElementById("pEmail").innerText = "📧 " + (window.user.email || "—");
  document.getElementById("pAddress").innerText = "📍 " + (window.user.address || "—");

  // جلب الطلبات
  const orders = await fetchUserOrders(window.user.phone);

  let html = "";

  if (orders.length === 0) {
    html = `<p style="text-align:center;color:#777;margin-top:20px;">لا توجد طلبات حتى الآن</p>`;
  } else {
    orders.forEach(o => {
      
      let st = "";
      if (o.status === "new") st = "st-new";
      else if (o.status === "preparing") st = "st-preparing";
      else if (o.status === "completed") st = "st-completed";
      else if (o.status === "out") st = "st-out";
      else if (o.status === "cancelled") st = "st-cancelled";

      html += `
      <div class="order-box">
        <p><b>رقم الطلب:</b> ${o.id}</p>
        <p><b>التاريخ:</b> ${o.date}</p>
        <p><b>الإجمالي:</b> ${safeNum(o.total_with_shipping || o.total)} ر.س</p>
        <p><span class="status-badge ${st}">${o.status}</span></p>
        <button onclick="go('track', ${o.id})" 
                style="margin-top:10px;background:#7a004b;color:white;border:none;padding:7px 12px;border-radius:6px;cursor:pointer;">
          تتبع الطلب
        </button>
      </div>
      `;
    });
  }

  document.getElementById("profileOrders").innerHTML = html;
}

function safeNum(n){
  return (!n || isNaN(n)) ? "0.00" : Number(n).toFixed(2);
}

// ===================== تغيير كلمة المرور =====================
function showChangePasswordModal(){
  document.getElementById("changePasswordModal").style.display = "flex";
  document.getElementById("currentPassword").value = "";
  document.getElementById("newPassword").value = "";
  document.getElementById("confirmPassword").value = "";
  document.getElementById("changePasswordMsg").innerText = "";
}

function hideChangePasswordModal(){
  document.getElementById("changePasswordModal").style.display = "none";
}

async function changePassword(){
  const currentPassword = document.getElementById("currentPassword").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();
  const confirmPassword = document.getElementById("confirmPassword").value.trim();
  const msgBox = document.getElementById("changePasswordMsg");
  
  if(!currentPassword || !newPassword || !confirmPassword){
    msgBox.innerText = "⚠️ يرجى ملء جميع الحقول";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  if(newPassword !== confirmPassword){
    msgBox.innerText = "⚠️ كلمة المرور الجديدة غير متطابقة";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  if(newPassword.length < 6){
    msgBox.innerText = "⚠️ كلمة المرور يجب أن تكون 6 أحرف على الأقل";
    msgBox.style.color = "#e74c3c";
    return;
  }
  
  try {
    const res = await fetch(API + "/api/change-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone: window.user.phone,
        current_password: currentPassword,
        new_password: newPassword
      })
    });
    
    const data = await res.json();
    
    if(data.success){
      msgBox.innerText = "✅ تم تغيير كلمة المرور بنجاح!";
      msgBox.style.color = "#28a745";
      setTimeout(() => {
        hideChangePasswordModal();
        alert("✅ تم تغيير كلمة المرور بنجاح!");
      }, 1500);
    } else {
      msgBox.innerText = "❌ " + (data.message || "حدث خطأ أثناء تغيير كلمة المرور");
      msgBox.style.color = "#e74c3c";
    }
  } catch (error) {
    console.error("خطأ:", error);
    msgBox.innerText = "❌ حدث خطأ في الاتصال بالسيرفر";
    msgBox.style.color = "#e74c3c";
  }
}

// إغلاق النافذة عند الضغط خارجها
document.addEventListener('click', function(event) {
  const modal = document.getElementById("changePasswordModal");
  if (event.target === modal) {
    hideChangePasswordModal();
  }
});



async function loadHome(){
  try {
    // البحث في homePage أولاً، ثم page-home
    const homePage = document.getElementById("homePage");
    const pageHome = document.getElementById("page-home");
    const container = homePage || pageHome;
    
    // لا حاجة لإضافة active هنا - go() سيتولى ذلك
    
    const featuredGrid = document.getElementById("featuredGrid");
    const discountGrid = document.getElementById("discountGrid");
    
    // التحقق من وجود العناصر
    if (!featuredGrid) console.warn("featuredGrid not found!");
    if (!discountGrid) console.warn("discountGrid not found!");

  // تحميل الماركات
  const brandsRes = await fetch(API + "/api/admin/brands");
    if(!brandsRes.ok) throw new Error("Failed to load brands");
  const brands = await brandsRes.json();

  // تحميل المنتجات
  const prodRes = await fetch(API + "/api/admin/products");
    if(!prodRes.ok) throw new Error("Failed to load products");
  const productsList = await prodRes.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;
    
    // تحميل البانرات
    try {
      await loadBanners();
    } catch(e) {
      console.error("Error loading banners:", e);
    }

  // ==================== الماركات المميزة ====================
  const slider = document.getElementById("brandsSlider");
    if(slider) {
  slider.innerHTML = "";

      const featuredBrands = brands.filter(b => b.featured == 1);
      
      if(featuredBrands.length > 0) {
        // إضافة نسخ للماركات للـ infinite loop
        const brandsToShow = [...featuredBrands, ...featuredBrands, ...featuredBrands];
        
        brandsToShow.forEach((b, index) => {
      slider.innerHTML += `
            <div class="brand-box" data-brand-index="${index}" onclick="go('brand', ${b.id})">
          <div class="brand-circle">
            <img src="${b.image_url || 'https://via.placeholder.com/120'}">
          </div>
          <div class="brand-name">${b.name}</div>
        </div>
      `;
    });
        
        // تهيئة السلايدر التلقائي بعد تحميل الماركات
        setTimeout(() => {
          try {
            initBrandsAutoSlider();
            updateBrandsVisibility();
          } catch(e) {
            console.error("Error initializing brands slider:", e);
          }
        }, 500);
      }
    }

  // ==================== المنتجات المميزة ====================
    if(featuredGrid) {
  featuredGrid.innerHTML = "";

      const featuredProducts = products.filter(p => p.featured == 1);
      if(featuredProducts.length > 0) {
        featuredProducts.slice(0, 12).forEach(p => {
          try {
      featuredGrid.innerHTML += makeProductCard(p);
          } catch(e) {
            console.error("Error creating product card:", e);
          }
    });
      } else {
        featuredGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">لا توجد منتجات مميزة حالياً</p>';
      }
    }

  // ==================== العروض (خصومات) ====================
    if(discountGrid) {
  discountGrid.innerHTML = "";

      const discountProducts = products.filter(p => p.discount_value > 0);
      if(discountProducts.length > 0) {
        discountProducts.slice(0, 12).forEach(p => {
          try {
      discountGrid.innerHTML += makeProductCard(p);
          } catch(e) {
            console.error("Error creating product card:", e);
          }
    });
      } else {
        discountGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#666;">لا توجد عروض حالياً</p>';
      }
    }
	
  // تحديث الأزرار بعد إعادة بناء الصفحة
    try {
  refreshAllAddToCartButtons();
      // تحديث التقييمات بعد تحميل المنتجات
      setTimeout(() => {
        updateAllProductRatings();
      }, 200);
    } catch(e) {
      console.error("Error refreshing buttons:", e);
    }
  } catch(error) {
    console.error("Error in loadHome:", error);
    const featuredGrid = document.getElementById("featuredGrid");
    const discountGrid = document.getElementById("discountGrid");
    if(featuredGrid) {
      featuredGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#e74c3c;">حدث خطأ في تحميل المنتجات</p>';
    }
    if(discountGrid) {
      discountGrid.innerHTML = '<p style="text-align:center;padding:20px;color:#e74c3c;">حدث خطأ في تحميل العروض</p>';
    }
  }
}

// دالة إنشاء skeleton cards
function generateSkeletonCards(count) {
  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div class="skeleton-card">
        <div class="skeleton-image"></div>
        <div class="skeleton-title"></div>
        <div class="skeleton-title-small"></div>
        <div class="skeleton-price"></div>
      </div>
    `;
  }
  return html;
}

// ===================== تحميل وعرض البانرات =====================
async function loadBanners(){
  const positions = [
    { key: 'above_brands', id: 'bannersAboveBrands' },
    { key: 'above_featured', id: 'bannersAboveFeatured' },
    { key: 'above_offers', id: 'bannersAboveOffers' }
  ];
  
  for(const pos of positions){
    try {
      const res = await fetch(API + "/api/banners/" + pos.key);
      const banners = await res.json();
      
      if(banners.error || !Array.isArray(banners)){
        continue;
      }
      
      const container = document.getElementById(pos.id);
      if(!container){
        console.warn(`Container ${pos.id} not found`);
        continue;
      }
      
      if(banners.length === 0){
        container.innerHTML = "";
        continue;
      }
      
      renderBannerSlider(pos.id, pos.key, banners);
    } catch (error) {
      console.error(`Error loading banners for ${pos.key}:`, error);
    }
  }
}

function renderBannerSlider(containerId, position, banners){
  const container = document.getElementById(containerId);
  
  if(!container){
    console.warn(`Container ${containerId} not found`);
    return;
  }
  
  if(banners.length === 0){
    container.innerHTML = "";
    return;
  }
  
  // استخدام containerId كمعرف فريد بدلاً من position
  const sliderId = containerId.replace('banners', 'slider');
  
  let html = `
    <div class="banners-slider-wrapper" id="bannerSlider_${sliderId}">
      <div class="banners-slider" id="bannerSliderInner_${sliderId}">
  `;
  
  banners.forEach((banner, index) => {
    let productIds = [];
    try {
      productIds = JSON.parse(banner.product_ids || "[]");
    } catch(e) {
      productIds = [];
    }
    
    const productIdsStr = productIds.join(',');
    
    html += `
      <div class="banner-slide" onclick="handleBannerClick('${productIdsStr}')">
        <img src="${banner.desktop_image}" class="banner-slide-desktop" alt="${banner.title}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%221200%22 height=%22400%22%3E%3Crect fill=%22%238a004a%22 width=%221200%22 height=%22400%22/%3E%3Ctext fill=%22%23fff%22 font-family=%22Arial%22 font-size=%2240%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EBanner%3C/text%3E%3C/svg%3E'">
        <img src="${banner.mobile_image}" class="banner-slide-mobile" alt="${banner.title}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%238a004a%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23fff%22 font-family=%22Arial%22 font-size=%2230%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EBanner%3C/text%3E%3C/svg%3E'">
      </div>
    `;
  });
  
  html += `
      </div>
      ${banners.length > 1 ? `
        <div class="banner-slider-dots" id="bannerDots_${sliderId}">
          ${banners.map((_, i) => `<span class="banner-dot ${i === 0 ? 'active' : ''}" onclick="bannerGoTo('${sliderId}', ${i})" onmouseenter="pauseBannerAutoSlide('${sliderId}')" onmouseleave="resumeBannerAutoSlide('${sliderId}')"></span>`).join('')}
        </div>
      ` : ''}
    </div>
  `;
  
  container.innerHTML = html;
  
  // إضافة swipe gestures للجوال
  if(banners.length > 1){
    initBannerSwipe(sliderId, banners.length);
    startBannerAutoSlide(sliderId, banners.length);
  }
}

let bannerIntervals = {};
let bannerPaused = {};
let bannerCurrentIndex = {};

function startBannerAutoSlide(sliderId, count){
  if(bannerIntervals[sliderId]){
    clearInterval(bannerIntervals[sliderId]);
  }
  
  if(!bannerCurrentIndex[sliderId]){
    bannerCurrentIndex[sliderId] = 0;
  }
  
  bannerIntervals[sliderId] = setInterval(() => {
    if(bannerPaused[sliderId]) return;
    
    bannerCurrentIndex[sliderId] = (bannerCurrentIndex[sliderId] + 1) % count;
    bannerGoTo(sliderId, bannerCurrentIndex[sliderId], true);
  }, 5000); // تغيير كل 5 ثواني
}

function pauseBannerAutoSlide(sliderId){
  bannerPaused[sliderId] = true;
}

function resumeBannerAutoSlide(sliderId){
  bannerPaused[sliderId] = false;
}

function bannerSlide(sliderId, direction){
  const slider = document.getElementById(`bannerSliderInner_${sliderId}`);
  if(!slider) return;
  
  const banners = slider.querySelectorAll('.banner-slide');
  const count = banners.length;
  if(count === 0) return;
  
  if(!bannerCurrentIndex[sliderId]){
    bannerCurrentIndex[sliderId] = 0;
  }
  
  // حساب الفهرس الجديد مع التدوير الدائري
  let newIndex = bannerCurrentIndex[sliderId] + direction;
  if(newIndex < 0) newIndex = count - 1;
  if(newIndex >= count) newIndex = 0;
  
  bannerCurrentIndex[sliderId] = newIndex;
  bannerGoTo(sliderId, newIndex, true);
}

function bannerGoTo(sliderId, index, isAuto = false){
  const slider = document.getElementById(`bannerSliderInner_${sliderId}`);
  if(!slider) return;
  
  const banners = slider.querySelectorAll('.banner-slide');
  const count = banners.length;
  if(count === 0) return;
  
  // التأكد من أن الفهرس صحيح
  if(index < 0) index = count - 1;
  if(index >= count) index = 0;
  
  bannerCurrentIndex[sliderId] = index;
  
  const slideWidth = slider.offsetWidth;
  slider.scrollTo({
    left: index * slideWidth,
    behavior: 'smooth'
  });
  
  updateBannerDots(sliderId, index);
  
  // إعادة تشغيل السلايدر التلقائي إذا لم يكن تلقائياً
  if(!isAuto && count > 1){
    startBannerAutoSlide(sliderId, count);
  }
}

function updateBannerDots(sliderId, activeIndex){
  const dots = document.querySelectorAll(`#bannerDots_${sliderId} .banner-dot`);
  dots.forEach((dot, index) => {
    dot.classList.toggle('active', index === activeIndex);
  });
}

// إضافة swipe gestures للجوال
function initBannerSwipe(sliderId, count){
  const slider = document.getElementById(`bannerSliderInner_${sliderId}`);
  if(!slider) return;
  
  let startX = 0;
  let startY = 0;
  let isDown = false;
  
  slider.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isDown = true;
    pauseBannerAutoSlide(sliderId);
  });
  
  slider.addEventListener('touchmove', (e) => {
    if(!isDown) return;
    e.preventDefault();
  });
  
  slider.addEventListener('touchend', (e) => {
    if(!isDown) return;
    isDown = false;
    
    const endX = e.changedTouches[0].clientX;
    const endY = e.changedTouches[0].clientY;
    const diffX = startX - endX;
    const diffY = startY - endY;
    
    // التأكد من أن الحركة أفقية أكثر من عمودية
    if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50){
      if(diffX > 0){
        // swipe left - next
        bannerSlide(sliderId, 1);
      } else {
        // swipe right - prev
        bannerSlide(sliderId, -1);
      }
    }
    
    setTimeout(() => {
      resumeBannerAutoSlide(sliderId);
    }, 2000);
  });
  
  // إضافة دعم الماوس للكمبيوتر
  slider.addEventListener('mousedown', (e) => {
    startX = e.clientX;
    startY = e.clientY;
    isDown = true;
    pauseBannerAutoSlide(sliderId);
    e.preventDefault();
  });
  
  slider.addEventListener('mousemove', (e) => {
    if(!isDown) return;
    e.preventDefault();
  });
  
  slider.addEventListener('mouseup', (e) => {
    if(!isDown) return;
    isDown = false;
    
    const endX = e.clientX;
    const endY = e.clientY;
    const diffX = startX - endX;
    const diffY = startY - endY;
    
    if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50){
      if(diffX > 0){
        bannerSlide(sliderId, 1);
      } else {
        bannerSlide(sliderId, -1);
      }
    }
    
    setTimeout(() => {
      resumeBannerAutoSlide(sliderId);
    }, 2000);
  });
  
  slider.addEventListener('mouseleave', () => {
    isDown = false;
    resumeBannerAutoSlide(sliderId);
  });
}

function handleBannerClick(productIdsStr){
  if(!productIdsStr || productIdsStr.trim() === ''){
    go('products');
    return;
  }
  
  const productIds = productIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
  
  if(productIds.length === 0){
    go('products');
    return;
  }
  
  // حفظ المنتجات المحددة في متغير عام
  window.bannerProducts = productIds;
  
  // عرض المنتجات المحددة
  go('products');
}
function makeProductCard(p){
  const wishlistArray = wishlist || JSON.parse(localStorage.getItem("wishlist") || "[]");
  const isFav = wishlistArray.includes(p.id);
  const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  const isOutOfStock = stock <= 0;
  const showStockBadge = stock > 0 && stock <= 6;

  return `
    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" style="position:relative;" onclick="go('product', ${p.id})">

      <!-- زر القلب في أعلى الكارت -->
      <div onclick="event.stopPropagation(); toggleWishlist(${p.id});"
           style="
             position:absolute;
             top:12px;
             left:12px;
             font-size:22px;
             cursor:pointer;
             z-index:20;
             color:${isFav ? '#E91E63' : '#bbb'};
             background:rgba(255,255,255,0.9);
             width:36px;
             height:36px;
             border-radius:50%;
             display:flex;
             align-items:center;
             justify-content:center;
             box-shadow:0 2px 8px rgba(0,0,0,0.1);
             transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
           "
           onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 4px 12px rgba(233, 30, 99, 0.3)'"
           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
        ❤
      </div>

      <!-- الصورة + الخصم -->
      <div style="position:relative;">

        <!-- الخصم في أسفل يمين الصورة -->
        ${
          p.discount_value > 0
          ? `<div style="
                position:absolute;
                bottom:0px;
                right:2px;
                background:#00a6ff;
                color:white;
                padding:3px 10px;
                font-size:12px;
                border-radius:20px;
                font-weight:600;
                white-space:nowrap;
                z-index:10;
              ">
              خصم ${p.discount_value}${p.discount_type === 'percent' ? "%" : ""}
             </div>`
          : ``
        }

        <!-- الصورة -->
        <img class="product-img"
             src="${safeImageURL(p.image_url)}"
             onerror="this.src='https://via.placeholder.com/200?text=No+Image'"
             style="${isOutOfStock ? 'filter: grayscale(100%); opacity: 0.5; cursor:pointer;' : 'cursor:pointer;'}"/>
      </div>

      <!-- اسم المنتج -->
      <h3 class="product-name"
          style="font-size:12px; line-height:1.35; height:40px; overflow:hidden; margin:6px 0; cursor:pointer;">
        ${p.name}
      </h3>

      <!-- منطقة الأسعار -->
      <div class="price-row"
           style="display:flex;align-items:center;gap:8px;margin-top:6px;flex-direction:row-reverse;">

        <!-- حساب السعر -->
${(() => {
  const prices = calculateFinalPrice(p);

  return `
    <div style="display:flex;align-items:center;gap:8px;flex-direction:row-reverse;">

      <!-- السعر النهائي -->
      <div style="
        font-size:18px;
        font-weight:800;
        color:${p.discount_value > 0 ? '#E91E63' : '#8a004a'};
        white-space:nowrap;
        background:linear-gradient(135deg, ${p.discount_value > 0 ? '#E91E63' : '#8a004a'} 0%, ${p.discount_value > 0 ? '#c2185b' : '#6a0038'} 100%);
        -webkit-background-clip:text;
        -webkit-text-fill-color:transparent;
        background-clip:text;
        text-shadow:0 2px 4px rgba(138, 0, 74, 0.1);
      ">
        ${prices.final} ر.س
      </div>

      <!-- السعر قبل الخصم -->
      ${
        p.discount_value > 0 
        ? `<div style="
              font-size:13px;
              color:#999;
              text-decoration:line-through;
              white-space:nowrap;
              opacity:0.7;
              position:relative;
            ">
              ${prices.before} ر.س
           </div>`
        : ``
      }

    </div>
  `;
})()}

      </div>

      <!-- النجوم -->
      <div class="product-rating" data-product-id="${p.id}" style="display:flex;align-items:center;gap:4px;margin-top:4px;">
        <div class="stars-container" style="display:flex;gap:2px;">
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
          <span class="star"><span style="color:#ddd;">★</span></span>
        </div>
        <span class="rating-value" style="font-size:12px;color:#666;font-weight:600;">0.0</span>
      </div>

      <!-- زر السلة -->
      <button 
        id="cart-btn-${p.id}"
        onclick="event.stopPropagation(); ${isOutOfStock ? 'return false;' : `addToCart(${p.id})`}"
        class="add-cart"
        ${isOutOfStock ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
        ${isOutOfStock ? 'الكمية منتهية' : 'أضف للسلة'}
      </button>

    </div>
  `;
}


// ========================== السلة ==========================

let cart = JSON.parse(localStorage.getItem("cart") || "[]");

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
}

function openCart(){
  const overlay = document.getElementById("cartOverlay");
  const panel = document.getElementById("cartPanel");
  
  if (!overlay || !panel) {
    console.error("Cart elements not found!");
    return;
  }
  
  // تحديث محتوى السلة أولاً
  renderCart();
  
  // ثم فتح اللوحة
  overlay.style.display = "block";
  if(window.innerWidth <= 768) {
  panel.style.right = "0px";
    panel.classList.add("open");
  } else {
    panel.style.right = "0px";
    panel.classList.add("open");
  }
}

function closeCart(){
  document.getElementById("cartOverlay").style.display = "none";
  const panel = document.getElementById("cartPanel");
  panel.style.right = window.innerWidth <= 768 ? "-85%" : "-350px";
  panel.classList.remove("open");
}

async function addToCart(id){
  // إظهار دائرة التحميل في الزر
  const btn = document.getElementById(`cart-btn-${id}`);
  const productBtn = document.getElementById("productAddBtn");
  
  let originalBtnText = "";
  let originalProductBtnText = "";
  
  if(btn) {
    btn.classList.add("loading");
    originalBtnText = btn.innerHTML;
    btn.innerHTML = '<span style="opacity:0;">أضف للسلة</span>';
    btn.disabled = true;
  }
  
  if(productBtn && productBtn.getAttribute("data-id") == id) {
    productBtn.classList.add("loading");
    originalProductBtnText = productBtn.innerHTML;
    productBtn.innerHTML = '<span style="opacity:0;">أضف للسلة</span>';
    productBtn.disabled = true;
  }

  try {
    // تحميل المنتجات من API (إعادة تحميل إذا لم تكن موجودة)
  if(!window.productsCache){
    const res = await fetch(API + "/api/admin/products");
    const productsList = await res.json();
    
    // التأكد من أن جميع المنتجات لديها stock و quantity
    window.productsCache = productsList.map(p => ({
      ...p,
        stock: parseInt(p.stock || p.quantity || 0),
        quantity: parseInt(p.quantity || p.stock || 0),
        stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
    }));
  }
    
    // إعادة تحميل المنتج المحدد من السيرفر للتأكد من أحدث بيانات المخزون
    const productRes = await fetch(API + "/api/admin/products");
    const allProducts = await productRes.json();
    const updatedProduct = allProducts.find(p => p.id == id);
    if(updatedProduct && window.productsCache){
      const productIndex = window.productsCache.findIndex(p => p.id == id);
      if(productIndex !== -1){
        window.productsCache[productIndex] = {
          ...updatedProduct,
          stock: parseInt(updatedProduct.stock || updatedProduct.quantity || 0),
          quantity: parseInt(updatedProduct.quantity || updatedProduct.stock || 0),
          stock_qty: parseInt(updatedProduct.stock || updatedProduct.quantity || 0)
        };
      }
  }

  const p = window.productsCache.find(x => x.id == id);
    if(!p) {
      if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = originalBtnText; }
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText; }
      return;
    }

  // التحقق من المخزون
    const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
  if(stock <= 0){
      showNotification("عذراً، هذا المنتج غير متوفر حالياً", 'warning');
      if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = "الكمية منتهية"; }
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = '<span>❌</span><span>الكمية منتهية</span>'; }
    return;
  }

  // هل المنتج موجود في السلة
  let item = cart.find(x => x.id == id);
  const currentQty = item ? item.qty : 0;
  const newQty = currentQty + 1;

  // التحقق من أن الكمية المطلوبة لا تتجاوز المخزون
  if(newQty > stock){
      showNotification(`عذراً، الكمية المتاحة في المخزون هي ${stock} حبة فقط`, 'warning');
      if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = originalBtnText; }
      if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText; }
    return;
  }

  if(item){
    item.qty = newQty;
  } else {
    // حسابات الأسعار
let base = parseFloat(p.base_price) || 0;
let discountValue = parseFloat(p.discount_value) || 0;
let discountType = p.discount_type;

let priceAfterDiscount = base;

if (discountValue > 0) {
    if (discountType === "percent") {
        priceAfterDiscount = base - (base * (discountValue / 100));
    } else if (discountType === "fixed") {
        priceAfterDiscount = base - discountValue;
    }
}

let priceWithVat = priceAfterDiscount * 1.15;

item = {
    id: p.id,
    name: p.name,
    qty: 1,
    image: p.image_url,

    // مهم جداً — يُرسل إلى الطلب وإلى orders.html
    base_price: base,
    price_after_discount: priceAfterDiscount.toFixed(2),
    price_with_vat: priceWithVat.toFixed(2),
    total: priceWithVat.toFixed(2)   // للقطعة الواحدة
};

    cart.push(item);
  }

  saveCart();
  renderCart();
  updateCartIcon();
  refreshCurrentPage();

  // فتح لوحة السلة تلقائياً عند إضافة منتج
  openCart();

  // تحديث زر الكرت للمنتج
  if(btn){
      btn.classList.remove("loading");
      btn.disabled = false;
      btn.innerHTML = `مضاف للسلة +${item.qty}`;
    btn.style.background = "#8a004a";
    btn.style.color = "#fff";
    btn.classList.add("added");
  }

  // تحديث زر صفحة المنتج
    if(productBtn && productBtn.getAttribute("data-id") == id) {
      productBtn.classList.remove("loading");
      productBtn.disabled = false;
      productBtn.innerHTML = `<span>🛒</span><span>مضاف للسلة +${item.qty}</span>`;
      productBtn.classList.add("added");
    } else {
  updateProductPageButton(id);
    }
  } catch(error) {
    console.error("Error adding to cart:", error);
    // إعادة تعيين الأزرار في حالة الخطأ
    if(btn) { btn.classList.remove("loading"); btn.disabled = false; btn.innerHTML = originalBtnText || "أضف للسلة"; }
    if(productBtn) { productBtn.classList.remove("loading"); productBtn.disabled = false; productBtn.innerHTML = originalProductBtnText || '<span>🛒</span><span>أضف للسلة</span>'; }
    alert("⚠️ حدث خطأ أثناء إضافة المنتج للسلة");
  }
}



function removeItem(id){
  cart = cart.filter(x => x.id != id);

  saveCart();
  renderCart();          // تحديث السلة الجانبية
  renderCheckoutPage();  // تحديث صفحة إتمام الطلب
  updateCartIcon();
  refreshAllAddToCartButtons();
  updateProductPageButton(id);
}





function changeQty(id, q){
  const item = cart.find(x => x.id == id);
  if(!item) return;

  // منع تقليل الكمية عن 1 - فقط زر الحذف يحذف المنتج
  if(q < 0 && item.qty <= 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من أن الكمية الجديدة لن تقل عن 1
  if(q < 0 && (item.qty + q) < 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من المخزون
  if(!window.productsCache){
    // إذا لم يتم تحميل المنتجات، استمر بدون تحقق
    item.qty += q;
  } else {
    const p = window.productsCache.find(x => x.id == id);
    if(p){
      const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
      const newQty = item.qty + q;
      
      if(newQty > stock){
        showNotification(`عذراً، الكمية المتاحة في المخزون هي ${stock} حبة فقط`, 'warning');
        return;
      }
    }
    
    item.qty += q;
  }

  // التأكد من أن الكمية لا تقل عن 1
  if(item.qty < 1){
    item.qty = 1;
  }

  saveCart();
  renderCart();
  renderCheckoutPage();  // ← تحديث صفحة إتمام الطلب

  updateCartIcon();
  refreshAllAddToCartButtons();
  updateProductPageButton(id);
}



function renderCart() {
  const box = document.getElementById("cartItems");
  const totalBox = document.getElementById("cartTotal");

  if (!box || !totalBox) {
    console.error("Cart elements not found!");
    return;
  }

  box.innerHTML = "";
  let total = 0;

  // إذا كانت السلة فارغة
  if (cart.length === 0) {
    box.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#999;">
        <div style="font-size:48px;margin-bottom:10px;">🛒</div>
        <div style="font-size:16px;">السلة فارغة</div>
        <div style="font-size:14px;margin-top:5px;">أضف منتجات للبدء</div>
      </div>
    `;
    totalBox.innerText = "0.00";
    return;
  }

  cart.forEach(item => {

// جلب بيانات المنتج الأصلية
let p = window.productsCache?.find(x => x.id == item.id);

// إذا لم يتم العثور على المنتج، استخدم البيانات المحفوظة في السلة
if (!p) {
  // استخدام البيانات المحفوظة في السلة
  box.innerHTML += `
    <div style="display:flex; align-items:flex-start; gap:10px; margin-bottom:15px;">
      <img src="${safeImageURL(item.image)}"
           onerror="this.src='https://via.placeholder.com/80?text=No+Img'"
           style="width:60px; height:60px; object-fit:cover; border-radius:10px;">
      <div style="flex:1;">
        <div style="font-weight:600; color:#333; margin-bottom:4px; font-size:13px; line-height:1.4; max-height:2.8em; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
          ${item.name}
        </div>
        <div style="font-size:17px; font-weight:bold; color:#8a004a;">
          ${item.price_with_vat || item.total} ر.س × ${item.qty}
        </div>
        <button onclick="removeItem(${item.id})" style="background:#ffd6e3;color:#E91E63;border:none;padding:5px 10px;border-radius:6px;font-size:13px;margin-top:5px;">حذف</button>
      </div>
    </div>
  `;
  total += parseFloat(item.price_with_vat || item.total || 0) * item.qty;
  return; // تخطي باقي الكود لهذا العنصر
}

let base = parseFloat(p.base_price) || 0;
let discountValue = parseFloat(p.discount_value) || 0;
let discountType = p.discount_type || "none";

// السعر الأساسي مع الضريبة
let beforePrice = base * 1.15;

// السعر بعد الخصم
let priceAfterDiscount = base;

if (discountValue > 0) {
  if (discountType === "percent") {
    priceAfterDiscount = base - (base * (discountValue / 100));
  } else if (discountType === "fixed") {
    priceAfterDiscount = base - discountValue;
  }
}

// السعر بعد الخصم + الضريبة
let finalPrice = priceAfterDiscount * 1.15;

// مجموع هذا المنتج
let lineTotal = finalPrice * item.qty;
total += lineTotal;


    box.innerHTML += `
      <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:18px; padding:12px; background:#f9f9f9; border-radius:12px; border:1px solid #f0f0f0; transition:all 0.3s ease;">

        <img src="${safeImageURL(item.image)}"
             onerror="this.src='https://via.placeholder.com/80?text=No+Img'"
             style="width:70px; height:70px; object-fit:cover; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); flex-shrink:0;">

        <div style="flex:1; display:flex; flex-direction:column; min-width:0;">

          <div style="font-weight:600; color:#333; margin-bottom:4px; line-height:1.4; font-size:12px; max-height:2.8em; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
            ${item.name}
          </div>

          <div style="margin-bottom:5px;">

            ${
  discountValue > 0
  ? `
      <!-- السعر قبل الخصم -->
      <div style="
        font-size:12px;
        color:#999;
        text-decoration:line-through;
        white-space:nowrap;
      ">
        ${beforePrice.toFixed(2)} ر.س
      </div>

      <!-- السعر النهائي -->
      <div style="
        font-size:17px;
        font-weight:bold;
        color:red;
        white-space:nowrap;
      ">
        ${finalPrice.toFixed(2)} ر.س
      </div>
    `
  : `
      <!-- السعر النهائي لمنتج بدون خصم -->
      <div style="
        font-size:17px;
        font-weight:bold;
        color:#006b6a;
        white-space:nowrap;
      ">
        ${beforePrice.toFixed(2)} ر.س
      </div>
    `
}


          </div>

          <div style="display:flex; align-items:center; gap:6px;">

            ${item.qty <= 1 
              ? `<button disabled onclick="return false;" style="background:#e0e0e0; border:1px solid #ccc; border-radius:8px; padding:6px 10px; font-size:14px; cursor:not-allowed; opacity:0.7; color:#999; pointer-events:none; user-select:none; font-weight:bold;" title="الكمية لا يمكن أن تقل عن 1 - استخدم زر الحذف لحذف المنتج">-</button>`
              : `<button onclick="changeQty(${item.id}, -1)" style="background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:6px 10px; font-size:14px; cursor:pointer; font-weight:bold; color:#666; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);" title="تقليل الكمية">-</button>`
            }

            <span style="font-size:15px; font-weight:bold; min-width:24px; text-align:center; color:#333;">
              ${item.qty}
            </span>

            <button onclick="changeQty(${item.id}, +1)"
              style="background:#fff; border:1px solid #e0e0e0; border-radius:8px;
                     padding:6px 10px; font-size:14px; cursor:pointer; font-weight:bold; color:#666; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">+</button>

            <button onclick="removeItem(${item.id})"
              style="background:linear-gradient(135deg, #ffe6f0 0%, #ffd6e3 100%); border:none; border-radius:8px;
                     padding:6px 12px; font-size:12px; color:#E91E63; cursor:pointer; font-weight:600; margin-right:auto; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(233, 30, 99, 0.2);">🗑️ حذف</button>

          </div>

        </div>
      </div>
    `;
  });

  totalBox.innerText = total.toFixed(2);
}

// ========== تحديث أزرار السلة لكل المنتجات ==========
function refreshAllAddToCartButtons() {
  document.querySelectorAll("[id^='cart-btn-']").forEach(btn => {

    const id = Number(btn.id.replace("cart-btn-", ""));
    const item = cart.find(x => x.id === id);

    if (item) {
      // إذا المنتج موجود في السلة
      btn.innerText = `مضاف للسلة +${item.qty}`;
      btn.style.background = "#8a004a";
      btn.style.color = "#fff";
      btn.classList.add("added");
    } else {
      // إذا المنتج غير موجود → أرجع الشكل الطبيعي
      btn.innerText = "أضف للسلة";
      btn.style.background = "";
      btn.style.color = "";
      btn.classList.remove("added");
    }
  });

  // نفس الشيء لزر صفحة المنتج
  const productBtn = document.getElementById("productAddBtn");
  if (productBtn) {
    const productId = Number(productBtn.getAttribute("data-id"));
    const item = cart.find(x => x.id === productId);

    if (item) {
      productBtn.innerText = `مضاف للسلة +${item.qty}`;
      productBtn.style.background = "#8a004a";
      productBtn.style.color = "#fff";
      productBtn.classList.add("added");
    } else {
      productBtn.innerText = "أضف للسلة";
      productBtn.style.background = "";
      productBtn.style.color = "";
      productBtn.classList.remove("added");
    }
  }
}



// ========== تحديث زر السلة داخل صفحة المنتج ==========
function updateProductPageButton(id){
  const btn = document.getElementById("productAddBtn");
  if(!btn) return;

  const item = cart.find(x => x.id == id);

  if(item){
    btn.innerText = `مضاف للسلة +${item.qty}`;
    btn.classList.add("added");
  }
  else {
    btn.innerText = "أضف للسلة";
    btn.classList.remove("added");
  }
}







// ========== تحديث عداد السلة في الهيدر ==========
function updateCartIcon(){
  const count = cart.reduce((sum, item) => sum + item.qty, 0);
  const badge = document.getElementById("cartCount");

  if(!badge) return;

  if(count > 0){
    badge.style.display = "inline-block";
    badge.innerText = count;
  } else {
    badge.style.display = "none";
  }
}

function goToCheckout() {

  if (cart.length === 0) {
    alert("⚠️ لا يمكنك إتمام الطلب — السلة فارغة");
    return;
  }

  // التحقق من تسجيل الدخول
  if (!window.user || !window.user.phone) {
    showLoginRequiredModal();
    return;
  }

  closeCart();
  go("checkout");
}

function showLoginRequiredModal() {
  const modal = document.getElementById("loginRequiredModal");
  if (modal) {
    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
}

function closeLoginRequiredModal() {
  const modal = document.getElementById("loginRequiredModal");
  if (modal) {
    modal.style.display = "none";
    document.body.style.overflow = "";
  }
}

function goToLoginFromModal() {
  closeLoginRequiredModal();
  closeCart();
  go("login");
}

// إغلاق الـ modal عند الضغط على الخلفية
document.addEventListener("click", function(event) {
  const modal = document.getElementById("loginRequiredModal");
  if (modal && event.target === modal) {
    closeLoginRequiredModal();
  }
});

// إغلاق الـ modal عند الضغط على ESC
document.addEventListener("keydown", function(event) {
  if (event.key === "Escape") {
    const modal = document.getElementById("loginRequiredModal");
    if (modal && modal.style.display === "flex") {
      closeLoginRequiredModal();
    }
  }
});

// ===================== نظام السلايدر التلقائي للماركات =====================
let brandsAutoSlideInterval = null;
let brandsSliderPaused = false;

// التمرير اليدوي بالسهام
function scrollBrands(px){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  pauseBrandsAutoSlide();
  
  slider.scrollBy({
    left: px,
    behavior: "smooth"
  });
  
  setTimeout(() => {
    updateBrandsVisibility();
    resumeBrandsAutoSlide();
  }, 600);
}

// تحديث حالة الماركات الجانبية (شفافة/blur)
function updateBrandsVisibility(){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  const brands = slider.querySelectorAll('.brand-box');
  if(brands.length === 0) return;
  
  const sliderRect = slider.getBoundingClientRect();
  const sliderCenter = sliderRect.left + sliderRect.width / 2;
  
  brands.forEach((brand) => {
    const brandRect = brand.getBoundingClientRect();
    const brandCenter = brandRect.left + brandRect.width / 2;
    const distance = Math.abs(brandCenter - sliderCenter);
    const threshold = sliderRect.width / 2.5;
    
    if(distance > threshold) {
      brand.classList.add('side');
    } else {
      brand.classList.remove('side');
    }
  });
}

// إيقاف السلايدر التلقائي
function pauseBrandsAutoSlide(){
  brandsSliderPaused = true;
}

// استئناف السلايدر التلقائي
function resumeBrandsAutoSlide(){
  brandsSliderPaused = false;
}

// تهيئة السلايدر التلقائي - تصميم جديد محسّن
function initBrandsAutoSlider(){
  const slider = document.getElementById("brandsSlider");
  if(!slider) return;
  
  // إيقاف السلايدر السابق
  if(brandsAutoSlideInterval) {
    clearInterval(brandsAutoSlideInterval);
    brandsAutoSlideInterval = null;
  }
  
  const featuredBrands = slider.querySelectorAll('.brand-box');
  if(featuredBrands.length === 0) return;
  
  // حساب عدد الماركات الأصلي (3 نسخ)
  const originalCount = Math.floor(featuredBrands.length / 3);
  if(originalCount === 0) return;
  
  // انتظار لضمان تحميل العناصر
  setTimeout(() => {
    const isMobile = window.innerWidth <= 768;
    const firstBrand = featuredBrands[0];
    if(!firstBrand) return;
    
    // حساب الأبعاد بدقة
    const cardWidth = firstBrand.offsetWidth || (isMobile ? (slider.clientWidth - 100) / 3 : 120);
    const gap = isMobile ? 18 : 15;
    const scrollAmount = cardWidth + gap;
    
    // بدء من أول ماركة (البداية) - تأكد من البداية
    slider.scrollLeft = 0;
    updateBrandsVisibility();
    
    // تفعيل السلايدر
    brandsSliderPaused = false;
    
    // دالة التمرير التلقائي - من اليسار لليمين (المنتجات تتحرك ناحية اليمين)
    function autoSlide() {
      if(brandsSliderPaused) return;
      
      const currentScroll = slider.scrollLeft;
      const maxScroll = slider.scrollWidth - slider.clientWidth;
      const nextScroll = currentScroll + scrollAmount;
      
      // إذا وصلنا للنهاية - العودة للبداية تلقائياً بدون توقف
      if(nextScroll >= maxScroll - scrollAmount/2) {
        // العودة للبداية بدون animation
        slider.scrollLeft = 0;
        updateBrandsVisibility();
        
        // نكمل التمرير مباشرة بعد العودة (من أول ماركة)
        requestAnimationFrame(() => {
          setTimeout(() => {
            slider.scrollTo({
              left: scrollAmount,
              behavior: 'smooth'
            });
            setTimeout(() => updateBrandsVisibility(), 300);
          }, 50);
        });
      } else {
        // التمرير العادي - من اليسار لليمين (المنتجات تتحرك ناحية اليمين)
        slider.scrollTo({
          left: nextScroll,
          behavior: 'smooth'
        });
        setTimeout(() => updateBrandsVisibility(), 300);
      }
    }
    
    // بدء السلايدر التلقائي - 0.7 ثانية
    brandsAutoSlideInterval = setInterval(autoSlide, 700);
    
    // بدء التمرير الأول بعد 0.5 ثانية
    setTimeout(() => {
      if(!brandsSliderPaused) {
        autoSlide();
      }
    }, 500);
    
    // إدارة التمرير اليدوي
    let isUserScrolling = false;
    let scrollTimeout;
    let lastScrollTime = 0;
    
    const handleScroll = () => {
      const now = Date.now();
      updateBrandsVisibility();
      
      // إذا كان التمرير سريع جداً، فهو يدوي
      if(now - lastScrollTime < 100) {
        isUserScrolling = true;
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          isUserScrolling = false;
          if(!brandsSliderPaused) {
            pauseBrandsAutoSlide();
            setTimeout(() => resumeBrandsAutoSlide(), 5000);
          }
        }, 300);
      }
      
      lastScrollTime = now;
    };
    
    slider.addEventListener('scroll', handleScroll, { passive: true });
    
    // إيقاف عند hover
    slider.addEventListener('mouseenter', () => {
      pauseBrandsAutoSlide();
    });
    
    slider.addEventListener('mouseleave', () => {
      resumeBrandsAutoSlide();
    });
    
    // إيقاف عند touch
    let touchStartX = 0;
    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
      pauseBrandsAutoSlide();
    }, { passive: true });
    
    slider.addEventListener('touchend', () => {
      setTimeout(() => {
        resumeBrandsAutoSlide();
      }, 3000);
    }, { passive: true });
  }, 600);
}
async function loadOffers(){
  const res = await fetch(API + "/api/admin/products");
  const productsList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;

  const offers = products.filter(p => p.discount_value > 0);

  const grid = document.getElementById("offersGrid");
  grid.innerHTML = "";

  offers.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  // ⭐ الحل هنا
  refreshAllAddToCartButtons();
}

async function loadCategories(){
  const res = await fetch(API + "/api/admin/products");
  const products = await res.json();

  // استخراج التصنيفات بدون تكرار
  let cats = {};

  products.forEach(p=>{
    if(p.category){
      cats[p.category] = true;
    }
  });

  const list = Object.keys(cats);

  const box = document.getElementById("categoriesList");
  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = "<p>لا يوجد تصنيفات</p>";
    return;
  }

  list.forEach(cat=>{
    box.innerHTML += `
      <div onclick="go('category', '${cat}')" 
           style="background:#f9d9e6;padding:20px;border-radius:14px;text-align:center;font-size:16px;color:#8a004a;font-weight:600;cursor:pointer;">
        ${cat}
      </div>
    `;
  });

}
async function loadCategoryProducts(catName){
  const res = await fetch(API + "/api/admin/products");
  const productsList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const products = productsList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = products;

  const filtered = products.filter(p => p.category === catName);

  document.getElementById("categoryTitle").innerText = "تصنيف: " + catName;

  const grid = document.getElementById("categoryGrid");
  grid.innerHTML = "";

  filtered.forEach(p=>{
    grid.innerHTML += makeProductCard(p);
  });

  // ⭐ الحل هنا
  refreshAllAddToCartButtons();
}



let headerProductsCache = [];

// ===================== وظائف البحث للجوال =====================
function toggleMobileSearch() {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  const searchInput = document.getElementById("headerSearchMobile");
  
  if (searchContainer && searchWrapper) {
    searchContainer.classList.add("active");
    searchWrapper.classList.add("search-active");
    
    // التركيز على حقل البحث بعد قليل
    setTimeout(() => {
      if (searchInput) {
        searchInput.focus();
      }
    }, 100);
  }
}

function closeMobileSearch() {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  const searchInput = document.getElementById("headerSearchMobile");
  const searchResults = document.getElementById("headerSearchResultsMobile");
  
  if (searchContainer && searchWrapper) {
    searchContainer.classList.remove("active");
    searchWrapper.classList.remove("search-active");
    
    if (searchInput) {
      searchInput.value = "";
      searchInput.blur();
    }
    
    if (searchResults) {
      searchResults.style.display = "none";
    }
  }
}

// إغلاق البحث عند الضغط خارجه
document.addEventListener("click", function(e) {
  const searchContainer = document.getElementById("mobileSearchContainer");
  const searchBtn = document.getElementById("mobileSearchBtn");
  const searchWrapper = document.querySelector(".header-search-wrapper");
  
  if (searchContainer && searchContainer.classList.contains("active")) {
    // إذا لم يكن النقر داخل حاوية البحث أو على زر البحث
    if (!searchContainer.contains(e.target) && !searchBtn.contains(e.target)) {
      closeMobileSearch();
    }
  }
});

// إغلاق البحث عند الضغط على ESC
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    const searchContainer = document.getElementById("mobileSearchContainer");
    if (searchContainer && searchContainer.classList.contains("active")) {
      closeMobileSearch();
    }
  }
});

async function headerLiveSearch(){
  // تحديد إذا كنا في الجوال أم لا أولاً
  const isMobile = window.innerWidth <= 768;
  
  // تحديد أي حقل بحث تم استخدامه بناءً على نوع الجهاز
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  
  // في الجوال، استخدم mobileSearch فقط
  // في الكمبيوتر، استخدم desktopSearch فقط
  let activeSearch;
  if(isMobile) {
    activeSearch = mobileSearch;
  } else {
    activeSearch = desktopSearch;
  }
  
  // تحديد أي صندوق نتائج يجب استخدامه
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  
  // للجوال، استخدم mobileBox فقط
  // للكمبيوتر، استخدم desktopBox فقط
  let box;
  if(isMobile) {
    box = mobileBox;
  } else {
    box = desktopBox;
  }
  
  // التأكد من أن box موجود
  if(!box) {
    console.error("Search results box not found. isMobile:", isMobile, "mobileBox:", mobileBox, "desktopBox:", desktopBox);
    return;
  }
  
  const text = activeSearch ? activeSearch.value.toLowerCase() : "";
  
  console.log("Search box selected:", {isMobile, boxId: box.id, searchInput: activeSearch?.id, hasValue: text.trim() !== "", textLength: text.length});

  if(text.trim() === ""){
    box.style.display = "none";
    box.style.visibility = "hidden";
    box.innerHTML = "";
    return;
  }

  // تحميل المنتجات مرة واحدة فقط
  if(headerProductsCache.length === 0){
    const res = await fetch(API + "/api/admin/products");
    const productsList = await res.json();
    
    // التأكد من أن جميع المنتجات لديها stock و quantity
    headerProductsCache = productsList.map(p => ({
      ...p,
      stock: parseInt(p.stock || p.quantity || 0),
      quantity: parseInt(p.quantity || p.stock || 0),
      stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
    }));
  }

  // البحث في الاسم والوصف والماركة
  const results = headerProductsCache.filter(p => {
    const searchText = text.toLowerCase();
    const name = (p.name || '').toLowerCase();
    const description = (p.description || '').toLowerCase();
    const brand = (p.brand || '').toLowerCase();
    
    return name.includes(searchText) || 
           description.includes(searchText) || 
           brand.includes(searchText);
  });
  
  // ترتيب النتائج: المطابقة في الاسم أولاً
  results.sort((a, b) => {
    const aName = (a.name || '').toLowerCase();
    const bName = (b.name || '').toLowerCase();
    const aStartsWith = aName.startsWith(text);
    const bStartsWith = bName.startsWith(text);
    
    if(aStartsWith && !bStartsWith) return -1;
    if(!aStartsWith && bStartsWith) return 1;
    return 0;
  });

  if(results.length === 0){
    // إعداد box قبل إظهار "لا توجد نتائج"
    box.innerHTML = `
      <div style="padding:40px 20px;text-align:center;">
        <div style="font-size:48px;margin-bottom:12px;opacity:0.5;">🔍</div>
        <div style="color:#666;font-size:15px;font-weight:500;margin-bottom:4px;">لا توجد نتائج</div>
        <div style="color:#999;font-size:13px;">جرب البحث بكلمات مختلفة</div>
      </div>
    `;
    box.style.display = "block";
    box.style.visibility = "visible";
    box.style.opacity = "1";
    
    // للجوال
    if(isMobile && box.id === "headerSearchResultsMobile") {
      box.style.position = "absolute";
      box.style.top = "100%";
      box.style.left = "50%";
      box.style.transform = "translateX(-50%)";
      box.style.width = "calc(100vw - 40px)";
      box.style.maxWidth = "95vw";
      box.style.zIndex = "1001";
      box.style.maxHeight = "70vh";
      box.style.overflowY = "auto";
    }
    return;
  }

  // عرض النتائج
  box.innerHTML = "";
  box.style.display = "block";
  box.style.visibility = "visible";
  box.style.opacity = "1";
  
  // التأكد من أن النتائج مرئية في الجوال
  if(isMobile && box.id === "headerSearchResultsMobile") {
    box.style.position = "absolute";
    box.style.top = "100%";
    box.style.left = "50%";
    box.style.transform = "translateX(-50%)";
    box.style.width = "calc(100vw - 40px)";
    box.style.maxWidth = "95vw";
    box.style.zIndex = "1001";
    box.style.maxHeight = "70vh";
    box.style.overflowY = "auto";
    box.style.visibility = "visible";
    box.style.opacity = "1";
    
    // التأكد من أن container موجود ونشط
    const searchContainer = box.closest('.mobile-search-container');
    if(searchContainer && !searchContainer.classList.contains('active')) {
      console.warn("Mobile search container is not active - results may not be visible!");
    }
  }

  results.slice(0, 8).forEach(p=>{
    const imageUrl = safeImageURL(p.image_url);
    const prices = calculateFinalPrice(p);
    const hasDiscount = p.discount_value > 0;
    
    box.innerHTML += `
      <div onclick="go('product', ${p.id}); clearHeaderSearch();"
           class="header-search-result-item"
           style="padding:14px 16px;display:flex;align-items:center;gap:16px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:all 0.2s ease;"
           onmouseover="this.style.background='#f8f9fa';this.style.transform='translateX(-2px)'"
           onmouseout="this.style.background='#fff';this.style.transform='translateX(0)'">
        <div style="position:relative;flex-shrink:0;">
          <img src="${imageUrl}" 
               onerror="this.src='https://via.placeholder.com/80?text=No+Image'"
               style="width:70px;height:70px;border-radius:12px;object-fit:cover;border:1px solid #e8e8e8;background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.05);"
               class="header-search-result-img">
        </div>
        <div style="flex:1;min-width:0;" class="header-search-result-content">
          <div style="font-size:16px;color:#1a1a1a;font-weight:600;margin-bottom:5px;line-height:1.4;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;" class="header-search-result-name">
          ${p.name}
        </div>
          ${p.category ? `
            <div style="font-size:13px;color:#666;margin-bottom:6px;font-weight:400;" class="header-search-result-category">
              📂 ${p.category}
            </div>
          ` : ''}
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;" class="header-search-result-price">
            <span style="color:#E91E63;font-weight:700;font-size:17px;" class="header-search-price-main">${prices.final} ر.س</span>
            ${hasDiscount ? `
              <span style="color:#999;font-size:13px;text-decoration:line-through;" class="header-search-price-old">${prices.before} ر.س</span>
              <span style="background:linear-gradient(135deg, #ff4757 0%, #ee5a6f 100%);color:#fff;font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600;box-shadow:0 2px 4px rgba(255, 71, 87, 0.3);" class="header-search-discount">
                خصم ${p.discount_value}${p.discount_type === 'percent' ? '%' : ' ر.س'}
              </span>
            ` : ''}
          </div>
        </div>
        <div style="flex-shrink:0;color:#ccc;font-size:22px;transition:all 0.2s ease;" class="header-search-result-arrow">→</div>
      </div>
    `;
  });
}

function clearHeaderSearch(){
  const desktopSearch = document.getElementById("headerSearch");
  const mobileSearch = document.getElementById("headerSearchMobile");
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  
  if(desktopSearch) desktopSearch.value = "";
  if(mobileSearch) mobileSearch.value = "";
  if(desktopBox) desktopBox.style.display = "none";
  if(mobileBox) mobileBox.style.display = "none";
}

document.addEventListener("click", function(e){
  const desktopBox = document.getElementById("headerSearchResults");
  const mobileBox = document.getElementById("headerSearchResultsMobile");
  const desktopContainer = document.querySelector(".desktop-search-container");
  const mobileContainer = document.querySelector(".mobile-search-container");

  // للكمبيوتر
  if(desktopBox && desktopContainer){
    if(!desktopContainer.contains(e.target)){
      desktopBox.style.display = "none";
    }
  }
  
  // للجوال
  if(mobileBox && mobileContainer){
    if(!mobileContainer.contains(e.target)){
      mobileBox.style.display = "none";
    }
  }
});
// ======================== المفضّلات ========================
let wishlist = JSON.parse(localStorage.getItem("wishlist") || "[]"); // IDs فقط


function saveWishlist(){
  localStorage.setItem("wishlist", JSON.stringify(wishlist));
}

async function toggleWishlist(id){
  const isCurrentlyFav = wishlist.includes(id);

  // لو المنتج موجود → احذفه
  if(isCurrentlyFav){
    wishlist = wishlist.filter(x => x !== id);
  } 
  else {
    wishlist.push(id);
  }

  saveWishlist();
  updateWishlistCount(); // تحديث عداد المفضلة
  
  // تحديث القلب في صفحة المنتج مباشرة دون إعادة تحميل الصفحة
  const productWishlistBtn = document.getElementById("productWishlistBtn");
  if(productWishlistBtn && window.currentProductId === id) {
    const isNowFav = !isCurrentlyFav;
    productWishlistBtn.style.color = isNowFav ? '#E91E63' : '#bbb';
    productWishlistBtn.title = isNowFav ? 'إزالة من المفضلة' : 'إضافة للمفضلة';
    
    // تأثير اهتزاز للصورة فقط
    const imageWrapper = document.querySelector('.product-image-wrapper');
    if(imageWrapper) {
      imageWrapper.style.animation = 'none';
      setTimeout(() => {
        imageWrapper.style.animation = 'heartShake 0.5s ease';
      }, 10);
    }
  } else {
    // تحديث الصفحات الأخرى
  refreshCurrentPage();
  }
}


function refreshCurrentPage(){
  const activePage = document.querySelector(".page.active");
  const active = activePage ? activePage.id : "";

  if(active === "page-products") loadAllProducts();
  if(active === "page-home" || active === "homePage") loadHome();
  if(active === "page-wishlist") loadWishlist();
  if(active === "page-brand") loadBrandProducts(window.currentBrand);
  if(active === "page-category") loadCategoryProducts(window.currentCategory);
  if(active === "page-product") {
    // تحديث صفحة المنتج الحالية
    const productId = window.currentProductId;
    if(productId) {
      loadProductDetails(productId);
    }
  }
}
function getSARIcon(){
  return `
    <svg width="18" height="18" viewBox="0 0 1228 1228" style="vertical-align:middle;">
    <path d="M699.62 1113.02c-20.06 44.48-33.32 92.75-38.4 143.37l424.51-90.24c20.06-44.47 33.31-92.75 38.4-143.37zM1085.73 895.8c20.06-44.47 33.32-92.75 38.4-143.37l-330.68 70.33v-135.2l292.27-62.11c20.06-44.47 33.32-92.75 38.4-143.37l-330.68 70.27V66.13c-50.67 28.45-95.67 66.32-132.25 110.99v403.35l-132.25 28.11V0c-50.67 28.44-95.67 66.32-132.25 110.99v525.69l-295.91 62.88c-20.06 44.47-33.33 92.75-38.42 143.37l334.33-71.05v170.26l-358.3 76.14c-20.06 44.47-33.32 92.75-38.4 143.37l375.04-79.7c30.53-6.35 56.77-24.4 73.83-49.24l68.78-101.97v-.02c7.14-10.55 11.3-23.27 11.3-36.97V743.77l132.25-28.11v270.4l424.53-90.28Z" fill="#8a004a"></path>
    </svg>
  `;
}

function renderCheckoutPage() {
  const box = document.getElementById("checkoutItems");
  box.innerHTML = "";

  let subtotal = 0;
  let totalQty = 0;

  cart.forEach(item => {

    // السعر الأساسي الحقيقي
    let p = window.productsCache?.find(x => x.id == item.id);

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p?.discount_value || 0;
    let discountType = p?.discount_type || "none";

    // السعر بعد الخصم
    let priceAfterDiscount = base;

    if (discountValue > 0) {
      if (discountType === "percent") priceAfterDiscount = base - (base * discountValue / 100);
      else if (discountType === "fixed") priceAfterDiscount = base - discountValue;
    }

    // السعر النهائي مع الضريبة
    let finalPrice = priceAfterDiscount * 1.15;

    let lineTotal = finalPrice * item.qty;
    subtotal += lineTotal;
    totalQty += item.qty;

    box.innerHTML += `
      <div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px;">

        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          
          <div style="flex:1;text-align:right;">
            <div style="font-weight:700;margin-bottom:5px;">${item.name}</div>

            <div style="margin-bottom:5px;font-weight:700;">
              ${
                discountValue > 0
                ? `
                    <span style="text-decoration:line-through;color:#999;font-size:14px;margin-left:8px;">
                      ${(base * 1.15).toFixed(2)} ر.س
                    </span>

                    <span style="color:#8a004a;font-weight:700;">
                      ${finalPrice.toFixed(2)} ر.س
                    </span>
                  `
                : `
                  <span style="color:#8a004a;font-weight:700;">
                    ${(base * 1.15).toFixed(2)} ر.س
                  </span>
                `
              }
            </div>

            <div style="display:flex;align-items:center;gap:10px;justify-content:flex-end;">
              ${item.qty <= 1 
                ? `<button disabled onclick="return false;" class="qty-btn" style="opacity:0.6; cursor:not-allowed; background:#e0e0e0; border:1px solid #ccc; color:#999; pointer-events:none; user-select:none;" title="الكمية لا يمكن أن تقل عن 1 - استخدم زر الحذف لحذف المنتج">-</button>`
                : `<button onclick="changeQtyCheckout(${item.id}, -1)" class="qty-btn" title="تقليل الكمية">-</button>`
              }
              <span style="font-size:16px;font-weight:bold;">${item.qty}</span>
              <button onclick="changeQtyCheckout(${item.id}, +1)" class="qty-btn">+</button>
            </div>
          </div>

          <img src="${safeImageURL(item.image)}"
               style="width:70px;height:70px;border-radius:10px;object-fit:cover;margin-left:10px;">
        </div>

        <button onclick="removeItemCheckout(${item.id})"
          style="background:#ffd6e3;color:#E91E63;border:none;padding:5px 15px;border-radius:6px;font-size:14px;margin-top:10px;">
          حذف
        </button>

      </div>
    `;
  });

  // إجماليات
// ===== تفصيل الفاتورة بطريقة النهدي =====
// ===== حساب قيم الفاتورة =====
let base_before_vat_total = 0;
let discount_amount_total = 0;
let subtotal_before_vat = 0;
let subtotal_with_vat = 0;
let vat_total = 0;

cart.forEach(item => {
    let p = window.productsCache.find(x => x.id == item.id);

    let base = parseFloat(p.base_price) || 0;
    let discountValue = p.discount_value || 0;
    let discountAmount = 0;

    // الخصم قبل الضريبة
    if (p.discount_type === "percent") {
        discountAmount = base * (discountValue / 100);
    } 
    else if (p.discount_type === "fixed") {
        discountAmount = discountValue;
    }

    let price_after_discount = base - discountAmount;
    let final_price = price_after_discount * 1.15;

    base_before_vat_total += base * item.qty;
    discount_amount_total += discountAmount * item.qty;
    subtotal_before_vat += price_after_discount * item.qty;
    subtotal_with_vat += final_price * item.qty;
});

// الضريبة الإجمالية
vat_total = subtotal_with_vat - subtotal_before_vat;

// كود الخصم
let coupon_discount = 0;

// الإجمالي النهائي
let total_final = subtotal_with_vat - coupon_discount;

// --- إضافة الشحن ---
let shipping = 15;
let shippingVat = shipping * 0.15;
let finalTotalWithShipping = subtotal_with_vat + shipping + shippingVat;

// ===== عرض الفاتورة =====
box.innerHTML += `

  <div style="padding:12px;margin-top:15px;line-height:1.9;font-size:15px;">

    <div style="display:flex;justify-content:space-between;">
      <span>المجموع الأساسي (بدون ضريبة)</span>
      <b>${base_before_vat_total.toFixed(2)} ر.س</b>
    </div>

    <div style="display:flex;justify-content:space-between; color:green;">
      <span>المبلغ المخصوم</span>
      <b>- ${discount_amount_total.toFixed(2)} ر.س</b>
    </div>

    <hr style="margin:12px 0;">

    <div style="display:flex;justify-content:space-between;">
      <span>المجموع (بدون ضريبة القيمة المضافة)</span>
      <b>${subtotal_before_vat.toFixed(2)} ر.س</b>
    </div>

    <div style="display:flex;justify-content:space-between;">
      <span>قيمة ضريبة القيمة المضافة</span>
      <b>${vat_total.toFixed(2)} ر.س</b>
    </div>

    <hr style="margin:12px 0;">

    <div style="display:flex;justify-content:space-between;">
      <span>المجموع (شامل ضريبة القيمة المضافة)</span>
      <b>${subtotal_with_vat.toFixed(2)} ر.س</b>
    </div>

    <div style="display:flex;justify-content:space-between;">
      <span>الخصم (كود الخصم)</span>
      <b>${coupon_discount.toFixed(2)} ر.س</b>
    </div>

    <div style="margin-top:15px;font-size:22px;font-weight:800;color:#E91E63;text-align:center;">
      السعر الإجمالي النهائي: ${total_final.toFixed(2)} ر.س
    </div>

  </div>
  <div style="display:flex;justify-content:space-between;">
  <span>الشحن:</span>
  <b>${shipping.toFixed(2)} ر.س</b>
</div>

<div style="display:flex;justify-content:space-between;">
  <span>ضريبة الشحن (15%):</span>
  <b>${shippingVat.toFixed(2)} ر.س</b>
</div>

<hr style="margin:12px 0;">

<div style="display:flex;justify-content:space-between;font-size:20px;color:#8a004a;font-weight:900;">
  <span>الإجمالي النهائي + الشحن:</span>
  <b>${finalTotalWithShipping.toFixed(2)} ر.س</b>
</div>

`;
}




async function payOnline() {
// 🔐 منع الدفع بدون تسجيل دخول
if (!window.user) {
  alert("⚠️ يجب تسجيل الدخول قبل الدفع الإلكتروني");
  go("login");
  return;
}


  if (cart.length === 0) {
    alert("⚠️ السلة فارغة!");
    return;
  }

  // 1) جمع بيانات العميل
  const name = document.getElementById("co_name").value.trim();
  const phone = document.getElementById("co_phone").value.trim();
  const phone2 = document.getElementById("co_phone2").value.trim();
  const notes = document.getElementById("co_notes").value.trim();
  const address = document.getElementById("co_address").value.trim();
  const location = document.getElementById("co_location").value.trim();

  if (!name || !phone) {
    alert("⚠️ الرجاء إدخال الاسم ورقم الجوال قبل الدفع الإلكتروني");
    return;
  }

  // 2) تجهيز الطلب للباك اند
  const body = {
    customer_name: name,
    customer_phone: phone,
	shipping: 15,
    shipping_vat: 15 * 0.15,
	customer_phone2: phone2,
	customer_notes: notes,
    customer_address: address,
    customer_location: location,
    notes: notes,

    items: cart.map(item => ({
    id: item.id,
    name: item.name,
    qty: item.qty,
    base_price: item.base_price,
    discount_value: window.productsCache.find(p => p.id == item.id)?.discount_value || 0,
    discount_type: window.productsCache.find(p => p.id == item.id)?.discount_type || "none"
}))


  };

  // 3) إرسال الطلب إلى السيرفر
  
  const res = await fetch(API + "/api/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if (!data.success) {
    alert("⚠️ لم يتم تسجيل الطلب! حاول مرة أخرى");
    return;
  }

const orderId = data.order_id;

  // تحديث المخزون في productsCache بعد إتمام الطلب
  if (window.productsCache) {
    cart.forEach(item => {
      const product = window.productsCache.find(p => p.id == item.id);
      if (product) {
        const currentStock = parseInt(product.stock || product.quantity || product.stock_qty || 0);
        const newStock = Math.max(0, currentStock - item.qty);
        product.stock = newStock;
        product.quantity = newStock;
        product.stock_qty = newStock; // للتوافق مع الكود القديم
      }
    });
  }

// ===== حفظ الطلب في localStorage للوحة التحكم =====
let dashboardOrders = JSON.parse(localStorage.getItem("orders") || "[]");

dashboardOrders.push({
    id: orderId,
    date: new Date().toLocaleString("ar-EG"),
    customer_name: name,
    customer_phone: phone,
    items: cart.map(item => ({
        id: item.id,
        name: item.name,
        qty: item.qty,
        base_price: item.base_price,
        price_after_discount: item.price_after_discount,
        price_with_vat: item.price_with_vat,
        total: (item.price_with_vat * item.qty).toFixed(2)
    })),
    total: cart.reduce((sum, i) => sum + (i.price_with_vat * i.qty), 0).toFixed(2),
    status: "new"
});


localStorage.setItem("orders", JSON.stringify(dashboardOrders));
// ====================================================


  // 4) تفريغ السلة + تحديث الواجهة
  cart = [];
  saveCart();
  updateCartIcon();

  // 5) عرض رقم الطلب + صفحة الشكر
  go("thanks", orderId);
}


function changeQtyCheckout(id, amount){
  let item = cart.find(p => p.id == id);
  if(!item) return;

  // منع تقليل الكمية عن 1 - فقط زر الحذف يحذف المنتج
  if(amount < 0 && item.qty <= 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من أن الكمية الجديدة لن تقل عن 1
  if(amount < 0 && (item.qty + amount) < 1){
    return; // لا تسمح بتقليل الكمية عن 1
  }

  // التحقق من المخزون
  if(window.productsCache){
    const p = window.productsCache.find(x => x.id == id);
    if(p){
      const stock = parseInt(p.stock || p.quantity || p.stock_qty || 0);
      const newQty = item.qty + amount;
      
      if(newQty > stock){
        showNotification(`عذراً، الكمية المتاحة في المخزون هي ${stock} حبة فقط`, 'warning');
        return;
      }
    }
  }

  item.qty += amount;

  // التأكد من أن الكمية لا تقل عن 1
  if(item.qty < 1){
    item.qty = 1;
  }

  saveCart();
  renderCheckoutPage();
  updateCartIcon();          // ← تحديث عداد السلة
  refreshAllAddToCartButtons(); // ← تحديث أزرار إضافة للسلة
}


function removeItemCheckout(id){
  cart = cart.filter(p => p.id != id);

  saveCart();
  renderCheckoutPage();
  updateCartIcon();             // ← تحديث عداد السلة
  refreshAllAddToCartButtons(); // ← تحديث الأزرار
}


function pickLocation(){
  if (!navigator.geolocation) {
    alert("⚠️ متصفحك لا يدعم تحديد الموقع الجغرافي. يرجى تحديث المتصفح أو استخدام متصفح آخر.");
    return;
  }

  // إظهار رسالة للمستخدم
  const locationInput = document.getElementById("co_location");
  locationInput.value = "جاري تحديد الموقع...";
  locationInput.style.color = "#00AEEF";

  const options = {
    enableHighAccuracy: true,
    timeout: 15000, // 15 ثانية
    maximumAge: 0
  };

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      let link = `https://maps.google.com/?q=${lat},${lng}`;
      locationInput.value = link;
      locationInput.style.color = "#4caf50";
      
      // إظهار رسالة نجاح
      if(typeof showNotification === 'function') {
        showNotification("✓ تم تحديد الموقع بنجاح", 'success');
      } else {
        alert("✓ تم تحديد الموقع بنجاح");
      }
    },
    (error) => {
      let errorMsg = "حدث خطأ في تحديد الموقع: ";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg = "⚠️ تم رفض الوصول للموقع الجغرافي. يرجى السماح بالوصول للموقع في إعدادات المتصفح.";
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg = "⚠️ معلومات الموقع غير متاحة.";
          break;
        case error.TIMEOUT:
          errorMsg = "⚠️ انتهت مهلة تحديد الموقع. يرجى المحاولة مرة أخرى.";
          break;
        default:
          errorMsg = "⚠️ حدث خطأ غير معروف في تحديد الموقع.";
          break;
      }
      locationInput.value = "";
      locationInput.placeholder = errorMsg;
      locationInput.style.color = "#e74c3c";
      if(typeof showNotification === 'function') {
        showNotification(errorMsg, 'error');
      } else {
        alert(errorMsg);
      }
    },
    options
  );
}


async function loadWishlist(){
  const res = await fetch(API + "/api/admin/products");
  const allList = await res.json();
  
  // التأكد من أن جميع المنتجات لديها stock و quantity
  const all = allList.map(p => ({
    ...p,
    stock: parseInt(p.stock || p.quantity || 0),
    quantity: parseInt(p.quantity || p.stock || 0),
    stock_qty: parseInt(p.stock || p.quantity || 0) // للتوافق مع الكود القديم
  }));
  
  // تحديث productsCache
  window.productsCache = all;

  const favList = all.filter(p => wishlist.includes(p.id));

  const grid = document.getElementById("wishlistGrid");
  grid.innerHTML = "";

  if(favList.length === 0){
    grid.innerHTML = "<p>لا توجد منتجات في المفضّلة.</p>";
    return;
  }

  favList.forEach(p=>{
  grid.innerHTML += makeProductCard(p);
});

refreshAllAddToCartButtons();

}
async function loadTrackPage(orderId) {

  const infoBox = document.getElementById("trackInfo");
  const timelineBox = document.getElementById("timeline");
  const itemsBox = document.getElementById("trackItems");

  infoBox.innerHTML = "جاري التحميل...";
  timelineBox.innerHTML = "";
  itemsBox.innerHTML = "";

  const res = await fetch(`${API}/api/orders/${orderId}`);
  const data = await res.json();

  if (data.error) {
    infoBox.innerHTML = `<p style="color:red;">الطلب غير موجود</p>`;
    return;
  }

  const o = data.order;

  /* ================================
     🛠 إصلاح القيم قبل استخدامها
     ================================ */
  o.total = Number(o.total) || 0;
  o.shipping = Number(o.shipping) || 0;
  o.shipping_vat = Number(o.shipping_vat) || 0;
  o.total_with_shipping = Number(o.total_with_shipping) || (o.total + o.shipping + o.shipping_vat);

  if (o.status === "delivery") o.status = "delivery";

  const items = data.items || [];

  // ---- معلومات الطلب ----
  infoBox.innerHTML = `
    <p><b>رقم الطلب:</b> ${o.id}</p>
    <p><b>التاريخ:</b> ${o.date}</p>
    <p><b>الإجمالي:</b> ${o.total_with_shipping.toFixed(2)} ر.س</p>
  `;

  // ---- الحالات ----
  const steps = [
    { key:"new", text:"تم استلام الطلب" },
    { key:"processing", text:"جاري التجهيز" }, 
    { key:"completed", text:"جاهز" },
    { key:"out", text:"خرج للتوصيل" },
    { key:"delivery", text:"قيد التوصيل" },
    { key:"done", text:"تم التسليم" }, 
    { key:"cancelled", text:"تم الإلغاء" }
  ];

  let activeFound = true;

  steps.forEach(s => {
    let active = "";
    if (activeFound) active = "step-active";
    if (o.status === s.key) activeFound = false;

    timelineBox.innerHTML += `
      <div class="step-item ${active}">
        <div class="step-circle"></div>
        <div class="step-text">${s.text}</div>
      </div>
    `;
  });

  // ---- الأصناف ----
  items.forEach(i => {

    const lineTotal = Number(i.total) || 0;

    itemsBox.innerHTML += `
      <div class="item-card">
        <b>${i.name}</b> × ${i.qty}<br>
        السعر: ${lineTotal.toFixed(2)} ر.س
      </div>
    `;
  });
}




async function viewOrder(id){
  const res = await fetch(API + "/api/orders/" + id);
  const data = await res.json();

  if(data.error){
    alert("الطلب غير موجود");
    return;
  }

  let text = `
    رقم الطلب: ${data.order.id}\n
    التاريخ: ${data.order.date}\n
    الحالة: ${data.order.status}\n
    الإجمالي: ${data.order.total} ر.س\n\n
    --- المنتجات ---\n
  `;

  data.items.forEach(i=>{
    text += `${i.name} × ${i.qty}\n`;
  });

  alert(text);
}


async function fetchUserOrders(phone){
  const res = await fetch(API + "/api/orders?phone=" + phone);
  return await res.json();
}

function autoFillUserInCheckout() {
    if (window.user) {
        const nameInput = document.getElementById("co_name");
        const phoneInput = document.getElementById("co_phone");
        
        if(nameInput && phoneInput) {
            nameInput.value = window.user.name;
            phoneInput.value = window.user.phone;

            nameInput.setAttribute("readonly", true);
            phoneInput.setAttribute("readonly", true);
            
            // إضافة الكلاس الخاص للمربعات readonly
            nameInput.classList.add("checkout-readonly");
            phoneInput.classList.add("checkout-readonly");
        }
    } else {
        // إذا لم يكن مسجل دخول، إزالة readonly والكلاسات
        const nameInput = document.getElementById("co_name");
        const phoneInput = document.getElementById("co_phone");
        
        if(nameInput && phoneInput) {
            nameInput.removeAttribute("readonly");
            phoneInput.removeAttribute("readonly");
            
            nameInput.classList.remove("checkout-readonly");
            phoneInput.classList.remove("checkout-readonly");
            
            nameInput.value = "";
            phoneInput.value = "";
        }
    }
}



// زر الطباعة


async function loadInvoice(orderId){

  const invoiceBox = document.getElementById("invoiceBox");
  invoiceBox.innerHTML = "<p style='text-align:center;padding:40px;color:#8a004a;'>جاري تحميل البيانات...</p>";

  // جلب بيانات الطلب
  const orderRes = await fetch(`${API}/api/orders/${orderId}`);
  const orderData = await orderRes.json();

  if(orderData.error){
    invoiceBox.innerHTML = "<p style='color:red;text-align:center;padding:40px;font-size:18px;'>❌ الطلب غير موجود</p>";
    return;
  }

  const o = orderData.order;

  // جلب الأصناف كاملة (مع الأسعار + الصور + الأكواد)
  const itemsRes = await fetch(`${API}/api/order_items_full/${orderId}`);
  const items = await itemsRes.json();

  let itemsHTML = "";
  let subtotal = 0;

  items.forEach((i, index) => {
    subtotal += i.total;

    const isEven = index % 2 === 0;
    itemsHTML += `
      <tr style="background:${isEven ? '#fafafa' : '#ffffff'};transition:background 0.2s;">
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;font-weight:500;color:#333;">${escapeHtml(i.name)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">
          <span style="background:#f0f0f0;padding:4px 12px;border-radius:20px;font-weight:600;">${i.qty}</span>
        </td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.base_price.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.price_after_discount.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;color:#666;">${i.price_with_vat.toFixed(2)}</td>
        <td style="padding:15px;border-bottom:1px solid #e0e0e0;text-align:center;font-weight:700;color:#8a004a;">${i.total.toFixed(2)} ر.س</td>
      </tr>
    `;
  });

  // حساب الإجماليات
  const shipping = parseFloat(o.shipping) || 0;
  const shippingVat = parseFloat(o.shipping_vat) || 0;
  const finalTotal = parseFloat(o.total_with_shipping) || 0;

  const html = `
    <div style="
      background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
      padding:30px;
      border-radius:15px 15px 0 0;
      margin:-20px -20px 30px -20px;
      color:#fff;
      text-align:center;
    ">
      <div style="font-size:48px;margin-bottom:10px;">🧾</div>
      <h2 style="margin:0;font-size:28px;font-weight:800;color:#fff;">فاتورة الطلب</h2>
      <p style="margin:10px 0 0 0;opacity:0.9;font-size:16px;">Invoice #${o.id}</p>
    </div>

    <div style="
      background:#f8f9fa;
      padding:25px;
      border-radius:12px;
      margin-bottom:25px;
      border-right:4px solid #8a004a;
    ">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;">
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">📋 رقم الطلب</div>
          <div style="font-size:18px;font-weight:700;color:#8a004a;">#${o.id}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">📅 التاريخ</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${o.date}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">👤 اسم العميل</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${escapeHtml(o.customer_name)}</div>
        </div>
        <div style="background:#fff;padding:15px;border-radius:10px;">
          <div style="font-size:14px;color:#999;margin-bottom:8px;">📞 رقم الجوال</div>
          <div style="font-size:18px;font-weight:700;color:#333;">${escapeHtml(o.customer_phone)}</div>
        </div>
      </div>
      <div style="background:#fff;padding:15px;border-radius:10px;margin-top:15px;">
        <div style="font-size:14px;color:#999;margin-bottom:8px;">📍 العنوان</div>
        <div style="font-size:16px;font-weight:600;color:#333;line-height:1.6;">${escapeHtml(o.customer_address)}</div>
      </div>
    </div>

    <div style="margin-bottom:25px;">
      <h3 style="
        color:#8a004a;
        font-size:22px;
        font-weight:800;
        margin:0 0 20px 0;
        padding-bottom:15px;
        border-bottom:3px solid #8a004a;
        display:inline-block;
      ">🛍️ تفاصيل المنتجات</h3>
      
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
      <thead>
            <tr style="background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);color:#fff;">
              <th style="padding:18px;text-align:right;font-weight:700;font-size:15px;">الصنف</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">الكمية</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">السعر الأساسي</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">بعد الخصم</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">بعد الضريبة</th>
              <th style="padding:18px;text-align:center;font-weight:700;font-size:15px;">الإجمالي</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>
      </div>
    </div>

    <div style="
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding:25px;
      border-radius:12px;
      margin-top:30px;
    ">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #ddd;">
        <span style="font-size:16px;color:#666;font-weight:600;">💰 إجمالي المنتجات:</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${subtotal.toFixed(2)} ر.س</span>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #ddd;">
        <span style="font-size:16px;color:#666;font-weight:600;">🚚 تكلفة الشحن:</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${shipping.toFixed(2)} ر.س</span>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:2px solid #8a004a;">
        <span style="font-size:16px;color:#666;font-weight:600;">📊 ضريبة الشحن (15%):</span>
        <span style="font-size:18px;font-weight:700;color:#333;">${shippingVat.toFixed(2)} ر.س</span>
      </div>
      
      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:20px 0 0 0;
        margin-top:15px;
      ">
        <span style="font-size:24px;font-weight:800;color:#8a004a;">✨ الإجمالي النهائي:</span>
        <span style="
          font-size:32px;
          font-weight:900;
          color:#8a004a;
          background:linear-gradient(135deg, #8a004a 0%, #E91E63 100%);
          -webkit-background-clip:text;
          -webkit-text-fill-color:transparent;
          background-clip:text;
        ">${finalTotal.toFixed(2)} ر.س</span>
      </div>
    </div>

    <div style="
      text-align:center;
      margin-top:30px;
      padding:20px;
      background:#f0f4ff;
      border-radius:12px;
      border:2px dashed #8a004a;
    ">
      <div style="font-size:16px;color:#8a004a;font-weight:600;">
        ✅ شكراً لك على ثقتك بنا
      </div>
      <div style="font-size:14px;color:#666;margin-top:8px;">
        سيتم التواصل معك قريباً لتأكيد الطلب
      </div>
    </div>
  `;

  invoiceBox.innerHTML = html;
}


function logoutUser() {
  // حذف بيانات المستخدم من التخزين
  localStorage.removeItem("user");
  window.user = null;

  alert("✔ تم تسجيل الخروج بنجاح");

  // تحديث رابط الحساب في الهيدر
  updateHeaderProfile();

  // الانتقال لصفحة تسجيل الدخول
  go("login");
}

  // ====================== إرسال كود نسيان الباسورد ======================
async function sendResetCode() {
  const email = fpEmail.value.trim();

  const res = await fetch(API + "/api/forgot", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  const data = await res.json();

  if (!data.success) {
    fpMsg.innerText = "❌ " + data.message;
    return;
  }

  alert("✔ تم إرسال كود الاستعادة إلى بريدك الإلكتروني");
  rpEmail.value = email;
  go("reset");
}


// ====================== إعادة ضبط كلمة المرور ======================
async function resetPassword() {
  const email = rpEmail.value.trim();
  const code = rpCode.value.trim();
  const new_password = rpPass.value.trim();

  const res = await fetch(API + "/api/reset-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, code, new_password })
  });

  const data = await res.json();

  if (!data.success) {
    rpMsg.innerText = "❌ " + data.message;
    return;
  }

  alert("✔ تم تغيير كلمة المرور بنجاح!");
  go("login");
}


// ====================== تفعيل الحساب ======================
async function verifyAccount(){
  const phone = document.getElementById("vPhone").value.trim();
  const code  = document.getElementById("vCode").value.trim();
  const verifyMsg = document.getElementById("verifyMsg");

  if (!code || code.length !== 6) {
    verifyMsg.innerText = "❌ يرجى إدخال كود التفعيل المكون من 6 أرقام";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    return;
  }

  try {
  const res = await fetch(API + "/api/verify", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone, code })
  });

    if (!res.ok) {
      throw new Error("Network error");
    }

  const data = await res.json();

  if(!data.success){
      verifyMsg.innerText = "❌ كود التفعيل غير صحيح. يرجى المحاولة مرة أخرى";
      verifyMsg.style.color = "#e74c3c";
      verifyMsg.style.display = "block";
      // مسح الحقل لإعادة المحاولة
      document.getElementById("vCode").value = "";
      document.getElementById("vCode").focus();
    return;
  }

    verifyMsg.innerHTML = "✔ تم تفعيل الحساب بنجاح — سيتم تحويلك الآن...";
    verifyMsg.style.color = "#4caf50";
    verifyMsg.style.display = "block";

  setTimeout(()=>{
    go("login");
    }, 1500);
  } catch (error) {
    verifyMsg.innerText = "❌ حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    console.error("Verification error:", error);
  }
}


//=================== تايمر رسالة التفعيل ======================
let verifyTimer = null;
function startVerifyTimer(){
  let sec = 60;
  const resendBox = document.getElementById("resendBox");
  const timerBox = document.getElementById("timerBox");
  const timer = document.getElementById("timer");
  
  if (resendBox) resendBox.style.display = "none";
  if (timerBox) timerBox.style.display = "inline";

  if (timer) timer.innerText = sec;

  if (verifyTimer) {
    clearInterval(verifyTimer);
  }

  verifyTimer = setInterval(()=>{
    sec--;
    if (timer) timer.innerText = sec;

    if(sec <= 0){
      clearInterval(verifyTimer);
      if (timerBox) timerBox.style.display = "none";
      if (resendBox) resendBox.style.display = "inline";
    }
  },1000);
}
// =================== اعادة ارسال الكود =========================
async function resendVerifyCode(){
  const phone = document.getElementById("vPhone").value;
  const verifyMsg = document.getElementById("verifyMsg");

  if (!phone) {
    verifyMsg.innerText = "❌ رقم الجوال غير موجود";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    return false;
  }

  try {
  const res = await fetch(API + "/api/resend-verify", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone })
  });

    if (!res.ok) {
      throw new Error("Network error");
    }

  const data = await res.json();

  if(data.success){
      verifyMsg.innerHTML = "✔ تم إرسال كود جديد إلى بريدك الإلكتروني";
      verifyMsg.style.color = "#4caf50";
      verifyMsg.style.display = "block";
    startVerifyTimer();
      // مسح الحقل القديم
      document.getElementById("vCode").value = "";
      document.getElementById("vCode").focus();
  } else {
      verifyMsg.innerText = "❌ " + (data.message || "حدث خطأ في إرسال الكود");
      verifyMsg.style.color = "#e74c3c";
      verifyMsg.style.display = "block";
    }
  } catch (error) {
    verifyMsg.innerText = "❌ حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى";
    verifyMsg.style.color = "#e74c3c";
    verifyMsg.style.display = "block";
    console.error("Resend code error:", error);
  }
  
  return false;
}



// ===================== تحديث رابط الحساب في الهيدر =====================
function updateHeaderProfile() {
  const profileLink = document.getElementById("profileLink");
  const mobileProfileLink = document.getElementById("mobileProfileLink");
  
  // استخراج الاسم الأول من الاسم الكامل
  function getFirstName(fullName) {
    if (!fullName) return "";
    // تقسيم الاسم والحصول على أول كلمة
    const parts = fullName.trim().split(/\s+/);
    return parts[0] || fullName;
  }
  
  if (profileLink) {
    const nameText = profileLink.querySelector(".profile-name-text");
    if (window.user && window.user.name) {
      const firstName = getFirstName(window.user.name);
      if (nameText) {
        nameText.textContent = firstName;
    } else {
        profileLink.innerHTML = `
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">${firstName}</span>
        `;
      }
      profileLink.classList.add("logged-in");
    } else {
      if (nameText) {
        nameText.textContent = "حسابي";
      } else {
        profileLink.innerHTML = `
          <span class="profile-icon-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <span class="profile-name-text">حسابي</span>
        `;
      }
      profileLink.classList.remove("logged-in");
    }
  }
  
  if (mobileProfileLink) {
    const nameText = mobileProfileLink.querySelector(".mobile-profile-name");
    if (window.user && window.user.name) {
      const firstName = getFirstName(window.user.name);
      if (nameText) {
        nameText.textContent = firstName;
    } else {
        mobileProfileLink.innerHTML = `
          <span class="mobile-profile-icon">👤</span>
          <span class="mobile-profile-name">${firstName}</span>
        `;
      }
      mobileProfileLink.classList.add("logged-in");
    } else {
      if (nameText) {
        nameText.textContent = "حسابي";
      } else {
        mobileProfileLink.innerHTML = `
          <span class="mobile-profile-icon">👤</span>
          <span class="mobile-profile-name">حسابي</span>
        `;
      }
      mobileProfileLink.classList.remove("logged-in");
    }
  }
}

// ===================== القائمة المنسدلة للجوال =====================
function toggleMobileMenu() {
  const menu = document.getElementById("mobileMenu");
  if (menu) {
    menu.classList.toggle("active");
  }
}

// إغلاق القائمة عند الضغط خارجها
document.addEventListener("click", function(e) {
  const menu = document.getElementById("mobileMenu");
  const menuBtn = document.querySelector(".mobile-menu-btn");
  
  if (menu && menuBtn && !menu.contains(e.target) && !menuBtn.contains(e.target)) {
    menu.classList.remove("active");
  }
});

// ===================== تحديث عداد المفضلة =====================
function updateWishlistCount() {
  const countBadge = document.getElementById("wishlistCount");
  const mobileCountBadge = document.getElementById("mobileWishlistCount");
  
  const count = wishlist.length;
  
  if (countBadge) {
    if (count > 0) {
      countBadge.innerText = count;
      countBadge.style.display = "inline-block";
    } else {
      countBadge.style.display = "none";
    }
  }
  
  if (mobileCountBadge) {
    if (count > 0) {
      mobileCountBadge.innerText = count;
      mobileCountBadge.style.display = "inline-block";
    } else {
      mobileCountBadge.style.display = "none";
    }
  }
}

// ===================== تحميل محتوى الصفحات القانونية =====================
async function loadPageContent(pageType) {
  try {
    const res = await fetch(API + "/api/pages/" + pageType);
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("pageContentTitle").innerText = "خطأ";
      document.getElementById("pageContentBody").innerHTML = "<p>حدث خطأ في تحميل المحتوى</p>";
      return;
    }

    document.getElementById("pageContentTitle").innerText = data.title || "الصفحة";
    
    // إذا كانت صفحة FAQ، عرض الأسئلة بشكل منظم
    if (pageType === "faq") {
      try {
        const parsed = JSON.parse(data.content);
        if (parsed.questions && Array.isArray(parsed.questions)) {
          let html = '<div style="margin-top:30px;">';
          parsed.questions.forEach((item, index) => {
            html += `
              <div style="margin-bottom:25px;padding:25px;background:#f8f9fa;border-radius:12px;border-right:4px solid #8a004a;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <h3 style="color:#8a004a;margin-bottom:15px;font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px;">
                  <span style="background:#8a004a;color:#fff;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;">${index + 1}</span>
                  ${escapeHtml(item.question)}
                </h3>
                <p style="color:#555;line-height:1.9;font-size:16px;margin:0;padding-right:45px;">${escapeHtml(item.answer)}</p>
              </div>
            `;
          });
          html += '</div>';
          document.getElementById("pageContentBody").innerHTML = html;
        } else {
          document.getElementById("pageContentBody").innerHTML = data.content || "<p>لا يوجد محتوى</p>";
        }
      } catch (e) {
        // إذا لم يكن JSON، عرض المحتوى كما هو
        document.getElementById("pageContentBody").innerHTML = data.content || "<p>لا يوجد محتوى</p>";
      }
    } else {
      // للصفحات الأخرى، عرض المحتوى HTML مباشرة
      document.getElementById("pageContentBody").innerHTML = data.content || "<p>لا يوجد محتوى</p>";
    }
    
    // التمرير للأعلى
    window.scrollTo(0, 0);
  } catch (error) {
    console.error("خطأ في تحميل المحتوى:", error);
    document.getElementById("pageContentTitle").innerText = "خطأ";
    document.getElementById("pageContentBody").innerHTML = "<p>حدث خطأ في تحميل المحتوى</p>";
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===================== إرسال الشكوى =====================
async function submitComplaint(event) {
  event.preventDefault();
  
  const email = document.getElementById("complaintEmail").value.trim();
  const subject = document.getElementById("complaintSubject").value.trim();
  const message = document.getElementById("complaintMessage").value.trim();
  
  if (!email || !subject || !message) {
    alert("⚠️ يرجى ملء جميع الحقول");
    return;
  }
  
  // تعطيل الزر أثناء الإرسال
  const submitBtn = event.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerText;
  submitBtn.disabled = true;
  submitBtn.innerText = "جاري الإرسال...";
  
  try {
    const res = await fetch(API + "/api/complaints", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ email, subject, message })
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.success) {
      alert("✅ تم إرسال شكواك بنجاح! سنتواصل معك قريباً.");
      document.getElementById("quickSupportForm").reset();
    } else {
      alert("❌ حدث خطأ أثناء الإرسال: " + (data.error || "خطأ غير معروف"));
    }
  } catch (error) {
    console.error("خطأ:", error);
    alert("❌ حدث خطأ في الاتصال بالسيرفر. يرجى المحاولة مرة أخرى.");
  } finally {
    // إعادة تفعيل الزر
    submitBtn.disabled = false;
    submitBtn.innerText = originalText;
  }
}

// تحميل السوشيال ميديا في الفوتر
async function loadFooterSocialMedia() {
  try {
    const res = await fetch(API + "/api/social-media");
    const socialMedia = await res.json();
    
    const container = document.getElementById("footerSocialMedia");
    if (!container) return;
    
    if (socialMedia.length === 0) {
      container.innerHTML = "";
      return;
    }
    
    container.innerHTML = socialMedia.map(sm => `
      <a href="${sm.url}" 
         target="_blank" 
         rel="noopener noreferrer"
         class="social-media-icon"
         title="${sm.platform}"
         style="
           display:flex;
           align-items:center;
           justify-content:center;
           width:40px;
           height:40px;
           border-radius:50%;
           background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           text-decoration:none;
           transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
           box-shadow:0 2px 8px rgba(0,0,0,0.1);
           overflow:hidden;
         "
         onmouseover="this.style.transform='scale(1.15) translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(138, 0, 74, 0.3)'"
         onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
        ${sm.icon_url ? `
          <img src="${sm.icon_url}" 
               alt="${sm.platform}" 
               style="width:24px;height:24px;object-fit:contain;"
               onerror="this.style.display='none'; this.parentElement.innerHTML='🔗';">
        ` : '🔗'}
      </a>
    `).join('');
  } catch (error) {
    console.error("Error loading social media:", error);
  }
}

window.onload = async () => {
  // إخفاء صفحة Loading بعد تحميل كل شيء
  const loader = document.getElementById("pageLoader");
  
  // مسح حقول البحث لمنع ملء رقم الهاتف تلقائياً
  const headerSearch = document.getElementById("headerSearch");
  const headerSearchMobile = document.getElementById("headerSearchMobile");
  if(headerSearch) headerSearch.value = "";
  if(headerSearchMobile) headerSearchMobile.value = "";
  
  try {
    await loadProductsCache(true);   // ← إعادة تحميل قسري للتأكد من أحدث بيانات المخزون
  renderCart();
  updateCartIcon();
  refreshAllAddToCartButtons();
  updateHeaderProfile(); // تحديث رابط الحساب
  updateWishlistCount(); // تحديث عداد المفضلة
    loadFooterSocialMedia(); // تحميل السوشيال ميديا
  
  // قراءة الـ hash من URL لاستعادة الصفحة الحالية بعد reload
  const hash = window.location.hash;
  let targetPage = "home";
  let targetData = null;
  
  if(hash && hash.length > 1) {
    // إزالة # من البداية
    const hashPath = hash.substring(1);
    const parts = hashPath.split('/');
    targetPage = parts[0];
    if(parts.length > 1) {
      const dataValue = parts[1];
      // تحويل إلى رقم إذا كانت الصفحة تتطلب رقم (مثل product, brand, category)
      if(targetPage === "product" || targetPage === "brand" || targetPage === "category" || targetPage === "track") {
        targetData = parseInt(dataValue);
        if(isNaN(targetData)) {
          targetData = dataValue; // إذا فشل التحويل، استخدم القيمة الأصلية
        }
      } else {
        targetData = dataValue;
      }
    }
  }
  
  // إظهار الصفحة المناسبة
  setTimeout(() => {
    // إخفاء جميع الصفحات أولاً - الاعتماد على CSS فقط
    document.querySelectorAll(".page").forEach(p => {
      p.classList.remove("active");
      p.style.removeProperty("display"); // إزالة أي inline styles
    });
    
    // استدعاء go() لإظهار الصفحة المناسبة (من الـ hash أو الرئيسية)
    go(targetPage, targetData, true); // true = بدون حفظ في السجل لأننا نستعيد الصفحة
  }, 100);
    
    // إخفاء الـ loader بعد تأخير قصير لضمان تحميل كل شيء
    setTimeout(() => {
      if(loader) {
        loader.classList.add("hidden");
        // إزالة العنصر من DOM بعد انتهاء الانتقال
        setTimeout(() => {
          if(loader && loader.parentNode) {
            loader.parentNode.removeChild(loader);
          }
        }, 500);
      }
    }, 800);
  } catch(error) {
    console.error("Error loading page:", error);
    // إخفاء الـ loader حتى في حالة الخطأ
    if(loader) {
      setTimeout(() => {
        loader.classList.add("hidden");
        setTimeout(() => {
          if(loader && loader.parentNode) {
            loader.parentNode.removeChild(loader);
          }
        }, 500);
      }, 1000);
    }
  }
};

function printInvoice() {
    const invoiceHTML = document.getElementById("invoiceBox").innerHTML;

    const printWin = window.open("", "_blank", "width=900,height=1200");

    printWin.document.open();
    printWin.document.write(`
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>فاتورة الطلب</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

      <style>
        @page {
          size: A4;
          margin: 15mm;
        }

        body {
          font-family: 'Cairo', 'Tajawal', sans-serif;
          background: #fff;
          direction: rtl;
          text-align: right;
          padding: 20px;
          color: #333;
          line-height: 1.6;
        }

        .invoice-wrapper {
          width: 100%;
        }

        .header {
          text-align: center;
          margin-bottom: 20px;
        }

        .header h1 {
          color: #8a004a;
          margin-bottom: 5px;
          font-size: 26px;
          font-weight: 900;
        }

        .header .sub {
          font-size: 14px;
          color: #777;
        }

        .section-title {
          font-size: 20px;
          margin: 18px 0 8px;
          color: #8a004a;
          font-weight: 800;
          border-right: 5px solid #8a004a;
          padding-right: 8px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
        }

        th {
          background: #8a004a !important;
          color: #fff !important;
          padding: 10px 8px;
          border: 1px solid #8a004a;
          font-size: 12px;
          font-weight: 700;
        }

        td {
          padding: 10px 8px;
          border: 1px solid #ddd;
          font-size: 12px;
        }

        tr:nth-child(even) {
          background: #fafafa;
        }

        .totals {
          margin-top: 25px;
          font-size: 16px;
          line-height: 1.8;
        }

        .totals div {
          display: flex;
          justify-content: space-between;
          margin: 4px 0;
        }

        .grand-total {
          text-align: center;
          margin-top: 15px;
          font-size: 24px;
          color: #8a004a;
          font-weight: 900;
        }

        .footer {
          text-align: center;
          margin-top: 30px;
          font-size: 14px;
          color: #888;
        }

      </style>
    </head>

    <body>

      <div class="invoice-wrapper">

        ${invoiceHTML}

        <div class="footer" style="text-align:center;margin-top:40px;padding-top:20px;border-top:2px dashed #8a004a;font-size:13px;color:#666;">
          <div style="margin-bottom:10px;font-weight:700;color:#8a004a;">شكراً لتسوقكم معنا ❤️</div>
          <div style="color:#999;font-size:12px;">للاستفسار والتواصل: يمكنكم التواصل معنا عبر وسائل التواصل المتاحة</div>
        </div>

      </div>

    </body>
    </html>
    `);

    printWin.document.close();

    printWin.onload = () => {
        printWin.focus();
        printWin.print();
    };
}


</script>


<!-- ========================= سيضاف هنا: كود API + كود السلة + كود الصفحات ========================= -->


</body>
</html>

