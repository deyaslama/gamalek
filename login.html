<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تسجيل الدخول – لوحة التحكم</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body {
    margin:0;
    height:100vh;
    background:#065f6a;
    font-family:'Cairo',sans-serif;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
}

.login-box {
    width:380px;
    background:white;
    color:#333;
    padding:32px;
    border-radius:14px;
    box-shadow:0 4px 16px rgba(0,0,0,0.25);
}

.login-box h2 {
    margin:0 0 25px 0;
    text-align:center;
    font-size:28px;
    color:#065f6a;
}

.input {
    width:93%;
    padding:13px;
    border-radius:8px;
    border:1px solid #bbb;
    margin-bottom:14px;
    font-size:15px;
}

.btn {
    width:100%;
    padding:13px;
    background:#065f6a;
    border:none;
    color:white;
    border-radius:8px;
    font-size:17px;
    cursor:pointer;
    margin-top:10px;
}

.btn:hover { background:#05464e; }

#error {
    margin-top:10px;
    text-align:center;
    color:#d62828;
    font-size:15px;
    display:none;
}
</style>
</head>

<body>

<div class="login-box">

    <h2>تسجيل الدخول</h2>

    <input id="username" class="input" placeholder="اسم المستخدم">
    <input id="password" class="input" type="password" placeholder="كلمة المرور">

    <button class="btn" onclick="login()">دخول</button>

    <div id="error">❌ اسم المستخدم أو كلمة المرور غير صحيحة</div>

</div>

<script>
const API = window.location.origin;

// التحقق من حالة تسجيل الدخول عند تحميل الصفحة
async function checkAuth() {
    try {
        const response = await fetch(API + "/api/admin/check-auth", {
            credentials: "include"
        });
        const data = await response.json();
        
        if (data.success && data.authenticated) {
            window.location.href = window.location.origin + "/layout.html";
        }
    } catch (error) {
        console.error("خطأ في التحقق من الجلسة:", error);
    }
}

// التحقق عند تحميل الصفحة
checkAuth();

/* تسجيل دخول */
async function login() {
    let user = document.getElementById("username").value.trim();
    let pass = document.getElementById("password").value.trim();
    let err = document.getElementById("error");
    let btn = document.querySelector(".btn");

    if (!user || !pass) {
        err.textContent = "❌ يرجى إدخال اسم المستخدم وكلمة المرور";
        err.style.display = "block";
        return;
    }

    // تعطيل الزر أثناء المعالجة
    btn.disabled = true;
    btn.textContent = "جاري تسجيل الدخول...";

    try {
        const response = await fetch(API + "/api/admin/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            credentials: "include",
            body: JSON.stringify({
                username: user,
                password: pass
            })
        });

        const data = await response.json();

        if (data.success) {
            // تسجيل الدخول ناجح - إعادة التوجيه
            window.location.href = window.location.origin + "/layout.html";
        } else {
            // فشل تسجيل الدخول
            err.textContent = "❌ " + (data.message || "اسم المستخدم أو كلمة المرور غير صحيحة");
            err.style.display = "block";
            btn.disabled = false;
            btn.textContent = "دخول";
        }
    } catch (error) {
        console.error("خطأ في تسجيل الدخول:", error);
        err.textContent = "❌ حدث خطأ في الاتصال بالسيرفر";
        err.style.display = "block";
        btn.disabled = false;
        btn.textContent = "دخول";
    }
}

// السماح بالضغط على Enter لتسجيل الدخول
document.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        login();
    }
});

</script>

</body>
</html>
