<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Øª Ø§Ù„Ø¯Ø¹Ù… â€“ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Cairo',sans-serif;
  background:#f5f7fa;
  color:#333;
  margin:0;
  padding:20px;
}

.main{
  max-width:1400px;
  margin:0 auto;
  background:#fff;
  padding:30px;
  border-radius:12px;
  box-shadow:0 2px 12px rgba(0,0,0,0.08);
}

.header{
  margin-bottom:30px;
  padding-bottom:20px;
  border-bottom:3px solid #065f6a;
}

.header h1{
  color:#065f6a;
  font-size:28px;
  font-weight:700;
}

.chat-container{
  display:flex;
  gap:20px;
  height:calc(100vh - 200px);
  min-height:600px;
}

.chats-list{
  width:350px;
  border:2px solid #e0e0e0;
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  background:#fff;
}

.chats-header{
  background:linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
  color:#fff;
  padding:15px;
  font-weight:700;
  font-size:18px;
}

.chats-scroll{
  flex:1;
  overflow-y:auto;
  padding:10px;
}

.chat-item{
  padding:15px;
  border-bottom:1px solid #e0e0e0;
  cursor:pointer;
  transition:all 0.2s;
  border-radius:8px;
  margin-bottom:8px;
}

.chat-item:hover{
  background:#f8f9fa;
}

.chat-item.active{
  background:#e3f2fd;
  border:2px solid #065f6a;
}

.chat-item-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.chat-user-name{
  font-weight:700;
  color:#065f6a;
  font-size:16px;
}

.chat-unread-badge{
  background:#e74c3c;
  color:#fff;
  padding:2px 8px;
  border-radius:12px;
  font-size:12px;
  font-weight:700;
}

.chat-last-message{
  color:#666;
  font-size:14px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  margin-bottom:5px;
}

.chat-time{
  color:#999;
  font-size:12px;
}

.chat-status{
  display:inline-block;
  padding:3px 8px;
  border-radius:6px;
  font-size:11px;
  font-weight:700;
  margin-top:5px;
}

.chat-status.open{
  background:#4caf50;
  color:#fff;
}

.chat-status.closed{
  background:#999;
  color:#fff;
}

.messages-area{
  flex:1;
  border:2px solid #e0e0e0;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  background:#fff;
  overflow:hidden;
}

.messages-header{
  background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);
  color:#fff;
  padding:15px 20px;
  font-weight:700;
  font-size:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.messages-scroll{
  flex:1;
  overflow-y:auto;
  padding:20px;
  background:#f8f9fa;
}

.message{
  display:flex;
  margin-bottom:15px;
  align-items:flex-start;
}

.message.user{
  justify-content:flex-end;
}

.message.admin{
  justify-content:flex-start;
}

.message-bubble{
  max-width:70%;
  padding:12px 16px;
  border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

.message.user .message-bubble{
  background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);
  color:#fff;
  border-radius:16px 16px 0 16px;
}

.message.admin .message-bubble{
  background:#e0e0e0;
  color:#333;
  border-radius:16px 16px 16px 0;
}

.message-text{
  font-size:14px;
  line-height:1.5;
  word-wrap:break-word;
  margin-bottom:5px;
}

.message-time{
  font-size:11px;
  opacity:0.7;
  text-align:right;
}

.message-input-area{
  padding:15px;
  border-top:2px solid #e0e0e0;
  display:flex;
  gap:10px;
}

.message-input{
  flex:1;
  padding:12px;
  border:2px solid #e0e0e0;
  border-radius:8px;
  font-size:14px;
  font-family:'Cairo',sans-serif;
}

.btn-send{
  padding:12px 25px;
  background:linear-gradient(135deg, #8a004a 0%, #6a0038 100%);
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  transition:all 0.3s;
}

.btn-send:hover{
  opacity:0.9;
  transform:translateY(-2px);
}

.btn-close{
  padding:8px 15px;
  background:#e74c3c;
  color:#fff;
  border:none;
  border-radius:6px;
  font-size:12px;
  font-weight:700;
  cursor:pointer;
}

.empty-state{
  text-align:center;
  color:#999;
  padding:40px;
  font-size:16px;
}

.filter-buttons{
  display:flex;
  gap:10px;
  margin-bottom:20px;
}

.filter-btn{
  padding:10px 20px;
  border:2px solid #065f6a;
  background:#fff;
  color:#065f6a;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.3s;
}

.filter-btn.active{
  background:#065f6a;
  color:#fff;
}

.filter-btn:hover{
  background:#065f6a;
  color:#fff;
}
</style>
</head>
<body>

<div class="main">
  <div class="header">
    <h1>ğŸ’¬ Ø´Ø§Øª Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h1>
  </div>

  <div class="filter-buttons">
    <button class="filter-btn active" onclick="filterChats('all')">Ø§Ù„ÙƒÙ„</button>
    <button class="filter-btn" onclick="filterChats('open')">Ù…ÙØªÙˆØ­Ø©</button>
    <button class="filter-btn" onclick="filterChats('closed')">Ù…ØºÙ„Ù‚Ø©</button>
  </div>

  <div class="chat-container">
    <div class="chats-list">
      <div class="chats-header">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
      <div class="chats-scroll" id="chatsList">
        <div class="empty-state">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>

    <div class="messages-area">
      <div class="messages-header">
        <span id="currentChatTitle">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
        <div style="display:flex;gap:10px;">
          <button class="btn-close" id="closeChatBtn" onclick="closeCurrentChat()" style="display:none;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª</button>
          <button class="btn-delete" id="deleteChatBtn" onclick="deleteCurrentChat()" style="display:none;padding:8px 15px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
      <div class="messages-scroll" id="messagesArea">
        <div class="empty-state">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      </div>
      <div class="message-input-area" id="messageInputArea" style="display:none;">
        <input type="text" class="message-input" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="btn-send" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<script>
// Load BASE_URL dynamically
let API = window.location.origin; // Use current origin as default
(async function() {
  try {
    const response = await fetch("/api/config", { credentials: "include" });
    const config = await response.json();
    if (config.baseUrl) API = config.baseUrl;
  } catch (error) {
    console.warn("Could not load BASE_URL from config, using current origin:", error);
    API = window.location.origin;
  }
  // Load chats after API is ready
  loadChats();
})();
let allChats = [];
let currentChatId = null;
let currentFilter = 'all';
let messagePollInterval = null;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§ØªØ§Øª
async function loadChats() {
  try {
    const res = await fetch(API + "/api/admin/support/chats", {
      credentials: 'include'
    });
    const data = await res.json();
    
    if (data.success) {
      allChats = data.chats;
      renderChats();
    } else {
      alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§ØªØ§Øª");
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

// ØªØµÙÙŠØ© Ø§Ù„Ø´Ø§ØªØ§Øª
function filterChats(status) {
  currentFilter = status;
  
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderChats();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§ØªØ§Øª
function renderChats() {
  const container = document.getElementById("chatsList");
  
  let filtered = allChats;
  if (currentFilter === 'open') {
    filtered = allChats.filter(c => c.status === 'open');
  } else if (currentFilter === 'closed') {
    filtered = allChats.filter(c => c.status === 'closed');
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>`;
    return;
  }
  
  container.innerHTML = "";
  filtered.forEach(chat => {
    const lastMessage = chat.last_message || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„";
    const lastMessageTime = chat.last_message_time ? new Date(chat.last_message_time).toLocaleString('ar-SA') : "";
    const unreadCount = chat.unread_count || 0;
    
    container.innerHTML += `
      <div class="chat-item ${currentChatId === chat.id ? 'active' : ''}" onclick="openChat(${chat.id})">
        <div class="chat-item-header">
          <div class="chat-user-name">${escapeHtml(chat.user_name || chat.user_phone)}</div>
          ${unreadCount > 0 ? `<span class="chat-unread-badge">${unreadCount}</span>` : ''}
        </div>
        <div class="chat-last-message">${escapeHtml(lastMessage)}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span class="chat-time">${lastMessageTime}</span>
          <span class="chat-status ${chat.status}">${chat.status === 'open' ? 'Ù…ÙØªÙˆØ­' : 'Ù…ØºÙ„Ù‚'}</span>
        </div>
      </div>
    `;
  });
}

// ÙØªØ­ Ø´Ø§Øª
async function openChat(chatId) {
  currentChatId = chatId;
  renderChats();
  
  const chat = allChats.find(c => c.id === chatId);
  document.getElementById("currentChatTitle").textContent = `ğŸ’¬ ${chat.user_name || chat.user_phone}`;
  
  updateChatUI();
  
  await loadMessages();
  startMessagePolling();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
async function loadMessages() {
  if (!currentChatId) return;
  
  try {
    const res = await fetch(API + `/api/admin/support/chat/${currentChatId}/messages`, {
      credentials: 'include'
    });
    const data = await res.json();
    
    if (data.success) {
      renderMessages(data.messages);
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø§ØªØ§Øª Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
      await loadChats();
    } else {
      alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„");
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function renderMessages(messages) {
  const container = document.getElementById("messagesArea");
  
  if (messages.length === 0) {
    container.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</div>`;
    return;
  }
  
  let html = "";
  messages.forEach(msg => {
    const isAdmin = msg.sender_type === "admin";
    const time = new Date(msg.created_at).toLocaleTimeString("ar-SA", {
      hour: "2-digit",
      minute: "2-digit"
    });
    
    html += `
      <div class="message ${isAdmin ? 'admin' : 'user'}">
        <div class="message-bubble">
          <div class="message-text">${escapeHtml(msg.message)}</div>
          <div class="message-time">${time}</div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.scrollTop = container.scrollHeight;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
async function sendMessage() {
  if (!currentChatId) return;
  
  const input = document.getElementById("messageInput");
  const message = input.value.trim();
  
  if (!message) return;
  
  input.value = "";
  
  try {
    const res = await fetch(API + `/api/admin/support/chat/${currentChatId}/messages`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: 'include',
      body: JSON.stringify({ message })
    });
    
    const data = await res.json();
    if (data.success) {
      await loadMessages();
      await loadChats();
    } else {
      alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + (data.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª
async function closeCurrentChat() {
  if (!currentChatId) return;
  
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§ØªØŸ")) return;
  
  try {
    const res = await fetch(API + `/api/admin/support/chat/${currentChatId}/close`, {
      method: "PUT",
      credentials: 'include'
    });
    
    const data = await res.json();
    if (data.success) {
      await loadChats();
      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
      const chat = allChats.find(c => c.id === currentChatId);
      if (chat) {
        chat.status = 'closed';
        updateChatUI();
      }
    } else {
      alert("Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª");
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

// Ø­Ø°Ù Ø§Ù„Ø´Ø§Øª
async function deleteCurrentChat() {
  if (!currentChatId) return;
  
  if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§ØªØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§Øª ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) return;
  
  try {
    const res = await fetch(API + `/api/admin/support/chat/${currentChatId}`, {
      method: "DELETE",
      credentials: 'include'
    });
    
    const data = await res.json();
    if (data.success) {
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
      await loadChats();
      currentChatId = null;
      document.getElementById("currentChatTitle").textContent = "Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„";
      document.getElementById("closeChatBtn").style.display = "none";
      document.getElementById("deleteChatBtn").style.display = "none";
      document.getElementById("messageInputArea").style.display = "none";
      document.getElementById("messagesArea").innerHTML = `<div class="empty-state">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>`;
      stopMessagePolling();
    } else {
      alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ø§Øª: " + (data.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
function updateChatUI() {
  if (!currentChatId) return;
  
  const chat = allChats.find(c => c.id === currentChatId);
  if (!chat) return;
  
  const closeBtn = document.getElementById("closeChatBtn");
  const deleteBtn = document.getElementById("deleteChatBtn");
  const inputArea = document.getElementById("messageInputArea");
  
  if (chat.status === 'closed') {
    closeBtn.style.display = "none";
    deleteBtn.style.display = "block";
    if (inputArea) {
      inputArea.style.display = "none";
    }
  } else {
    closeBtn.style.display = "block";
    deleteBtn.style.display = "none";
    if (inputArea) {
      inputArea.style.display = "flex";
    }
  }
}

// Ø¨Ø¯Ø¡ Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function startMessagePolling() {
  stopMessagePolling();
  messagePollInterval = setInterval(() => {
    if (currentChatId) {
      loadMessages();
      loadChats();
    }
  }, 3000);
}

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function stopMessagePolling() {
  if (messagePollInterval) {
    clearInterval(messagePollInterval);
    messagePollInterval = null;
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©
function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§ØªØ§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadChats();
</script>

</body>
</html>

