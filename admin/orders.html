<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
* {
  box-sizing: border-box;
}

body { 
  font-family: 'Cairo', sans-serif; 
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  margin: 0; 
  padding: 25px; 
  min-height: 100vh;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
}

h1 {
  text-align: center;
  color: #065f6a;
  margin-bottom: 30px;
  font-size: 32px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* ======================= Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ======================= */
.orders-table-box { 
  background: white; 
  border-radius: 16px; 
  box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
  overflow: hidden;
  overflow-x: auto;
}

.orders-table { 
  width: 100%; 
  border-collapse: collapse;
  min-width: 1000px;
}

.orders-table thead {
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
}

.orders-table th { 
  color: white; 
  padding: 18px 14px; 
  font-size: 15px;
  font-weight: 700;
  text-align: center;
  white-space: nowrap;
}

.orders-table td { 
  padding: 16px 14px; 
  text-align: center; 
  border-bottom: 1px solid #f0f0f0; 
  font-size: 14px;
  color: #333;
}

.orders-table tbody tr {
  transition: all 0.2s ease;
}

.orders-table tbody tr:hover {
  background: #f8f9fa;
  transform: scale(1.01);
}

.orders-table tbody tr:last-child td {
  border-bottom: none;
}

.view-btn {
  background: linear-gradient(135deg, #00a6ff 0%, #0288d1 100%);
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 166, 255, 0.3);
}

.view-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 166, 255, 0.4);
}

.print-btn { 
  background: linear-gradient(135deg, #0288d1 0%, #0277bd 100%);
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(2, 136, 209, 0.3);
  margin-right: 8px;
}

.print-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(2, 136, 209, 0.4);
}

.status-badge { 
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  color: white;
  display: inline-block;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.status-new { 
  background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
}

.status-processing { 
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
}

.status-delivery { 
  background: linear-gradient(135deg, #0288d1 0%, #0277bd 100%);
}

.status-done { 
  background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
}

.status-canceled { 
  background: linear-gradient(135deg, #b71c1c 0%, #8b0000 100%);
}

/* ======================= Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ======================= */
.popup { 
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  padding: 20px;
}

.popup-box { 
  background: white;
  width: 100%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: 20px;
  padding: 30px;
  animation: fadeInScale 0.3s ease;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

@keyframes fadeInScale { 
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.popup-box h2 {
  color: #065f6a;
  text-align: center;
  margin-bottom: 25px;
  font-size: 28px;
  font-weight: 700;
  border-bottom: 3px solid #065f6a;
  padding-bottom: 15px;
}

.popup-box h3 {
  color: #065f6a;
  margin-top: 25px;
  margin-bottom: 15px;
  font-size: 20px;
  font-weight: 700;
  padding-right: 10px;
  border-right: 4px solid #065f6a;
}

.popup-box p {
  margin: 10px 0;
  font-size: 15px;
  color: #555;
  line-height: 1.8;
}

.popup-box p b {
  color: #065f6a;
  font-weight: 700;
}

.popup-box a {
  color: #0288d1;
  text-decoration: none;
  font-weight: 600;
  transition: color 0.2s;
}

.popup-box a:hover {
  color: #0277bd;
  text-decoration: underline;
}

.items-table { 
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.items-table thead {
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
}

.items-table th { 
  color: white;
  padding: 14px 10px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
}

.items-table td { 
  padding: 14px 10px;
  border-bottom: 1px solid #f0f0f0;
  text-align: center;
  font-size: 14px;
}

.items-table tbody tr:hover {
  background: #f8f9fa;
}

.items-table img { 
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© */
.status-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
  margin-bottom: 20px;
}

.status-buttons button {
  background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(233, 30, 99, 0.3);
  flex: 1;
  min-width: 120px;
}

.status-buttons button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
}

.status-buttons button.active { 
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%) !important;
  box-shadow: 0 4px 12px rgba(6, 95, 106, 0.4);
}

.close-btn {
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
  color: white;
  padding: 14px;
  width: 100%;
  border: none;
  border-radius: 12px;
  margin-top: 20px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(6, 95, 106, 0.3);
}

.close-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(6, 95, 106, 0.4);
}

/* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ */
.summary-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 20px;
  border-radius: 12px;
  margin: 15px 0;
  border-right: 4px solid #065f6a;
}

.summary-card h3 {
  margin: 0 0 10px 0;
  color: #065f6a;
  font-size: 18px;
  border: none;
  padding: 0;
}

.summary-card .amount {
  font-size: 24px;
  font-weight: 700;
  color: #065f6a;
}

.summary-card.final {
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
  color: white;
}

.summary-card.final h3 {
  color: white;
}

.summary-card.final .amount {
  color: white;
  font-size: 28px;
}

@media print {
  body * { visibility: hidden; }
  #invoiceArea, #invoiceArea * { visibility: visible; }
  #invoiceArea { position: absolute; top: 0; left: 0; right: 0; }
}

@media (max-width: 768px) {
  body {
    padding: 15px;
  }
  
  h1 {
    font-size: 24px;
  }
  
  .orders-table-box {
    overflow-x: auto;
  }
  
  .popup-box {
    padding: 20px;
    max-height: 95vh;
  }
  
  .status-buttons button {
    min-width: 100px;
    font-size: 12px;
    padding: 8px 12px;
  }
}
</style>
</head>

<body>
<!-- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
<script src="/admin/auth-check.js"></script>

<div class="container">
  <h1>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>

  <audio id="notifSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <div class="orders-table-box">
    <table class="orders-table">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù…</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø© / Ø·Ø¨Ø§Ø¹Ø©</th>
          <th>Ø¹Ø±Ø¶</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div class="popup" id="popup">
  <div class="popup-box" id="popupBox"></div>
</div>

<script>
// Load BASE_URL dynamically
let API = "http://localhost:3000";
(async function() {
  try {
    const response = await fetch("/api/config", { credentials: "include" });
    const config = await response.json();
    if (config.baseUrl) API = config.baseUrl;
  } catch (error) {
    console.warn("Could not load BASE_URL from config, using fallback:", error);
  }
})();
let ALL = [];
let CURRENT_ORDER = null;
let lastOrderId = null;

// Ù„Ùˆ Ø¯Ø®Ù„Ù†Ø§ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ â†’ ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
const urlParams = new URLSearchParams(location.search);
const filterPhone = urlParams.get("phone");

/* ------------------ Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØ± ------------------ */
function safeImageURL(url) {
  if (!url) return "/uploads/default.png";
  url = url.trim();

  if (url.includes("drive.google.com")) {
    const id = url.match(/[-\w]{25,}/);
    return id ? `https://lh3.googleusercontent.com/d/${id[0]}` : url;
  }

  if (url.includes("lh3.googleusercontent.com")) return url;

  if (url.startsWith("http://") || url.startsWith("https://")) return url;

  return url;
}

/* ------------------ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ------------------ */
async function loadOrders() {
  try {
    const res = await fetch(API + "/api/orders");
    ALL = await res.json();
    renderOrders();

    if (ALL.length > 0) {
      let newest = ALL[0].id;
      if (lastOrderId !== null && newest > lastOrderId) {
        document.getElementById("notifSound").play();
      }
      lastOrderId = newest;
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", error);
  }
}

function renderOrders() {
  const box = document.getElementById("ordersBody");
  box.innerHTML = "";

  let filteredOrders = filterPhone ? ALL.filter(o => o.customer_phone == filterPhone) : ALL;

  if (filteredOrders.length === 0) {
    box.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª
        </td>
      </tr>
    `;
    return;
  }

  filteredOrders.forEach(o => {
    box.innerHTML += `
    <tr>
      <td><strong style="color: #065f6a;">#${o.id}</strong></td>
      <td>${o.customer_name}</td>
      <td>${o.customer_phone}</td>
      <td>${o.date}</td>
      <td>${o.coupon_code ? `<span style="background:#d4edda;color:#155724;padding:4px 10px;border-radius:6px;font-weight:600;font-size:12px;">ğŸŸï¸ ${o.coupon_code}</span>` : 'â€”'}</td>
      <td>
        <span class="status-badge ${statusClass(o.status)}">${statusText(o.status)}</span>
        ${
          (o.status === "delivery" || o.status === "done")
          ? `<button class="print-btn" onclick="directPrint(${o.id})">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø©</button>`
          : ""
        }
      </td>
      <td><button class="view-btn" onclick="openOrder(${o.id})">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button></td>
    </tr>`;
  });
}

function statusClass(s) {
  return {
    new: "status-new",
    processing: "status-processing",
    delivery: "status-delivery",
    done: "status-done",
    canceled: "status-canceled"
  }[s];
}

function statusText(s) {
  return {
    new: "Ø¬Ø¯ÙŠØ¯",
    processing: "Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²",
    delivery: "Ø®Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„",
    done: "Ù…ÙƒØªÙ…Ù„",
    canceled: "Ù…Ù„ØºÙŠ"
  }[s];
}

/* ------------------ ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ------------------ */
async function openOrder(id) {
  try {
    const fullItems = await fetch(API + "/api/order_items_full/" + id).then(r => r.json());
    const base = await fetch(API + "/api/orders/" + id).then(r => r.json());

    CURRENT_ORDER = { order: base.order, items: fullItems };

    let o = base.order;
    let items = fullItems;

    let html = `
    <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #${o.id}</h2>

    <h3>ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
      <p><b>Ø§Ù„Ø§Ø³Ù…:</b> ${o.customer_name}</p>
      <p><b>Ø§Ù„Ø¬ÙˆØ§Ù„:</b> ${o.customer_phone}</p>
      <p><b>Ø¬ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ:</b> ${o.customer_phone2 || "â€”"}</p>
      <p><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.customer_address || "â€”"}</p>
      <p><b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${o.customer_location ? `<a href="${o.customer_location}" target="_blank">ğŸ“ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>` : "â€”"}</p>
      <p><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${o.customer_notes || "â€”"}</p>
    </div>

    <h3>ğŸ›ï¸ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>

    <table class="items-table">
      <thead>
        <tr>
          <th>Ø§Ù„ØµÙˆØ±Ø©</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>ASKON</th>
          <th>Ø§Ù„Ø¯ÙˆÙ„ÙŠ</th>
          <th>Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø­Ø¨Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th>
        </tr>
      </thead>
      <tbody>
    `;

    for (let i of items) {
      let finalPrice = parseFloat(i.price_with_vat) || 0;
      let totalFinal = parseFloat(i.total) || 0;

      html += `
        <tr>
          <td><img src="${safeImageURL(i.image_url)}" alt="${i.name}"></td>
          <td><strong>${i.name}</strong></td>
          <td>${i.askon_code || "â€”"}</td>
          <td>${i.intl_code || "â€”"}</td>
          <td>${finalPrice.toFixed(2)} Ø±.Ø³</td>
          <td><strong>${i.qty}</strong></td>
          <td><strong style="color: #065f6a;">${totalFinal.toFixed(2)} Ø±.Ø³</strong></td>
        </tr>
      `;
    }

    html += `
      </tbody>
    </table>

    <div class="summary-card">
      <h3>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</h3>
      <span class="amount">${(parseFloat(o.total) + (o.coupon_discount ? parseFloat(o.coupon_discount) * 1.15 : 0)).toFixed(2)} Ø±.Ø³</span>
    </div>

    ${o.coupon_code && parseFloat(o.coupon_discount || 0) > 0 ? `
    <div class="summary-card" style="background:linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);border-right:4px solid #28a745;">
      <h3 style="color:#155724;">ğŸŸï¸ Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (${o.coupon_code}):</h3>
      <span class="amount" style="color:#155724;font-size:20px;">- ${(parseFloat(o.coupon_discount || 0) * 1.15).toFixed(2)} Ø±.Ø³</span>
    </div>
    ` : ''}

    <div class="summary-card">
      <h3>ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</h3>
      <span class="amount">${o.total.toFixed(2)} Ø±.Ø³</span>
    </div>

    <div class="summary-card">
      <h3>ğŸšš Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†:</h3>
      <span class="amount">${o.shipping.toFixed(2)} Ø±.Ø³</span>
    </div>

    <div class="summary-card">
      <h3>ğŸ“Š Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø´Ø­Ù† (15%):</h3>
      <span class="amount">${o.shipping_vat.toFixed(2)} Ø±.Ø³</span>
    </div>

    <div class="summary-card final">
      <h3>ğŸ’³ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„Ø´Ø­Ù†:</h3>
      <span class="amount">${o.total_with_shipping.toFixed(2)} Ø±.Ø³</span>
    </div>

    <h3>ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</h3>
    <div class="status-buttons">
      ${statusButton(id, "new")}
      ${statusButton(id, "processing")}
      ${statusButton(id, "delivery")}
      ${statusButton(id, "done")}
      ${statusButton(id, "canceled")}
    </div>

    <button class="close-btn" onclick="closePopup()">Ø¥ØºÙ„Ø§Ù‚</button>
    `;

    document.getElementById("popupBox").innerHTML = html;
    document.getElementById("popup").style.display = "flex";
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    highlightActive(o.status);
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨");
  }
}

function statusButton(id, st) {
  return `<button onclick="updateStatus(${id}, '${st}')" id="btn-${st}">${statusText(st)}</button>`;
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
}

function highlightActive(st) {
  document.querySelectorAll(".status-buttons button").forEach(btn => {
    btn.classList.remove("active");
  });
  const btn = document.getElementById("btn-" + st);
  if (btn) btn.classList.add("active");
}

/* ------------------ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ------------------ */
async function updateStatus(id, st) {
  try {
    await fetch(API + "/api/orders/" + id + "/status", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: st })
    });

    highlightActive(st);
    loadOrders();
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  }
}

/* ------------------ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙØµÙ„Ø© ------------------ */
async function directPrint(id) {
  try {
    const fullItems = await fetch(API + "/api/order_items_full/" + id).then(r => r.json());
    const base = await fetch(API + "/api/orders/" + id).then(r => r.json());

    let o = base.order;
    let items = fullItems;

    let totalBeforeDiscount = 0;
    let totalAfterDiscount = 0;
    let totalWithVat = 0;

    items.forEach(i => {
      let base = parseFloat(i.base_price) * i.qty;
      let afterDiscount = parseFloat(i.price_after_discount) * i.qty;
      let withVat = parseFloat(i.total);

      totalBeforeDiscount += base;
      totalAfterDiscount += afterDiscount;
      totalWithVat += withVat;
    });

    // QR CODE DATA
    const qrText = `Order: ${o.id}\nCustomer: ${o.customer_name}\nTotal: ${totalWithVat.toFixed(2)} SAR`;
    const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(qrText)}`;

    let logoURL = "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";

    let html = `
    <div id="invoiceArea" style="font-family:Cairo; padding:20px; direction:rtl;">

      <!-- Logo -->
      <div style="text-align:center; margin-bottom:20px;">
        <img src="${logoURL}" style="width:120px; height:120px; object-fit:contain;">
      </div>

      <h2 style="text-align:center;color:#065f6a;">ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ Ø±Ù‚Ù… ${o.id}</h2>

      <p><b>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.customer_name}</p>
      <p><b>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</b> ${o.customer_phone}</p>
      <p><b>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.customer_address}</p>
      <p><b>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${o.date}</p>

      <hr style="margin:20px 0;">

      <h3 style="margin-bottom:10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>

      <table style="width:100%; border-collapse:collapse; text-align:center; font-size:15px;">
        <tr style="background:#065f6a; color:white;">
          <th style="padding:10px;">Ø§Ù„Ø§Ø³Ù…</th>
          <th style="padding:10px;">ASKON</th>
          <th style="padding:10px;">Ø§Ù„Ø¯ÙˆÙ„ÙŠ</th>
          <th style="padding:10px;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
          <th style="padding:10px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th style="padding:10px;">Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th>
          <th style="padding:10px;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th>
        </tr>`;

    for (let i of items) {
      html += `
        <tr style="background:#fafafa;">
          <td style="padding:10px;">${i.name}</td>
          <td style="padding:10px; text-align:center;">${i.askon_code || "â€”"}</td>
          <td style="padding:10px; text-align:center;">${i.intl_code || "â€”"}</td>
          <td style="padding:10px;">${(i.base_price * i.qty).toFixed(2)}</td>
          <td style="padding:10px;">${i.qty}</td>
          <td style="padding:10px;">${(i.price_after_discount * i.qty).toFixed(2)}</td>
          <td style="padding:10px;">${i.total.toFixed(2)}</td>
        </tr>
        <tr><td colspan="7" style="height:12px;"></td></tr>
      `;
    }

    html += `
      </table>

      <br><br>

      <h3>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>

      <p><b>âœ” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</b> ${totalBeforeDiscount.toFixed(2)} Ø±.Ø³</p>
      <p><b>âœ” Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</b> ${totalAfterDiscount.toFixed(2)} Ø±.Ø³</p>
      <p><b>âœ” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©):</b> ${totalWithVat.toFixed(2)} Ø±.Ø³</p>
      
      ${o.coupon_code && parseFloat(o.coupon_discount || 0) > 0 ? `
      <p style="color:#155724; background:#d4edda; padding:10px; border-radius:8px; margin:10px 0;">
        <b>ğŸŸï¸ Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (${o.coupon_code}):</b> - ${(parseFloat(o.coupon_discount || 0) * 1.15).toFixed(2)} Ø±.Ø³
      </p>
      ` : ''}
      
      <p><b>ğŸšš Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†:</b> ${(parseFloat(o.shipping) || 0).toFixed(2)} Ø±.Ø³</p>
      <p><b>ğŸ“Š Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø´Ø­Ù† (15%):</b> ${(parseFloat(o.shipping_vat) || 0).toFixed(2)} Ø±.Ø³</p>
      <p style="font-size:20px; font-weight:bold; color:#065f6a; margin-top:15px;">
        <b>ğŸ’³ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„Ø´Ø­Ù†:</b> ${(parseFloat(o.total_with_shipping) || 0).toFixed(2)} Ø±.Ø³
      </p>

      <hr style="margin:25px 0;">

      <h3 style="text-align:center;">Ø±Ù…Ø² QR Ù„Ù„ÙØ§ØªÙˆØ±Ø©</h3>
      <div style="text-align:center;">
        <img src="${qrURL}" style="width:150px; height:150px;">
      </div>

    </div>`;

    let win = window.open("", "_blank");
    win.document.write(html);
    win.print();
    win.close();
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Popup Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
document.getElementById("popup").addEventListener("click", function(e) {
  if (e.target === this) {
    closePopup();
  }
});

/* ------------------ ØªØ´ØºÙŠÙ„ ------------------ */
loadOrders();
setInterval(loadOrders, 4000);
</script>

</body>
</html>
