<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ø®ØµÙ…</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
* {
  box-sizing: border-box;
}

body {
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  margin: 0;
  padding: 25px;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

h1 {
  text-align: center;
  color: #065f6a;
  margin-bottom: 30px;
  font-size: 32px;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.add-btn {
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  margin-bottom: 20px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(6, 95, 106, 0.3);
  transition: all 0.3s ease;
}

.add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(6, 95, 106, 0.4);
}

.coupons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.coupon-card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.coupon-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.coupon-card.inactive {
  opacity: 0.6;
  background: #f5f5f5;
}

.coupon-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.coupon-name {
  font-size: 20px;
  font-weight: 700;
  color: #065f6a;
}

.coupon-status {
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
}

.coupon-status.active {
  background: #4caf50;
  color: white;
}

.coupon-status.inactive {
  background: #e0e0e0;
  color: #666;
}

.coupon-info {
  margin-bottom: 15px;
}

.coupon-info-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 14px;
}

.coupon-info-label {
  color: #666;
  font-weight: 600;
}

.coupon-info-value {
  color: #065f6a;
  font-weight: 700;
}

.coupon-actions {
  display: flex;
  gap: 10px;
}

.coupon-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s ease;
}

.edit-btn {
  background: linear-gradient(135deg, #0288d1 0%, #00a6ff 100%);
  color: white;
}

.edit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(2, 136, 209, 0.4);
}

.toggle-btn {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  color: white;
}

.toggle-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
}

.delete-btn {
  background: linear-gradient(135deg, #d62828 0%, #b71c1c 100%);
  color: white;
}

.delete-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(214, 40, 40, 0.4);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  z-index: 10000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: fadeInScale 0.3s ease;
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  color: #065f6a;
}

.close-modal {
  background: none;
  border: none;
  font-size: 28px;
  color: #999;
  cursor: pointer;
  transition: color 0.2s;
}

.close-modal:hover {
  color: #d62828;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  font-family: 'Cairo', sans-serif;
  transition: border-color 0.3s;
}

.form-input:focus {
  outline: none;
  border-color: #065f6a;
}

.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 25px;
}

.form-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.save-btn {
  background: linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
  color: white;
}

.save-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(6, 95, 106, 0.4);
}

.cancel-btn {
  background: #e0e0e0;
  color: #333;
}

.cancel-btn:hover {
  background: #d0d0d0;
}

.error-message {
  color: #d62828;
  font-size: 14px;
  margin-top: 10px;
  text-align: center;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.empty-state-text {
  font-size: 18px;
}
</style>
</head>

<body>
<!-- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
<script src="/admin/auth-check.js"></script>

<div class="container">
  <h1>ğŸŸï¸ Ø¥Ø¯Ø§Ø±Ø© ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø§Ù„Ø®ØµÙ…</h1>

  <button class="add-btn" onclick="openAddModal()">+ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</button>

  <div class="coupons-grid" id="couponsGrid"></div>
</div>

<!-- Modal Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† -->
<div class="modal" id="couponModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>

    <form id="couponForm" onsubmit="saveCoupon(event)">
      <div class="form-group">
        <label class="form-label">Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</label>
        <input type="text" id="couponName" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… Ù„Ø£ÙˆÙ„ Ø¹Ù…ÙŠÙ„" required>
      </div>

      <div class="form-group">
        <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…</label>
        <input type="text" id="couponCode" class="form-input" placeholder="Ù…Ø«Ø§Ù„: FIRST10" required style="text-transform: uppercase;">
      </div>

      <div class="form-group">
        <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)</label>
        <input type="number" id="couponDiscount" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 10" min="0" max="100" step="0.1" required>
      </div>

      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="couponShowInBanner" style="width:18px;height:18px;cursor:pointer;">
          <span>Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ø¨Ø§Ù†Ø± (ÙÙˆÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)</span>
        </label>
      </div>

      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="couponFirstOrderOnly" style="width:18px;height:18px;cursor:pointer;">
          <span>Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· (ÙŠØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· ÙÙŠ Ø£ÙˆÙ„ Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„)</span>
        </label>
      </div>

      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="couponOneTimeOnly" style="width:18px;height:18px;cursor:pointer;">
          <span>ØµØ§Ù„Ø­ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨)</span>
        </label>
      </div>

      <div id="errorMessage" class="error-message" style="display: none;"></div>

      <div class="form-actions">
        <button type="button" class="form-btn cancel-btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" class="form-btn save-btn">Ø­ÙØ¸</button>
      </div>
    </form>
  </div>
</div>

<script>
// Load BASE_URL dynamically
let API = "http://localhost:3000";
(async function() {
  try {
    const response = await fetch("/api/config", { credentials: "include" });
    const config = await response.json();
    if (config.baseUrl) API = config.baseUrl;
  } catch (error) {
    console.warn("Could not load BASE_URL from config, using fallback:", error);
  }
})();
let currentCouponId = null;

async function loadCoupons() {
  try {
    const res = await fetch(API + "/api/admin/coupons", {
      credentials: "include"
    });
    
    if (!res.ok) throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    
    const coupons = await res.json();
    const grid = document.getElementById("couponsGrid");
    
    if (coupons.length === 0) {
      grid.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
          <div class="empty-state-icon">ğŸŸï¸</div>
          <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        </div>
      `;
      return;
    }
    
    grid.innerHTML = "";
    coupons.forEach(coupon => {
      grid.innerHTML += `
        <div class="coupon-card ${coupon.active ? '' : 'inactive'}">
          <div class="coupon-header">
            <div class="coupon-name">${coupon.name}</div>
            <span class="coupon-status ${coupon.active ? 'active' : 'inactive'}">
              ${coupon.active ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}
            </span>
          </div>
          <div class="coupon-info">
            <div class="coupon-info-item">
              <span class="coupon-info-label">Ø§Ù„ÙƒÙˆØ¯:</span>
              <span class="coupon-info-value">${coupon.code}</span>
            </div>
            <div class="coupon-info-item">
              <span class="coupon-info-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…:</span>
              <span class="coupon-info-value">${coupon.discount_percent}%</span>
            </div>
            <div class="coupon-info-item">
              <span class="coupon-info-label">ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¨Ø§Ù†Ø±:</span>
              <span class="coupon-info-value">${coupon.show_in_banner == 1 ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</span>
            </div>
            <div class="coupon-info-item">
              <span class="coupon-info-label">Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø·:</span>
              <span class="coupon-info-value">${coupon.first_order_only == 1 ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</span>
            </div>
            <div class="coupon-info-item">
              <span class="coupon-info-label">ØµØ§Ù„Ø­ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·:</span>
              <span class="coupon-info-value">${coupon.one_time_only == 1 ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</span>
            </div>
          </div>
          <div class="coupon-actions">
            <button class="coupon-btn edit-btn" onclick="openEditModal(${coupon.id})">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="coupon-btn toggle-btn" onclick="toggleCoupon(${coupon.id}, ${coupon.active ? 0 : 1})">
              ${coupon.active ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„'}
            </button>
            <button class="coupon-btn delete-btn" onclick="deleteCoupon(${coupon.id})">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
    });
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª:", error);
    document.getElementById("couponsGrid").innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1; color: #d62828;">
        <div class="empty-state-icon">âŒ</div>
        <div class="empty-state-text">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
      </div>
    `;
  }
}

function openAddModal() {
  currentCouponId = null;
  document.getElementById("modalTitle").textContent = "Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯";
  document.getElementById("couponForm").reset();
  document.getElementById("errorMessage").style.display = "none";
  document.getElementById("couponModal").style.display = "flex";
  document.getElementById("couponCode").addEventListener("input", function(e) {
    e.target.value = e.target.value.toUpperCase();
  });
}

function openEditModal(id) {
  currentCouponId = id;
  document.getElementById("modalTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†";
  document.getElementById("errorMessage").style.display = "none";
  
  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†
  fetch(API + "/api/admin/coupons", {
    credentials: "include"
  })
    .then(r => r.json())
    .then(coupons => {
      const coupon = coupons.find(c => c.id === id);
      if (coupon) {
        document.getElementById("couponName").value = coupon.name;
        document.getElementById("couponCode").value = coupon.code;
        document.getElementById("couponDiscount").value = coupon.discount_percent;
        document.getElementById("couponShowInBanner").checked = coupon.show_in_banner == 1;
        document.getElementById("couponFirstOrderOnly").checked = coupon.first_order_only == 1;
        document.getElementById("couponOneTimeOnly").checked = coupon.one_time_only == 1;
        document.getElementById("couponModal").style.display = "flex";
      }
    });
}

function closeModal() {
  document.getElementById("couponModal").style.display = "none";
  currentCouponId = null;
  document.getElementById("couponForm").reset();
  document.getElementById("errorMessage").style.display = "none";
}

async function saveCoupon(event) {
  event.preventDefault();
  
  const name = document.getElementById("couponName").value.trim();
  const code = document.getElementById("couponCode").value.trim().toUpperCase();
  const discount = parseFloat(document.getElementById("couponDiscount").value);
  const showInBanner = document.getElementById("couponShowInBanner").checked;
  const firstOrderOnly = document.getElementById("couponFirstOrderOnly").checked;
  const oneTimeOnly = document.getElementById("couponOneTimeOnly").checked;
  const errorDiv = document.getElementById("errorMessage");
  
  if (!name || !code || isNaN(discount) || discount < 0 || discount > 100) {
    errorDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­";
    errorDiv.style.display = "block";
    return;
  }
  
  try {
    const url = currentCouponId 
      ? `${API}/api/admin/coupons/${currentCouponId}`
      : `${API}/api/admin/coupons`;
    
    const method = currentCouponId ? "PUT" : "POST";
    const body = currentCouponId
      ? { name, code, discount_percent: discount, active: 1, show_in_banner: showInBanner, first_order_only: firstOrderOnly, one_time_only: oneTimeOnly }
      : { name, code, discount_percent: discount, show_in_banner: showInBanner, first_order_only: firstOrderOnly, one_time_only: oneTimeOnly };
    
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    
    if (data.success) {
      closeModal();
      loadCoupons();
    } else {
      errorDiv.textContent = data.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸";
      errorDiv.style.display = "block";
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:", error);
    errorDiv.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
    errorDiv.style.display = "block";
  }
}

async function toggleCoupon(id, newStatus) {
  try {
    const res = await fetch(`${API}/api/admin/coupons`, {
      credentials: "include"
    });
    const coupons = await res.json();
    const coupon = coupons.find(c => c.id === id);
    
    if (!coupon) return;
    
    await fetch(`${API}/api/admin/coupons/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        name: coupon.name,
        code: coupon.code,
        discount_percent: coupon.discount_percent,
        active: newStatus
      })
    });
    
    loadCoupons();
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©");
  }
}

async function deleteCoupon(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†ØŸ")) return;
  
  try {
    const res = await fetch(`${API}/api/admin/coupons/${id}`, {
      method: "DELETE",
      credentials: "include"
    });
    
    const data = await res.json();
    
    if (data.success) {
      loadCoupons();
    } else {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
document.getElementById("couponModal").addEventListener("click", function(e) {
  if (e.target === this) {
    closeModal();
  }
});

loadCoupons();
</script>

</body>
</html>

