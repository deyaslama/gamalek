<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª â€“ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Cairo',sans-serif;
  background:#f5f7fa;
  color:#333;
  margin:0;
  padding:20px;
}

.main{
  max-width:1400px;
  margin:0 auto;
  background:#fff;
  padding:30px;
  border-radius:12px;
  box-shadow:0 2px 12px rgba(0,0,0,0.08);
}

.header{
  margin-bottom:30px;
  padding-bottom:20px;
  border-bottom:3px solid #065f6a;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header h1{
  color:#065f6a;
  font-size:28px;
  font-weight:700;
}

.btn{
  background:linear-gradient(135deg, #065f6a 0%, #0d7b86 100%);
  color:#fff;
  border:none;
  padding:12px 24px;
  border-radius:8px;
  cursor:pointer;
  font-size:16px;
  font-weight:600;
  transition:all 0.3s ease;
  box-shadow:0 2px 8px rgba(6, 95, 106, 0.2);
}

.btn:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(6, 95, 106, 0.3);
}

.btn-red{background:linear-gradient(135deg, #d62828 0%, #b71c1c 100%);}
.btn-green{background:linear-gradient(135deg, #28a745 0%, #20c997 100%);}
.btn-yellow{background:linear-gradient(135deg, #ffc107 0%, #ff9800 100%);}

.banners-list{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(350px, 1fr));
  gap:20px;
  margin-top:30px;
}

.banner-item{
  background:#f8f9fa;
  border:2px solid #e0e0e0;
  border-radius:12px;
  padding:20px;
  position:relative;
}

.banner-item.inactive{
  opacity:0.6;
  background:#f0f0f0;
}

.banner-item-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
  padding-bottom:15px;
  border-bottom:2px solid #e0e0e0;
}

.banner-title{
  font-size:18px;
  font-weight:700;
  color:#065f6a;
}

.banner-position{
  background:#065f6a;
  color:#fff;
  padding:4px 12px;
  border-radius:6px;
  font-size:12px;
  font-weight:600;
}

.banner-images{
  display:flex;
  gap:15px;
  margin-bottom:15px;
}

.banner-image-preview{
  flex:1;
  border:2px solid #e0e0e0;
  border-radius:8px;
  padding:10px;
  background:#fff;
}

.banner-image-preview img{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:6px;
}

.banner-image-label{
  font-size:12px;
  color:#666;
  margin-bottom:5px;
  font-weight:600;
}

.banner-products{
  margin-bottom:15px;
  padding:10px;
  background:#fff;
  border-radius:6px;
  border:1px solid #e0e0e0;
}

.banner-products-label{
  font-size:14px;
  font-weight:600;
  color:#065f6a;
  margin-bottom:8px;
}

.banner-products-list{
  font-size:12px;
  color:#666;
  max-height:60px;
  overflow-y:auto;
}

.banner-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.btn-small{
  padding:8px 16px;
  font-size:14px;
}

.modal-overlay{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9999;
  backdrop-filter:blur(4px);
}

.modal-box{
  background:#fff;
  padding:30px;
  border-radius:16px;
  box-shadow:0 8px 32px rgba(0,0,0,0.2);
  width:90%;
  max-width:800px;
  max-height:90vh;
  overflow-y:auto;
}

.modal-box h3{
  text-align:center;
  color:#065f6a;
  margin-bottom:20px;
  font-size:22px;
  font-weight:800;
  padding-bottom:15px;
  border-bottom:3px solid #065f6a;
}

.modal-input{
  width:100%;
  padding:12px 16px;
  border-radius:10px;
  border:2px solid #e0e0e0;
  font-size:14px;
  margin-bottom:12px;
  transition:all 0.3s ease;
  background:#fafafa;
  font-family:'Cairo',sans-serif;
}

.modal-input:focus{
  outline:none;
  border-color:#065f6a;
  background:#fff;
  box-shadow:0 0 0 4px rgba(6, 95, 106, 0.1);
}

.modal-actions{
  display:flex;
  gap:12px;
  justify-content:flex-end;
  margin-top:20px;
  padding-top:20px;
  border-top:2px solid #f0f0f0;
}

.products-selector{
  max-height:300px;
  overflow-y:auto;
  border:2px solid #e0e0e0;
  border-radius:8px;
  padding:15px;
  background:#fafafa;
  margin-top:10px;
}

.product-checkbox-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px;
  margin-bottom:8px;
  background:#fff;
  border-radius:6px;
  cursor:pointer;
  transition:all 0.2s ease;
}

.product-checkbox-item:hover{
  background:#f0f8ff;
}

.product-checkbox-item input[type="checkbox"]{
  width:18px;
  height:18px;
  cursor:pointer;
}

.product-checkbox-item label{
  cursor:pointer;
  flex:1;
  font-size:14px;
}

.empty-state{
  text-align:center;
  padding:60px 20px;
  color:#999;
}

.empty-state p{
  font-size:18px;
  margin-bottom:10px;
}
</style>
</head>
<body>

<div class="main">
  <div class="header">
    <h1>ğŸ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª</h1>
    <button class="btn" onclick="showAddModal()">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <div class="banners-list" id="bannersList">
    <div class="empty-state">
      <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
<div id="bannerModal" class="modal-overlay">
  <div class="modal-box">
    <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯</h3>

    <input type="hidden" id="edit_id">

    <input type="text" id="bannerTitle" class="modal-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø§Ù†Ø±">
    
    <select id="bannerPosition" class="modal-input">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
      <option value="main_slider">Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø«Ø§Ø¨Øª (Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)</option>
      <option value="above_brands">ÙÙˆÙ‚ Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª</option>
      <option value="above_featured">ÙÙˆÙ‚ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø®ØªØ§Ø±Ø©</option>
      <option value="above_offers">ÙÙˆÙ‚ Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ©</option>
    </select>

    <label id="desktopImageLabel" style="display:block;margin-bottom:8px;font-weight:600;color:#065f6a;">ØµÙˆØ±Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (1200x400):</label>
    <div style="display:flex;gap:10px;align-items:flex-start;">
      <input type="text" id="desktopImage" class="modal-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±" style="flex:1;">
      <div style="position:relative;">
        <input type="file" id="desktopImageFile" accept="image/*" style="display:none;" onchange="handleDesktopImageUpload(event)">
        <button type="button" onclick="document.getElementById('desktopImageFile').click()" class="btn" style="white-space:nowrap;padding:10px 15px;">ğŸ“ Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
      </div>
    </div>
    <div id="desktopPreview" style="margin-bottom:15px;"></div>
    <div id="desktopUploadStatus" style="margin-top:5px;font-size:12px;color:#666;"></div>

    <label id="mobileImageLabel" style="display:block;margin-bottom:8px;font-weight:600;color:#065f6a;">ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ (600x400):</label>
    <div style="display:flex;gap:10px;align-items:flex-start;">
      <input type="text" id="mobileImage" class="modal-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„" style="flex:1;">
      <div style="position:relative;">
        <input type="file" id="mobileImageFile" accept="image/*" style="display:none;" onchange="handleMobileImageUpload(event)">
        <button type="button" onclick="document.getElementById('mobileImageFile').click()" class="btn" style="white-space:nowrap;padding:10px 15px;">ğŸ“ Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
      </div>
    </div>
    <div id="mobilePreview" style="margin-bottom:15px;"></div>
    <div id="mobileUploadStatus" style="margin-top:5px;font-size:12px;color:#666;"></div>

    <label style="display:block;margin-bottom:8px;font-weight:600;color:#065f6a;">ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶:</label>
    <input type="number" id="displayOrder" class="modal-input" placeholder="0" value="0" min="0">

    <label style="display:block;margin-bottom:8px;font-weight:600;color:#065f6a;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:</label>
    <div class="products-selector" id="productsSelector">
      <p style="text-align:center;color:#999;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="saveBanner()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn btn-red" onclick="hideModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
const API = "http://localhost:3000";
let allProducts = [];
let selectedProducts = [];

async function loadBanners(){
  try {
    const res = await fetch(API + "/api/admin/banners", {
      credentials: "include"
    });
    const data = await res.json();
    
    if(data.error){
      alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª: " + data.error);
      return;
    }

    renderBanners(data);
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª");
  }
}

function renderBanners(banners){
  const container = document.getElementById("bannersList");
  
  if(banners.length === 0){
    container.innerHTML = `
      <div class="empty-state" style="grid-column:1/-1;">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ù†Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
        <p style="font-size:14px;color:#999;margin-top:10px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¨Ø§Ù†Ø±</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = "";
  banners.forEach(banner => {
    const positionNames = {
      'main_slider': 'Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø«Ø§Ø¨Øª (Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)',
      'above_brands': 'ÙÙˆÙ‚ Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª',
      'above_featured': 'ÙÙˆÙ‚ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø®ØªØ§Ø±Ø©',
      'above_offers': 'ÙÙˆÙ‚ Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ©'
    };
    
    let productIds = [];
    try {
      if (banner.product_ids) {
        const parsed = JSON.parse(banner.product_ids);
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…ØµÙÙˆÙØ©
        productIds = Array.isArray(parsed) ? parsed : [];
      }
    } catch(e) {
      productIds = [];
    }
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† productIds Ù…ØµÙÙˆÙØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
    if (!Array.isArray(productIds)) {
      productIds = [];
    }
    
    container.innerHTML += `
      <div class="banner-item ${banner.active == 0 ? 'inactive' : ''}">
        <div class="banner-item-header">
          <div>
            <div class="banner-title">${banner.title}</div>
            <div class="banner-position" style="margin-top:5px;">${positionNames[banner.position] || banner.position}</div>
          </div>
          <span style="font-size:12px;color:#999;">ØªØ±ØªÙŠØ¨: ${banner.display_order}</span>
        </div>
        
        <div class="banner-images">
          <div class="banner-image-preview">
            <div class="banner-image-label">ğŸ’» Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</div>
            <img src="${banner.desktop_image || ''}" onerror="this.style.display='none'">
          </div>
          <div class="banner-image-preview">
            <div class="banner-image-label">ğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„</div>
            <img src="${banner.mobile_image || ''}" onerror="this.style.display='none'">
          </div>
        </div>
        
        <div class="banner-products">
          <div class="banner-products-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (${productIds.length})</div>
          <div class="banner-products-list">
            ${productIds.length > 0 ? productIds.map(id => {
              const product = allProducts.find(p => p.id == id);
              return product ? product.name : `ID: ${id}`;
            }).join(', ') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª'}
          </div>
        </div>
        
        <div class="banner-actions">
          <button class="btn btn-yellow btn-small" onclick="editBanner(${banner.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn ${banner.active == 1 ? 'btn-red' : 'btn-green'} btn-small" onclick="toggleBanner(${banner.id}, ${parseInt(banner.active) || 0})">
            ${banner.active == 1 ? 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù' : 'â–¶ï¸ ØªÙØ¹ÙŠÙ„'}
          </button>
          <button class="btn btn-red btn-small" onclick="deleteBanner(${banner.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
    `;
  });
}

async function loadProducts(){
  try {
    const res = await fetch(API + "/api/admin/products", {
      credentials: "include"
    });
    const data = await res.json();
    allProducts = data;
    renderProductsSelector();
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
  }
}

function renderProductsSelector(selected = []){
  const container = document.getElementById("productsSelector");
  selectedProducts = selected;
  
  if(allProducts.length === 0){
    container.innerHTML = "<p style='text-align:center;color:#999;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>";
    return;
  }
  
  container.innerHTML = "";
  allProducts.forEach(product => {
    const isChecked = selected.includes(product.id);
    container.innerHTML += `
      <div class="product-checkbox-item">
        <input type="checkbox" id="prod_${product.id}" value="${product.id}" ${isChecked ? 'checked' : ''} onchange="updateSelectedProducts()">
        <label for="prod_${product.id}">${product.name}</label>
      </div>
    `;
  });
}

function updateSelectedProducts(){
  const checkboxes = document.querySelectorAll('#productsSelector input[type="checkbox"]:checked');
  selectedProducts = Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function showAddModal(){
  document.getElementById("modalTitle").innerText = "Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯";
  document.getElementById("edit_id").value = "";
  document.getElementById("bannerTitle").value = "";
  document.getElementById("bannerPosition").value = "";
  document.getElementById("desktopImage").value = "";
  document.getElementById("mobileImage").value = "";
  document.getElementById("displayOrder").value = "0";
  selectedProducts = [];
  renderProductsSelector([]);
  document.getElementById("bannerModal").style.display = "flex";
  
  setTimeout(() => {
    updateDesktopPreview();
    updateMobilePreview();
  }, 100);
  
  document.getElementById("desktopImage").oninput = updateDesktopPreview;
  document.getElementById("mobileImage").oninput = updateMobilePreview;
}

function updateDesktopPreview(){
  const input = document.getElementById("desktopImage");
  const preview = document.getElementById("desktopPreview");
  if(input.value){
    preview.innerHTML = `<img src="${input.value}" style="max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;" onerror="this.style.display='none'">`;
  } else {
    preview.innerHTML = "";
  }
}

function updateMobilePreview(){
  const input = document.getElementById("mobileImage");
  const preview = document.getElementById("mobilePreview");
  if(input.value){
    preview.innerHTML = `<img src="${input.value}" style="max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;" onerror="this.style.display='none'">`;
  } else {
    preview.innerHTML = "";
  }
}

// ØªØ­Ø¯ÙŠØ« Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„ØµÙˆØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
function updateImageDimensions(){
  const position = document.getElementById("bannerPosition").value;
  const desktopLabel = document.getElementById("desktopImageLabel");
  const mobileLabel = document.getElementById("mobileImageLabel");
  
  if(position === "main_slider"){
    // Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø«Ø§Ø¨Øª - Ù…Ù‚Ø§Ø³Ø§Øª full width
    desktopLabel.textContent = "ØµÙˆØ±Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (1920x640 Ø£Ùˆ Ø£ÙƒØ¨Ø± - Ù†Ø³Ø¨Ø© 4:1):";
    mobileLabel.textContent = "ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ (1080x720 Ø£Ùˆ Ø£ÙƒØ¨Ø± - Ù†Ø³Ø¨Ø© 2:1):";
  } else {
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª - Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    desktopLabel.textContent = "ØµÙˆØ±Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (1200x400):";
    mobileLabel.textContent = "ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ (600x400):";
  }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
async function handleDesktopImageUpload(event){
  const file = event.target.files[0];
  if(!file) return;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (10MB)
  if(file.size > 10 * 1024 * 1024){
    const statusDiv = document.getElementById("desktopUploadStatus");
    statusDiv.textContent = "âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB)";
    statusDiv.style.color = "#dc3545";
    return;
  }
  
  const statusDiv = document.getElementById("desktopUploadStatus");
  statusDiv.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
  statusDiv.style.color = "#065f6a";
  
  try {
    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const formData = new FormData();
    formData.append("image", file);
    
    const response = await fetch(API + "/api/admin/upload-image", {
      method: "POST",
      credentials: "include",
      body: formData
    });
    
    const data = await response.json();
    
    if(data.success && data.url){
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      const fullUrl = API + data.url;
      document.getElementById("desktopImage").value = fullUrl;
      updateDesktopPreview();
      statusDiv.textContent = "âœ“ ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­";
      statusDiv.style.color = "#28a745";
    } else {
      statusDiv.textContent = "âŒ " + (data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
      statusDiv.style.color = "#dc3545";
    }
  } catch (error) {
    console.error("Error:", error);
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message;
    statusDiv.style.color = "#dc3545";
  }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„
async function handleMobileImageUpload(event){
  const file = event.target.files[0];
  if(!file) return;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (10MB)
  if(file.size > 10 * 1024 * 1024){
    const statusDiv = document.getElementById("mobileUploadStatus");
    statusDiv.textContent = "âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB)";
    statusDiv.style.color = "#dc3545";
    return;
  }
  
  const statusDiv = document.getElementById("mobileUploadStatus");
  statusDiv.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
  statusDiv.style.color = "#065f6a";
  
  try {
    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const formData = new FormData();
    formData.append("image", file);
    
    const response = await fetch(API + "/api/admin/upload-image", {
      method: "POST",
      credentials: "include",
      body: formData
    });
    
    const data = await response.json();
    
    if(data.success && data.url){
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      const fullUrl = API + data.url;
      document.getElementById("mobileImage").value = fullUrl;
      updateMobilePreview();
      statusDiv.textContent = "âœ“ ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­";
      statusDiv.style.color = "#28a745";
    } else {
      statusDiv.textContent = "âŒ " + (data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
      statusDiv.style.color = "#dc3545";
    }
  } catch (error) {
    console.error("Error:", error);
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message;
    statusDiv.style.color = "#dc3545";
  }
}

async function editBanner(id){
  try {
    const res = await fetch(API + "/api/admin/banners", {
      credentials: "include"
    });
    const data = await res.json();
    const banner = data.find(b => b.id == id);
    
    if(!banner){
      alert("Ø§Ù„Ø¨Ø§Ù†Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }
    
    document.getElementById("modalTitle").innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù†Ø±";
    document.getElementById("edit_id").value = banner.id;
    document.getElementById("bannerTitle").value = banner.title;
    document.getElementById("bannerPosition").value = banner.position;
    document.getElementById("desktopImage").value = banner.desktop_image;
    document.getElementById("mobileImage").value = banner.mobile_image;
    document.getElementById("displayOrder").value = banner.display_order || 0;
    
    let productIds = [];
    try {
      productIds = JSON.parse(banner.product_ids || "[]");
    } catch(e) {
      productIds = [];
    }
    
    renderProductsSelector(productIds);
    
    if(banner.desktop_image){
      document.getElementById("desktopPreview").innerHTML = `<img src="${banner.desktop_image}" style="max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;">`;
    }
    if(banner.mobile_image){
      document.getElementById("mobilePreview").innerHTML = `<img src="${banner.mobile_image}" style="max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;">`;
    }
    
    document.getElementById("bannerModal").style.display = "flex";
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    setTimeout(() => {
      updateImageDimensions();
    }, 100);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    setTimeout(() => {
      updateImageDimensions();
    }, 100);
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ù†Ø±");
  }
}

function hideModal(){
  document.getElementById("bannerModal").style.display = "none";
}

async function saveBanner(){
  const id = document.getElementById("edit_id").value;
  const title = document.getElementById("bannerTitle").value.trim();
  const position = document.getElementById("bannerPosition").value;
  const desktopImage = document.getElementById("desktopImage").value.trim();
  const mobileImage = document.getElementById("mobileImage").value.trim();
  const displayOrder = parseInt(document.getElementById("displayOrder").value) || 0;
  
  if(!title || !position || !desktopImage || !mobileImage){
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }
  
  updateSelectedProducts();
  
  const body = {
    title,
    position,
    desktop_image: desktopImage,
    mobile_image: mobileImage,
    product_ids: selectedProducts,
    display_order: displayOrder
  };
  
  try {
    let res;
    if(id){
      res = await fetch(API + "/api/admin/banners/" + id, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(body)
      });
    } else {
      res = await fetch(API + "/api/admin/banners", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(body)
      });
    }
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if(data.success){
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­!");
      hideModal();
      loadBanners();
    } else {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + (data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ ÙˆØ£Ù†Ùƒ Ù‚Ù…Øª Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„Ù‡.");
  }
}

async function toggleBanner(id, currentActive){
  // ØªØ­ÙˆÙŠÙ„ currentActive Ø¥Ù„Ù‰ number Ù„Ù„ØªØ£ÙƒØ¯
  const currentActiveNum = parseInt(currentActive) || 0;
  const newActive = currentActiveNum === 1 ? 0 : 1;
  
  console.log(`Toggling banner ${id}: currentActive=${currentActive} (${typeof currentActive}), newActive=${newActive}`);
  
  try {
    const res = await fetch(API + "/api/admin/banners", {
      credentials: "include"
    });
    const data = await res.json();
    const banner = data.find(b => b.id == id);
    
    if(!banner) {
      alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù†Ø±");
      return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ body Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·
    // Ù…Ø¹Ø§Ù„Ø¬Ø© product_ids - Ù‚Ø¯ ÙŠÙƒÙˆÙ† string JSON Ø£Ùˆ array
    let productIds = banner.product_ids;
    if (typeof productIds === 'string') {
      try {
        productIds = JSON.parse(productIds);
      } catch(e) {
        productIds = [];
      }
    }
    if (!Array.isArray(productIds)) {
      productIds = [];
    }
    
    const body = {
      title: banner.title,
      position: banner.position,
      desktop_image: banner.desktop_image,
      mobile_image: banner.mobile_image,
      product_ids: productIds, // Ø§Ø³ØªØ®Ø¯Ø§Ù… array Ù…Ø¨Ø§Ø´Ø±Ø©
      active: newActive, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (0 Ø£Ùˆ 1)
      display_order: banner.display_order || 0
    };
    
    console.log(`Updating banner ${id} with:`, body);
    
    const updateRes = await fetch(API + "/api/admin/banners/" + id, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(body)
    });
    
    const updateData = await updateRes.json();
    
    if(updateData.success){
      console.log(`Banner ${id} updated successfully: active = ${newActive}`);
      loadBanners();
    } else {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + (updateData.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

async function deleteBanner(id){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ù†Ø±ØŸ")) return;
  
  try {
    const res = await fetch(API + "/api/admin/banners/" + id, {
      method: "DELETE",
      credentials: "include"
    });
    
    const data = await res.json();
    
    if(data.success){
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­!");
      loadBanners();
    } else {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
    }
  } catch (error) {
    console.error("Ø®Ø·Ø£:", error);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
(async () => {
  await loadProducts();
  await loadBanners();
})();
</script>

</body>
</html>

