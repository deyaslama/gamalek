<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Cairo',sans-serif;background:#f4f7fb;color:#333;}

.sidebar{
  width:230px;background:#006b6a;height:100vh;position:fixed;
  right:0;top:0;padding:20px;color:#fff;
}
.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.nav-links{display:flex;flex-direction:column;gap:15px;}
.nav-links a{color:#fff;padding:10px;border-radius:6px;font-size:16px;text-decoration: none;}
.nav-links a:hover,.nav-links a.active{background:#009b9b;}

.main{margin-right:25px;padding:25px;}
.header{
  background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);
  margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;
}

.card{
  background:#fff;padding:20px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:25px;
}

.btn{background:#006b6a;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;}
.btn-red{background:#d62828;color:#fff;}
.btn-light{background:#e4e4e4;color:#333;}

.search-input{
  width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;margin-bottom:10px;
}

table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #eee;font-size:13px;}
th{background:#f1f1f1;font-weight:600;}

.brand-img{width:60px;height:60px;object-fit:contain;border:1px solid #ccc;padding:3px;border-radius:6px;}
.star{font-size:22px;color:#ccc;cursor:pointer;}
.star.on{color:#ffbf00;}

.modal-overlay{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:999;
}
.modal-box{
  background:#fff;padding:20px;border-radius:10px;
  box-shadow:0 2px 12px rgba(0,0,0,0.2);width:420px;
}
.modal-box h3{text-align:center;color:#006b6a;margin-bottom:10px;font-size:18px;}
.modal-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;margin-bottom:8px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px;}
</style>
</head>

<body>


</div>

<div class="main">

  <div class="header">
    <span style="font-size:20px;font-weight:600;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª</span>
    <div>
      <button class="btn" onclick="openAddModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ©</button>
      <button class="btn" onclick="downloadExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn" onclick="showUploadExcelModal()">ğŸ“¤ Ø±ÙØ¹ Excel</button>
    </div>
  </div>

  <div class="card">

    <input id="searchInput" class="search-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª..." oninput="loadBrands()">

    <table>
      <thead>
        <tr>
          <th>â­</th>
          <th>Ø§Ù„ØµÙˆØ±Ø©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th>
          <th>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="brandTable"></tbody>
    </table>

  </div>

</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ© -->
<div id="addModal" class="modal-overlay">
  <div class="modal-box">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ©</h3>

    <input id="add_name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
    <input id="add_code" class="modal-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø±ÙƒØ©">

    <label style="display:block;margin-bottom:8px;font-weight:600;color:#006b6a;">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ©:</label>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
      <input id="add_image" class="modal-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ©" style="flex:1;">
      <input type="file" id="addImageUpload" accept="image/*" style="display:none;" onchange="handleBrandImageUpload(event, 'add')">
      <button type="button" class="btn" onclick="document.getElementById('addImageUpload').click()">ğŸ“ Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
    </div>
    <div id="addImagePreview" style="margin-bottom:15px;"></div>
    <div id="addImageUploadStatus" style="margin-bottom:15px;font-size:13px;color:#006b6a;"></div>

    <div class="modal-actions">
      <button class="btn" onclick="addBrand()">Ø­ÙØ¸</button>
      <button class="btn-red" onclick="closeAddModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø±ÙƒØ© -->
<div id="editModal" class="modal-overlay">
  <div class="modal-box">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø±ÙƒØ©</h3>

    <input type="hidden" id="edit_id">

    <input id="edit_name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
    <input id="edit_code" class="modal-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
    <label style="display:block;margin-bottom:8px;font-weight:600;color:#006b6a;">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ©:</label>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
      <input id="edit_image" class="modal-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ©" style="flex:1;">
      <input type="file" id="editImageUpload" accept="image/*" style="display:none;" onchange="handleBrandImageUpload(event, 'edit')">
      <button type="button" class="btn" onclick="document.getElementById('editImageUpload').click()">ğŸ“ Ø±ÙØ¹ ØµÙˆØ±Ø©</button>
    </div>
    <div id="editImagePreview" style="margin-bottom:15px;"></div>
    <div id="editImageUploadStatus" style="margin-bottom:15px;font-size:13px;color:#006b6a;"></div>

    <select id="edit_featured" class="modal-input">
      <option value="0">ØºÙŠØ± Ù…Ù…ÙŠØ²Ø©</option>
      <option value="1">â­ Ù…Ù…ÙŠØ²Ø©</option>
    </select>

    <div class="modal-actions">
      <button class="btn" onclick="saveBrand()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="btn-red" onclick="closeEditModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Excel -->
<div id="uploadExcelModal" class="modal-overlay">
  <div class="modal-box">
    <h3>Ø±ÙØ¹ Ù…Ù„Ù Excel Ù„Ù„Ù…Ø§Ø±ÙƒØ§Øª</h3>
    
    <input type="file" id="brandsExcelFile" accept=".xlsx,.xls" style="margin-bottom:15px;">
    <div id="excelUploadStatus" style="margin-bottom:15px;font-size:13px;color:#006b6a;"></div>
    
    <div class="modal-actions">
      <button class="btn" onclick="uploadBrandsExcel()">Ø±ÙØ¹</button>
      <button class="btn-red" onclick="hideUploadExcelModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
// Load BASE_URL dynamically
let API = "http://localhost:3000";
(async function() {
  try {
    const response = await fetch("/api/config", { credentials: "include" });
    const config = await response.json();
    if (config.baseUrl) API = config.baseUrl;
  } catch (error) {
    console.warn("Could not load BASE_URL from config, using fallback:", error);
  }
})();

/* ========== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª ========== */
async function loadBrands() {
  const q = document.getElementById("searchInput").value;
  const res = await fetch(API + "/api/admin/brands?search=" + q, {
    credentials: "include"
  });
  const brands = await res.json();

  const tbody = document.getElementById("brandTable");
  tbody.innerHTML = "";

  brands.forEach(b => {
    tbody.innerHTML += `
      <tr>
        <td><span class="star ${b.featured ? 'on':''}" onclick="toggleFeatured(${b.id},${b.featured})">${b.featured?"â˜…":"â˜†"}</span></td>
        <td><img src="${b.image_url || ''}" class="brand-img"></td>
        <td>${b.name}</td>
        <td>${b.brand_code || "-"}</td>
        <td>${b.product_count}</td>
        <td>
          <button class="btn-light" onclick="openEditModal(${b.id}, '${b.name}', '${b.brand_code}', '${b.image_url}', ${b.featured})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn-red" onclick="deleteBrand(${b.id})">Ø­Ø°Ù</button>
        </td>
      </tr>
    `;
  });
}

/* ========== Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ© (JSON) ========== */
async function addBrand() {
  const body = {
    name: document.getElementById("add_name").value,
    brand_code: document.getElementById("add_code").value,
    image_url: document.getElementById("add_image").value
  };

  await fetch(API + "/api/admin/brands", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    credentials: "include",
    body: JSON.stringify(body)
  });

  closeAddModal();
  loadBrands();
}

/* ========== ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø±ÙƒØ© (JSON) ========== */
function openEditModal(id, name, code, img, featured) {
  document.getElementById("edit_id").value = id;
  document.getElementById("edit_name").value = name;
  document.getElementById("edit_code").value = code;
  document.getElementById("edit_image").value = img || "";
  document.getElementById("edit_preview").src = img || "";
  document.getElementById("edit_featured").value = featured;

  document.getElementById("editModal").style.display = "flex";
}

async function saveBrand() {
  const id = document.getElementById("edit_id").value;

  const body = {
    name: document.getElementById("edit_name").value,
    brand_code: document.getElementById("edit_code").value,
    image_url: document.getElementById("edit_image").value,
    featured: document.getElementById("edit_featured").value
  };

  await fetch(API + "/api/admin/brands/" + id, {
    method: "PUT",
    headers: { "Content-Type":"application/json" },
    credentials: "include",
    body: JSON.stringify(body)
  });

  closeEditModal();
  loadBrands();
}

/* ========== Ø­Ø°Ù Ù…Ø§Ø±ÙƒØ© ========== */
async function deleteBrand(id) {
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø±ÙƒØ©ØŸ")) return;

  await fetch(API + "/api/admin/brands/" + id, {
    method: "DELETE",
    credentials: "include"
  });
  loadBrands();
}

/* ========== Ù†Ø¬Ù…Ø© ========== */
async function toggleFeatured(id, current) {
  await fetch(API + "/api/admin/brands/feature", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    credentials: "include",
    body: JSON.stringify({ id, featured: current ? 0 : 1 })
  });

  loadBrands();
}

/* ========== Excel ========== */
function downloadExcel() {
  window.location.href = API + "/api/admin/brands/excel";
}

/* ========== Modals ========== */
function openAddModal(){ document.getElementById("addModal").style.display="flex"; }
function closeAddModal(){ document.getElementById("addModal").style.display="none"; }
function closeEditModal(){ document.getElementById("editModal").style.display="none"; }

// Ø±ÙØ¹ Excel Ù„Ù„Ù…Ø§Ø±ÙƒØ§Øª
function showUploadExcelModal() {
  document.getElementById("uploadExcelModal").style.display = "flex";
}

function hideUploadExcelModal() {
  document.getElementById("uploadExcelModal").style.display = "none";
}

async function uploadBrandsExcel() {
  const file = document.getElementById("brandsExcelFile").files[0];
  if(!file) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel");
    return;
  }

  const statusDiv = document.getElementById("excelUploadStatus");
  statusDiv.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
  statusDiv.style.color = "#006b6a";

  try {
    const formData = new FormData();
    formData.append("file", file);

    const response = await fetch(API + "/api/admin/brands/upload-excel", {
      method: "POST",
      credentials: "include",
      body: formData
    });

    const data = await response.json();

    if(data.success) {
      statusDiv.textContent = "âœ“ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­";
      statusDiv.style.color = "#28a745";
      setTimeout(() => {
        hideUploadExcelModal();
        loadBrands();
      }, 1000);
    } else {
      statusDiv.textContent = "âŒ " + (data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù");
      statusDiv.style.color = "#dc3545";
    }
  } catch (error) {
    console.error("Error:", error);
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message;
    statusDiv.style.color = "#dc3545";
  }
}

// Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ©
async function handleBrandImageUpload(event, type) {
  const file = event.target.files[0];
  if(!file) return;
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (10MB)
  if(file.size > 10 * 1024 * 1024){
    const statusDiv = document.getElementById(type === 'add' ? "addImageUploadStatus" : "editImageUploadStatus");
    statusDiv.textContent = "âŒ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB)";
    statusDiv.style.color = "#dc3545";
    return;
  }
  
  const statusDiv = document.getElementById(type === 'add' ? "addImageUploadStatus" : "editImageUploadStatus");
  statusDiv.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";
  statusDiv.style.color = "#006b6a";
  
  try {
    const formData = new FormData();
    formData.append("image", file);
    
    const response = await fetch(API + "/api/admin/upload-image", {
      method: "POST",
      credentials: "include",
      body: formData
    });
    
    const data = await response.json();
    
    if(data.success && data.url){
      const fullUrl = API + data.url;
      const imageInput = type === 'add' ? document.getElementById("add_image") : document.getElementById("edit_image");
      imageInput.value = fullUrl;
      
      const previewDiv = document.getElementById(type === 'add' ? "addImagePreview" : "editImagePreview");
      previewDiv.innerHTML = `<img src="${fullUrl}" style="max-width:100%;max-height:200px;border-radius:8px;margin-top:10px;">`;
      
      statusDiv.textContent = "âœ“ ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­";
      statusDiv.style.color = "#28a745";
    } else {
      statusDiv.textContent = "âŒ " + (data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
      statusDiv.style.color = "#dc3545";
    }
  } catch (error) {
    console.error("Error:", error);
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message;
    statusDiv.style.color = "#dc3545";
  }
}

/* ========== Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ========== */
loadBrands();
</script>

</body>
</html>
